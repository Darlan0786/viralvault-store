<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#fbfbff" />
  <title>ViralVault Store â€” Ultimate Premium (PIX) â€¢ VV-OFICIAL</title>

  <meta name="description" content="Loja premium com checkout PIX, verificaÃ§Ã£o VV-OFICIAL no servidor, chat suporte, cupons, avaliaÃ§Ãµes e painel admin simples." />
  <meta property="og:title" content="ViralVault Store â€” Ultimate Premium (PIX)" />
  <meta property="og:description" content="Checkout PIX + assinatura VV-OFICIAL no servidor + suporte e avaliaÃ§Ãµes." />
  <meta property="og:type" content="website" />

  <style>
    :root{
      --bg:#fbfbff;
      --card:rgba(255,255,255,.72);
      --text:#141621;
      --muted:#5b6374;
      --line:rgba(40,50,80,.12);
      --shadow: 0 22px 70px rgba(15,18,30,.10);
      --shadow2: 0 14px 35px rgba(15,18,30,.08);
      --radius:22px;
      --radius2:30px;

      --accent:#d11f2a;
      --accent2:#ff4d57;

      --ok:#0aa56a;
      --bad:#d11f2a;

      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 18% 0%, rgba(209,31,42,.10), transparent 60%),
        radial-gradient(1000px 700px at 100% 10%, rgba(255,77,87,.08), transparent 62%),
        radial-gradient(900px 600px at 30% 110%, rgba(70,80,120,.08), transparent 60%),
        linear-gradient(180deg, #ffffff, var(--bg));
      overflow-x:hidden;
    }
    a{color:inherit;text-decoration:none}
    button,input,textarea,select{font-family:inherit}
    .mono{font-family:var(--mono)}
    .wrap{max-width:1120px;margin:0 auto;padding:14px 16px 120px}

    /* Notice */
    .topNotice{
      position:sticky; top:0; z-index:80;
      background: rgba(255,255,255,.92);
      border-bottom: 1px solid var(--line);
      backdrop-filter: blur(10px);
    }
    .topNoticeInner{
      max-width:1120px;margin:0 auto;
      padding:10px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
    }
    .noticeLeft{font-size:12px;color:var(--muted)}
    .noticeLeft b{color:var(--text)}
    .noticeBtn{
      border:1px solid var(--line); background:#fff;
      border-radius:14px; padding:8px 10px;
      cursor:pointer;font-weight:950;font-size:12px;
      box-shadow: var(--shadow2);
    }

    /* Topbar */
    .topbar{
      position:sticky; top:44px; z-index:70;
      backdrop-filter: blur(14px);
      background: rgba(251,251,255,.72);
      border-bottom: 1px solid var(--line);
    }
    .topbar .inner{
      max-width:1120px;margin:0 auto;
      padding:12px 16px;
      display:flex;gap:12px;align-items:center;justify-content:space-between;
    }
    .brand{display:flex;align-items:center;gap:12px;cursor:pointer;min-width:240px}
    .logo{
      width:42px;height:42px;border-radius:16px;position:relative;overflow:hidden;
      background: linear-gradient(135deg, #0e111a, #232a3c);
      box-shadow: 0 16px 38px rgba(0,0,0,.18);
    }
    .logo:after{
      content:"VV";
      position:absolute; inset:0; display:grid; place-items:center;
      color:rgba(255,255,255,.95);
      font-weight:950;
      letter-spacing:-.06em;
      text-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .brand b{display:block;font-size:14px;line-height:1.1}
    .brand span{display:block;font-size:12px;color:var(--muted)}

    .nav{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      display:flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.72);
      border:1px solid var(--line);
      box-shadow: var(--shadow2);
      cursor:pointer;
      transition:.18s transform,.18s box-shadow,.18s background;
      user-select:none;
      font-weight:900;
      font-size:13px;
    }
    .pill:hover{transform:translateY(-1px); box-shadow: var(--shadow)}
    .pill.primary{
      border-color: transparent;
      color:#fff;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 16px 34px rgba(209,31,42,.22);
    }
    .badge{
      display:inline-grid; place-items:center;
      min-width:22px;height:22px;padding:0 6px;
      border-radius:999px;background:#fff;color:var(--text);
      font-size:12px;font-weight:950;
    }

    /* Inputs */
    .input{
      width:100%;
      padding:14px 14px;
      border-radius:18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.78);
      box-shadow: var(--shadow2);
      outline:none;
      font-size:14px;
      transition:.18s box-shadow,.18s transform;
    }
    .input:focus{box-shadow: var(--shadow), 0 0 0 6px rgba(209,31,42,.08)}
    .select{
      appearance:none;
      background-image:
        linear-gradient(45deg, transparent 50%, var(--muted) 50%),
        linear-gradient(135deg, var(--muted) 50%, transparent 50%);
      background-position: calc(100% - 22px) calc(1em + 4px), calc(100% - 17px) calc(1em + 4px);
      background-size: 5px 5px, 5px 5px;
      background-repeat:no-repeat;
      padding-right:46px;
    }

    /* Hero */
    .hero{
      margin-top:16px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 900px){ .hero{grid-template-columns:1fr} .brand{min-width:unset} }

    .heroCard{
      position:relative;
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow);
      overflow:hidden;
      min-height:280px;
    }
    .heroCard .bg{
      position:absolute; inset:-40px;
      background:
        radial-gradient(460px 260px at 14% 30%, rgba(209,31,42,.18), transparent 62%),
        radial-gradient(420px 260px at 78% 14%, rgba(255,77,87,.14), transparent 60%),
        radial-gradient(520px 320px at 60% 100%, rgba(30,40,70,.10), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.88));
      filter:saturate(1.05);
    }
    .heroCard .content{position:relative;padding:22px}
    .kicker{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,.8);
      border:1px solid var(--line);
      box-shadow: var(--shadow2);
      font-weight:900;font-size:12px;
    }
    .dot{width:8px;height:8px;border-radius:50%;background:var(--accent); box-shadow: 0 0 0 6px rgba(209,31,42,.10)}
    h1{margin:14px 0 8px;font-size:34px;letter-spacing:-.03em}
    .sub{margin:0;color:var(--muted);max-width:58ch;line-height:1.55}
    .heroBtns{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
    .btn{
      border:none; cursor:pointer;
      padding:12px 14px;border-radius:16px;
      background: rgba(255,255,255,.88);
      border:1px solid var(--line);
      box-shadow: var(--shadow2);
      font-weight:950;
      transition:.18s transform,.18s box-shadow;
    }
    .btn:hover{transform:translateY(-1px); box-shadow: var(--shadow)}
    .btn.accent{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff; border-color:transparent;
      box-shadow: 0 16px 34px rgba(209,31,42,.22);
    }

    /* Panels */
    .side{display:grid;gap:14px}
    .panel{
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background: var(--card);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .pHead{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      background: rgba(255,255,255,.55);
    }
    .pHead b{font-size:13px}
    .pBody{padding:14px 16px}
    .tiny{font-size:12px;line-height:1.55}
    .muted{color:var(--muted)}
    .row{display:flex;justify-content:space-between;gap:12px;align-items:center;margin:8px 0}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,.85);
      border:1px solid var(--line);
      font-weight:950;font-size:12px;
    }
    .chip.ok{color:var(--ok)}
    .chip.bad{color:var(--bad)}
    .divider{height:1px;background:var(--line);margin:12px 0}

    /* Tools */
    .tools{
      margin-top:14px;
      display:grid;
      grid-template-columns: 1.3fr .7fr .7fr;
      gap:12px;
    }
    @media (max-width: 900px){ .tools{grid-template-columns:1fr} }

    /* Tabs */
    .tabs{display:flex;gap:8px;flex-wrap:wrap}
    .tabBtn{
      border:1px solid var(--line); background: rgba(255,255,255,.85);
      border-radius:999px; padding:10px 12px;
      cursor:pointer;font-weight:950;font-size:13px;
      box-shadow: var(--shadow2);
      transition:.18s transform;
    }
    .tabBtn:hover{transform:translateY(-1px)}
    .tabBtn.active{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;border-color:transparent;
      box-shadow: 0 14px 26px rgba(209,31,42,.18);
    }

    /* Sections */
    .sectionHead{display:flex;align-items:flex-end;justify-content:space-between;gap:10px;margin:22px 0 10px}
    .sectionHead h2{margin:0;font-size:18px;letter-spacing:-.02em}

    /* Grid cards */
    .grid{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){ .grid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 520px){ .grid{grid-template-columns: 1fr;} }

    .card{
      border-radius: var(--radius2);
      border:1px solid var(--line);
      background: rgba(255,255,255,.84);
      box-shadow: var(--shadow2);
      overflow:hidden;
      transition:.18s transform,.18s box-shadow;
      transform: translateY(0);
    }
    .card:hover{transform: translateY(-2px); box-shadow: var(--shadow)}
    .thumb{
      height:140px;
      background:
        radial-gradient(140px 90px at 22% 45%, rgba(209,31,42,.18), transparent 62%),
        radial-gradient(160px 100px at 72% 10%, rgba(255,77,87,.12), transparent 62%),
        radial-gradient(160px 120px at 70% 92%, rgba(30,40,70,.10), transparent 62%),
        linear-gradient(180deg, #ffffff, #f4f5fb);
      border-bottom:1px solid var(--line);
      position:relative;
    }
    .sticker{
      position:absolute; top:12px; left:12px;
      padding:8px 10px;border-radius:999px;
      background: rgba(255,255,255,.9);
      border:1px solid var(--line);
      font-weight:950;font-size:12px;
      box-shadow: var(--shadow2);
    }
    .cBody{padding:12px 12px 14px}
    .price{font-weight:950}
    .tag{display:inline-flex;align-items:center;gap:6px;margin-top:8px;font-size:12px;color:var(--muted)}
    .buyRow{display:flex;gap:10px;align-items:center;margin-top:12px}
    .miniBtn{
      flex:1;
      border:none; cursor:pointer;
      padding:11px 12px;border-radius:16px;
      background: rgba(255,255,255,.92);
      border:1px solid var(--line);
      font-weight:950;
      transition:.18s transform,.18s box-shadow;
    }
    .miniBtn:hover{transform:translateY(-1px); box-shadow: var(--shadow2)}
    .miniBtn.accent{
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;border-color:transparent;
      box-shadow: 0 14px 26px rgba(209,31,42,.18);
    }

    /* Reviews */
    .infoGrid{
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){ .infoGrid{grid-template-columns:1fr} }
    .reviewCard{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow2);
      padding:14px;
      display:grid;
      gap:8px;
    }
    .stars{font-weight:950; letter-spacing:.08em}
    .who{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:12px}
    .quote{line-height:1.55}
    .pill2{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;
      font-weight:950;font-size:12px;
    }
    .pill2.ok{color:var(--ok)}
    .pill2.bad{color:var(--bad)}

    /* Proofs */
    .gallery{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
    }
    @media (max-width:980px){ .gallery{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width:520px){ .gallery{grid-template-columns: 1fr;} }
    .proof{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow2);
      overflow:hidden;
      min-height:120px;
      display:grid;
      grid-template-rows: 1fr auto;
    }
    .proof .img{
      background:
        radial-gradient(150px 100px at 20% 40%, rgba(209,31,42,.18), transparent 62%),
        radial-gradient(180px 120px at 80% 20%, rgba(255,77,87,.12), transparent 62%),
        linear-gradient(180deg, #ffffff, #f4f5fb);
      display:grid; place-items:center;
      color:rgba(0,0,0,.45); font-weight:950;
    }
    .proof .cap{
      padding:10px 12px;
      font-size:12px;
      color:var(--muted);
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.8);
    }

    /* FAQ */
    details{
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(255,255,255,.86);
      box-shadow: var(--shadow2);
      padding:12px 12px;
      margin:10px 0;
      overflow:hidden;
    }
    summary{
      list-style:none;
      cursor:pointer;
      font-weight:950;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    summary::-webkit-details-marker{display:none}
    .chev{opacity:.6; transition:.15s transform}
    details[open] .chev{transform:rotate(180deg)}
    .ans{margin-top:10px;color:var(--muted);line-height:1.6;font-size:13px}

    /* Footer */
    .footer{
      margin-top:22px;
      border-top:1px solid var(--line);
      padding:18px 0 0;
    }
    .footGrid{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width: 900px){ .footGrid{grid-template-columns:1fr} }
    .footBox{
      border:1px solid var(--line);
      border-radius: var(--radius2);
      background: rgba(255,255,255,.82);
      box-shadow: var(--shadow2);
      padding:14px;
    }
    .footBox b{display:block;margin-bottom:6px}
    .footLinks{display:grid;gap:8px;margin-top:10px}
    .linkBtn{
      border:1px solid var(--line);
      background:#fff;
      border-radius:16px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:950;
      text-align:left;
      box-shadow: var(--shadow2);
      transition:.18s transform;
    }
    .linkBtn:hover{transform:translateY(-1px)}

    /* Drawer */
    .overlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.30);
      backdrop-filter: blur(8px);
      display:none; z-index:90;
    }
    .overlay.open{display:block}
    .drawer{
      position:fixed; right:0; top:0; bottom:0;
      width:min(520px, 94vw);
      background: rgba(255,255,255,.92);
      border-left:1px solid var(--line);
      box-shadow: -22px 0 80px rgba(0,0,0,.20);
      transform: translateX(105%);
      transition: .25s transform;
      z-index:99;
      display:flex; flex-direction:column;
    }
    .drawer.open{transform: translateX(0)}
    .dHead{
      padding:14px 14px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      background: rgba(255,255,255,.92);
    }
    .x{
      width:44px;height:44px;border-radius:16px;
      background:#fff;border:1px solid var(--line);
      cursor:pointer;font-weight:950;
    }
    .dBody{padding:12px 14px; overflow:auto}
    .item{
      display:flex; gap:12px; align-items:flex-start;
      padding:12px; border-radius:22px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow: var(--shadow2);
      margin-bottom:10px;
    }
    .iThumb{width:68px;height:56px;border-radius:18px;background:linear-gradient(135deg,#f5f6fc,#fff);border:1px solid var(--line); display:grid;place-items:center; font-weight:950; color:rgba(0,0,0,.35)}
    .iMain{flex:1}
    .iMain b{display:block;font-size:13px}
    .qtyRow{display:flex;align-items:center;gap:8px;margin-top:8px}
    .qbtn{
      width:34px;height:34px;border-radius:12px;
      border:1px solid var(--line); background:#fff;
      cursor:pointer;font-weight:950;
    }
    .qval{min-width:28px;text-align:center;font-weight:950}
    .rm{background:transparent;border:none;color:var(--bad);font-weight:950;cursor:pointer}

    .box{
      margin-top:12px;
      border:1px solid var(--line);
      background:#fff;
      border-radius:22px;
      padding:12px;
      box-shadow: var(--shadow2);
    }
    .sumRow{display:flex;justify-content:space-between;gap:12px;margin:6px 0}
    .field{display:grid;gap:6px;margin-top:10px}
    .field label{font-size:12px;color:var(--muted);font-weight:800}
    .field input, .field textarea, .field select{
      padding:12px 12px;border-radius:16px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.95);
      outline:none;
    }
    .field input:focus, .field textarea:focus, .field select:focus{box-shadow: 0 0 0 6px rgba(209,31,42,.08); border-color: rgba(209,31,42,.25)}

    .couponBox{
      border:1px dashed rgba(209,31,42,.45);
      background: rgba(209,31,42,.05);
      padding:12px;border-radius:18px;margin-top:10px;
    }
    .couponCode{
      display:flex;gap:10px;align-items:center;justify-content:space-between;
      background:#fff;border:1px solid var(--line);
      border-radius:16px;padding:10px 12px;margin-top:8px;
    }
    .couponCode code{font-family:var(--mono);font-weight:950}
    .copyBtn{
      border:1px solid var(--line); background:#fff;
      border-radius:14px; padding:10px 12px;
      cursor:pointer;font-weight:950;
    }
    .vipRow{
      display:flex;gap:10px;align-items:flex-start;
      padding:12px;border-radius:18px;
      border:1px dashed rgba(209,31,42,.45);
      background: rgba(209,31,42,.05);
      margin-top:10px;
    }
    .vipRow input{margin-top:3px}

    .actions{
      display:grid; gap:10px;
      padding:12px 14px;
      border-top:1px solid var(--line);
      background: rgba(255,255,255,.92);
    }
    .bigBtn{
      border:none; cursor:pointer;
      padding:14px 14px;border-radius:18px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;font-weight:950;
      box-shadow: 0 16px 34px rgba(209,31,42,.20);
      transition:.18s transform;
    }
    .bigBtn:hover{transform:translateY(-1px)}
    .bigBtn.secondary{
      background:#fff;color:var(--text);
      border:1px solid var(--line);
      box-shadow: var(--shadow2);
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:#fff;border:1px solid var(--line);
      box-shadow: var(--shadow);
      padding:12px 14px;border-radius:999px;
      display:none; z-index:120;
      font-weight:950;
    }
    .toast.show{display:block; animation: pop .18s ease-out}
    @keyframes pop{from{transform:translateX(-50%) translateY(6px); opacity:.2} to{transform:translateX(-50%) translateY(0); opacity:1}}

    /* Support */
    .float{
      position:fixed; right:16px; bottom:16px; z-index:60;
      width:58px;height:58px;border-radius:20px;
      border:1px solid var(--line);
      background:#fff;
      box-shadow: var(--shadow);
      display:grid;place-items:center;
      cursor:pointer;
      transition:.18s transform;
    }
    .float:hover{transform:translateY(-2px)}
    .float:after{content:"ğŸ’¬"; font-size:22px}
    .support{
      position:fixed; inset:auto 16px 86px auto;
      width:min(380px, 92vw);
      background: rgba(255,255,255,.95);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      border-radius:24px;
      overflow:hidden;
      z-index:80;
      display:none;
    }
    .support.open{display:block; animation: pop2 .18s ease-out}
    @keyframes pop2{from{transform:translateY(10px); opacity:.2} to{transform:translateY(0); opacity:1}}
    .sHead{
      padding:12px 12px;
      border-bottom:1px solid var(--line);
      display:flex;align-items:center;justify-content:space-between;
      background: rgba(255,255,255,.92);
      gap:8px;
    }
    .sClose{
      width:40px;height:40px;border-radius:14px;
      border:1px solid var(--line); background:#fff; cursor:pointer; font-weight:950;
    }
    .sBody{padding:12px;height:260px;overflow:auto;background: rgba(255,255,255,.86)}
    .msg{
      max-width:86%;
      padding:10px 12px;border-radius:18px;
      margin:8px 0;border:1px solid var(--line);
      background:#fff; box-shadow: var(--shadow2);
      font-size:13px;
    }
    .msg.me{margin-left:auto; background: rgba(209,31,42,.06); border-color: rgba(209,31,42,.18)}
    .sFoot{display:flex;gap:10px;padding:10px;border-top:1px solid var(--line); background:#fff}
    .sFoot input{flex:1;padding:12px 12px;border-radius:16px;border:1px solid var(--line);outline:none}
    .sendBtn{
      border:none; cursor:pointer;
      width:50px;border-radius:16px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color:#fff;font-weight:950;
    }

    /* Modals */
    .modalWrap{position:fixed; inset:0; display:none; z-index:140; background: rgba(0,0,0,.35); backdrop-filter: blur(10px);}
    .modalWrap.open{display:block}
    .modal{
      width:min(920px, 94vw);
      max-height: min(86vh, 760px);
      overflow:auto;
      margin: 6vh auto 0;
      background: rgba(255,255,255,.95);
      border:1px solid var(--line);
      border-radius: 26px;
      box-shadow: var(--shadow);
    }
    .mHead{padding:14px 14px; border-bottom:1px solid var(--line); display:flex;justify-content:space-between;align-items:center;gap:10px}
    .mBody{padding:14px}
    .table{width:100%; border-collapse:separate; border-spacing:0 10px}
    .table th{font-size:12px;color:var(--muted);text-align:left}
    .table td{background:#fff;border:1px solid var(--line); padding:10px 10px; border-left:none; border-right:none}
    .table tr td:first-child{border-left:1px solid var(--line); border-top-left-radius:14px; border-bottom-left-radius:14px}
    .table tr td:last-child{border-right:1px solid var(--line); border-top-right-radius:14px; border-bottom-right-radius:14px}
    .mActions{display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end;padding:12px 14px;border-top:1px solid var(--line);background: rgba(255,255,255,.92)}
    .danger{color:#fff;background:linear-gradient(135deg,#1b1d2a,#111); border:none}
    .small{font-size:12px;color:var(--muted)}

    /* Animations */
    .fade{opacity:0; transform:translateY(10px); transition:.55s opacity,.55s transform}
    .fade.show{opacity:1; transform:translateY(0)}
    .skeleton{
      height:140px; border-radius: var(--radius2);
      border:1px solid var(--line);
      background: linear-gradient(90deg, rgba(0,0,0,.03), rgba(0,0,0,.06), rgba(0,0,0,.03));
      background-size: 200% 100%;
      animation: shimmer 1.1s linear infinite;
      box-shadow: var(--shadow2);
    }
    @keyframes shimmer{
      0%{background-position: 200% 0}
      100%{background-position: -200% 0}
    }
  
    /* Checkout em 3 passos */
    .stepper{display:flex;gap:10px;align-items:center;justify-content:space-between;margin-bottom:12px}
    .steps{display:flex;gap:8px;flex-wrap:wrap}
    .stepPill{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.72);border:1px solid var(--line);box-shadow: var(--shadow2);
      font-weight:950;font-size:12px;color:var(--muted)}
    [data-theme="dark"] .stepPill{background: rgba(18,22,35,.62)}
    .stepPill.active{color:#fff;border-color:transparent;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 16px 34px rgba(209,31,42,.22)}
    .stepWrap{display:none}
    .stepWrap.active{display:block;animation: fadeInUp .25s ease}
    .stepHint{font-size:12px;color:var(--muted);margin-top:6px}
    @keyframes fadeInUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}

  
    /* Produto: modal pÃ¡gina */
    .modalBack{position:fixed; inset:0; background: rgba(10,12,18,.55); display:none; align-items:center; justify-content:center; z-index:120; padding:16px}
    .modalBack.show{display:flex}
    .modal{width:min(980px, 100%); max-height: min(86vh, 860px); overflow:auto; border-radius: var(--radius2); border:1px solid var(--line);
      background: var(--card); box-shadow: var(--shadow); backdrop-filter: blur(12px)}
    .modalHead{position:sticky; top:0; z-index:2; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 16px; border-bottom:1px solid var(--line);
      background: rgba(255,255,255,.55)}
    [data-theme="dark"] .modalHead{background: rgba(18,22,35,.35)}
    .modalGrid{display:grid; grid-template-columns: 1.05fr .95fr; gap:14px; padding:14px 16px}
    @media (max-width: 920px){ .modalGrid{grid-template-columns:1fr} }
    .mediaBox{border:1px solid var(--line); border-radius: var(--radius2); overflow:hidden; background: rgba(255,255,255,.6); box-shadow: var(--shadow2)}
    [data-theme="dark"] .mediaBox{background: rgba(18,22,35,.55)}
    .mediaBox .ph{height:320px; display:grid; place-items:center; color:var(--muted)}
    .mediaBox img{width:100%; height:auto; display:block}
    .mediaBox video{width:100%; display:block}
    .prodTitle{margin:0; font-size:18px; letter-spacing:-.02em}
    .prodMeta{display:flex; gap:8px; flex-wrap:wrap; margin-top:8px}
    .metaPill{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid var(--line);
      background: rgba(255,255,255,.75); box-shadow: var(--shadow2); font-size:12px; font-weight:950; color:var(--muted)}
    [data-theme="dark"] .metaPill{background: rgba(18,22,35,.60)}
    .prodDesc{margin-top:10px; color:var(--muted); line-height:1.6}
    .prodActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .reviewBox{border:1px solid var(--line); border-radius: var(--radius2); background: rgba(255,255,255,.65); box-shadow: var(--shadow2); padding:12px}
    [data-theme="dark"] .reviewBox{background: rgba(18,22,35,.55)}
    .revItem{padding:10px 0; border-top:1px solid var(--line)}
    .revItem:first-child{border-top:none}

  
    .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    @media (max-width:820px){.grid2{grid-template-columns:1fr}}
  
    /* Rastreamento: timeline */
    .timeline{display:grid; gap:10px}
    .tItem{display:grid; grid-template-columns:18px 1fr; gap:10px; align-items:flex-start}
    .tDot{width:14px; height:14px; border-radius:999px; margin-top:3px; border:2px solid var(--line); background: rgba(255,255,255,.9)}
    [data-theme="dark"] .tDot{background: rgba(18,22,35,.75)}
    .tDot.ok{border-color: rgba(19,210,133,.7); box-shadow: 0 0 0 4px rgba(19,210,133,.12)}
    .tDot.wait{border-color: rgba(209,31,42,.35)}
    .tText b{display:block; font-size:13px}
    .tText .tiny{margin-top:2px}

  
    /* Admin panel list */
    .ad_list{display:grid; gap:10px}
    .ad_item{border:1px solid var(--line); border-radius: var(--radius2); background: rgba(255,255,255,.72);
      box-shadow: var(--shadow2); padding:12px}
    [data-theme="dark"] .ad_item{background: rgba(18,22,35,.55)}
    .ad_top{display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .ad_actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .mono2{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size:12px}

  
    .trustBar{margin:18px auto 0; max-width:1100px; padding:0 16px}
    .trustInner{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;padding:12px;border:1px solid var(--line);border-radius:var(--radius2);background:rgba(255,255,255,.72);box-shadow:var(--shadow2)}
    [data-theme="dark"] .trustInner{background:rgba(18,22,35,.55)}

  
    .faqList{display:grid;gap:10px}
    details.faq{border:1px solid var(--line); border-radius: var(--radius2); background: rgba(255,255,255,.72); box-shadow: var(--shadow2); padding:10px}
    [data-theme="dark"] details.faq{background: rgba(18,22,35,.55)}
    details.faq summary{cursor:pointer; font-weight:700; list-style:none}
    details.faq summary::-webkit-details-marker{display:none}
    .faqBody{margin-top:8px}

  
    .stars{display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .star{width:18px;height:18px;display:inline-block}
    .rvList{display:grid;gap:10px}
    .rvItem{border:1px solid var(--line);border-radius:var(--radius2);background:rgba(255,255,255,.72);box-shadow:var(--shadow2);padding:12px}
    [data-theme="dark"] .rvItem{background:rgba(18,22,35,.55)}

  
    .ol{margin:0; padding-left:18px; display:grid; gap:8px}
  
    .chips{display:flex;gap:10px;flex-wrap:wrap}
    .chipBtn{border:1px solid var(--line); background:rgba(255,255,255,.72); padding:8px 10px; border-radius:999px; cursor:pointer; font-weight:700; font-size:12px}
    [data-theme="dark"] .chipBtn{background:rgba(18,22,35,.55)}
    .chipBtn.active{box-shadow: var(--shadow2); transform: translateY(-1px)}
    .gridCards{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px}
    @media (max-width:980px){.gridCards{grid-template-columns: repeat(2, 1fr);}}
    @media (max-width:560px){.gridCards{grid-template-columns: 1fr;}}
    .card{border:1px solid var(--line); border-radius: var(--radius2); background:rgba(255,255,255,.72); box-shadow: var(--shadow2); padding:12px; display:flex; flex-direction:column; gap:10px}
    [data-theme="dark"] .card{background:rgba(18,22,35,.55)}
    .cardTop{display:flex; gap:10px; align-items:flex-start}
    .cardImg{width:54px; height:54px; border-radius:14px; border:1px solid var(--line); background:linear-gradient(135deg, rgba(0,0,0,.06), rgba(0,0,0,.02)); display:flex; align-items:center; justify-content:center; font-weight:900}
    .cardName{font-weight:900}
    .cardDesc{font-size:12px; color:var(--muted)}

  
    @keyframes pulseAnim{0%{transform:scale(1)}50%{transform:scale(1.06)}100%{transform:scale(1)}}
    .pulse{animation:pulseAnim 1.1s ease-in-out infinite}

  
    .maintBanner{margin:14px auto 0; max-width:1100px; padding:0 16px}
    .maintInner{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:var(--radius2);background:rgba(255,210,64,.16);padding:12px;box-shadow:var(--shadow2)}
    .maintInner .muted{color:var(--muted);font-size:12px}

  
    .barWrap{display:grid;gap:8px}
    .barRow{display:grid;grid-template-columns:72px 1fr 44px;gap:10px;align-items:center}
    .bar{height:12px;border-radius:999px;border:1px solid var(--line);background:rgba(0,0,0,.03);overflow:hidden}
    [data-theme="dark"] .bar{background:rgba(255,255,255,.06)}
    .bar > i{display:block;height:100%;width:0%;background:currentColor;opacity:.8}

  
    .bundleItem{border:1px solid var(--line);border-radius:var(--radius2);background:rgba(255,255,255,.72);box-shadow:var(--shadow2);padding:12px}
    [data-theme="dark"] .bundleItem{background:rgba(18,22,35,.55)}

  </style>

<style>
  /* FIX: quando um overlay invisÃ­vel trava os cliques */
  .vv-kill-overlay { pointer-events: none !important; }
</style>
<script>
  // FIX: desarma camadas invisÃ­veis que cobrem a tela e travam cliques
  (function () {
    function killOverlays() {
      const vw = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
      const vh = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

      const els = document.body ? document.body.querySelectorAll("*") : [];
      for (const el of els) {
        const st = getComputedStyle(el);
        if (st.pointerEvents === "none") continue;

        const pos = st.position;
        if (pos !== "fixed" && pos !== "absolute") continue;

        const z = parseInt(st.zIndex || "0", 10);
        if (!Number.isFinite(z) || z < 10) continue;

        const r = el.getBoundingClientRect();
        const covers = r.width >= vw * 0.95 && r.height >= vh * 0.95;
        if (!covers) continue;

        const invisible =
          st.opacity === "0" ||
          st.visibility === "hidden" ||
          (st.backgroundColor === "rgba(0, 0, 0, 0)" && st.color === "rgba(0, 0, 0, 0)");

        // Se tÃ¡ cobrindo a tela e parece invisÃ­vel -> mata o clique dela
        if (invisible) el.classList.add("vv-kill-overlay");
      }
    }

    window.addEventListener("load", () => {
      killOverlays();
      setTimeout(killOverlays, 300);
      setTimeout(killOverlays, 900);
      setTimeout(killOverlays, 2000);
    });
  })();
</script>

</head>

<body>
  <!-- Aviso anti-fake -->
  <div class="topNotice" role="note" aria-label="Aviso anti-fake">
    <div class="topNoticeInner">
      <div class="noticeLeft">
        <b>ğŸ›¡ï¸ Anti-fake:</b> nosso WhatsApp oficial Ã© <span class="mono">+55 11 94159-8713</span>
      </div>
      <button class="noticeBtn" onclick="copyText('+55 11 94159-8713')">Copiar</button>
    </div>
  </div>

  <header class="topbar">
    <div class="inner">
      <div class="brand" onclick="scrollToTop()">
        <div class="logo"></div>
        <div>
          <b>ViralVault Store</b>
          <span>Ultimate Premium â€¢ PIX â€¢ VV-OFICIAL</span>
        </div>
      </div>

      <nav class="nav" aria-label="Atalhos">
        <div class="pill" onclick="scrollToEl('#sec-verify')">ğŸ” Verificar pedido</div>
        <div class="pill" onclick="scrollToEl('#sec-reviews')">â­ ReputaÃ§Ã£o</div>
        <div class="pill" onclick="scrollToEl('#sec-proofs')">ğŸ§¾ Provas</div>
        <div class="pill" onclick="scrollToEl('#sec-faq')">â“ FAQ</div>
        <div class="pill" onclick="toggleSupport(true)">ğŸ’¬ Suporte</div>
        <div class="pill primary" onclick="openCart()">ğŸ›’ Carrinho <span class="badge" id="cartCount">0</span></div>
      </nav>
    </div>
  </header>

<div id="maintBanner" class="maintBanner" style="display:none">
  <div class="maintInner">
    <b>ğŸ› ï¸ ManutenÃ§Ã£o ativa</b>
    <span class="muted">Compras pausadas temporariamente. VocÃª ainda pode navegar e falar com suporte.</span>
    <span class="chip" id="maintBadge">OFF</span>
  </div>
</div>


  <main class="wrap">
    <section class="hero">
      <div class="heroCard fade">
        <div class="bg" aria-hidden="true"></div>
        <div class="content">
          <div class="kicker"><span class="dot"></span> Pedido assinado no servidor: <b>VV-OFICIAL</b></div>
          <h1>Loja <span style="color:var(--accent)">Premium</span>, clara e com confianÃ§a.</h1>
          <p class="sub">
            Checkout PIX com verificaÃ§Ã£o no servidor (HMAC SHA-256).
            Cupom de boas-vindas, suporte no site e prova social.
          </p>
          <div class="heroBtns">
            <button class="btn accent" onclick="scrollToEl('#sec-shop')">Ver vitrine</button>
            <button class="btn" onclick="openCart()">Abrir checkout</button>
            <button class="btn" onclick="toggleSupport(true)">Falar no chat</button>
          </div>
        </div>
      </div>

      <aside class="side">
        <div class="panel fade">
          <div class="pHead">
            <b>ConfianÃ§a</b>
            <span class="chip ok" id="sysPill">â— Online</span>
          </div>
          <div class="pBody tiny">
            <div class="row"><span class="muted">Worker VV-OFICIAL</span> <span class="chip" id="workerPill">Checandoâ€¦</span></div>
            <div class="row"><span class="muted">Pagamento</span> <span class="chip">PIX via WhatsApp</span></div>
            <div class="row"><span class="muted">WhatsApp oficial</span> <span class="chip mono">5511941598713</span></div>
            <div class="divider"></div>
            <div class="muted">
              Dica: finalize sÃ³ com <b>Order ID</b> + <b>assinatura VV-OFICIAL</b> âœ…
            </div>
          </div>
        </div>

        
        <div class="panel fade" id="panelProof">
          <div class="pHead">
            <b>âš¡ Atividade do site (ao vivo)</b>
            <span class="chip ok" id="liveDot">â— Online</span>
          </div>
          <div class="pBody">
            <div class="row"><span class="muted">ğŸ‘€ Pessoas vendo agora</span><b id="ps_viewing">â€”</b></div>
            <div class="row"><span class="muted">ğŸ›’ Carrinhos hoje</span><b id="ps_carts">â€”</b></div>
            <div class="row"><span class="muted">âœ… Pedidos gerados hoje</span><b id="ps_orders">â€”</b></div>
            <div class="divider"></div>
            <div class="tiny muted" id="ps_feed">Carregando atividadeâ€¦</div>
          </div>
        </div>
<div class="panel fade" id="sec-coupons">
          <div class="pHead">
            <b>Boas-vindas</b>
            <span class="chip">Uso Ãºnico</span>
          </div>
          <div class="pBody tiny">
            <div class="couponBox">
              <b>ğŸ 10% OFF</b>
              <div class="muted">Cupom visÃ­vel no checkout. Uso Ãºnico por cliente (neste aparelho).</div>
              <div class="couponCode">
                <code id="couponVisible">BEMVINDO10</code>
                <button class="copyBtn" onclick="copyText('BEMVINDO10')">Copiar</button>
              </div>
              <div class="muted tiny" id="couponStatus" style="margin-top:8px"></div>
            </div>
          </div>
        </div>
      </aside>
    </section>

    <section id="sec-verify" class="fade" style="margin-top:18px">
      <div class="sectionHead">
        <h2>Verificar pedido</h2>
        <div class="muted tiny">Consulta simples (cliente digita o Order ID)</div>
      </div>
      <div class="panel">
        <div class="pBody">
          <div class="tools" style="grid-template-columns:1.2fr .8fr;">
            <input id="verifyOrder" class="input" placeholder="Cole aqui o Order ID (ex: vv_...)" />
            <button class="btn accent" onclick="checkOrderStatus()">Verificar</button>
          </div>
          <div class="divider"></div>
          <div class="row">
            <span class="muted">Status</span>
            <span class="chip" id="verifyStatus">Aguardandoâ€¦</span>
          </div>
          <div class="tiny muted" id="verifyDetail"></div>
        </div>
      </div>
    </section>

    <section class="tools">
      <input id="q" class="input fade" placeholder="Buscar produto (ex: pack, serviÃ§o, premiumâ€¦)" oninput="renderProducts()" />
      <select id="cat" class="input select fade" onchange="renderProducts()">
        <option value="">Todas as categorias</option>
        <option value="packs">Packs</option>
        <option value="servicos">ServiÃ§os</option>
        <option value="premium">Premium</option>
        <option value="extras">Extras</option>
      </select>
      <select id="sort" class="input select fade" onchange="renderProducts()">
        <option value="popular">Ordenar: Popular</option>
        <option value="priceAsc">PreÃ§o: menor â†’ maior</option>
        <option value="priceDesc">PreÃ§o: maior â†’ menor</option>
      </select>
    </section>

    <section id="sec-shop">
      <div class="sectionHead">
        <h2>Vitrine Premium</h2>
        <div class="muted tiny">Checkout PIX â€¢ VV-OFICIAL â€¢ suporte rÃ¡pido</div>
      </div>
      <div class="tabs" style="margin:6px 0 12px">
        <button class="tabBtn active" id="tabBest" onclick="setTab('best')">ğŸ”¥ Mais vendidos</button>
        <button class="tabBtn" id="tabNew" onclick="setTab('new')">âœ¨ Novidades</button>
        <button class="tabBtn" id="tabAll" onclick="setTab('all')">ğŸ“¦ Tudo</button>
      
      <button class="tab" id="tabVerify" onclick="setPage('verify')">âœ… Verificar pedido</button>

      <button class="tab" id="tabTrack" onclick="setPage('track')">ğŸ“¦ Rastrear pedido</button>

      <button class="tab" id="tabAdmin" onclick="setPage('admin')">ğŸ§° Painel Admin <span id="ad_badge" class="chip" style="margin-left:8px;display:none">NOVO</span></button>

      <button class="tab" id="tabInfo" onclick="setPage('info')">â„¹ï¸ Sobre</button>
      <button class="tab" id="tabPolicies" onclick="setPage('policies')">ğŸ“œ PolÃ­ticas</button>

      <button class="tab" id="tabFAQ" onclick="setPage('faq')">â“ FAQ</button>

      <button class="tab" id="tabReviews" onclick="setPage('reviews')">â­ AvaliaÃ§Ãµes</button>

      <button class="tab" id="tabGuarantee" onclick="setPage('guarantee')">ğŸ›¡ï¸ Garantias</button>

      <button class="tab" id="tabCatalog" onclick="setPage('catalog')">ğŸ—‚ï¸ CatÃ¡logo</button>

      <button class="tab" id="tabMyOrders" onclick="setPage('myorders')">ğŸ§¾ Meus pedidos</button>

      <button class="tab" id="tabDash" onclick="setPage('dash')">ğŸ“Š Dashboard</button>

      <button class="tab" id="tabVitrine" onclick="setPage('vitrine')">ğŸª„ Vitrine</button>

      <button class="tab" id="tabLoyalty" onclick="setPage('loyalty')">ğŸ–ï¸ Fidelidade</button>

      <button class="tab" id="tabFav" onclick="setPage('fav')">â¤ï¸ Favoritos</button>

      <button class="tab" id="tabTrust" onclick="setPage('trust')">ğŸ§¾ TransparÃªncia</button>

      <button class="tab" id="tabStatus" onclick="setPage('status')">ğŸŸ¢ Status</button>

      <button class="tab" id="tabPay" onclick="setPage('pay')">ğŸ’³ Pagamento</button>

      <button class="tab" id="tabG24" onclick="setPage('g24')">ğŸ›¡ï¸ Garantia 24h</button>
</div>

      <div id="gridSkeleton" class="grid" aria-hidden="true" style="margin-bottom:12px"></div>
      <div class="grid" id="grid"></div>
    </section>

    <section id="sec-reviews" class="fade" style="margin-top:22px">
      <div class="sectionHead">
        <h2>ReputaÃ§Ã£o & AvaliaÃ§Ãµes</h2>
        <div class="muted tiny">Clientes podem deixar avaliaÃ§Ã£o (verificada com Order ID)</div>
      </div>

      <div class="panel">
        <div class="pBody">
          <div class="tools" style="grid-template-columns:1fr .6fr .6fr; margin-top:0">
            <input id="revName" class="input" placeholder="Seu nome (ex: @cliente)" />
            <select id="revStars" class="input select">
              <option value="5">â˜…â˜…â˜…â˜…â˜… (5)</option>
              <option value="4">â˜…â˜…â˜…â˜…â˜† (4)</option>
              <option value="3">â˜…â˜…â˜…â˜†â˜† (3)</option>
              <option value="2">â˜…â˜…â˜†â˜†â˜† (2)</option>
              <option value="1">â˜…â˜†â˜†â˜†â˜† (1)</option>
            </select>
            <input id="revOrder" class="input" placeholder="Order ID (opcional p/ verificado)" />
          </div>
          <div class="field">
            <label>Sua avaliaÃ§Ã£o</label>
            <textarea id="revText" rows="3" placeholder="Escreva sua experiÃªnciaâ€¦"></textarea>
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
            <button class="btn accent" onclick="submitReview()">Publicar avaliaÃ§Ã£o</button>
            <button class="btn" onclick="toast('Dica: avaliaÃ§Ãµes com Order ID aparecem como â€œverificadasâ€.')">Como verificar?</button>
          </div>
          <div class="divider"></div>
          <div class="infoGrid" id="reviewsGrid"></div>
        </div>
      </div>
    </section>

    <section id="sec-proofs" class="fade" style="margin-top:22px">
      <div class="sectionHead">
        <h2>Provas de entrega</h2>
        <div class="muted tiny">Troque os blocos por prints reais quando tiver</div>
      </div>
      <div class="gallery">
        <div class="proof"><div class="img">PRINT</div><div class="cap">âœ… Entrega confirmada â€¢ (adicione seu print)</div></div>
        <div class="proof"><div class="img">PRINT</div><div class="cap">âœ… Cliente satisfeito â€¢ (adicione seu print)</div></div>
        <div class="proof"><div class="img">PRINT</div><div class="cap">âœ… Pedido VV-OFICIAL â€¢ (adicione seu print)</div></div>
        <div class="proof"><div class="img">PRINT</div><div class="cap">âœ… Pagamento confirmado â€¢ (adicione seu print)</div></div>
      </div>
      <div class="tiny muted" style="margin-top:10px">
        Dica: suba imagens no GitHub e substitua por <span class="mono">&lt;img src="..." style="width:100%;height:100%;object-fit:cover"&gt;</span>.
      </div>
    </section>

    <section id="sec-faq" class="fade" style="margin-top:22px">
      <div class="sectionHead">
        <h2>FAQ (Perguntas frequentes)</h2>
        <div class="muted tiny">Reduz dÃºvidas e abandono</div>
      </div>

      <details>
        <summary>Como sei que o pedido Ã© real? <span class="chev">â–¾</span></summary>
        <div class="ans">
          ApÃ³s clicar em <b>â€œGerar pedido VV-OFICIALâ€</b>, o servidor cria um <b>Order ID</b> e uma
          <b>assinatura VV-OFICIAL</b>. Sem isso, <b>nÃ£o finalize</b> o pagamento.
        </div>
      </details>

      <details>
        <summary>Como funciona o pagamento no PIX? <span class="chev">â–¾</span></summary>
        <div class="ans">
          O checkout abre o WhatsApp com a mensagem do pedido (itens + total + assinatura).
          VocÃª faz o PIX e envia o comprovante no atendimento.
        </div>
      </details>

      <details>
        <summary>O cupom BEMVINDO10 vale como? <span class="chev">â–¾</span></summary>
        <div class="ans">
          Ele dÃ¡ <b>10% OFF</b> e Ã© <b>uso Ãºnico por cliente</b> (por aparelho).
          JÃ¡ aparece no checkout para facilitar.
        </div>
      </details>

      <details>
        <summary>Tem status do pedido? <span class="chev">â–¾</span></summary>
        <div class="ans">
          Sim â€” use a seÃ§Ã£o <b>â€œVerificar pedidoâ€</b> e cole o <b>Order ID</b>. O status comeÃ§a como â€œGeradoâ€ e pode ser atualizado no painel admin.
        </div>
      </details>
    </section>

    <section id="sec-about" class="fade" style="margin-top:22px">
      <div class="sectionHead">
        <h2>Sobre a ViralVault</h2>
        <div class="muted tiny">TransparÃªncia e profissionalismo</div>
      </div>
      <div class="panel">
        <div class="pBody tiny">
          <b>O que Ã©?</b><br>
          A <b>ViralVault Store</b> Ã© uma loja digital focada em curadoria de produtos e serviÃ§os com entrega rÃ¡pida e atendimento direto.
          <div class="divider"></div>
          <b>Como garantimos seguranÃ§a?</b><br>
          Pedidos sÃ£o gerados com <b>VV-OFICIAL</b> no servidor (assinatura HMAC SHA-256). Isso ajuda a reduzir fraudes, mas atenÃ§Ã£o:
          sempre confirme se o WhatsApp e os dados do pedido sÃ£o oficiais antes de pagar.
          <div class="divider"></div>
          <b>Contato oficial</b><br>
          WhatsApp: <span class="mono">+55 11 94159-8713</span>
        </div>
      </div>
    </section>

    <footer class="footer fade" id="sec-policies">
      <div class="sectionHead">
        <h2>PolÃ­ticas & TransparÃªncia</h2>
        <div class="muted tiny">ConfianÃ§a = mais conversÃ£o</div>
      </div>

      <div class="footGrid">
        <div class="footBox">
          <b>ğŸ›¡ï¸ SeguranÃ§a</b>
          <div class="tiny muted">
            Pedidos assinados no servidor (VV-OFICIAL). Nunca pague sem <b>Order ID</b> + assinatura.
          </div>
        </div>

        <div class="footBox">
          <b>ğŸ” Troca / Reembolso</b>
          <div class="tiny muted">
            Para itens digitais, verifique a descriÃ§Ã£o antes de comprar. Erro na entrega? O suporte resolve.
          </div>
        </div>

        <div class="footBox">
          <b>ğŸ”’ Privacidade</b>
          <div class="tiny muted">
            Usamos dados apenas para atendimento e entrega do pedido. NÃ£o vendemos informaÃ§Ãµes.
          </div>
        </div>
      </div>

      <div class="footLinks">
        <button class="linkBtn" onclick="toggleSupport(true)">ğŸ’¬ Precisa de ajuda? Abra o suporte</button>
        <button class="linkBtn" onclick="scrollToEl('#sec-shop')">ğŸ›ï¸ Voltar para a vitrine</button>
        <button class="linkBtn" onclick="openCart()">ğŸ›’ Ir para o checkout</button>
        <button class="linkBtn" onclick="openAdmin()">ğŸ” Admin (dono)</button>
      </div>

      <div class="tiny muted" style="margin-top:12px">
        Â© <span id="year"></span> ViralVault Store â€¢ Checkout PIX â€¢ VerificaÃ§Ã£o VV-OFICIAL
      </div>
    
  <div class="footer tiny muted" id="adminMini" style="opacity:.7">
    <span class="mono">Admin:</span>
    <a href="javascript:adminSetup()">Configurar</a> â€¢
    <a href="javascript:adminUnlock()">Desbloquear</a> â€¢
    <a href="javascript:adminLock()">Bloquear</a>
  </div>


<div class="trustBar">
  <div class="trustInner">
    <span class="chip ok">ğŸ”’ HTTPS</span>
    <span class="chip ok">âœ… VV-OFICIAL</span>
    <span class="chip">ğŸ“¦ Rastreio</span>
    <span class="chip">ğŸ« Tickets</span>
    <span class="chip">ğŸ›¡ï¸ Privacidade (LGPD)</span>
  </div>
</div>

</footer>
  
  <section class="page" id="pageVerify" style="display:none">
    <div class="box">
      <b>âœ… VerificaÃ§Ã£o pÃºblica de pedido</b>
      <div class="tiny muted">Cole o <b>Order ID</b> e a <b>assinatura</b> para confirmar se Ã© VV-OFICIAL no servidor.</div>
      <div class="divider"></div>

      <div class="grid2">
        <div>
          <div class="tiny muted">Order ID</div>
          <input class="input mono" id="vf_orderId" placeholder="ex: vv_..." />
        </div>
        <div>
          <div class="tiny muted">Assinatura (sig)</div>
          <input class="input mono" id="vf_sig" placeholder="cole aqui" />
        </div>
      </div>

      <div style="height:10px"></div>
      <div class="grid2">
        <div>
          <div class="tiny muted">Total (R$)</div>
          <input class="input mono" id="vf_total" placeholder="ex: 39.90" />
        </div>
        <div>
          <div class="tiny muted">UsuÃ¡rio</div>
          <input class="input" id="vf_user" placeholder="nome do cliente" />
        </div>
      </div>

      <div style="height:10px"></div>
      <div>
        <div class="tiny muted">itemsHash</div>
        <input class="input mono" id="vf_itemsHash" placeholder="cole aqui" />
        <div class="stepHint">Se o link vier do site, esses campos jÃ¡ preenchem automaticamente.</div>
      </div>

      <div class="divider"></div>

      <div class="prodActions">
        <button class="btn accent" onclick="verifyFromForm()">Verificar agora</button>
        <button class="btn" onclick="fillFromLastOrder()">Usar meu Ãºltimo pedido</button>
        <button class="btn" onclick="copyVerifyLink()">Copiar link de verificaÃ§Ã£o</button>
      </div>

      <div class="divider"></div>
      <div class="row">
        <span class="muted">Status</span>
        <span class="chip" id="vf_status">â€”</span>
      </div>
      <div class="tiny muted" id="vf_detail" style="margin-top:8px">Aguardando dadosâ€¦</div>
    </div>
  </section>
  <section class="page" id="pageTrust" style="display:none">
    <div class="box">
      <b>ğŸ§¾ TransparÃªncia & Antiâ€‘Golpe</b>
      <div class="tiny muted">Tudo que o cliente precisa ver para confiar (sem â€œpromessa vaziaâ€).</div>
      <div class="divider"></div>

      <div class="grid2">
        <div class="panel fade">
          <div class="pHead"><b>âœ… Canais oficiais</b><span class="chip ok">Oficial</span></div>
          <div class="pBody">
            <div class="tiny muted">Este site Ã© o canal oficial da loja. Para falar com a gente:</div>
            <div style="height:10px"></div>
            <div class="ad_list">
              <div class="ad_item">
                <div class="ad_top">
                  <div>
                    <b>WhatsApp (suporte)</b>
                    <div class="tiny muted" id="trust_whats_text">â€”</div>
                  </div>
                  <div><button class="btn accent" onclick="openWhatsSupport()">Abrir</button></div>
                </div>
              </div>
              <div class="ad_item">
                <div class="ad_top">
                  <div>
                    <b>VerificaÃ§Ã£o VVâ€‘OFICIAL</b>
                    <div class="tiny muted">Use a aba <b>Verificar</b> para confirmar se um pedido Ã© real.</div>
                  </div>
                  <div><button class="btn" onclick="setPage('verify')">Verificar</button></div>
                </div>
              </div>
            </div>
            <div class="divider"></div>
            <div class="tiny muted">Dica: desconfie de perfis/links que mudam o @, que pedem pressa ou que nÃ£o passam pelo verificador.</div>
          </div>
        </div>

        <div class="panel fade">
          <div class="pHead"><b>ğŸ”’ Como a verificaÃ§Ã£o funciona</b><span class="chip">TÃ©cnico</span></div>
          <div class="pBody">
            <div class="tiny muted">
              Cada pedido gerado aqui pode receber uma assinatura <b>VVâ€‘OFICIAL</b> (HMAC SHAâ€‘256) no servidor.
              Isso impede que alguÃ©m â€œinventeâ€ um pedido falso com o mesmo visual.
            </div>
            <div class="divider"></div>
            <div class="tiny muted">
              O cliente pode colar o <b>Order ID</b> na aba <b>Verificar</b>. Se der âœ… â€œVerificado no servidorâ€, o pedido Ã© legÃ­timo.
              Se der âŒ â€œPedido falsoâ€, nÃ£o pague.
            </div>
            <div class="prodActions" style="margin-top:10px">
              <button class="btn accent" onclick="setPage('verify')">Abrir verificador</button>
              <button class="btn" onclick="copyText(trustExplainText())">Copiar explicaÃ§Ã£o</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ§  Checklist antiâ€‘golpe</b><span class="chip ok">Leitura rÃ¡pida</span></div>
        <div class="pBody">
          <div class="rvList">
            <div class="bundleItem">
              <b>1) Sempre use o verificador</b>
              <div class="tiny muted" style="margin-top:6px">Qualquer pedido real passa por âœ… â€œVerificado no servidorâ€.</div>
            </div>
            <div class="bundleItem">
              <b>2) Confirme o domÃ­nio</b>
              <div class="tiny muted" style="margin-top:6px">Pague somente apÃ³s conferir que estÃ¡ no site oficial (mesmo link do seu perfil).</div>
            </div>
            <div class="bundleItem">
              <b>3) NÃ£o confie em prints</b>
              <div class="tiny muted" style="margin-top:6px">Print/recibo pode ser editado. O verificador Ã© o que vale.</div>
            </div>
            <div class="bundleItem">
              <b>4) PIX: confira o destinatÃ¡rio</b>
              <div class="tiny muted" style="margin-top:6px">Antes de confirmar, confira o nome/identificador do recebedor no app do banco.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ“„ Dados e polÃ­ticas</b><span class="chip">Conformidade</span></div>
        <div class="pBody">
          <div class="tiny muted">
            PolÃ­ticas e informaÃ§Ãµes da loja ficam na aba <b>PolÃ­ticas</b>. Se vocÃª for pessoa fÃ­sica,
            evite expor CPF no site pÃºblico. Use canais oficiais e o verificador para gerar confianÃ§a.
          </div>
          <div class="prodActions" style="margin-top:10px">
            <button class="btn" onclick="setPage('policies')">Abrir polÃ­ticas</button>
            <button class="btn" onclick="setPage('info')">Sobre</button>
          </div>
        </div>
      </div>

    </div>
  </section>
  <section class="page" id="pageStatus" style="display:none">
    <div class="box">
      <b>ğŸŸ¢ Status do Sistema</b>
      <div class="tiny muted">Teste automÃ¡tico do verificador (Worker), latÃªncia e integridade.</div>
      <div class="divider"></div>

      <div class="grid2">
        <div class="panel fade">
          <div class="pHead"><b>âš™ï¸ Verificador (Worker)</b><span class="chip" id="st_worker_badge">â€”</span></div>
          <div class="pBody">
            <div class="row"><span class="muted">URL</span><b class="mono2" id="st_worker_url">â€”</b></div>
            <div style="height:8px"></div>
            <div class="row"><span class="muted">LatÃªncia</span><b id="st_latency">â€”</b></div>
            <div style="height:8px"></div>
            <div class="row"><span class="muted">Ãšltimo teste</span><b id="st_last">â€”</b></div>
            <div class="divider"></div>
            <div class="prodActions">
              <button class="btn accent" onclick="statusRun()">Rodar teste</button>
              <button class="btn" onclick="statusAutoToggle()" id="st_auto_btn">Auto: ON</button>
              <button class="btn" onclick="copyText(el('st_report').innerText)">Copiar relatÃ³rio</button>
            </div>
          </div>
        </div>

        <div class="panel fade">
          <div class="pHead"><b>ğŸ›¡ï¸ Integridade</b><span class="chip ok" id="st_integrity_badge">Ok</span></div>
          <div class="pBody">
            <div class="tiny muted">
              Este teste verifica se o servidor responde e assina pedidos corretamente.
              Isso ajuda o cliente a confiar que â€œVVâ€‘OFICIALâ€ Ã© real.
            </div>
            <div class="divider"></div>
            <div class="rvList">
              <div class="bundleItem">
                <b>âœ… HTTPS (cadeado)</b>
                <div class="tiny muted" style="margin-top:6px">Seu site e o Worker devem abrir com https://</div>
              </div>
              <div class="bundleItem">
                <b>âœ… Assinatura (HMAC)</b>
                <div class="tiny muted" style="margin-top:6px">O Worker retorna um <span class="mono2">sig</span> quando estÃ¡ OK.</div>
              </div>
              <div class="bundleItem">
                <b>âœ… VerificaÃ§Ã£o</b>
                <div class="tiny muted" style="margin-top:6px">Um Order ID + itensHash vÃ¡lidos retornam <span class="mono2">ok:true</span>.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ“‹ RelatÃ³rio</b><span class="chip" id="st_report_badge">â€”</span></div>
        <div class="pBody">
          <pre class="mono2" id="st_report" style="white-space:pre-wrap;margin:0">â€”</pre>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ‘€ O que mostrar pro cliente</b><span class="chip ok">Dica</span></div>
        <div class="pBody">
          <div class="tiny muted">
            Se alguÃ©m desconfiar, mande o cliente abrir esta aba â€œStatusâ€ e tirar print do teste âœ….
          </div>
        </div>
      </div>
    </div>
  </section>
  <section class="page" id="pagePay" style="display:none">
    <div class="box">
      <b>ğŸ’³ Pagamento (PIX seguro)</b>
      <div class="tiny muted">OrientaÃ§Ãµes claras + gerador de mensagem/QR para evitar golpes.</div>
      <div class="divider"></div>

      <div class="grid2">
        <div class="panel fade">
          <div class="pHead"><b>âœ… Como pagar com seguranÃ§a</b><span class="chip ok">Anti-golpe</span></div>
          <div class="pBody">
            <div class="rvList">
              <div class="bundleItem">
                <b>1) Verifique o pedido</b>
                <div class="tiny muted" style="margin-top:6px">Abra a aba <b>Verificar</b> e confirme âœ… â€œVerificado no servidorâ€.</div>
              </div>
              <div class="bundleItem">
                <b>2) Confirme o recebedor no banco</b>
                <div class="tiny muted" style="margin-top:6px">Antes de finalizar, confira o <b>nome do destinatÃ¡rio</b> no app do banco.</div>
              </div>
              <div class="bundleItem">
                <b>3) Pague somente pelo canal oficial</b>
                <div class="tiny muted" style="margin-top:6px">NÃ£o pague por links enviados por terceiros. Use sempre este site.</div>
              </div>
            </div>
            <div class="prodActions" style="margin-top:10px">
              <button class="btn accent" onclick="setPage('verify')">Abrir verificador</button>
              <button class="btn" onclick="setPage('trust')">TransparÃªncia</button>
            </div>
          </div>
        </div>

        <div class="panel fade">
          <div class="pHead"><b>ğŸ§¾ Gerar instruÃ§Ãµes de pagamento</b><span class="chip">Profissional</span></div>
          <div class="pBody">
            <div class="tiny muted">Cole o Order ID e o total. O site gera a mensagem padrÃ£o pro WhatsApp.</div>
            <div style="height:10px"></div>
            <div class="grid2">
              <div>
                <div class="tiny muted">Order ID</div>
                <input class="input mono" id="pay_order" placeholder="vv_..." />
              </div>
              <div>
                <div class="tiny muted">Total (R$)</div>
                <input class="input mono" id="pay_total" placeholder="49,90" />
              </div>
            </div>
            <div style="height:10px"></div>
            <div class="tiny muted">Chave PIX (opcional)</div>
            <input class="input mono" id="pay_pix" placeholder="sua chave pix (email/cel/aleatoria)" />
            <div style="height:10px"></div>
            <div class="tiny muted">Mensagem gerada</div>
            <textarea class="input mono" id="pay_msg" rows="6" readonly></textarea>
            <div class="prodActions" style="margin-top:10px">
              <button class="btn accent" onclick="payGenerate()">Gerar</button>
              <button class="btn" onclick="copyText(el('pay_msg').value)">Copiar</button>
              <button class="btn" onclick="openWhatsFromPay()">Enviar no WhatsApp</button>
            </div>
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ”³ QR PIX (visual)</b><span class="chip">Opcional</span></div>
        <div class="pBody">
          <div class="tiny muted">Sem integraÃ§Ã£o bancÃ¡ria: o QR aqui Ã© sÃ³ para facilitar copiar dados. Confirme sempre o recebedor no banco.</div>
          <div class="divider"></div>
          <div class="grid2">
            <div>
              <div class="tiny muted">Texto PIX / Copia e cola</div>
              <textarea class="input mono" id="pay_payload" rows="5" placeholder="(gerado ao clicar em Gerar)"></textarea>
              <div class="prodActions" style="margin-top:10px">
                <button class="btn" onclick="copyText(el('pay_payload').value)">Copiar PIX</button>
              </div>
            </div>
            <div>
              <div class="tiny muted">QR</div>
              <div class="card" style="display:flex;align-items:center;justify-content:center;min-height:180px">
                <div class="tiny muted" id="pay_qr">Gere uma mensagem primeiro.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>
  <section class="page" id="pageG24" style="display:none">
    <div class="box">
      <b>ğŸ›¡ï¸ Garantia ViralVault â€” 24 horas</b>
      <div class="tiny muted">TransparÃªncia total para vocÃª comprar com seguranÃ§a.</div>
      <div class="divider"></div>

      <div class="panel fade" style="overflow:hidden">
        <div class="pHead"><b>âœ… Entrega em atÃ© 24h</b><span class="chip ok">SLA 24h</span></div>
        <div class="pBody">
          <div class="grid2">
            <div class="card">
              <div class="tiny muted">O que Ã©</div>
              <div style="font-weight:900;font-size:18px;margin-top:6px">Prazo mÃ¡ximo</div>
              <div class="tiny muted" style="margin-top:8px">
                ApÃ³s a <b>confirmaÃ§Ã£o do pagamento</b>, entregamos seu item/brainrot no Roblox em atÃ© <b>24h</b>.
              </div>
            </div>
            <div class="card">
              <div class="tiny muted">Se atrasar</div>
              <div style="font-weight:900;font-size:18px;margin-top:6px">Reembolso total</div>
              <div class="tiny muted" style="margin-top:8px">
                Se passar de 24h sem entrega, vocÃª tem direito ao <b>reembolso integral</b>.
              </div>
            </div>
          </div>
          <div class="divider"></div>

          <div class="rvList">
            <div class="bundleItem">
              <b>ğŸ” Como vocÃª se protege</b>
              <div class="tiny muted" style="margin-top:6px">
                Use a aba <b>Verificar</b>. Se aparecer âœ… â€œVerificado no servidorâ€, o pedido Ã© real.
              </div>
            </div>
            <div class="bundleItem">
              <b>ğŸ“· Prova de entrega</b>
              <div class="tiny muted" style="margin-top:6px">
                Enviamos <b>print/vÃ­deo</b> apÃ³s a entrega quando necessÃ¡rio.
              </div>
            </div>
            <div class="bundleItem">
              <b>ğŸ’¬ Suporte</b>
              <div class="tiny muted" style="margin-top:6px">
                Atendimento via WhatsApp. Se a IA nÃ£o resolver, vocÃª chama um atendente.
              </div>
            </div>
          </div>

          <div class="divider"></div>
          <div class="grid2">
            <div class="panel fade">
              <div class="pHead"><b>ğŸ“Œ Passo a passo</b><span class="chip">Simples</span></div>
              <div class="pBody">
                <div class="tiny muted">1) FaÃ§a o pedido e gere o Order ID</div>
                <div class="tiny muted">2) Verifique no servidor (VVâ€‘OFICIAL)</div>
                <div class="tiny muted">3) Pague via PIX (confira recebedor)</div>
                <div class="tiny muted">4) Envie comprovante no WhatsApp</div>
                <div class="tiny muted">5) Receba em atÃ© 24h âœ…</div>
              </div>
            </div>
            <div class="panel fade">
              <div class="pHead"><b>â†©ï¸ Como pedir reembolso</b><span class="chip">Garantia</span></div>
              <div class="pBody">
                <div class="tiny muted">
                  Se o prazo estourar, chame o suporte com seu <b>Order ID</b> e peÃ§a reembolso.
                </div>
                <div class="prodActions" style="margin-top:10px">
                  <button class="btn accent" onclick="openWhatsSupport()">Chamar suporte</button>
                  <button class="btn" onclick="setPage('status')">Ver Status</button>
                  <button class="btn" onclick="setPage('verify')">Verificar pedido</button>
                </div>
              </div>
            </div>
          </div>

          <div class="panel fade" style="margin-top:12px">
            <div class="pHead"><b>ğŸ§¾ Texto curto para o cliente</b><span class="chip ok">Copiar</span></div>
            <div class="pBody">
              <textarea class="input mono" id="g24_copy" rows="5" readonly></textarea>
              <div class="prodActions" style="margin-top:10px">
                <button class="btn accent" onclick="copyText(el('g24_copy').value)">Copiar</button>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </section>




  <section class="page" id="pageTrack" style="display:none">
    <div class="box">
      <b>ğŸ“¦ Rastreamento do pedido</b>
      <div class="tiny muted">Cole seu <b>Order ID</b> para acompanhar o status. (Link pÃºblico funciona com <span class="mono">#track?orderId=...</span>)</div>
      <div class="divider"></div>

      <div class="grid2">
        <div>
          <div class="tiny muted">Order ID</div>
          <input class="input mono" id="tr_orderId" placeholder="vv_..." />
        </div>
        <div>
          <div class="tiny muted">AÃ§Ã£o</div>
          <div class="prodActions" style="margin-top:6px">
            <button class="btn accent" onclick="loadTracking()">Ver status</button>
            <button class="btn" onclick="copyTrackLink()">Copiar link</button>
          </div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ“ Linha do tempo</b><span class="chip" id="tr_chip">â€”</span></div>
        <div class="pBody">
          <div class="timeline" id="tr_timeline"></div>
          <div class="divider"></div>
          <div class="tiny muted" id="tr_note">Dica: se vocÃª pagou via PIX, envie o comprovante no WhatsApp para confirmaÃ§Ã£o.</div>
        </div>
      </div>

      <div class="divider"></div>

      <div class="panel fade" id="tr_adminPanel" style="display:none">
        <div class="pHead"><b>ğŸ”’ Ãrea do lojista</b><span class="chip ok">Admin</span></div>
        <div class="pBody">
          <div class="tiny muted">Atualize o status do pedido (somente no seu aparelho).</div>
          <div style="height:10px"></div>
          <div class="prodActions">
            <button class="btn" onclick="markPaid()">Marcar como pago</button>
            <button class="btn" onclick="markDelivered()">Marcar como entregue</button>
            <button class="btn" onclick="clearTracking()">Limpar status</button>
          </div>
          <div class="divider"></div>
          <div class="tiny muted">ObservaÃ§Ã£o (opcional)</div>
          <input class="input" id="tr_adminNote" placeholder="ex: Entrega em atÃ© 10 min" />
          <div style="height:10px"></div>
          <button class="btn accent" onclick="saveAdminNote()">Salvar observaÃ§Ã£o</button>
        </div>
      </div>

      <div class="tiny muted" style="margin-top:10px">
        Quer falar com um humano? Use o botÃ£o <b>Falar com atendente</b> no suporte.
      </div>
    </div>
  </section>
  <section class="page" id="pageAdmin" style="display:none">
    <div class="box">
        <div class="panel fade" id="adminEasyGuide">
          <div class="pHead"><b>ğŸ§° Admin FÃ¡cil (3 passos)</b><span class="chip ok">RÃ¡pido</span></div>
          <div class="pBody">
            <div class="rvList">
              <div class="bundleItem"><b>1) Ache o pedido</b><div class="tiny muted" style="margin-top:6px">Use a busca por <b>Order ID</b> ou role a lista.</div></div>
              <div class="bundleItem"><b>2) Marque como PAGO</b><div class="tiny muted" style="margin-top:6px">Depois que confirmar no banco, clique <b>Marcar PAGO</b>.</div></div>
              <div class="bundleItem"><b>3) Entregue no Roblox</b><div class="tiny muted" style="margin-top:6px">Clique <b>Enviar entrega</b> â†’ e depois <b>Entregue âœ…</b> com prova.</div></div>
            </div>
            <div class="divider"></div>
            <div class="tiny muted">Dica: se alguÃ©m desconfiar, mande abrir <b>Status</b> e <b>Verificar</b> âœ…</div>
          </div>
        </div>
        <div class="panel fade" id="adminSearchPanel">
          <div class="pHead"><b>ğŸ” Buscar pedido</b><span class="chip">Order ID</span></div>
          <div class="pBody">
            <div class="grid2">
              <div>
                <div class="tiny muted">Order ID</div>
                <input class="input mono" id="adminFindId" placeholder="vv_..." />
              </div>
              <div style="display:flex;align-items:flex-end;gap:10px">
                <button class="btn accent" onclick="adminFind()">Buscar</button>
                <button class="btn" onclick="adminClearFind()">Limpar</button>
              </div>
            </div>
            <div class="tiny muted" style="margin-top:10px" id="adminFindResult">â€”</div>
          </div>
        </div>
        
      <b>ğŸ§° Painel Admin (1 toque)</b>
      <div class="tiny muted">Gerencie pedidos, marque <b>Pago</b>/<b>Entregue</b> e responda clientes. (Login fica somente neste aparelho.)</div>
      <div class="divider"></div>

      <div class="panel fade" id="ad_loginPanel">
        <div class="pHead"><b>ğŸ” Login</b><span class="chip" id="ad_loginChip">Offline</span></div>
        <div class="pBody">
          <div class="grid2">
            <div>
              <div class="tiny muted">Senha do Admin</div>
              <input class="input" id="ad_pass" type="password" placeholder="Digite sua senha" />
            </div>
            <div>
              <div class="tiny muted">AÃ§Ã£o</div>
              <div class="prodActions" style="margin-top:6px">
                <button class="btn accent" onclick="adminLogin()">Entrar</button>
                <button class="btn" onclick="adminSetupLocal()">Criar senha</button>
              </div>
            </div>
          </div>
          <div class="tiny muted" style="margin-top:10px">Dica: use senha forte e nÃ£o compartilhe.</div>
        </div>
      </div>

      <div class="panel fade" id="ad_panel" style="display:none">
        <div class="pHead">
          <b>âœ… Admin ativo</b>
          <span class="chip ok">Seguro</span>
        </div>
        <div class="pBody">
          <div class="grid2">
            <div>
              <b>ğŸ“¦ Pedidos recentes</b>
              <div class="tiny muted">Salvos localmente quando o pedido Ã© gerado.</div>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
              <button class="btn" onclick="adminRefresh()">Atualizar</button>
              <button class="btn" onclick="adminExport()">Exportar JSON</button>
              <button class="btn" onclick="adminLogout()">Sair</button>
            </div>
          </div>

          <div class="divider"></div>

          <div class="ad_list" id="ad_list"></div>
          <div class="divider"></div>

          <div class="grid2">
            <div>
              <b>ğŸ« Tickets de suporte</b>
              <div class="tiny muted">SolicitaÃ§Ãµes abertas pelos clientes no site.</div>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
              <button class="btn" onclick="ticketsRefresh()">Atualizar tickets</button>
              <button class="btn" onclick="ticketsExport()">Exportar tickets</button>
              <button class="btn" id="ad_maint_btn" onclick="toggleMaintenance()">ğŸ› ï¸ ManutenÃ§Ã£o: OFF</button>
              <button class="btn" onclick="backupAll()">â¬‡ï¸ Backup</button>
              <button class="btn" onclick="restoreAll()">â¬†ï¸ Restaurar</button>
              <button class="btn" onclick="maintTest()">Testar</button>
              <button class="btn" id="ad_notify_btn" onclick="toggleTicketNotify()">ğŸ”” NotificaÃ§Ãµes: ON</button>
              <button class="btn" onclick="testTicketNotify()">Testar alerta</button>
            </div>
          </div>

          <div class="divider"></div>
          <div class="ad_list" id="ad_tickets"></div>
          <div class="divider"></div>

          <div class="grid2">
            <div>
              <b>ğŸ›¡ï¸ Logs de seguranÃ§a</b>
              <div class="tiny muted">Tentativas invÃ¡lidas, verificaÃ§Ãµes falhas e eventos suspeitos.</div>
            </div>
            <div style="display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap">
              <button class="btn" onclick="secRefresh()">Atualizar</button>
              <button class="btn" onclick="secExport()">Exportar</button>
              <button class="btn" onclick="secClear()">Limpar</button>
            </div>
          </div>

          <div class="divider"></div>
          <div class="row">
            <span class="muted">Bloqueios evitados</span>
            <b id="sec_counter">0</b>
          </div>
          <div style="height:8px"></div>
          <div class="ad_list" id="ad_sec"></div>


          <div class="tiny muted" style="margin-top:12px">
            âš ï¸ Dica: use <b>Verificar pedido</b> para validar um comprovante antes de marcar como pago.
          </div>
        </div>
      </div>
    </div>
  
      <div class="panel fade" id="deliveryTemplatesPanel">
        <div class="pHead"><b>ğŸš€ Entrega Roblox (1 clique)</b><span class="chip ok">Itens/Brainrots</span></div>
        <div class="pBody">
          <div class="tiny muted">Defina o modelo de mensagem e entregue rÃ¡pido com prova. (Sem senha, mais seguro)</div>
          <div class="divider"></div>
          <div class="grid2">
            <div>
              <div class="tiny muted">Modelo (template) de entrega</div>
              <textarea class="input mono" id="deliv_tpl" rows="10"></textarea>
              <div class="tiny muted" style="margin-top:8px">Use variÃ¡veis: <b>{orderId}</b> <b>{total}</b> <b>{items}</b> <b>{robloxUser}</b> <b>{server}</b> <b>{time}</b></div>
              <div class="prodActions" style="margin-top:10px">
                <button class="btn accent" onclick="delivTplSave()">Salvar template</button>
                <button class="btn" onclick="delivTplReset()">Reset padrÃ£o</button>
              </div>
            </div>
            <div>
              <div class="tiny muted">Coleta de dados do cliente (no checkout)</div>
              <div class="bundleItem">
                <b>âœ… @ do Roblox</b><div class="tiny muted" style="margin-top:6px">Cliente informa o username para entrega.</div>
              </div>
              <div class="bundleItem">
                <b>âœ… Servidor/Jogo</b><div class="tiny muted" style="margin-top:6px">Ex: Blox Fruits / Anime Vanguards etc.</div>
              </div>
              <div class="bundleItem">
                <b>âœ… HorÃ¡rio</b><div class="tiny muted" style="margin-top:6px">Um horÃ¡rio combinado pra entregar sem atraso.</div>
              </div>
              <div class="divider"></div>
              <div class="tiny muted">Depois do pagamento, vocÃª abre o pedido e clica em <b>â€œEnviar entregaâ€</b>.</div>
            </div>
          </div>
        </div>
      </div>
</section>
  <section class="page" id="pageDash" style="display:none">
    <div class="box">
      <b>ğŸ“Š Dashboard</b>
      <div class="tiny muted">MÃ©tricas rÃ¡pidas do seu negÃ³cio (dados deste aparelho).</div>
      <div class="divider"></div>

      <div class="gridCards" style="grid-template-columns:repeat(4,1fr)">
        <div class="card">
          <div class="tiny muted">Pedidos</div>
          <div style="font-size:28px;font-weight:900" id="d_orders">0</div>
          <div class="tiny muted" id="d_orders_sub">â€”</div>
        </div>
        <div class="card">
          <div class="tiny muted">Receita (estimada)</div>
          <div style="font-size:28px;font-weight:900" id="d_rev">R$0</div>
          <div class="tiny muted" id="d_rev_sub">â€”</div>
        </div>
        <div class="card">
          <div class="tiny muted">Cupons usados</div>
          <div style="font-size:28px;font-weight:900" id="d_coupons">0</div>
          <div class="tiny muted" id="d_coupons_sub">â€”</div>
        </div>
        <div class="card">
          <div class="tiny muted">Tickets abertos</div>
          <div style="font-size:28px;font-weight:900" id="d_tickets">0</div>
          <div class="tiny muted" id="d_tickets_sub">â€”</div>
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ“ˆ Pedidos por dia (Ãºltimos 7 dias)</b><span class="chip" id="d_range">7d</span></div>
        <div class="pBody">
          <div class="barWrap" id="d_bars"></div>
          <div class="tiny muted" style="margin-top:8px">Dica: para mÃ©tricas globais em qualquer aparelho, dÃ¡ pra ligar isso no Worker depois.</div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ§  Insights</b><span class="chip ok">Auto</span></div>
        <div class="pBody">
          <div class="tiny muted" id="d_insights">â€”</div>
          <div class="prodActions" style="margin-top:10px">
            <button class="btn" onclick="dashRefresh()">Atualizar</button>
            <button class="btn" onclick="setPage('admin')">Abrir Admin</button>
          </div>
        </div>
      </div>

    </div>
  </section>
  <section class="page" id="pageVitrine" style="display:none">
    <div class="box">
      <b>ğŸª„ Vitrine (link direto de produto)</b>
      <div class="tiny muted">Gere um link para divulgar no Instagram/TikTok com preview do produto.</div>
      <div class="divider"></div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ”— Gerador de link</b><span class="chip ok">CompartilhÃ¡vel</span></div>
        <div class="pBody">
          <div class="grid2">
            <div>
              <div class="tiny muted">Produto</div>
              <select class="input" id="vit_product" onchange="vitrineUpdate()"></select>
            </div>
            <div>
              <div class="tiny muted">Cupom opcional (ex: BEMVINDO10)</div>
              <input class="input mono" id="vit_coupon" placeholder="BEMVINDO10" oninput="vitrineUpdate()" />
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="tiny muted">Link gerado</div>
          <input class="input mono" id="vit_link" readonly />
          <div class="prodActions" style="margin-top:10px">
            <button class="btn accent" onclick="vitrineCopy()">Copiar link</button>
            <button class="btn" onclick="vitrineOpen()">Abrir preview</button>
          </div>
        </div>
      </div>

      <div class="panel fade" id="vit_preview_wrap">
        <div class="pHead"><b>ğŸ‘€ Preview</b><span class="chip">Auto</span></div>
        <div class="pBody">
          <div id="vit_preview"></div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ“Œ Dica de post</b><span class="chip">Pronto</span></div>
        <div class="pBody">
          <div class="tiny muted" id="vit_caption"></div>
          <div class="prodActions" style="margin-top:10px">
            <button class="btn" onclick="copyText(el('vit_caption').innerText)">Copiar legenda</button>
          </div>
        </div>
      </div>

    </div>
  </section>






          <div class="panel fade" id="couponPanel">
            <div class="pHead">
              <b>ğŸ·ï¸ Cupom</b>
              <span class="chip ok" id="cp_hint">10% boas-vindas disponÃ­vel</span>
            </div>
            <div class="pBody">
              <div class="grid2">
                <div>
                  <div class="tiny muted">CÃ³digo do cupom</div>
                  <input class="input mono" id="cp_code" placeholder="ex: BEMVINDO10" />
                </div>
                <div>
                  <div class="tiny muted">Aplicar</div>
                  <div class="prodActions" style="margin-top:6px">
                    <button class="btn accent" onclick="applyCoupon()">Aplicar</button>
                    <button class="btn" onclick="autoApplyBestCoupon()">Aplicar melhor</button>
                  </div>
                </div>
              </div>
              <div style="height:10px"></div>
              <div class="row">
                <span class="muted">Desconto</span>
                <b id="cp_discount">R$ 0,00</b>
              </div>
              <div class="row">
                <span class="muted">Total com desconto</span>
                <b id="cp_total">â€”</b>
              </div>
              <div class="divider"></div>
              <div class="tiny muted">ğŸ Cupom do dia:</div>
              <div class="row">
                <span class="mono" id="cp_day">â€”</span>
                <button class="btn" onclick="useDailyCoupon()">Usar</button>
              </div>
              <div class="tiny muted" id="cp_msg" style="margin-top:8px">Dica: cada cliente pode usar 1x (por WhatsApp).</div>
            </div>
          </div>

  <section class="page" id="pageInfo" style="display:none">
    <div class="box">
      <b>â„¹ï¸ Sobre a ViralVault Store</b>
      <div class="tiny muted">Loja digital com entrega rÃ¡pida e verificaÃ§Ã£o VV-OFICIAL para aumentar sua seguranÃ§a.</div>
      <div class="divider"></div>

      <div class="panel fade">
        <div class="pHead"><b>âœ… O que a gente vende</b><span class="chip">Curadoria</span></div>
        <div class="pBody">
          <div class="tiny muted">
            A ViralVault Ã© uma curadoria de itens digitais e utilidades sob demanda. Nosso foco Ã©: velocidade, clareza e suporte humano quando precisar.
          </div>
          <div style="height:10px"></div>
          <div class="tiny muted">
            <b>TransparÃªncia:</b> pedidos sÃ£o confirmados por WhatsApp e verificados no servidor (VV-OFICIAL).
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ›¡ï¸ SeguranÃ§a</b><span class="chip ok">Verificado</span></div>
        <div class="pBody">
          <ul class="ul">
            <li><b>HTTPS</b> (cadeado no navegador)</li>
            <li><b>VV-OFICIAL</b> (assinatura HMAC no servidor)</li>
            <li><b>VerificaÃ§Ã£o pÃºblica</b> e <b>rastreio</b> por link</li>
            <li><b>Tickets</b> e atendimento humano</li>
          </ul>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ“ Contato</b><span class="chip">Suporte</span></div>
        <div class="pBody">
          <div class="tiny muted">
            Use o chat de suporte no canto inferior ou fale direto pelo WhatsApp.
          </div>
        </div>
      </div>
    </div>
  
      <div class="panel fade">
        <div class="pHead"><b>ğŸ“¦ Entrega (Digital)</b><span class="chip ok">InstantÃ¢nea</span></div>
        <div class="pBody">
          <div class="tiny muted">
            A ViralVault trabalha com <b>produtos digitais</b> (sem envio fÃ­sico). ApÃ³s a confirmaÃ§Ã£o do pagamento,
            vocÃª recebe o conteÃºdo pelo WhatsApp e/ou e-mail informado. O prazo tÃ­pico Ã© de <b>minutos</b>, podendo variar em horÃ¡rios de pico.
          </div>
        </div>
      </div>
</section>
  <section class="page" id="pagePolicies" style="display:none">
    <div class="box">
      <b>ğŸ“œ PolÃ­ticas (Trocas, Entregas e Privacidade)</b>
      <div class="tiny muted">Texto base. Ajuste se vocÃª tiver regras especÃ­ficas.</div>
      <div class="divider"></div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸšš Entrega</b><span class="chip">Digital</span></div>
        <div class="pBody">
          <div class="tiny muted">
            Produtos digitais sÃ£o entregues apÃ³s confirmaÃ§Ã£o do pagamento. O prazo pode variar conforme demanda e horÃ¡rio de atendimento.
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ” Troca / Reembolso</b><span class="chip">Clareza</span></div>
        <div class="pBody">
          <div class="tiny muted">
            Para itens digitais, apÃ³s a entrega, pode nÃ£o ser possÃ­vel desfazer o envio (por ser um bem consumÃ­vel). 
            Caso ocorra erro nosso (item incorreto, falha na entrega), fazemos correÃ§Ã£o ou reenvio.
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ”’ Privacidade (LGPD)</b><span class="chip ok">LGPD</span></div>
        <div class="pBody">
          <div class="tiny muted">
            Coletamos apenas o necessÃ¡rio para atender seu pedido (nome e WhatsApp). NÃ£o vendemos seus dados.
            VocÃª pode solicitar remoÃ§Ã£o dos dados pelo suporte.
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>âš ï¸ Anti-golpe</b><span class="chip bad">AtenÃ§Ã£o</span></div>
        <div class="pBody">
          <div class="tiny muted">
            Sempre confirme se o pedido tem <b>VV-OFICIAL</b>. Use a aba <b>Verificar pedido</b> para checar no servidor.
            Se alguÃ©m tentar se passar pela loja, peÃ§a o link de verificaÃ§Ã£o.
          </div>
        </div>
      </div>
    </div>
  
      <div class="panel fade">
        <div class="pHead"><b>â±ï¸ Prazo e Garantia</b><span class="chip ok">24h</span></div>
        <div class="pBody">
          <div class="tiny muted">
            Trabalhamos com <b>produtos digitais</b> e entrega via WhatsApp. O prazo padrÃ£o Ã© de atÃ© <b>24 horas</b>
            apÃ³s a confirmaÃ§Ã£o do pagamento. Se o prazo estourar sem entrega, oferecemos <b>reembolso total</b>.
          </div>
        </div>
      </div>
</section>
  <section class="page" id="pageFAQ" style="display:none">
    <div class="box">
      <b>â“ Perguntas Frequentes (FAQ)</b>
      <div class="tiny muted">Respostas rÃ¡pidas para aumentar confianÃ§a e reduzir suporte.</div>
      <div class="divider"></div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ” Buscar</b><span class="chip">RÃ¡pido</span></div>
        <div class="pBody">
          <input class="input" id="faq_search" placeholder="Digite: pagamento, entrega, VV-OFICIAL, reembolso..." oninput="faqRender()" />
          <div class="tiny muted" style="margin-top:8px">Dica: use palavras como <b>pix</b>, <b>prazo</b>, <b>verificaÃ§Ã£o</b>, <b>cupom</b>.</div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ“Œ Respostas</b><span class="chip ok" id="faq_count">0</span></div>
        <div class="pBody">
          <div class="faqList" id="faq_list"></div>
        </div>
      </div>
    </div>
  </section>
  <section class="page" id="pageReviews" style="display:none">
    <div class="box">
      <b>â­ AvaliaÃ§Ãµes de Clientes</b>
      <div class="tiny muted">Prova social real aumenta conversÃ£o. (AvaliaÃ§Ãµes ficam registradas neste site.)</div>
      <div class="divider"></div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ“Š Nota mÃ©dia</b><span class="chip ok" id="rv_badge">â€”</span></div>
        <div class="pBody">
          <div class="grid2">
            <div>
              <div style="font-size:34px;font-weight:900" id="rv_avg">â€”</div>
              <div class="tiny muted" id="rv_count">â€”</div>
            </div>
            <div>
              <div class="stars" id="rv_stars" aria-label="stars"></div>
              <div class="tiny muted" style="margin-top:8px">Somente avaliaÃ§Ãµes com texto sÃ£o exibidas.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>âœï¸ Deixar avaliaÃ§Ã£o</b><span class="chip">RÃ¡pido</span></div>
        <div class="pBody">
          <div class="grid2">
            <div>
              <div class="tiny muted">Seu nome</div>
              <input class="input" id="rv_name" placeholder="ex: Maria" />
            </div>
            <div>
              <div class="tiny muted">Nota (1 a 5)</div>
              <input class="input mono" id="rv_rate" placeholder="5" />
            </div>
          </div>
          <div style="height:10px"></div>
          <div>
            <div class="tiny muted">ComentÃ¡rio</div>
            <textarea class="input" id="rv_text" rows="3" placeholder="Conte como foi sua experiÃªnciaâ€¦"></textarea>
          </div>
          <div style="height:10px"></div>
          <div class="prodActions">
            <button class="btn accent" onclick="reviewAdd()">Publicar</button>
            <button class="btn" onclick="reviewPrefill()">Preencher com meus dados</button>
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ§¾ Ãšltimas avaliaÃ§Ãµes</b><span class="chip" id="rv_last">â€”</span></div>
        <div class="pBody">
          <div class="rvList" id="rv_list"></div>
        </div>
      </div>
    </div>
  </section>
  <section class="page" id="pageGuarantee" style="display:none">
    <div class="box">
      <b>ğŸ›¡ï¸ Garantias e ConfianÃ§a</b>
      <div class="tiny muted">Tudo o que vocÃª precisa para comprar com tranquilidade.</div>
      <div class="divider"></div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ§¾ Como comprar (passo a passo)</b><span class="chip ok">FÃ¡cil</span></div>
        <div class="pBody">
          <ol class="ol">
            <li>Escolha o produto e adicione ao carrinho.</li>
            <li>No checkout, preencha seus dados e aplique cupom (se tiver).</li>
            <li>Gere seu pedido <b>VV-OFICIAL</b>.</li>
            <li>Finalize pelo WhatsApp e envie o comprovante PIX.</li>
            <li>Acompanhe na aba <b>Rastrear pedido</b>.</li>
          </ol>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>âœ… Checklist anti-golpe</b><span class="chip bad">Importante</span></div>
        <div class="pBody">
          <ul class="ul">
            <li>Confira se o site tem <b>HTTPS</b> (cadeado).</li>
            <li>Gere o pedido e exija o cÃ³digo <b>VV-OFICIAL</b>.</li>
            <li>Use a aba <b>Verificar pedido</b> para confirmar no servidor.</li>
            <li>Nunca pague se o pedido nÃ£o conferir na verificaÃ§Ã£o.</li>
            <li>Em caso de dÃºvida, abra um <b>Ticket</b> e peÃ§a atendimento humano.</li>
          </ul>
          <div class="prodActions" style="margin-top:10px">
            <button class="btn accent" onclick="setPage('verify')">Verificar agora</button>
            <button class="btn" onclick="setPage('track')">Rastrear pedido</button>
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ”’ Garantia de entrega</b><span class="chip ok">Compromisso</span></div>
        <div class="pBody">
          <div class="tiny muted">
            Se houver erro nosso (produto incorreto, falha no envio, atraso fora do normal), a gente corrige o pedido ou reenviamos sem custo.
            Nosso suporte fica disponÃ­vel via chat/ticket.
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ“Œ TransparÃªncia</b><span class="chip">Claro</span></div>
        <div class="pBody">
          <ul class="ul">
            <li>VocÃª recebe um <b>Order ID</b> e um link de verificaÃ§Ã£o.</li>
            <li>O status do pedido Ã© atualizado no rastreio global.</li>
            <li>Dados mÃ­nimos: nome + WhatsApp (LGPD).</li>
          </ul>
        </div>
      </div>
    </div>
  </section>






  <section class="page" id="pageCatalog" style="display:none">
    <div class="box">
      <b>ğŸ—‚ï¸ CatÃ¡logo (ColeÃ§Ãµes)</b>
      <div class="tiny muted">Busque, filtre e encontre rÃ¡pido. (Trend / Anime / Premium)</div>
      <div class="divider"></div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ” Busca & Filtros</b><span class="chip">Loja de verdade</span></div>
        <div class="pBody">
          <div class="grid2">
            <div>
              <div class="tiny muted">Pesquisar</div>
              <input class="input" id="cat_search" placeholder="Digite nome, palavra-chave..." oninput="catalogRender()" />
            </div>
            <div>
              <div class="tiny muted">Ordenar</div>
              <select class="input" id="cat_sort" onchange="catalogRender()">
                <option value="relevance">RelevÃ¢ncia</option>
                <option value="priceAsc">PreÃ§o (menor â†’ maior)</option>
                <option value="priceDesc">PreÃ§o (maior â†’ menor)</option>
                <option value="nameAsc">Nome (A â†’ Z)</option>
              </select>
            </div>
          </div>

          <div style="height:10px"></div>
          <div class="chips" id="cat_chips"></div>

          <div class="divider"></div>
          <div class="row">
            <span class="muted">Resultados</span>
            <b id="cat_count">0</b>
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ›ï¸ Produtos</b><span class="chip ok">Atual</span></div>
        <div class="pBody">
          <div class="gridCards" id="cat_grid"></div>
        </div>
      </div>
    </div>
  </section>
  <section class="page" id="pageFav" style="display:none">
    <div class="box">
      <b>â¤ï¸ Favoritos</b>
      <div class="tiny muted">Salve produtos para comprar depois.</div>
      <div class="divider"></div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ“Œ Sua lista</b><span class="chip" id="fav_count">0</span></div>
        <div class="pBody">
          <div class="gridCards" id="fav_grid"></div>
          <div class="prodActions" style="margin-top:10px">
            <button class="btn" onclick="favClear()">Limpar lista</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="page" id="pageMyOrders" style="display:none">
    <div class="box">
      <b>ğŸ§¾ Meus pedidos</b>
      <div class="tiny muted">Veja seu histÃ³rico neste aparelho e acompanhe com rastreio global.</div>
      <div class="divider"></div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ” Encontrar meus pedidos</b><span class="chip">Privado</span></div>
        <div class="pBody">
          <div class="grid2">
            <div>
              <div class="tiny muted">Seu WhatsApp</div>
              <input class="input" id="mo_whats" placeholder="+55 11 9...." oninput="myOrdersRender()" />
            </div>
            <div>
              <div class="tiny muted">AÃ§Ãµes</div>
              <div class="prodActions" style="margin-top:6px">
                <button class="btn accent" onclick="myOrdersSaveWhats()">Salvar</button>
                <button class="btn" onclick="myOrdersClear()">Limpar</button>
              </div>
            </div>
          </div>
          <div class="tiny muted" style="margin-top:10px">
            Dica: se vocÃª trocar de celular/navegador, o histÃ³rico local nÃ£o migra. O rastreio global continua funcionando com o <b>Order ID</b>.
          </div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ“¦ Seus pedidos</b><span class="chip ok" id="mo_count">0</span></div>
        <div class="pBody">
          <div class="ad_list" id="mo_list"></div>
        </div>
      </div>
    </div>
  </section>
  <section class="page" id="pageLoyalty" style="display:none">
    <div class="box">
      <b>ğŸ–ï¸ Programa de Fidelidade</b>
      <div class="tiny muted">Ganhe pontos por compra e desbloqueie benefÃ­cios.</div>
      <div class="divider"></div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ‘¤ Seu perfil</b><span class="chip" id="loy_level">â€”</span></div>
        <div class="pBody">
          <div class="grid2">
            <div>
              <div class="tiny muted">Seu WhatsApp</div>
              <input class="input" id="loy_whats" placeholder="+55 11 9...." oninput="loyRender()" />
              <div class="tiny muted" style="margin-top:8px">Usamos sÃ³ para identificar seus pontos (nÃ£o Ã© compartilhado).</div>
            </div>
            <div>
              <div class="tiny muted">Pontos</div>
              <div style="font-size:30px;font-weight:900" id="loy_points">0</div>
              <div class="tiny muted" id="loy_next">â€”</div>
              <div class="prodActions" style="margin-top:10px">
                <button class="btn accent" onclick="loySave()">Salvar</button>
                <button class="btn" onclick="loyClaim()">Gerar cupom</button>
              </div>
            </div>
          </div>
          <div class="divider"></div>
          <div class="tiny muted">Regras: <b>1 real</b> gasto = <b>1 ponto</b>. Ao juntar pontos suficientes vocÃª pode gerar um cupom automÃ¡tico.</div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ BenefÃ­cios</b><span class="chip ok">Auto</span></div>
        <div class="pBody">
          <div class="rvList" id="loy_benefits"></div>
        </div>
      </div>

      <div class="panel fade">
        <div class="pHead"><b>ğŸ§¾ HistÃ³rico</b><span class="chip" id="loy_hist_count">0</span></div>
        <div class="pBody">
          <div class="ad_list" id="loy_hist"></div>
        </div>
      </div>
    </div>
  </section>



</main>

  <!-- Suporte -->
  <div class="float" title="Suporte" onclick="toggleSupport(true)"></div>
  <div class="support" id="support" aria-label="Chat de suporte">
    <div class="sHead">
      <div>
        <b>Suporte ViralVault</b>
        <div class="muted tiny">Atalhos â€¢ IA FAQ â€¢ Humano quando precisar</div>
      </div>
      <button class="sClose" onclick="clearChat()" aria-label="Limpar chat" title="Limpar chat">ğŸ—‘ï¸</button>
      <button class="sClose" onclick="toggleSupport(false)" aria-label="Fechar chat">âœ•</button>
    </div>

    <div class="sBody" id="sBody" aria-live="polite">
      <div class="msg">
        Oi! ğŸ‘‹ Eu sou o <b>assistente</b> da ViralVault.
        <div class="tiny muted" style="margin-top:6px">Se for pedido: envie <b>Order ID</b> + <b>VV-OFICIAL</b>.</div>
      </div>

      <div class="msg" style="max-width:100%">
        <b>Atalhos</b>
        <div class="tiny muted" style="margin-top:6px">Toque em um botÃ£o:</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:10px">
          <button class="copyBtn" type="button" onclick="quickReply('ğŸ“¦ Prazo de entrega')">ğŸ“¦ Prazo</button>
          <button class="copyBtn" type="button" onclick="quickReply('ğŸ’³ Como pagar no PIX')">ğŸ’³ PIX</button>
          <button class="copyBtn" type="button" onclick="quickReply('ğŸ›¡ï¸ VV-OFICIAL / anti-golpe')">ğŸ›¡ï¸ VV-OFICIAL</button>
          <button class="copyBtn" type="button" onclick="quickReply('ğŸŸï¸ Cupom BEMVINDO10')">ğŸŸï¸ Cupom</button>
          <button class="copyBtn" type="button" onclick="quickReply('ğŸ” Troca e reembolso')">ğŸ” Troca</button>
          <button class="copyBtn" type="button" onclick="sendReceiptHelp()">ğŸ“ Comprovante</button>
          <button class="copyBtn" type="button" onclick="sendOrderIdToChat()">ğŸ†” Meu Order ID</button>
        </div>
      </div>

      <div class="msg" style="max-width:100%">
        <b>Antes de falar com atendente (opcional)</b>
        <div class="tiny muted" style="margin-top:6px">Se preencher, eu mando tudo certinho pro WhatsApp do dono.</div>
        <div style="display:grid;gap:8px;margin-top:10px">
          <input id="chatName" class="input" style="padding:10px 12px;border-radius:16px" placeholder="Seu nome (opcional)" />
          <input id="chatOrderId" class="input" style="padding:10px 12px;border-radius:16px" placeholder="Order ID (opcional)" />
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
          <button class="btn accent" type="button" onclick="callHuman('Cliente pediu atendente')">ğŸ‘¤ Falar com atendente</button>
          <div class="divider"></div>
          <div id="ticketForm" class="panel fade">
            <div class="pHead"><b>ğŸ« Abrir ticket (suporte humano)</b><span class="chip">Novo</span></div>
            <div class="pBody">
              <div class="tiny muted">Descreva seu problema. VocÃª recebe um <b>ID</b> e o lojista Ã© notificado.</div>
              <div style="height:10px"></div>
              <div class="grid2">
                <div>
                  <div class="tiny muted">Seu nome</div>
                  <input class="input" id="tk_name" placeholder="ex: JoÃ£o" />
                </div>
                <div>
                  <div class="tiny muted">WhatsApp</div>
                  <input class="input" id="tk_whats" placeholder="ex: +55 11 9...." />
                </div>
              </div>
              <div style="height:10px"></div>
              <div>
                <div class="tiny muted">Mensagem</div>
                <textarea class="input" id="tk_msg" rows="3" placeholder="Explique sua dÃºvida / problemaâ€¦"></textarea>
              </div>
              <div style="height:10px"></div>
              <div class="prodActions">
                <button class="btn accent" onclick="openTicket()">Abrir ticket</button>
                <button class="btn" onclick="prefillTicketFromCheckout()">Preencher com meus dados</button>
              </div>
              <div class="divider"></div>
              <div class="row">
                <span class="muted">Status</span>
                <span class="chip" id="tk_status">â€”</span>
              </div>
              <div class="tiny muted" id="tk_detail" style="margin-top:8px">Nenhum ticket aberto.</div>
            </div>
          </div>

          <button class="btn" type="button" onclick="openTicket()">ğŸ« Abrir chamado</button>
        </div>
      </div>
    </div>

    <div class="sFoot">
      <input id="sInput" placeholder="Digite sua mensagemâ€¦" autocomplete="off" />
      <button class="sendBtn" onclick="sendSupport()">â¤</button>
    </div>
  </div>

  <!-- Drawer Carrinho -->
  <div class="overlay" id="overlay" onclick="closeCart()"></div>
  <aside class="drawer" id="drawer">
    <div class="dHead">
      <b>ğŸ›’ Carrinho & Checkout (PIX)</b>
      <button class="x" onclick="closeCart()">âœ•</button>
    </div>

    <div class="dBody">
      <div class="stepWrap active" id="step1">
<div id="cartList"></div>

      <div class="box">
        <div class="sumRow"><span class="muted">Subtotal</span> <b id="subTotal">R$ 0,00</b></div>
        <div class="sumRow"><span class="muted">Desconto</span> <b id="discount">R$ 0,00</b></div>
        <div class="sumRow"><span class="muted">VIP</span> <b id="vipLine">R$ 0,00</b></div>
        <div class="divider"></div>
        <div class="sumRow"><span class="muted">Total</span> <b id="grandTotal">R$ 0,00</b></div>
        <div class="tiny muted" id="oneUseHint" style="margin-top:8px"></div>
      </div>

      <div class="box">
</div>
<div class="stepWrap" id="step2">
<div class="box">
        <b>Checkout</b>
        <div class="tiny muted">Aplique o cupom e gere o pedido assinado VV-OFICIAL.</div>

        <div class="couponBox">
          <b>ğŸŸï¸ Cupom de boas-vindas (uso Ãºnico)</b>
          <div class="couponCode">
            <code>BEMVINDO10</code>
            <button class="copyBtn" onclick="applyCoupon('BEMVINDO10')">Aplicar</button>
          </div>
          <div class="tiny muted" id="couponAppliedInfo" style="margin-top:8px"></div>
        </div>

        <div class="vipRow">
          <input id="vipToggle" type="checkbox" onchange="toggleVIP(this.checked)" />
          <div>
            <b>âš¡ Entrega PrioritÃ¡ria (VIP)</b>
            <div class="tiny muted">Seu pedido vai na frente da fila. + <span class="mono">R$ 9,90</span></div>
          </div>
        </div>

        <div class="field">
          <label>Seu nome</label>
          <input id="custName" placeholder="Ex: Darlan" />
        </div>

        <div class="field">
          <label>WhatsApp (com DDD)</label>
          <input id="custWpp" placeholder="Ex: 11999999999" inputmode="numeric" />
        </div>

        <div class="field">
          <label>ObservaÃ§Ã£o (opcional)</label>
          <textarea id="custNote" rows="3" placeholder="Ex: entrega hoje / preferÃªnciaâ€¦"></textarea>
        </div>

        <div class="field">
          <label>Comprovante (opcional)</label>
          <input id="receiptFile" type="file" accept="image/*" />
          <div class="tiny muted">O WhatsApp nÃ£o anexa imagem automaticamente. Depois de abrir o WhatsApp, toque no ğŸ“ e anexe a foto.</div>
        </div>

        <div class="divider"></div>
        <div class="row">
          <span class="muted">VV-OFICIAL</span>
          <span class="chip" id="vvStatus">Aguardandoâ€¦</span>
        </div>
        <div class="tiny muted" id="vvDetail"></div>

        <div class="divider"></div>
        <div class="tiny muted">âš ï¸ Finalize sÃ³ com <b>Order ID</b> + <b>VV-OFICIAL</b>.</div>
      </div>
</div>
<div class="stepWrap" id="step3">
  <div class="box">
    <b>Finalizar</b>
    <div class="tiny muted">Gere o pedido VV-OFICIAL e finalize no WhatsApp. Se jÃ¡ pagou, envie o comprovante.</div>
    <div class="divider"></div>
    <div class="row">
      <span class="muted">Status</span>
      <span class="chip" id="finalStatus">Passo 3/3</span>
    </div>
    <div class="stepHint">Dica: se o status estiver â€œâœ… Verificadoâ€, Ã© seguro finalizar.</div>
  </div>
</div>

</div>


  <div class="actions" aria-label="AÃ§Ãµes do checkout">
    <button class="bigBtn secondary" id="btnBack" onclick="goStep(-1)" style="display:none">â† Voltar</button>
    <button class="bigBtn" id="btnNext" onclick="goStep(1)">Continuar â†’</button>

    <button class="bigBtn" id="btnSign" onclick="createSignedOrder()" style="display:none">Gerar pedido VV-OFICIAL</button>
    <button class="bigBtn secondary" id="btnWpp" onclick="sendToWhatsApp()" style="display:none">Finalizar no WhatsApp</button>
    <button class="bigBtn secondary" id="btnPaid" onclick="alreadyPaid()" style="display:none">âœ… JÃ¡ paguei (enviar comprovante)</button>
  </div>
</aside>

  <!-- Admin modal -->
  <div class="modalWrap" id="adminWrap" onclick="closeAdmin(event)">
    <div class="modal" role="dialog" aria-label="Admin ViralVault" onclick="event.stopPropagation()">
      <div class="mHead">
        <div>
          <b>ğŸ” Painel Admin (simples)</b>
          <div class="small">Editar vitrine â€¢ status de pedidos â€¢ ver tickets</div>
        </div>
        <button class="x" onclick="hideAdmin()">âœ•</button>
      </div>
      <div class="mBody">
        <div class="panel">
          <div class="pHead">
            <b>Senha</b>
            <span class="chip">localStorage</span>
          </div>
          <div class="pBody tiny">
            <div class="muted">Primeira vez? VocÃª vai criar uma senha. Depois, ela fica salva neste aparelho.</div>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
              <button class="btn accent" onclick="setAdminPassword()">Definir / trocar senha</button>
              <button class="btn" onclick="logoutAdmin()">Sair do admin</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="panel">
          <div class="pHead">
            <b>Produtos</b>
            <span class="chip">Editar</span>
          </div>
          <div class="pBody">
            <div class="small">Dica: depois de editar, clique em <b>Salvar</b>.</div>
            <table class="table" id="prodTable"></table>
            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
              <button class="btn accent" onclick="addProduct()">+ Adicionar produto</button>
              <button class="btn" onclick="saveProducts()">Salvar</button>
              <button class="btn" onclick="resetProducts()">Resetar padrÃ£o</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="panel">
          <div class="pHead">
            <b>Status de pedidos</b>
            <span class="chip">Manual</span>
          </div>
          <div class="pBody">
            <div class="tools" style="grid-template-columns:1fr .7fr .7fr; margin-top:0">
              <input id="admOrder" class="input" placeholder="Order ID" />
              <select id="admStatus" class="input select">
                <option value="Gerado">Gerado</option>
                <option value="Aguardando pagamento">Aguardando pagamento</option>
                <option value="Pago / Confirmado">Pago / Confirmado</option>
                <option value="Em entrega">Em entrega</option>
                <option value="ConcluÃ­do">ConcluÃ­do</option>
              </select>
              <button class="btn accent" onclick="setOrderStatusAdmin()">Atualizar</button>
            </div>
            <div class="small muted" id="admOrderHint" style="margin-top:10px"></div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="panel">
          <div class="pHead">
            <b>Tickets (chat)</b>
            <span class="chip">VV-TICKET</span>
          </div>
          <div class="pBody">
            <div class="small muted">Ãšltimos tickets criados neste aparelho:</div>
            <div id="ticketList" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
      <div class="mActions">
        <button class="btn danger" onclick="hardReset()">Limpar dados locais (carrinho/chat)</button>
        <button class="btn" onclick="hideAdmin()">Fechar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ===================== CONFIG ===================== */
const WORKER_URL = "https://viralvault-sign.darlanana06.workers.dev"; // seu worker
const SUPPORT_WHATSAPP_NUMBER = "5511941598713"; // seu WhatsApp (sem +)
const STORE_NAME = "ViralVault Store";
const WELCOME_COUPON = { code: "BEMVINDO10", pct: 10 };
const VIP_UPSELL = { enabled: false, price: 9.90, label: "Entrega PrioritÃ¡ria (VIP)" };
let ACTIVE_TAB = "best";

/* ===================== STORAGE KEYS ===================== */
const K_CART="vv_cart";
const K_COUPON="vv_coupon";
const K_COUPON_USED="vv_coupon_used";
const K_SIGNED="vv_signed";
const K_VIP="vv_vip";
const K_CHAT="vv_chat_history_v2";
const K_TICKETS="vv_tickets";
const K_ORDERS="vv_order_status";
const K_REVIEWS="vv_reviews";
const K_PRODUCTS="vv_products";
const K_ADMIN_PW="vv_admin_pw";
const K_ADMIN_AUTH="vv_admin_auth";

/* ===================== HELPERS ===================== */
const el = (id)=>document.getElementById(id);
function money(n){ return n.toLocaleString("pt-BR", {style:"currency", currency:"BRL"}); }
function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
function loadJSON(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch{ return null; } }
function toast(msg){ const t=el("toast"); t.textContent=msg; t.classList.add("show"); setTimeout(()=>t.classList.remove("show"), 1800); }
function scrollToTop(){ window.scrollTo({top:0, behavior:"smooth"}); }
function scrollToEl(sel){ const node=document.querySelector(sel); if(node) node.scrollIntoView({behavior:"smooth", block:"start"}); }
function escapeHTML(s){ return (s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function copyText(txt){ navigator.clipboard?.writeText(txt); toast("Copiado âœ…"); }
function labelCat(c){ return c==="packs"?"Packs":c==="servicos"?"ServiÃ§os":c==="premium"?"Premium":c==="extras"?"Extras":"Geral"; }

/* ===================== DATA ===================== */
const DEFAULT_PRODUCTS = [
  { id:"pack_001", name:"Pack Viral Starter", img:"", video:"", descLong:"", cat:"packs", price:29.90, badge:"Popular", tags:["rÃ¡pido","digital"], best:true },
  { id:"pack_002", name:"Pack Premium Creator", img:"", video:"", descLong:"", cat:"premium", price:59.90, badge:"Premium", tags:["pro","top"], best:true },
  { id:"srv_001",  name:"Setup Loja + Anti-golpe", img:"", video:"", descLong:"", cat:"servicos", price:79.90, badge:"ServiÃ§o", tags:["site","seguranÃ§a"], new:true },
  { id:"ext_001",  name:"Extras â€¢ PersonalizaÃ§Ã£o", img:"", video:"", descLong:"", cat:"extras", price:19.90, badge:"Extra", tags:["estilo","design"], new:true },
  { id:"pack_003", name:"Pack Social Boost", img:"", video:"", descLong:"", cat:"packs", price:39.90, badge:"Trend", tags:["social","conteÃºdo"], best:true },
  { id:"srv_002",  name:"Ajuste & Bug Fix", img:"", video:"", descLong:"", cat:"servicos", price:49.90, badge:"Fix", tags:["rÃ¡pido","suporte"], new:true },
  { id:"prem_002", name:"VIP â€¢ Entrega PrioritÃ¡ria", img:"", video:"", descLong:"", cat:"premium", price:24.90, badge:"VIP", tags:["prioridade","vip"], best:true },
  { id:"ext_002",  name:"Cupom/PromoÃ§Ãµes", img:"", video:"", descLong:"", cat:"extras", price:14.90, badge:"Promo", tags:["cupom","vendas"], new:true }
];

let PRODUCTS = loadJSON(K_PRODUCTS) || DEFAULT_PRODUCTS;

/* ===================== STATE ===================== */
const vipSaved = loadJSON(K_VIP);
VIP_UPSELL.enabled = !!(vipSaved && vipSaved.enabled);

const state = {
  cart: loadJSON(K_CART) || [],
  coupon: loadJSON(K_COUPON) || null,
  signed: loadJSON(K_SIGNED) || null,
};

function calcSubtotal(){ return state.cart.reduce((s,i)=>s+i.price*i.qty,0); }
function calcVip(){ return VIP_UPSELL.enabled ? VIP_UPSELL.price : 0; }
function calcDiscount(subtotal){ if(!state.coupon) return 0; return Math.max(0, subtotal*(state.coupon.pct/100)); }
function calcTotal(subtotal, discount){ return Math.max(0, subtotal - discount + calcVip()); }
function toggleVIP(on){ VIP_UPSELL.enabled=!!on; saveJSON(K_VIP,{enabled:VIP_UPSELL.enabled}); updateCartUI(); toast(on?"VIP ativado âš¡":"VIP desativado"); }

/* ===================== PRODUCTS UI ===================== */
function setTab(tab){
  ACTIVE_TAB = tab;
  const b = el("tabBest"), n = el("tabNew"), a = el("tabAll");
  [b,n,a].forEach(x=>x && x.classList.remove("active"));
  if(tab==="best" && b) b.classList.add("active");
  if(tab==="new" && n) n.classList.add("active");
  if(tab==="all" && a) a.classList.add("active");
  renderProducts();
  toast(tab==="best" ? "Mais vendidos ğŸ”¥" : tab==="new" ? "Novidades âœ¨" : "Tudo ğŸ“¦");
}

function renderProducts(){
  const q=(el("q").value||"").trim().toLowerCase();
  const cat=el("cat").value;
  const sort=el("sort").value;

  let list = PRODUCTS.filter(p=>{
    const okQ = !q || (p.name.toLowerCase().includes(q) || (p.tags||[]).join(" ").toLowerCase().includes(q));
    const okC = !cat || p.cat===cat;
    const okTab = (ACTIVE_TAB==='all') || (ACTIVE_TAB==='best' && p.best) || (ACTIVE_TAB==='new' && p.new);
    return okQ && okC && okTab;
  });

  if(sort==="priceAsc") list.sort((a,b)=>a.price-b.price);
  if(sort==="priceDesc") list.sort((a,b)=>b.price-a.price);

  const grid=el("grid");
  grid.innerHTML="";

  if(list.length===0){
    grid.innerHTML = `<div class="panel" style="grid-column:1/-1"><div class="pBody tiny muted">Nada encontrado. Tente outra busca.</div></div>`;
    reveal();
    return;
  }

  list.forEach(p=>{
    const card=document.createElement("div");
    card.className="card fade";
    card.innerHTML=`
      <div class="thumb"><div class="sticker">${escapeHTML(p.badge||"Item")}</div></div>
      <div class="cBody">
        <b>${escapeHTML(p.name)}</b>
        <div class="tag">ğŸ·ï¸ ${escapeHTML(labelCat(p.cat))} â€¢ <span class="price">${money(p.price)}</span></div>
        <div class="tag">âœ¨ ${(p.tags||[]).map(escapeHTML).join(" â€¢ ")}</div>
        <div class="buyRow">
          <button class="miniBtn" onclick="toast('${escapeHTML(p.name)} â€¢ ${money(p.price)}')">Detalhes</button>
          <button class="miniBtn accent" onclick="addToCart('${p.id}')">Adicionar</button>
        </div>
      </div>`;
    grid.appendChild(card);
  });

  reveal();
}

function renderSkeleton(){
  const sk=el("gridSkeleton");
  sk.innerHTML="";
  for(let i=0;i<8;i++){
    const d=document.createElement("div");
    d.className="skeleton";
    sk.appendChild(d);
  }
}

/* ===================== CART ===================== */
function addToCart(id){
  const p=PRODUCTS.find(x=>x.id===id); if(!p) return;
  const it=state.cart.find(i=>i.id===id);
  if(it) it.qty++; else state.cart.push({id:p.id,name:p.name,price:p.price,qty:1});
  saveJSON(K_CART, state.cart);
  updateCartUI();
  toast("Adicionado âœ…");
}
function inc(id){ const it=state.cart.find(i=>i.id===id); if(!it) return; it.qty++; saveJSON(K_CART, state.cart); updateCartUI(); }
function dec(id){ const it=state.cart.find(i=>i.id===id); if(!it) return; it.qty--; if(it.qty<=0) state.cart=state.cart.filter(x=>x.id!==id); saveJSON(K_CART, state.cart); updateCartUI(); }
function rm(id){ state.cart=state.cart.filter(x=>x.id!==id); saveJSON(K_CART, state.cart); updateCartUI(); }

function couponEligible(){ return !localStorage.getItem(K_COUPON_USED); }
function applyCoupon(code){
  code=(code||"").trim().toUpperCase();
  if(code!==WELCOME_COUPON.code){ toast("Cupom invÃ¡lido"); return; }
  if(!couponEligible()){ toast("Cupom jÃ¡ foi usado neste aparelho"); return; }
  state.coupon={code:WELCOME_COUPON.code,pct:WELCOME_COUPON.pct,appliedAt:new Date().toISOString()};
  saveJSON(K_COUPON, state.coupon);
  updateCartUI();
  toast("Cupom aplicado âœ…");
}

function updateCartUI(){
  el("cartCount").textContent = state.cart.reduce((s,i)=>s+i.qty,0);

  const list=el("cartList");
  list.innerHTML="";
  if(state.cart.length===0){
    list.innerHTML = `<div class="panel"><div class="pBody tiny muted">Seu carrinho estÃ¡ vazio. Adicione um item para continuar.</div></div>`;
  } else {
    state.cart.forEach(i=>{
      const div=document.createElement("div");
      div.className="item";
      div.innerHTML=`
        <div class="iThumb">VV</div>
        <div class="iMain">
          <b>${escapeHTML(i.name)}</b>
          <div class="tiny muted">${money(i.price)} â€¢ <span class="mono">${escapeHTML(i.id)}</span></div>
          <div class="qtyRow">
            <button class="qbtn" onclick="dec('${i.id}')">âˆ’</button>
            <div class="qval">${i.qty}</div>
            <button class="qbtn" onclick="inc('${i.id}')">+</button>
            <button class="rm" onclick="rm('${i.id}')">Remover</button>
          </div>
        </div>`;
      list.appendChild(div);
    });
  }

  if(couponEligible()){
    el("couponStatus").textContent="DisponÃ­vel âœ… (uso Ãºnico por cliente neste aparelho)";
    el("oneUseHint").textContent="Cupom disponÃ­vel (uso Ãºnico).";
  } else {
    el("couponStatus").textContent="Cupom jÃ¡ usado neste aparelho âœ…";
    el("oneUseHint").textContent="Cupom jÃ¡ usado neste aparelho.";
    if(state.coupon){ state.coupon=null; saveJSON(K_COUPON, state.coupon); }
  }

  const subtotal=calcSubtotal();
  const discount=calcDiscount(subtotal);
  const total=calcTotal(subtotal, discount);

  el("subTotal").textContent=money(subtotal);
  el("discount").textContent="- "+money(discount);
  el("vipLine").textContent=money(calcVip());
  el("grandTotal").textContent=money(total);

  const vipToggle = el("vipToggle");
  if(vipToggle) vipToggle.checked = VIP_UPSELL.enabled;

  el("couponAppliedInfo").textContent = state.coupon
    ? `Cupom aplicado: ${state.coupon.code} (${state.coupon.pct}% OFF)`
    : "Nenhum cupom aplicado.";

  // Se o total mudou, invalida assinatura antiga
  if(state.signed && Math.abs(state.signed.total - total) > 0.001){
    state.signed=null; saveJSON(K_SIGNED, state.signed);
    el("vvStatus").textContent="Aguardandoâ€¦"; el("vvStatus").className="chip";
    el("vvDetail").textContent="";
  }
}

/* Drawer */
function openCart(){ el("overlay").classList.add("open"); el("drawer").classList.add("open"); updateCartUI(); }
function closeCart(){ el("overlay").classList.remove("open"); el("drawer").classList.remove("open"); }

/* ===================== WORKER / SIGN ===================== */
async function checkWorker(){
  try{
    const r=await fetch(WORKER_URL, {method:"GET"});
    const j=await r.json().catch(()=>null);
    if(r.ok && j && j.ok){
      el("workerPill").className="chip ok";
      el("workerPill").textContent="â— Online";
    } else {
      el("workerPill").className="chip bad";
      el("workerPill").textContent="â— InstÃ¡vel";
    }
  }catch{
    el("workerPill").className="chip bad";
    el("workerPill").textContent="â— Offline";
  }
}

async function sha256Base64Url(str){
  const enc = new TextEncoder().encode(str);
  const buf = await crypto.subtle.digest("SHA-256", enc);
  const bytes = new Uint8Array(buf);
  let bin=""; for(const b of bytes) bin += String.fromCharCode(b);
  return btoa(bin).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"");
}

function ordersDB(){ return loadJSON(K_ORDERS) || {}; }
function setOrderStatus(orderId, status){
  const db = ordersDB();
  db[orderId] = { status, ts:new Date().toISOString() };
  saveJSON(K_ORDERS, db);
}

async function createSignedOrder(){
  if(state.cart.length===0){ toast("Carrinho vazio"); return; }

  const name=(el("custName").value||"").trim();
  const wpp=(el("custWpp").value||"").trim().replace(/\D/g,"");
  if(!name || wpp.length<10){ toast("Preencha nome e WhatsApp"); return; }

  const subtotal=calcSubtotal();
  const discount=calcDiscount(subtotal);
  const total=calcTotal(subtotal, discount);

  const itemsPayload = state.cart.map(i=>({id:i.id,name:i.name,qty:i.qty,price:Number(i.price.toFixed(2))}));
  const itemsHash = await sha256Base64Url(JSON.stringify(itemsPayload));
  const user = `${wpp}:${name}`.toLowerCase();

  el("vvStatus").className="chip";
  el("vvStatus").textContent="Gerandoâ€¦";
  el("vvDetail").textContent="Conectando ao servidor VV-OFICIALâ€¦";

  try{
    const resp = await fetch(WORKER_URL + "/", {
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ user, total:Number(total.toFixed(2)), items: itemsPayload, itemsHash })
    });
    const data = await resp.json().catch(()=>null);

    if(!resp.ok || !data || !data.ok){
      const msg=(data && data.error)?data.error:("Erro HTTP "+resp.status);
      el("vvStatus").className="chip bad";
      el("vvStatus").textContent="Falhou";
      el("vvDetail").textContent=msg;
      toast("Falha ao gerar assinatura");
      return;
    }

    state.signed = { ts:data.ts, orderId:data.orderId, sig:data.sig, note:data.note||"", total:Number(total.toFixed(2)), itemsHash };
    saveJSON(K_SIGNED, state.signed);

    el("vvStatus").className="chip ok";
    el("vvStatus").textContent="âœ… Verificado";
    el("vvDetail").textContent=`Order ID: ${data.orderId}`;
    toast("Pedido VV-OFICIAL gerado âœ…");

    // cria status inicial
    setOrderStatus(data.orderId, "Gerado");

  }catch{
    el("vvStatus").className="chip bad";
    el("vvStatus").textContent="Falhou";
    el("vvDetail").textContent="Sem conexÃ£o com o Worker.";
    toast("Sem conexÃ£o com servidor");
  }
}

/* WhatsApp finalize */
function buildWhatsAppText(extraTitle){
  const name=(el("custName").value||"").trim();
  const wpp=(el("custWpp").value||"").trim().replace(/\D/g,"");
  const note=(el("custNote").value||"").trim();
  const rf = el("receiptFile");

  const subtotal=calcSubtotal();
  const discount=calcDiscount(subtotal);
  const total=calcTotal(subtotal, discount);

  const lines=[];
  lines.push(`âœ… *${STORE_NAME}* â€” ${extraTitle||"Pedido VV-OFICIAL"}`);
  if(name) lines.push(`ğŸ‘¤ Cliente: *${name}*`);
  if(wpp) lines.push(`ğŸ“± WhatsApp: *${wpp}*`);
  lines.push(``);
  lines.push(`ğŸ§¾ Itens:`);
  state.cart.forEach(i=>lines.push(`â€¢ ${i.qty}x ${i.name} â€” ${money(i.price)}`));
  lines.push(``);
  if(state.coupon) lines.push(`ğŸŸï¸ Cupom: *${state.coupon.code}* (${state.coupon.pct}% OFF)`);
  if(VIP_UPSELL.enabled) lines.push(`âš¡ VIP: *${VIP_UPSELL.label}* (+ ${money(VIP_UPSELL.price)})`);
  lines.push(`ğŸ’° Total: *${money(total)}*`);
  lines.push(``);

  if(state.signed){
    lines.push(`ğŸ›¡ï¸ VV-OFICIAL: *${state.signed.sig}*`);
    lines.push(`ğŸ†” Order ID: *${state.signed.orderId}*`);
    lines.push(`â±ï¸ Timestamp: ${state.signed.ts}`);
    lines.push(`ğŸ” itemsHash: ${state.signed.itemsHash}`);
  } else {
    lines.push(`âš ï¸ Sem assinatura VV-OFICIAL â€” gere no checkout antes de pagar.`);
  }

  if(rf && rf.files && rf.files[0]){
    lines.push(``);
    lines.push(`ğŸ“ Comprovante: vou anexar a foto no WhatsApp agora.`);
  }
  if(note){ lines.push(``); lines.push(`ğŸ“ Obs: ${note}`); }

  return encodeURIComponent(lines.join("\n"));
}

function sendToWhatsApp(){
  if(state.cart.length===0){ toast("Carrinho vazio"); return; }
  if(!state.signed){ toast("Gere o pedido VV-OFICIAL primeiro"); return; }

  // Marca cupom como usado ao finalizar
  if(state.coupon && couponEligible()){
    localStorage.setItem(K_COUPON_USED,"1");
    state.coupon=null;
    saveJSON(K_COUPON, state.coupon);
    updateCartUI();
  }

  const base = `https://wa.me/${SUPPORT_WHATSAPP_NUMBER}`;
  window.open(base + `?text=${buildWhatsAppText("Pedido VV-OFICIAL")}`, "_blank");
}

function alreadyPaid(){
  if(!state.signed){ toast("Gere o pedido VV-OFICIAL primeiro"); return; }
  const base = `https://wa.me/${SUPPORT_WHATSAPP_NUMBER}`;
  window.open(base + `?text=${buildWhatsAppText("âœ… JÃ¡ paguei â€” vou enviar comprovante")}`, "_blank");
}

/* ===================== ORDER STATUS ===================== */
function checkOrderStatus(){
  const id=(el("verifyOrder").value||"").trim();
  if(!id){ toast("Cole o Order ID"); return; }
  const db=ordersDB();
  const rec=db[id];
  if(!rec){
    el("verifyStatus").className="chip bad";
    el("verifyStatus").textContent="NÃ£o encontrado";
    el("verifyDetail").textContent="Esse Order ID nÃ£o estÃ¡ no histÃ³rico deste aparelho. Se vocÃª acabou de gerar, tente novamente. (Em versÃ£o futura, isso pode virar um painel online.)";
    return;
  }
  el("verifyStatus").className="chip ok";
  el("verifyStatus").textContent=rec.status;
  el("verifyDetail").textContent=`Atualizado em ${new Date(rec.ts).toLocaleString("pt-BR")}`;
}

/* ===================== CHAT (UPGRADES) ===================== */
const chatState = { msgCount:0, rated:false };

function playPing(){
  try{
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine"; o.frequency.value = 880;
    g.gain.value = 0.0001;
    o.connect(g); g.connect(ctx.destination);
    o.start();
    g.gain.exponentialRampToValueAtTime(0.08, ctx.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.20);
    o.stop(ctx.currentTime + 0.22);
    setTimeout(()=>ctx.close?.(), 350);
  }catch(e){}
}

function saveChatMessage(payload){
  const data = loadJSON(K_CHAT) || [];
  data.push(payload);
  saveJSON(K_CHAT, data.slice(-70));
}

function appendChat(text, isMe=false, allowHtml=false, silent=false){
  const box=el("sBody");
  const div=document.createElement("div");
  div.className="msg" + (isMe ? " me" : "");
  if(allowHtml) div.innerHTML = text;
  else div.textContent = text;
  box.appendChild(div);
  box.scrollTop=box.scrollHeight;
  if(!silent){
    saveChatMessage({ ts:new Date().toISOString(), me:!!isMe, html: allowHtml?String(text):null, text: allowHtml?null:String(text) });
  }
}

function loadChatHistory(){
  const data = loadJSON(K_CHAT);
  if(!data || !Array.isArray(data) || data.length===0) return;
  data.slice(-40).forEach(m=>appendChat(m.html || m.text || "", !!m.me, !!m.html, true));
}

function clearChat(){
  localStorage.removeItem(K_CHAT);
  el("sBody").innerHTML = `
    <div class="msg">Chat limpo âœ… Me diga sua dÃºvida.</div>
    <div class="msg"><span class="tiny muted">Dica: para pedidos, envie <b>Order ID</b> + <b>VV-OFICIAL</b>.</span></div>
  `;
  chatState.msgCount=0; chatState.rated=false;
  toast("Chat limpo âœ…");
}

function toggleSupport(open){
  const m=el("support");
  if(open){ m.classList.add("open"); setTimeout(()=>el("sInput").focus(), 80); }
  else m.classList.remove("open");
}

function quickReply(topic){
  appendChat(topic, true);
  const resp = smartBotReply(topic) || "Certo âœ… Me diga sua dÃºvida com detalhes.";
  setTimeout(()=>appendChat(resp, false, true), 320);
}

function shouldEscalate(text){
  const t=(text||"").toLowerCase();
  return /(atendente|humano|pessoa|urgente|reclama|reembolso|golpe|fraude|nÃ£o funcionou|nao funcionou|nÃ£o consigo|nao consigo)/.test(t);
}

function smartBotReply(text){
  const t=(text||"").toLowerCase();
  if(/pix|pagar|pagamento|chave/.test(t)){
    return [
      "<b>Pagamento via PIX</b> âœ…",
      "1) Abra o <b>checkout</b> â†’ clique em <b>Gerar pedido VV-OFICIAL</b>.",
      "2) Depois clique em <b>Finalizar no WhatsApp</b>.",
      "3) Pague o PIX e mande o comprovante no atendimento.",
      "<span class='tiny muted'>Dica: confirme WhatsApp oficial + Order ID + VV-OFICIAL.</span>"
    ].join("<br>");
  }
  if(/prazo|entrega|demora|quando chega/.test(t)){
    return [
      "<b>Prazo de entrega</b> ğŸ“¦",
      "Produtos digitais geralmente sÃ£o enviados apÃ³s a confirmaÃ§Ã£o do pagamento.",
      "Se tiver pressa, escreva <b>â€œentrega hojeâ€</b> no WhatsApp.",
      "<span class='tiny muted'>Se quiser, mande seu <b>Order ID</b> aqui.</span>"
    ].join("<br>");
  }
  if(/cupom|desconto|bemvindo10/.test(t)){
    return [
      "<b>Cupom BEMVINDO10</b> ğŸŸï¸",
      "DÃ¡ <b>10% OFF</b> e aparece no checkout.",
      "Uso Ãºnico por cliente (por aparelho).",
      "Para aplicar: checkout â†’ clique em <b>Aplicar</b>."
    ].join("<br>");
  }
  if(/vv|oficial|assinatura|anti|golpe|fraude|verific/.test(t)){
    return [
      "<b>VV-OFICIAL (anti-golpe)</b> ğŸ›¡ï¸",
      "O servidor gera <b>Order ID</b> + <b>assinatura</b>.",
      "Sem <b>âœ… Verificado</b>, nÃ£o finalize.",
      "<span class='tiny muted'>Isso reduz risco, mas sempre confirme os dados oficiais.</span>"
    ].join("<br>");
  }
  if(/troca|reembolso|devolu|cancel/.test(t)){
    return [
      "<b>Troca / Reembolso</b> ğŸ”",
      "Se houve erro na entrega ou problema tÃ©cnico, o suporte resolve.",
      "Envie: <b>Order ID</b> + descriÃ§Ã£o do problema.",
      "Se preferir, clique em <b>Falar com atendente</b>."
    ].join("<br>");
  }
  if(t.length<3) return null;
  return "Entendi âœ… Me diga se Ã© sobre <b>PIX</b>, <b>prazo</b>, <b>cupom</b> ou <b>VV-OFICIAL</b>.";
}

function sendReceiptHelp(){
  appendChat("ğŸ“ Quero enviar comprovante", true);
  const resp = [
    "<b>Enviar comprovante</b> ğŸ“",
    "1) Gere o pedido <b>VV-OFICIAL</b>.",
    "2) Clique em <b>Finalizar no WhatsApp</b>.",
    "3) No WhatsApp, toque no Ã­cone ğŸ“ e anexe a foto.",
    "<span class='tiny muted'>Dica: envie junto com seu <b>Order ID</b>.</span>"
  ].join("<br>");
  setTimeout(()=>appendChat(resp, false, true), 320);
}

function sendOrderIdToChat(){
  const id = state.signed?.orderId || (el("chatOrderId").value||"").trim();
  if(!id){ toast("Ainda nÃ£o hÃ¡ Order ID"); return; }
  appendChat(`ğŸ†” Meu Order ID: ${id}`, true);
}

function appendChatButton(label, onClick){
  const box=el("sBody");
  const wrap=document.createElement("div");
  wrap.className="msg"; wrap.style.maxWidth="100%";
  const btn=document.createElement("button");
  btn.className="btn accent"; btn.type="button"; btn.textContent=label;
  btn.onclick=()=>{ try{ onClick(); }catch(e){ console.error(e); } };
  wrap.appendChild(btn);
  box.appendChild(wrap);
  box.scrollTop=box.scrollHeight;
}

function appendRatingButtons(){
  const box=el("sBody");
  const wrap=document.createElement("div");
  wrap.className="msg"; wrap.style.maxWidth="100%";
  const row=document.createElement("div");
  row.style.display="flex"; row.style.gap="8px"; row.style.flexWrap="wrap";
  for(let i=1;i<=5;i++){
    const b=document.createElement("button");
    b.className="copyBtn"; b.type="button"; b.textContent=`${i}â­`;
    b.onclick=()=>{ appendChat(`AvaliaÃ§Ã£o enviada: ${i}/5 â­ â€” obrigado!`, true); toast("Valeu pela avaliaÃ§Ã£o âœ…"); };
    row.appendChild(b);
  }
  wrap.appendChild(row);
  box.appendChild(wrap);
  box.scrollTop=box.scrollHeight;
}

function makeTicketId(){
  const rnd = Math.random().toString(36).slice(2,6).toUpperCase();
  const ts = Date.now().toString().slice(-6);
  return `VV-TICKET-${ts}-${rnd}`;
}
function openTicket(){
  const id = makeTicketId();
  const name = (el("chatName")?.value||"").trim();
  const orderId = (el("chatOrderId")?.value||"").trim() || (state.signed?.orderId || "");
  appendChat(`ğŸ« Chamado aberto: ${id}`, true);
  const msg=[
    `<b>Chamado criado âœ…</b>`,
    `ID: <span class="mono">${id}</span>`,
    name?`Nome: <b>${escapeHTML(name)}</b>`:"",
    orderId?`Order ID: <b>${escapeHTML(orderId)}</b>`:"",
    `<span class="tiny muted">Clique em <b>Falar com atendente</b> para enviar.</span>`
  ].filter(Boolean).join("<br>");
  setTimeout(()=>appendChat(msg,false,true),320);
  const tickets = loadJSON(K_TICKETS) || [];
  tickets.push({id, ts:new Date().toISOString(), name, orderId});
  saveJSON(K_TICKETS, tickets.slice(-40));
  refreshTicketsUI();
}

function callHuman(reasonText){
  playPing();
  const name = (el("chatName")?.value||"").trim();
  const orderId = (el("chatOrderId")?.value||"").trim() || (state.signed?.orderId || "");

  const lines=[];
  lines.push(`ğŸ‘¤ *Atendimento humano â€” ${STORE_NAME}*`);
  if(name) lines.push(`Nome: *${name}*`);
  if(orderId) lines.push(`Order ID: *${orderId}*`);
  if(state.signed?.sig) lines.push(`VV-OFICIAL: *${state.signed.sig}*`);
  lines.push(`Motivo: ${reasonText||"Cliente pediu atendente"}`);

  const text = encodeURIComponent(lines.join("\n"));
  const base = `https://wa.me/${SUPPORT_WHATSAPP_NUMBER}`;
  window.open(base + `?text=${text}`, "_blank");
}

function sendSupport(){
  const input=el("sInput");
  const text=(input.value||"").trim();
  if(!text) return;

  // anti-spam simples
  if(chatState.lastTs && (Date.now()-chatState.lastTs)<900){ toast("Aguarde um poucoâ€¦"); return; }
  chatState.lastTs = Date.now();

  appendChat(text, true);
  input.value="";

  const resp = smartBotReply(text);
  if(resp){ setTimeout(()=>appendChat(resp, false, true), 420); }

  if(shouldEscalate(text)){
    setTimeout(()=>{
      appendChat("Entendi âœ… Se preferir, posso te passar para um atendente humano agora.", false, true);
      playPing();
      appendChatButton("ğŸ‘¤ Falar com atendente", ()=>callHuman(text));
    }, 650);
  }

  chatState.msgCount++;
  if(!chatState.rated && chatState.msgCount>=4){
    chatState.rated=true;
    setTimeout(()=>{
      appendChat("Antes de vocÃª sair: como foi o suporte? â­", false, true);
      appendRatingButtons();
    }, 900);
  }
}

/* ===================== REVIEWS ===================== */
function reviewsDB(){ return loadJSON(K_REVIEWS) || []; }
function isOrderKnown(orderId){
  if(!orderId) return false;
  const db=ordersDB();
  return !!db[orderId];
}
function starsStr(n){
  n = Number(n||5);
  return "â˜…â˜…â˜…â˜…â˜…â˜†â˜†â˜†â˜†â˜†".slice(5-n, 10-n);
}
function submitReview(){
  const name=(el("revName").value||"").trim() || "Cliente";
  const stars=Number(el("revStars").value||5);
  const order=(el("revOrder").value||"").trim();
  const text=(el("revText").value||"").trim();
  if(text.length<6){ toast("Escreva um pouco mais"); return; }

  const verified = isOrderKnown(order);
  const db=reviewsDB();
  db.unshift({ name, stars, order: order||null, verified, text, ts:new Date().toISOString() });
  saveJSON(K_REVIEWS, db.slice(0, 24));
  el("revText").value="";
  toast("AvaliaÃ§Ã£o publicada âœ…");
  renderReviews();
}
function renderReviews(){
  const grid=el("reviewsGrid");
  const db=reviewsDB();
  if(db.length===0){
    grid.innerHTML = `<div class="panel" style="grid-column:1/-1"><div class="pBody tiny muted">Sem avaliaÃ§Ãµes ainda. Seja o primeiro âœ…</div></div>`;
    return;
  }
  grid.innerHTML="";
  db.slice(0,8).forEach(r=>{
    const card=document.createElement("div");
    card.className="reviewCard";
    card.innerHTML = `
      <div class="stars">${escapeHTML(starsStr(r.stars))}</div>
      <div class="quote">â€œ${escapeHTML(r.text)}â€</div>
      <div class="who">
        <span>${escapeHTML(r.name)}</span>
        <span>${r.verified ? `<span class="pill2 ok">âœ… verificado</span>` : `<span class="pill2">nÃ£o verificado</span>`}</span>
      </div>
      ${r.order ? `<div class="tiny muted">Order ID: <span class="mono">${escapeHTML(r.order)}</span></div>` : ``}
    `;
    grid.appendChild(card);
  });
}

/* ===================== ADMIN ===================== */
function isAdminAuthed(){ return localStorage.getItem(K_ADMIN_AUTH)==="1"; }

function openAdmin(){
  // auth
  if(!localStorage.getItem(K_ADMIN_PW)){
    const pw = prompt("Crie uma senha para o Admin (guarde bem):");
    if(!pw || pw.length<4){ toast("Senha invÃ¡lida"); return; }
    localStorage.setItem(K_ADMIN_PW, pw);
    localStorage.setItem(K_ADMIN_AUTH, "1");
    toast("Senha criada âœ…");
  } else if(!isAdminAuthed()){
    const pw = prompt("Senha do Admin:");
    if(pw !== localStorage.getItem(K_ADMIN_PW)){ toast("Senha incorreta"); return; }
    localStorage.setItem(K_ADMIN_AUTH, "1");
  }
  el("adminWrap").classList.add("open");
  renderAdminProducts();
  refreshTicketsUI();
}

function hideAdmin(){ el("adminWrap").classList.remove("open"); }
function closeAdmin(e){ if(e && e.target && e.target.id==="adminWrap") hideAdmin(); }
function setAdminPassword(){
  if(!isAdminAuthed()){ toast("Entre no admin primeiro"); return; }
  const pw = prompt("Nova senha do Admin:");
  if(!pw || pw.length<4){ toast("Senha invÃ¡lida"); return; }
  localStorage.setItem(K_ADMIN_PW, pw);
  toast("Senha atualizada âœ…");
}
function logoutAdmin(){ localStorage.removeItem(K_ADMIN_AUTH); toast("Saiu do admin"); hideAdmin(); }

function renderAdminProducts(){
  if(!isAdminAuthed()) return;
  const t=el("prodTable");
  const head=`
    <tr>
      <th>ID</th><th>Nome</th><th>Categoria</th><th>PreÃ§o</th><th>Badge</th><th>Tags</th><th>Best</th><th>New</th><th>AÃ§Ãµes</th>
    </tr>`;
  const rows = PRODUCTS.map((p,idx)=>`
    <tr>
      <td><input class="input" style="padding:10px 12px" value="${escapeHTML(p.id)}" data-k="id" data-i="${idx}"></td>
      <td><input class="input" style="padding:10px 12px" value="${escapeHTML(p.name)}" data-k="name" data-i="${idx}"></td>
      <td>
        <select class="input select" style="padding:10px 12px" data-k="cat" data-i="${idx}">
          ${["packs","servicos","premium","extras"].map(c=>`<option value="${c}" ${p.cat===c?"selected":""}>${labelCat(c)}</option>`).join("")}
        </select>
      </td>
      <td><input class="input" style="padding:10px 12px" value="${Number(p.price||0).toFixed(2)}" data-k="price" data-i="${idx}"></td>
      <td><input class="input" style="padding:10px 12px" value="${escapeHTML(p.badge||"")}" data-k="badge" data-i="${idx}"></td>
      <td><input class="input" style="padding:10px 12px" value="${escapeHTML((p.tags||[]).join(", "))}" data-k="tags" data-i="${idx}"></td>
      <td style="text-align:center"><input type="checkbox" ${p.best?"checked":""} data-k="best" data-i="${idx}"></td>
      <td style="text-align:center"><input type="checkbox" ${p.new?"checked":""} data-k="new" data-i="${idx}"></td>
      <td style="white-space:nowrap">
        <button class="btn" onclick="deleteProduct(${idx})">Excluir</button>
      </td>
    </tr>`).join("");
  t.innerHTML = head + rows;

  // bind changes
  t.querySelectorAll("input,select").forEach(inp=>{
    inp.addEventListener("change", ()=>{
      const i=Number(inp.dataset.i);
      const k=inp.dataset.k;
      if(!PRODUCTS[i]) return;
      if(k==="best"||k==="new"){
        PRODUCTS[i][k] = !!inp.checked;
      } else if(k==="price"){
        PRODUCTS[i][k] = Number(String(inp.value).replace(",", ".")) || 0;
      } else if(k==="tags"){
        PRODUCTS[i][k] = String(inp.value||"").split(",").map(s=>s.trim()).filter(Boolean);
      } else {
        PRODUCTS[i][k] = String(inp.value||"").trim();
      }
    });
  });
}

function addProduct(){
  if(!isAdminAuthed()) return;
  PRODUCTS.unshift({ id:"novo_"+Math.random().toString(36).slice(2,6), name:"Novo produto", cat:"extras", price:9.90, badge:"Novo", tags:["digital"], new:true });
  renderAdminProducts();
  toast("Produto adicionado");
}

function deleteProduct(idx){
  if(!isAdminAuthed()) return;
  const p=PRODUCTS[idx];
  if(!confirm(`Excluir "${p?.name}"?`)) return;
  PRODUCTS.splice(idx,1);
  renderAdminProducts();
  toast("ExcluÃ­do");
}

function saveProducts(){
  if(!isAdminAuthed()) return;
  // sanitize unique ids
  const seen=new Set();
  PRODUCTS = PRODUCTS.filter(p=>p && p.id && !seen.has(p.id) && (seen.add(p.id), true));
  saveJSON(K_PRODUCTS, PRODUCTS);
  toast("Produtos salvos âœ…");
  setTab(ACTIVE_TAB);
}

function resetProducts(){
  if(!isAdminAuthed()) return;
  if(!confirm("Resetar para produtos padrÃ£o?")) return;
  PRODUCTS = JSON.parse(JSON.stringify(DEFAULT_PRODUCTS));
  saveJSON(K_PRODUCTS, PRODUCTS);
  renderAdminProducts();
  setTab("best");
  toast("Resetado âœ…");
}

function setOrderStatusAdmin(){
  if(!isAdminAuthed()) return;
  const order=(el("admOrder").value||"").trim();
  const status=el("admStatus").value;
  if(!order){ toast("Digite o Order ID"); return; }
  setOrderStatus(order, status);
  el("admOrderHint").textContent = `OK âœ… ${order} â†’ ${status}`;
  toast("Status atualizado âœ…");
}

function refreshTicketsUI(){
  const box=el("ticketList");
  const t=loadJSON(K_TICKETS) || [];
  if(!box) return;
  if(t.length===0){
    box.innerHTML = `<div class="small muted">Nenhum ticket ainda.</div>`;
    return;
  }
  box.innerHTML = t.slice(-12).reverse().map(x=>`
    <div class="panel" style="margin-bottom:10px">
      <div class="pBody tiny">
        <b class="mono">${escapeHTML(x.id)}</b>
        <div class="muted">Nome: ${escapeHTML(x.name||"-")} â€¢ Order: <span class="mono">${escapeHTML(x.orderId||"-")}</span></div>
        <div class="muted">${new Date(x.ts).toLocaleString("pt-BR")}</div>
      </div>
    </div>
  `).join("");
}

function hardReset(){
  if(!confirm("Isso vai apagar carrinho, chat e cupom deste aparelho. Continuar?")) return;
  [K_CART,K_COUPON,K_COUPON_USED,K_SIGNED,K_CHAT].forEach(k=>localStorage.removeItem(k));
  state.cart=[]; state.coupon=null; state.signed=null;
  updateCartUI();
  clearChat();
  toast("Reset local feito âœ…");
}

/* ===================== REVEAL ===================== */
function reveal(){
  document.querySelectorAll(".fade").forEach((n,i)=>{
    if(n.classList.contains("show")) return;
    setTimeout(()=>n.classList.add("show"), 40 + i*12);
  });
}
const io = new IntersectionObserver((entries)=>{
  for(const e of entries) if(e.isIntersecting) e.target.classList.add("show");
},{threshold:.12});
function initFade(){
  document.querySelectorAll(".fade").forEach(n=>io.observe(n));
  reveal();
}

/* ===================== INIT ===================== */
el("year").textContent = new Date().getFullYear();
renderSkeleton();
setTimeout(()=>{ el("gridSkeleton").style.display="none"; setTab("best"); }, 250);
updateCartUI();
checkWorker();
setTimeout(checkWorker, 1200);
renderReviews();
initFade();
loadChatHistory();
refreshTicketsUI();

document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){ toggleSupport(false); hideAdmin(); closeCart(); }
  if(e.key==="Enter" && document.activeElement===el("sInput")){
    sendSupport();
  }
});

/* ===== Upgrade 2: Checkout em 3 passos ===== */
let CHECKOUT_STEP = 1;

function showStep(n){
  CHECKOUT_STEP = Math.max(1, Math.min(3, n));
  const s1 = document.getElementById("step1");
  const s2 = document.getElementById("step2");
  const s3 = document.getElementById("step3");
  const p1 = document.getElementById("pill1");
  const p2 = document.getElementById("pill2");
  const p3 = document.getElementById("pill3");

  [s1,s2,s3].forEach(s=>s && s.classList.remove("active"));
  [p1,p2,p3].forEach(p=>p && p.classList.remove("active"));

  if(CHECKOUT_STEP===1){ s1 && s1.classList.add("active"); p1 && p1.classList.add("active"); }
  if(CHECKOUT_STEP===2){ s2 && s2.classList.add("active"); p2 && p2.classList.add("active"); }
  if(CHECKOUT_STEP===3){ s3 && s3.classList.add("active"); p3 && p3.classList.add("active"); }

  // Actions
  const back = document.getElementById("btnBack");
  const next = document.getElementById("btnNext");
  const sign = document.getElementById("btnSign");
  const wpp  = document.getElementById("btnWpp");
  const paid = document.getElementById("btnPaid");

  if(back) back.style.display = CHECKOUT_STEP===1 ? "none" : "inline-flex";

  if(CHECKOUT_STEP<3){
    if(next) next.style.display = "inline-flex";
    if(sign) sign.style.display = "none";
    if(wpp)  wpp.style.display  = "none";
    if(paid) paid.style.display = "none";
  }else{
    if(next) next.style.display = "none";
    if(sign) sign.style.display = "inline-flex";
    if(wpp)  wpp.style.display  = "inline-flex";
    if(paid) paid.style.display = "inline-flex";
  }

  const fs = document.getElementById("finalStatus");
  if(fs) fs.textContent = `Passo ${CHECKOUT_STEP}/3`;
}

function validateStep2(){
  const name = (document.getElementById("custName")?.value || "").trim();
  const wpp  = (document.getElementById("custWpp")?.value  || "").trim();

  if(!name || name.length < 2){
    toast("Digite seu nome para continuar âœ…");
    document.getElementById("custName")?.focus();
    return false;
  }
  if(!wpp || !/^[0-9]{10,13}$/.test(wpp)){
    toast("Digite seu WhatsApp com DDD (apenas nÃºmeros) âœ…");
    document.getElementById("custWpp")?.focus();
    return false;
  }
  return true;
}

function goStep(dir){
  // Step 1: precisa ter item
  if(CHECKOUT_STEP===1 && dir>0){
    if(!state.cart || state.cart.length===0){ toast("Seu carrinho estÃ¡ vazio."); return; }
  }
  // Step 2: validar dados
  if(CHECKOUT_STEP===2 && dir>0){
    if(!validateStep2()) return;
  }
  showStep(CHECKOUT_STEP + dir);
}

function openCartAtStep(step=1){
  toggleCart(true);
  showStep(step);
}

// Se abrir o carrinho, sempre comeÃ§ar no passo 1
const _oldToggleCart = window.toggleCart;
window.toggleCart = function(open){
  try{ _oldToggleCart(open); }catch(e){ /* ignore */ }
  if(open) setTimeout(()=>showStep(1), 50);
};
/* ===== end Upgrade 2 ===== */


/* ===== Upgrade 3: Prova social dinÃ¢mica ===== */
(function(){
  const FEED_LINES=[
    "ğŸ”¥ Produto em alta nas Ãºltimas horas",
    "ğŸ“¦ Pedido confirmado recentemente",
    "âœ¨ Novo visitante entrou agora",
    "ğŸ’¬ Cliente abriu o suporte",
    "âœ… Pedido VV-OFICIAL gerado",
    "ğŸ›’ Item adicionado ao carrinho"
  ];
  function todayKey(s){
    const d=new Date();
    return `vv_${s}_${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
  }
  function getInt(k,def=0){ const v=Number(localStorage.getItem(k)); return Number.isFinite(v)?v:def; }
  function setInt(k,v){ localStorage.setItem(k,String(v|0)); }

  const keyCarts=todayKey("carts");
  const keyOrders=todayKey("orders");

  const _oldAdd=window.addToCart;
  if(typeof _oldAdd==="function"){
    window.addToCart=function(){
      setInt(keyCarts,getInt(keyCarts,0)+1);
      return _oldAdd.apply(this,arguments);
    }
  }
  const _oldCreate=window.createSignedOrder;
  if(typeof _oldCreate==="function"){
    window.createSignedOrder=async function(){
      const r=await _oldCreate.apply(this,arguments);
      setTimeout(()=>{
        try{
          const ok=(document.getElementById("vvStatus")?.textContent||"").includes("Verificado")
                || (document.getElementById("vvVerified")?.textContent||"").includes("Verificado");
          if(ok) setInt(keyOrders,getInt(keyOrders,0)+1);
        }catch(e){}
      },400);
      return r;
    }
  }

  function tick(){
    const now=new Date();
    const mins=now.getHours()*60+now.getMinutes();
    let base=(mins>=420 && mins<=1380)?3:1;
    let sim=base+Math.floor(Math.random()*6);
    const lastKey="vv_live_viewing";
    const last=getInt(lastKey,sim);
    const viewing=Math.max(0,Math.min(18,Math.round((last*0.6)+(sim*0.4)+(Math.random()*1.5-0.7))));
    setInt(lastKey,viewing);

    const carts=getInt(keyCarts,0);
    const orders=getInt(keyOrders,0);

    const elV=document.getElementById("ps_viewing");
    const elC=document.getElementById("ps_carts");
    const elO=document.getElementById("ps_orders");
    const elF=document.getElementById("ps_feed");
    if(elV) elV.textContent=String(viewing);
    if(elC) elC.textContent=String(carts);
    if(elO) elO.textContent=String(orders);
    if(elF){
      const line=FEED_LINES[Math.floor(Math.random()*FEED_LINES.length)];
      const t=now.toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"});
      elF.textContent=`${t} â€¢ ${line}`;
    }
  }
  setInterval(tick,4500);
  setTimeout(tick,700);
})();
/* ===== end Upgrade 3 ===== */


/* ===== Upgrade 4: PÃ¡gina do produto (modal) + mÃ­dia ===== */
let PM_CURRENT=null;

function openProduct(id){
  const p=(PRODUCTS||[]).find(x=>x.id===id);
  if(!p) return;
  PM_CURRENT=p;

  el("pmSub").textContent = p.cat ? `Categoria: ${p.cat}` : "Detalhes e compra";
  el("pmTitle").textContent = p.name || "Produto";
  el("pmDesc").textContent = (p.descLong && p.descLong.trim()) ? p.descLong : (p.desc || "");

  const meta=el("pmMeta");
  meta.innerHTML="";
  const pills=[];
  pills.push({t: money(p.price), icon:"ğŸ’"});
  if(p.best) pills.push({t:"Mais vendido", icon:"ğŸ”¥"});
  if(p.new) pills.push({t:"Novo", icon:"âœ¨"});
  pills.push({t:"VV-OFICIAL", icon:"ğŸ›¡ï¸"});
  pills.forEach(x=>{
    const d=document.createElement("div");
    d.className="metaPill";
    d.textContent = `${x.icon} ${x.t}`;
    meta.appendChild(d);
  });

  const box=el("pmMedia");
  box.innerHTML="";
  const hasVideo=(p.video||"").trim();
  const hasImg=(p.img||"").trim();
  if(hasVideo){
    const v=document.createElement("video");
    v.controls=true; v.playsInline=true;
    v.src=hasVideo;
    box.appendChild(v);
  }else if(hasImg){
    const img=document.createElement("img");
    img.alt=p.name||"Produto";
    img.src=hasImg;
    box.appendChild(img);
  }else{
    const ph=document.createElement("div");
    ph.className="ph";
    ph.textContent="Sem mÃ­dia â€” adicione imagem/vÃ­deo no admin";
    box.appendChild(ph);
  }

  renderProductReviews(id);
  el("prodModalBack").classList.add("show");
  document.body.style.overflow="hidden";
}

function closeProdModal(evt){
  if(evt && evt.target && evt.target.id!=="prodModalBack") return;
  el("prodModalBack").classList.remove("show");
  document.body.style.overflow="";
}

function pmAddToCart(){
  if(!PM_CURRENT) return;
  addToCart(PM_CURRENT.id);
  toast("Adicionado âœ…");
}

function pmCopy(){
  if(!PM_CURRENT) return;
  const text = `${PM_CURRENT.name}\nPreÃ§o: ${money(PM_CURRENT.price)}\nCategoria: ${PM_CURRENT.cat||"-"}\nVV-OFICIAL: finalize com Order ID + assinatura`;
  navigator.clipboard?.writeText(text);
  toast("Copiado âœ…");
}

function productReviewKey(id){ return `vv_reviews_${id}`; }

function renderProductReviews(id){
  const box=el("pmReviews");
  const list=loadJSON(productReviewKey(id)) || [];
  if(list.length===0){
    box.innerHTML="<div class='tiny muted'>Ainda sem avaliaÃ§Ãµes. Seja o primeiro âœ…</div>";
    return;
  }
  box.innerHTML="";
  list.slice(-6).reverse().forEach(r=>{
    const d=document.createElement("div");
    d.className="revItem";
    d.innerHTML = `<b>${"â­".repeat(r.stars||5)}</b><div class="tiny muted">${escapeHTML(r.text||"")}</div><div class="tiny muted mono">${escapeHTML(r.ts||"")}</div>`;
    box.appendChild(d);
  });
}

function pmLeaveReview(stars){
  if(!PM_CURRENT) return;
  const t=(el("pmReviewText").value||"").trim();
  if(t.length<3){ toast("Escreva uma avaliaÃ§Ã£o curta âœ…"); return; }
  const hasOrder = !!(state && state.signed && state.signed.sig);
  if(!hasOrder){ toast("Gere um pedido VV-OFICIAL antes de avaliar âœ…"); return; }
  const key=productReviewKey(PM_CURRENT.id);
  const list=loadJSON(key) || [];
  list.push({stars:stars||5, text:t.slice(0,240), ts:new Date().toLocaleString("pt-BR")});
  saveJSON(key, list.slice(-50));
  el("pmReviewText").value="";
  renderProductReviews(PM_CURRENT.id);
  toast("AvaliaÃ§Ã£o enviada âœ…");
}

document.addEventListener("keydown",(e)=>{
  if(e.key==="Escape"){
    const m=document.getElementById("prodModalBack");
    if(m && m.classList.contains("show")) closeProdModal();
  }
});
/* ===== end Upgrade 4 ===== */


/* ===== Upgrade 5: Link pÃºblico de verificaÃ§Ã£o VV-OFICIAL ===== */
function setPage(page){
  const pages = ["Home","Catalog","Fav","MyOrders","Loyalty","Vitrine","Verify","Trust","Status","Pay","G24","Track","Admin","Dash","Info","Policies","FAQ","Reviews","Guarantee"];
  pages.forEach(p=>{
    const elp=document.getElementById("page"+p);
    if(elp) elp.style.display = (p.toLowerCase()===page) ? "block" : "none";
  });
  const t=document.getElementById("tabVerify");
  const ta=document.getElementById("tabAdmin");
  const tt=document.getElementById("tabTrack");
  if(ta) ta.classList.toggle("active", page==="admin");
  if(tt) tt.classList.toggle("active", page==="track");
  const ti=document.getElementById("tabInfo");
  const tp=document.getElementById("tabPolicies");
  if(ti) ti.classList.toggle("active", page==="info");
  if(tp) tp.classList.toggle("active", page==="policies");
  const tf=document.getElementById("tabFAQ");
  if(tf) tf.classList.toggle("active", page==="faq");
  const trv=document.getElementById("tabReviews");
  if(trv) trv.classList.toggle("active", page==="reviews");
  const tg=document.getElementById("tabGuarantee");
  if(tg) tg.classList.toggle("active", page==="guarantee");
  const tc=document.getElementById("tabCatalog");
  if(tc) tc.classList.toggle("active", page==="catalog");
  const tmo=document.getElementById("tabMyOrders");
  if(tmo) tmo.classList.toggle("active", page==="myorders");
  const td=document.getElementById("tabDash");
  if(td) td.classList.toggle("active", page==="dash");
  const tv=document.getElementById("tabVitrine");
  if(tv) tv.classList.toggle("active", page==="vitrine");
  const tl=document.getElementById("tabLoyalty");
  if(tl) tl.classList.toggle("active", page==="loyalty");
  const tf=document.getElementById("tabFav");
  if(tf) tf.classList.toggle("active", page==="fav");
  const tt=document.getElementById("tabTrust");
  if(tt) tt.classList.toggle("active", page==="trust");
  const ts=document.getElementById("tabStatus");
  if(ts) ts.classList.toggle("active", page==="status");
  const tp=document.getElementById("tabPay");
  if(tp) tp.classList.toggle("active", page==="pay");
  const tg=document.getElementById("tabG24");
  if(tg) tg.classList.toggle("active", page==="g24");
  if(t) t.classList.toggle("active", page==="verify");
  if(page==="verify") window.location.hash = "#verify";
}

function parseHashParams(){
  const h=window.location.hash||"";
  const q=h.includes("?") ? h.split("?")[1] : "";
  const params=new URLSearchParams(q);
  const out={};
  ["orderId","sig","total","user","itemsHash"].forEach(k=>{
    const v=params.get(k);
    if(v) out[k]=v;
  });
  return out;
}
function fillVerifyForm(p){
  if(!p) return;
  const map={orderId:"vf_orderId",sig:"vf_sig",total:"vf_total",user:"vf_user",itemsHash:"vf_itemsHash"};
  Object.keys(map).forEach(k=>{
    if(p[k]){
      const el=document.getElementById(map[k]);
      if(el) el.value=p[k];
    }
  });
}
function lastSigned(){
  try{
    return (state && state.signed) ? state.signed : (loadJSON("vv_last_signed")||null);
  }catch(e){ return null; }
}
function fillFromLastOrder(){
  const s=lastSigned();
  if(!s){ toast("Sem pedido salvo ainda."); return; }
  fillVerifyForm(s); toast("Preenchido âœ…");
}
function makeVerifyLink(payload){
  const base=window.location.origin+window.location.pathname;
  const q=new URLSearchParams();
  ["orderId","sig","total","user","itemsHash"].forEach(k=>{
    if(payload && payload[k]!==undefined && payload[k]!==null && String(payload[k]).length){
      q.set(k,String(payload[k]));
    }
  });
  return base + "#verify?" + q.toString();
}
function copyVerifyLink(){
  const p={
    orderId:(document.getElementById("vf_orderId")?.value||"").trim(),
    sig:(document.getElementById("vf_sig")?.value||"").trim(),
    total:(document.getElementById("vf_total")?.value||"").trim(),
    user:(document.getElementById("vf_user")?.value||"").trim(),
    itemsHash:(document.getElementById("vf_itemsHash")?.value||"").trim(),
  };
  if(!p.orderId || !p.sig){ toast("Preencha Order ID e sig primeiro."); return; }
  const link=makeVerifyLink(p);
  navigator.clipboard?.writeText(link);
  toast("Link copiado âœ…");
}
async function verifyFromForm(){
  const payload={
    orderId:(document.getElementById("vf_orderId")?.value||"").trim(),
    sig:(document.getElementById("vf_sig")?.value||"").trim(),
    total:(document.getElementById("vf_total")?.value||"").trim(),
    user:(document.getElementById("vf_user")?.value||"").trim(),
    itemsHash:(document.getElementById("vf_itemsHash")?.value||"").trim(),
  };
  const st=document.getElementById("vf_status");
  const dt=document.getElementById("vf_detail");
  if(st){ st.textContent="Verificandoâ€¦"; st.className="chip"; }
  if(dt) dt.textContent="Consultando servidorâ€¦";

  try{
    const base=(typeof WORKER_URL!=="undefined" ? WORKER_URL : "");
    const url=base.replace(/\/$/,"") + "/verify";
    const res=await fetch(url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(payload)});
    const data=await res.json().catch(()=>({ok:false,error:"Resposta invÃ¡lida"}));
    if(data.ok){
      if(st){ st.textContent="âœ… Verificado no servidor"; st.className="chip ok"; }
      if(dt){ dt.textContent=`VV-OFICIAL â€¢ ${payload.orderId}`; }
    }else{
      if(st){ st.textContent="âŒ NÃ£o confere"; st.className="chip bad"; }
      if(dt){ dt.textContent=data.error || "Falhou na verificaÃ§Ã£o."; }
    }
  }catch(e){
    if(st){ st.textContent="âš ï¸ Erro"; st.className="chip"; }
    if(dt){ dt.textContent="NÃ£o foi possÃ­vel conectar ao servidor. Verifique a WORKER_URL."; }
  }
}

// Salva Ãºltimo pedido assinado e gera link
(function(){
  const _oldCreate=window.createSignedOrder;
  if(typeof _oldCreate==="function"){
    window.createSignedOrder=async function(){
      const r=await _oldCreate.apply(this,arguments);
      try{
        if(state && state.signed && state.signed.orderId && state.signed.sig){
          saveJSON("vv_last_signed", state.signed);
          const link=makeVerifyLink(state.signed);
          const elLink=document.getElementById("vvVerifyLink");
          if(elLink) elLink.textContent=link;
        }
      }catch(e){}
      return r;
    }
  }
})();

function initVerifyFromHash(){
  const h=window.location.hash||"";
  if(h.startsWith("#verify")){
    setPage("verify");
    const p=parseHashParams();
    if(Object.keys(p).length){ fillVerifyForm(p); setTimeout(()=>verifyFromForm(),150); }
  }
}
window.addEventListener("hashchange", initVerifyFromHash);
setTimeout(initVerifyFromHash, 50);
/* ===== end Upgrade 5 ===== */





/* ===== Upgrade 6 (GLOBAL): Rastreamento + timeline no servidor ===== */
function renderTimelineFromData(orderId, data){
  const createdAt = data?.createdAt || null;
  const paidAt = data?.paidAt || null;
  const deliveredAt = data?.deliveredAt || null;
  const note = data?.note || "";

  const t = document.getElementById("tr_timeline");
  const chip = document.getElementById("tr_chip");
  const noteEl = document.getElementById("tr_note");
  if(!t) return;

  const items = [
    {title:"Pedido gerado", when: createdAt, done: !!createdAt, hint:"Pedido VV-OFICIAL foi criado no site."},
    {title:"Pagamento confirmado", when: paidAt, done: !!paidAt, hint:"ApÃ³s validaÃ§Ã£o do comprovante PIX."},
    {title:"Entregue", when: deliveredAt, done: !!deliveredAt, hint:"Produto/serviÃ§o entregue ao cliente."},
  ];
  const fmt = (x)=> x ? new Date(x).toLocaleString("pt-BR") : "Aguardandoâ€¦";

  t.innerHTML = "";
  items.forEach(it=>{
    const row=document.createElement("div");
    row.className="tItem";
    row.innerHTML = `
      <div class="tDot ${it.done ? "ok" : "wait"}"></div>
      <div class="tText">
        <b>${escapeHTML(it.title)}</b>
        <div class="tiny muted">${escapeHTML(fmt(it.when))}</div>
        <div class="tiny muted">${escapeHTML(it.done ? "ConcluÃ­do" : it.hint)}</div>
      </div>`;
    t.appendChild(row);
  });

  let status = "Aguardando pagamento";
  let cls = "chip";
  if(deliveredAt){ status="âœ… Entregue"; cls="chip ok"; }
  else if(paidAt){ status="âœ… Pago (em preparo)"; cls="chip ok"; }
  else if(createdAt){ status="ğŸ§¾ Pedido gerado"; cls="chip"; }

  if(chip){ chip.textContent=status; chip.className=cls; }
  if(noteEl){
    noteEl.textContent = note ? `Obs: ${note}` : "Dica: se vocÃª pagou via PIX, envie o comprovante no WhatsApp para confirmaÃ§Ã£o.";
  }

  const ap = document.getElementById("tr_adminPanel");
  if(ap) ap.style.display = "block"; // global admin is controlled by VV-OFICIAL proof
}

async function trackGet(orderId){
  const base=(typeof WORKER_URL!=="undefined" ? WORKER_URL : "");
  const url=base.replace(/\/$/,"") + "/track/get";
  const res = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({orderId})});
  const data = await res.json().catch(()=>({ok:false,error:"Resposta invÃ¡lida"}));
  if(!data.ok) throw new Error(data.error||"Falha no rastreio");
  return data.data || null;
}

async function trackSet(payload){
  const base=(typeof WORKER_URL!=="undefined" ? WORKER_URL : "");
  const url=base.replace(/\/$/,"") + "/track/set";
  const res = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(payload)});
  const data = await res.json().catch(()=>({ok:false,error:"Resposta invÃ¡lida"}));
  if(!data.ok) throw new Error(data.error||"Falha ao atualizar status");
  return data.data || null;
}

function lastSignedSafe(){
  try{ return (state && state.signed) ? state.signed : (loadJSON("vv_last_signed")||null); }catch(e){ return null; }
}

async function loadTracking(){
  const orderId = (document.getElementById("tr_orderId")?.value||"").trim();
  if(!orderId){ toast("Cole o Order ID âœ…"); return; }
  try{
    const data = await trackGet(orderId);
    renderTimelineFromData(orderId, data || { createdAt:null });
    toast("Status carregado âœ…");
  }catch(e){
    renderTimelineFromData(orderId, null);
    toast("NÃ£o encontrado (ainda) âš ï¸");
  }
}

function makeTrackLink(orderId){
  const base = window.location.origin + window.location.pathname;
  const q = new URLSearchParams();
  q.set("orderId", orderId);
  return base + "#track?" + q.toString();
}
function copyTrackLink(){
  const orderId = (document.getElementById("tr_orderId")?.value||"").trim();
  if(!orderId){ toast("Cole o Order ID âœ…"); return; }
  navigator.clipboard?.writeText(makeTrackLink(orderId));
  toast("Link copiado âœ…");
}

async function markStatus(status){
  const orderId=(document.getElementById("tr_orderId")?.value||"").trim();
  if(!orderId){ toast("Cole o Order ID"); return; }

  // Need VV-OFICIAL proof (sig + total + user + itemsHash)
  let s = lastSignedSafe();
  if(!s || s.orderId !== orderId){
    // Try prompt
    const sig = prompt("Cole a assinatura (sig) VV-OFICIAL do pedido:");
    if(!sig) return;
    const total = prompt("Total (ex: 39.90):");
    if(!total) return;
    const user = prompt("Nome do cliente:");
    if(!user) return;
    const itemsHash = prompt("itemsHash:");
    if(!itemsHash) return;
    s = { orderId, sig, total, user, itemsHash };
  }
  const note = (document.getElementById("tr_adminNote")?.value||"").trim();

  try{
    const data = await trackSet({
      orderId: s.orderId,
      sig: s.sig,
      total: s.total,
      user: s.user,
      itemsHash: s.itemsHash,
      status,
      note
    });
    renderTimelineFromData(orderId, data);
    toast("Atualizado âœ…");
  }catch(e){
    toast("Falhou: " + (e.message||"erro"));
  }
}

function markPaid(){ return markStatus("paid"); }
function markDelivered(){ return markStatus("delivered"); }
function clearTracking(){ return markStatus("reset"); }
function saveAdminNote(){ return markStatus("note"); } // keeps status unchanged in DO; note will update

// When a signed order is generated, initialize track on server as "created"
(function(){
  const _oldCreate=window.createSignedOrder;
  if(typeof _oldCreate==="function"){
    window.createSignedOrder=async function(){
      const r=await _oldCreate.apply(this,arguments);
      try{
        if(state && state.signed && state.signed.orderId){
          const s=state.signed;
          // store last signed
          saveJSON("vv_last_signed", s);
          const data = await trackSet({
            orderId: s.orderId,
            sig: s.sig,
            total: s.total,
            user: s.user,
            itemsHash: s.itemsHash,
            status: "created"
          });
          const el=document.getElementById("vvTrackLink");
          if(el) el.textContent = makeTrackLink(s.orderId);
        }
      }catch(e){}
      return r;
    }
  }
})();

// Hash router: #track?orderId=...
function initTrackFromHash(){
  const h=window.location.hash||"";
  if(h.startsWith("#track")){
    setPage("track");
    const q=h.includes("?") ? h.split("?")[1] : "";
    const p=new URLSearchParams(q);
    const oid=p.get("orderId");
    if(oid){
      const input=document.getElementById("tr_orderId");
      if(input) input.value=oid;
      loadTracking();
    }
  }
}
window.addEventListener("hashchange", initTrackFromHash);
setTimeout(initTrackFromHash, 60);
/* ===== end Upgrade 6 (GLOBAL) ===== */

/* ===== Upgrade 8: Painel Admin (lista pedidos + 1 toque) ===== */
function adHash(s){ let h=0; for(let i=0;i<s.length;i++) h=(h*33 + s.charCodeAt(i))>>>0; return String(h); }
function adminKey(){ return "vv_admin_hash2"; }
function adminOK(){ return localStorage.getItem("vv_admin_ok2")==="1"; }

function adminSetupLocal(){
  const pass = (document.getElementById("ad_pass")?.value||"").trim() || prompt("Crie uma senha admin:");
  if(!pass || pass.length<4){ toast("Senha curta."); return; }
  localStorage.setItem(adminKey(), adHash(pass));
  localStorage.setItem("vv_admin_ok2","1");
  toast("Senha criada âœ…");
  adminShowPanel();
}

function adminLogin(){
  const pass = (document.getElementById("ad_pass")?.value||"").trim();
  if(!pass){ toast("Digite a senha."); return; }
  const expect = localStorage.getItem(adminKey()) || "";
  if(!expect){ toast("Crie a senha primeiro."); return; }
  if(adHash(pass)===expect){
    localStorage.setItem("vv_admin_ok2","1");
    toast("Bem-vindo âœ…");
    adminShowPanel();
  }else toast("Senha invÃ¡lida âŒ");
}
function adminLogout(){
  localStorage.removeItem("vv_admin_ok2");
  toast("Saiu.");
  adminShowLogin();
}
function adminShowPanel(){
  const lp=el("ad_loginPanel"); const p=el("ad_panel");
  if(lp) lp.style.display="none";
  if(p) p.style.display="block";
  const c=el("ad_loginChip"); if(c){ c.textContent="Online"; c.className="chip ok"; }
  adminRefresh();
}
function adminShowLogin(){
  const lp=el("ad_loginPanel"); const p=el("ad_panel");
  if(lp) lp.style.display="block";
  if(p) p.style.display="none";
  const c=el("ad_loginChip"); if(c){ c.textContent="Offline"; c.className="chip"; }
}

function ordersKey(){ return "vv_orders_local"; }
function loadOrders(){ return loadJSON(ordersKey()) || []; }
function saveOrders(list){ saveJSON(ordersKey(), (list||[]).slice(-200)); }

function addOrderToList(order){
  try{
    const list = loadOrders();
    const exists = list.some(x=>x.orderId===order.orderId);
    if(!exists){
      list.push({
        orderId: order.orderId,
        total: order.total,
        user: order.user,
        itemsHash: order.itemsHash,
        sig: order.sig,
        ts: order.ts || new Date().toISOString(),
        status: "created"
      });
      saveOrders(list);
    }
  }catch(e){}
}

// Hook into signed order creation
(function(){
  const _oldCreate=window.createSignedOrder;
  if(typeof _oldCreate==="function"){
    window.createSignedOrder=async function(){
      const r=await _oldCreate.apply(this,arguments);
      try{
        if(state && state.signed && state.signed.orderId){
          addOrderToList(state.signed);
        }
      }catch(e){}
      return r;
    }
  }
})();

async function adminSetStatus(orderId, status){
  const list = loadOrders();
  const o = list.find(x=>x.orderId===orderId);
  if(!o){ toast("Pedido nÃ£o encontrado."); return; }
  try{
    const data = await trackSet({
      orderId: o.orderId,
      sig: o.sig,
      total: o.total,
      user: o.user,
      itemsHash: o.itemsHash,
      status,
      note: ""
    });
    o.status = status;
    o.updatedAt = new Date().toISOString();
    saveOrders(list);
    toast("Atualizado âœ…");
    adminRefresh();
  }catch(e){
    toast("Erro: " + (e.message||""));
  }
}

function adminCopyOrder(orderId){
  const o = loadOrders().find(x=>x.orderId===orderId);
  if(!o) return;
  const text = `Order ID: ${o.orderId}\nTotal: ${o.total}\nCliente: ${o.user}\nitemsHash: ${o.itemsHash}\nsig: ${o.sig}`;
  navigator.clipboard?.writeText(text);
  toast("Copiado âœ…");
}

function adminOpenTrack(orderId){
  setPage("track");
  const input = document.getElementById("tr_orderId");
  if(input) input.value = orderId;
  loadTracking();
}

function adminOpenVerify(orderId){
  const o = loadOrders().find(x=>x.orderId===orderId);
  if(!o) return;
  setPage("verify");
  fillVerifyForm(o);
  setTimeout(()=>verifyFromForm(), 100);
}

function adminRemove(orderId){
  let list = loadOrders().filter(x=>x.orderId!==orderId);
  saveOrders(list);
  toast("Removido.");
  adminRefresh();
}

function adminRefresh(){
  const box = document.getElementById("ad_list");
  if(!box) return;
  const list = loadOrders().slice().reverse();
  if(list.length===0){
    box.innerHTML = "<div class='tiny muted'>Nenhum pedido ainda. Gere um pedido para aparecer aqui.</div>";
    return;
  }
  box.innerHTML = "";
  list.slice(0, 30).forEach(o=>{
    const wrap = document.createElement("div");
    wrap.className="ad_item";
    const st = o.status==="delivered" ? "âœ… Entregue" : o.status==="paid" ? "âœ… Pago" : "ğŸ§¾ Criado";
    wrap.innerHTML = `
      <div class="ad_top">
        <div>
          <b class="mono2">${escapeHTML(o.orderId)}</b>
          <div class="tiny muted">Cliente: <b>${escapeHTML(o.user||"-")}</b> â€¢ Total: <b>${escapeHTML(String(o.total||"-"))}</b></div>
          <div class="tiny muted mono2">${escapeHTML(o.ts||"")}</div>
        </div>
        <div><span class="chip">${escapeHTML(st)}</span></div>
      </div>
      <div class="ad_actions">
        <button class="btn" onclick="adminOpenVerify('${o.orderId}')">Verificar</button>
        <button class="btn" onclick="adminOpenTrack('${o.orderId}')">Rastrear</button>
        <button class="btn" onclick="adminSetStatus('${o.orderId}','paid')">Marcar Pago</button>
        <button class="btn" onclick="adminSetStatus('${o.orderId}','delivered')">Marcar Entregue</button>
        <button class="btn" onclick="adminCopyOrder('${o.orderId}')">Copiar</button>
        <button class="btn" onclick="adminRemove('${o.orderId}')">Remover</button>
      </div>
    `;
    box.appendChild(wrap);
  });
}

function adminExport(){
  const list = loadOrders();
  const blob = new Blob([JSON.stringify(list, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download="viralvault_pedidos.json";
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0);
}

// init login state
setTimeout(()=>{ if(adminOK()) adminShowPanel(); else adminShowLogin(); }, 120);
/* ===== end Upgrade 8 ===== */


/* Admin hash router */
function initAdminFromHash(){
  const h=window.location.hash||"";
  if(h.startsWith("#admin")){ setPage("admin"); if(adminOK()) adminShowPanel(); else adminShowLogin(); }
}
window.addEventListener("hashchange", initAdminFromHash);
setTimeout(initAdminFromHash, 70);


/* ===== Upgrade 9: Tickets de suporte (estilo marketplace) ===== */
function ticketsKey(){ return "vv_tickets"; }
function loadTickets(){ return loadJSON(ticketsKey()) || []; }
function saveTickets(list){ saveJSON(ticketsKey(), (list||[]).slice(-500)); }

function newTicketId(){
  const rand = Math.random().toString(36).slice(2, 8).toUpperCase();
  return "TK-" + Date.now().toString().slice(-6) + "-" + rand;
}

function prefillTicketFromCheckout(){
  try{
    const n = (document.getElementById("custName")?.value||document.getElementById("vf_user")?.value||"").trim();
    const w = (document.getElementById("custWhats")?.value||"").trim();
    if(n) document.getElementById("tk_name").value=n;
    if(w) document.getElementById("tk_whats").value=w;
    toast("Preenchido âœ…");
  }catch(e){}
}

function openTicket(){
  const name=(document.getElementById("tk_name")?.value||"").trim();
  const whats=(document.getElementById("tk_whats")?.value||"").trim();
  const msg=(document.getElementById("tk_msg")?.value||"").trim();
  if(msg.length<5){ toast("Escreva uma mensagem um pouco maior âœ…"); return; }

  const tId = newTicketId();
  const createdAt = new Date().toISOString();
  const orderId = (state?.signed?.orderId) || (document.getElementById("vf_orderId")?.value||"").trim() || "";
  const ticket = { id:tId, name, whats, msg: msg.slice(0,800), orderId, status:"open", createdAt, lastUpdate: createdAt };

  const list = loadTickets();
  list.push(ticket);
  saveTickets(list);

  // UI
  const st=el("tk_status"); const dt=el("tk_detail");
  if(st){ st.textContent="âœ… Ticket aberto"; st.className="chip ok"; }
  if(dt){ dt.innerHTML = `ID: <b class="mono">${escapeHTML(tId)}</b> â€¢ Aguarde atendimento.`; }

  // Notify owner by WhatsApp (uses configured OWNER_WHATS / SUPPORT_WHATS if present)
  try{
    const owner = (typeof OWNER_WHATS!=="undefined" && OWNER_WHATS) ? OWNER_WHATS : (typeof SUPPORT_WHATS!=="undefined" ? SUPPORT_WHATS : "");
    if(owner){
      const text = `ğŸ« NOVO TICKET ${tId}%0A`+
        (orderId?`Order: ${orderId}%0A`:"")+
        (name?`Nome: ${name}%0A`:"")+
        (whats?`Whats: ${whats}%0A`:"")+
        `Mensagem: ${encodeURIComponent(msg.slice(0,500))}%0A`+
        `Abrir painel: ${encodeURIComponent(window.location.origin+window.location.pathname+"#admin")}`;
      window.open(`https://wa.me/${owner.replace(/\D/g,"")}?text=${text}`, "_blank");
    }
  }catch(e){}

  // refresh admin list if open
  try{ ticketsRefresh(); }catch(e){}
  toast("Ticket criado âœ…");
}

function ticketsRefresh(){
  const box=document.getElementById("ad_tickets");
  if(!box) return;
  const list=loadTickets().slice().reverse();
  if(list.length===0){
    box.innerHTML="<div class='tiny muted'>Nenhum ticket ainda.</div>";
    return;
  }
  box.innerHTML="";
  list.slice(0, 30).forEach(t=>{
    const wrap=document.createElement("div");
    wrap.className="ad_item";
    const stLabel = t.status==="closed" ? "âœ… Resolvido" : "ğŸŸ¡ Aberto";
    wrap.innerHTML = `
      <div class="ad_top">
        <div>
          <b class="mono2">${escapeHTML(t.id)}</b>
          <div class="tiny muted">Status: <b>${escapeHTML(stLabel)}</b>${t.orderId?` â€¢ Order: <span class="mono2">${escapeHTML(t.orderId)}</span>`:""}</div>
          <div class="tiny muted">${escapeHTML(t.name||"Cliente")} ${t.whats?`â€¢ ${escapeHTML(t.whats)}`:""}</div>
          <div class="tiny muted mono2">${escapeHTML(new Date(t.createdAt).toLocaleString("pt-BR"))}</div>
        </div>
        <div><span class="chip">${escapeHTML(stLabel)}</span></div>
      </div>
      <div class="divider"></div>
      <div class="tiny muted">${escapeHTML(t.msg||"")}</div>
      <div class="ad_actions">
        <button class="btn" onclick="ticketReply('${t.id}')">Responder</button>
        <button class="btn" onclick="ticketClose('${t.id}')">Marcar resolvido</button>
        <button class="btn" onclick="ticketCopy('${t.id}')">Copiar</button>
        <button class="btn" onclick="ticketRemove('${t.id}')">Remover</button>
      </div>
    `;
    box.appendChild(wrap);
  });
}

function ticketFind(id){
  const list=loadTickets();
  const idx=list.findIndex(x=>x.id===id);
  return { list, idx, t: idx>=0?list[idx]:null };
}

function ticketReply(id){
  const f=ticketFind(id);
  if(!f.t){ toast("Ticket nÃ£o encontrado"); return; }
  const msg = prompt("Digite sua resposta (vai abrir no WhatsApp):");
  if(!msg) return;

  const dest = (f.t.whats||"").replace(/\D/g,"");
  if(!dest){ toast("Ticket sem WhatsApp"); return; }
  const text = `âœ… Resposta do suporte (Ticket ${f.t.id})%0A%0A${encodeURIComponent(msg.slice(0,700))}`;
  window.open(`https://wa.me/${dest}?text=${text}`, "_blank");

  // update lastUpdate
  f.t.lastUpdate = new Date().toISOString();
  f.list[f.idx]=f.t; saveTickets(f.list);
  ticketsRefresh();
}

function ticketClose(id){
  const f=ticketFind(id);
  if(!f.t){ toast("Ticket nÃ£o encontrado"); return; }
  f.t.status="closed";
  f.t.lastUpdate=new Date().toISOString();
  f.list[f.idx]=f.t; saveTickets(f.list);
  ticketsRefresh();
  toast("Resolvido âœ…");
}

function ticketCopy(id){
  const f=ticketFind(id);
  if(!f.t) return;
  const text = `Ticket ${f.t.id}\nStatus: ${f.t.status}\nOrder: ${f.t.orderId||"-"}\nCliente: ${f.t.name||"-"}\nWhats: ${f.t.whats||"-"}\nMsg: ${f.t.msg||"-"}`;
  navigator.clipboard?.writeText(text);
  toast("Copiado âœ…");
}

function ticketRemove(id){
  let list=loadTickets().filter(x=>x.id!==id);
  saveTickets(list);
  ticketsRefresh();
  toast("Removido.");
}

function ticketsExport(){
  const list=loadTickets();
  const blob=new Blob([JSON.stringify(list,null,2)],{type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="viralvault_tickets.json";
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
}

// Auto refresh in admin
setTimeout(()=>{ try{ ticketsRefresh(); }catch(e){} }, 200);
/* ===== end Upgrade 9 ===== */


/* ===== Upgrade 10: Cupons avanÃ§ados ===== */
const COUPONS = [
  { code:"BEMVINDO10", type:"percent", value:10, oncePerCustomer:true, expires:"2099-12-31", minTotal:0, title:"Boas-vindas 10%" },
  { code:"ANIME5", type:"percent", value:5, oncePerCustomer:false, expires:"2099-12-31", minTotal:20, title:"Anime 5% (R$20+)" },
  { code:"entrega digitalGRATIS", type:"fixed", value:5, oncePerCustomer:false, expires:"2099-12-31", minTotal:35, title:"Cupom fixo R$5 (R$35+)" }
];

function normCode(s){ return (s||"").toUpperCase().replace(/\s+/g,"").trim(); }
function todayISO(){ const d=new Date(); return d.toISOString().slice(0,10); }

function getCustomerId(){
  // Try WhatsApp input on checkout
  const w = (document.getElementById("custWhats")?.value || document.getElementById("tk_whats")?.value || "").replace(/\D/g,"");
  return w ? ("wa_"+w) : "anon_device";
}
function usedKey(code, customerId){ return `vv_coupon_used_${code}_${customerId}`; }

function cartTotal(){
  try{
    // Use existing calc total if exists
    if(typeof calcTotal==="function") return Number(calcTotal()) || 0;
  }catch(e){}
  // Fallback: sum cart
  let sum=0;
  try{
    (state.cart||[]).forEach(it=>{
      const p=(PRODUCTS||[]).find(x=>x.id===it.id);
      if(p) sum += Number(p.price||0) * Number(it.qty||1);
    });
  }catch(e){}
  return Number(sum)||0;
}

function findCoupon(code){
  const c = normCode(code);
  return COUPONS.find(x=>x.code===c) || null;
}

function couponValid(c, total, customerId){
  if(!c) return {ok:false, msg:"Cupom invÃ¡lido."};
  if(c.expires && todayISO() > c.expires) return {ok:false, msg:"Cupom expirado."};
  if(total < (c.minTotal||0)) return {ok:false, msg:`MÃ­nimo R$ ${Number(c.minTotal).toFixed(2)}.`};
  if(c.oncePerCustomer){
    const used = localStorage.getItem(usedKey(c.code, customerId))==="1";
    if(used) return {ok:false, msg:"Cupom jÃ¡ usado por este cliente."};
  }
  return {ok:true, msg:"Ok"};
}

function calcDiscount(c, total){
  if(!c) return 0;
  if(c.type==="percent") return Math.max(0, total * (Number(c.value||0)/100));
  if(c.type==="fixed") return Math.max(0, Math.min(total, Number(c.value||0)));
  return 0;
}

function setCouponApplied(obj){
  saveJSON("vv_coupon_applied", obj||null);
}
function getCouponApplied(){
  return loadJSON("vv_coupon_applied") || null;
}

function updateCouponUI(){
  const total = cartTotal();
  const applied = getCouponApplied();
  let discount = 0;
  let msg = "Digite um cupom ou use o cupom do dia.";
  if(applied && applied.code){
    const c = findCoupon(applied.code);
    const check = couponValid(c, total, getCustomerId());
    if(check.ok){
      discount = calcDiscount(c, total);
      msg = `Aplicado: ${c.code} â€¢ ${c.title}`;
      el("cp_hint") && (el("cp_hint").textContent = "Cupom aplicado âœ…");
    }else{
      setCouponApplied(null);
      msg = check.msg;
      el("cp_hint") && (el("cp_hint").textContent = "Cupom invÃ¡lido");
    }
  }
  const newTotal = Math.max(0, total - discount);
  if(el("cp_discount")) el("cp_discount").textContent = money(discount);
  if(el("cp_total")) el("cp_total").textContent = money(newTotal);
  if(el("cp_msg")) el("cp_msg").textContent = msg;
  // store totals in state for order creation
  state.discount = discount;
  state.totalAfterDiscount = newTotal;
}

function applyCoupon(){
  const total = cartTotal();
  const code = normCode(document.getElementById("cp_code")?.value||"");
  const c = findCoupon(code);
  const customerId = getCustomerId();
  const check = couponValid(c, total, customerId);
  if(!check.ok){ toast(check.msg); if(el("cp_msg")) el("cp_msg").textContent = check.msg; return; }
  setCouponApplied({code:c.code, ts:new Date().toISOString()});
  updateCouponUI();
  toast("Cupom aplicado âœ…");
}

function autoApplyBestCoupon(){
  const total = cartTotal();
  const customerId = getCustomerId();
  let best=null, bestDisc=0;
  COUPONS.forEach(c=>{
    const check=couponValid(c, total, customerId);
    if(!check.ok) return;
    const disc=calcDiscount(c,total);
    if(disc>bestDisc){ bestDisc=disc; best=c; }
  });
  if(!best){ toast("Nenhum cupom disponÃ­vel agora."); return; }
  if(el("cp_code")) el("cp_code").value = best.code;
  setCouponApplied({code:best.code, ts:new Date().toISOString()});
  updateCouponUI();
  toast("Melhor cupom aplicado âœ…");
}

function dailyCoupon(){
  // rotate among coupons by day
  const d = new Date();
  const idx = (d.getFullYear()*10000 + (d.getMonth()+1)*100 + d.getDate()) % COUPONS.length;
  return COUPONS[idx];
}
function useDailyCoupon(){
  const c = dailyCoupon();
  if(el("cp_code")) el("cp_code").value = c.code;
  applyCoupon();
}
function renderDailyCoupon(){
  const c = dailyCoupon();
  if(el("cp_day")) el("cp_day").textContent = `${c.code} â€¢ ${c.title}`;
}

/* Make sure order uses discounted total */
(function(){
  const _oldBuild = window.buildOrderPayload;
  if(typeof _oldBuild==="function"){
    window.buildOrderPayload = function(){
      const p = _oldBuild.apply(this, arguments);
      const applied = getCouponApplied();
      if(applied && applied.code){
        p.coupon = applied.code;
        p.discount = Number(state.discount||0);
        p.total = Number(state.totalAfterDiscount||p.total);
      }
      return p;
    }
  }
})();

/* After successful signed order, mark coupon as used per customer */
(function(){
  const _oldCreate=window.createSignedOrder;
  if(typeof _oldCreate==="function"){
    window.createSignedOrder=async function(){
      const r=await _oldCreate.apply(this,arguments);
      try{
        const applied=getCouponApplied();
        if(applied && applied.code){
          const c=findCoupon(applied.code);
          if(c && c.oncePerCustomer){
            localStorage.setItem(usedKey(c.code, getCustomerId()), "1");
          }
        }
      }catch(e){}
      return r;
    }
  }
})();

// Update coupon UI when cart changes (best effort)
setTimeout(()=>{ try{ renderDailyCoupon(); updateCouponUI(); }catch(e){} }, 200);
document.addEventListener("click", ()=>{ try{ updateCouponUI(); }catch(e){} });
/* ===== end Upgrade 10 ===== */


/* ===== Upgrade 12: FAQ + busca + respostas rÃ¡pidas no chat ===== */
const FAQ = [
  {q:"Como funciona o pagamento?", a:"O pagamento Ã© feito via PIX. ApÃ³s o comprovante, confirmamos e entregamos. VocÃª pode usar o rastreio do pedido para acompanhar."},
  {q:"O que Ã© VV-OFICIAL?", a:"Ã‰ uma assinatura no servidor (HMAC) que prova que o pedido foi gerado pela loja. Use 'Verificar pedido' para confirmar."},
  {q:"Quanto tempo para entregar?", a:"Depende do item e do horÃ¡rio. Itens digitais normalmente sÃ£o entregues apÃ³s confirmaÃ§Ã£o do pagamento, o mais rÃ¡pido possÃ­vel."},
  {q:"Como eu verifico se nÃ£o Ã© golpe?", a:"PeÃ§a o link de verificaÃ§Ã£o do pedido ou confira na aba 'Verificar pedido'. Se nÃ£o bater, nÃ£o pague."},
  {q:"Tem reembolso?", a:"Para itens digitais, apÃ³s entrega pode nÃ£o haver reversÃ£o. Se houver erro nosso (item incorreto/falha), corrigimos e reenviamos."},
  {q:"Posso usar cupom?", a:"Sim. No checkout existe Ã¡rea de cupom. O BEMVINDO10 dÃ¡ 10% (1 uso por cliente)."},
  {q:"Como falar com atendente humano?", a:"Abra um Ticket em 'Suporte humano' ou clique em 'Falar com atendente'. VocÃª recebe um ID e o lojista Ã© notificado."},
  {q:"Rastreio funciona em qualquer celular?", a:"Sim. O rastreio Ã© GLOBAL (servidor). Qualquer pessoa com o Order ID consegue ver o status."},
];

function faqRender(){
  const q = (document.getElementById("faq_search")?.value||"").toLowerCase().trim();
  const list = document.getElementById("faq_list");
  if(!list) return;

  const items = FAQ.filter(x=>{
    if(!q) return true;
    return (x.q+x.a).toLowerCase().includes(q);
  });

  const count = document.getElementById("faq_count");
  if(count) count.textContent = String(items.length);

  list.innerHTML = "";
  items.forEach((it, idx)=>{
    const d = document.createElement("details");
    d.className="faq";
    d.innerHTML = `
      <summary>${escapeHTML(it.q)}</summary>
      <div class="faqBody tiny muted">${escapeHTML(it.a)}</div>
      <div class="prodActions" style="margin-top:10px">
        <button class="btn" onclick="faqSendToChat(${idx})">Perguntar no chat</button>
        <button class="btn" onclick="copyText('${escapeHTML(it.q + " â€” " + it.a).replace(/'/g,"&#39;")}')">Copiar</button>
      </div>
    `;
    list.appendChild(d);
  });
}

function copyText(txt){
  navigator.clipboard?.writeText(txt);
  toast("Copiado âœ…");
}

function faqSendToChat(idx){
  const it = FAQ[idx];
  // Try to open support chat and prefill message if chat input exists
  try{
    openSupport && openSupport(); // if defined
  }catch(e){}
  const text = it.q;
  // common ids for chat input
  const input = document.getElementById("chatInput") || document.getElementById("supportInput") || document.querySelector('input[name="chat"]');
  if(input){
    input.value = text;
    input.focus();
    toast("Mensagem pronta no chat âœ…");
  }else{
    // fallback: open ticket msg field
    const tk = document.getElementById("tk_msg");
    if(tk){
      tk.value = text + "\n";
      tk.focus();
      toast("Mensagem pronta no ticket âœ…");
    }else{
      toast("NÃ£o achei o campo do chat. Abra o suporte e tente novamente.");
    }
  }
}

// Init
setTimeout(()=>{ try{ faqRender(); }catch(e){} }, 250);
/* ===== end Upgrade 12 ===== */


/* ===== Upgrade 13: AvaliaÃ§Ãµes pÃºblicas ===== */
function reviewsKey(){ return "vv_reviews"; }
function loadReviews(){ return loadJSON(reviewsKey()) || []; }
function saveReviews(list){ saveJSON(reviewsKey(), (list||[]).slice(-500)); }

function reviewPrefill(){
  try{
    const n = (document.getElementById("custName")?.value||document.getElementById("vf_user")?.value||"").trim();
    if(n) document.getElementById("rv_name").value=n;
  }catch(e){}
  toast("Pronto âœ…");
}

function starSVG(filled){
  return `<svg class="star" viewBox="0 0 24 24" fill="${filled ? "currentColor" : "none"}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87L18.18 22 12 18.56 5.82 22 7 14.14l-5-4.87 6.91-1.01z"/>
  </svg>`;
}

function renderStars(elm, rating){
  if(!elm) return;
  const r = Math.max(0, Math.min(5, Number(rating)||0));
  elm.innerHTML = "";
  for(let i=1;i<=5;i++){
    const span=document.createElement("span");
    span.innerHTML = starSVG(i<=r);
    elm.appendChild(span);
  }
}

function reviewAdd(){
  const name=(document.getElementById("rv_name")?.value||"").trim() || "Cliente";
  const rate=Math.max(1, Math.min(5, parseInt((document.getElementById("rv_rate")?.value||"5"),10)||5));
  const text=(document.getElementById("rv_text")?.value||"").trim();
  if(text.length<6){ toast("Escreva um comentÃ¡rio maior âœ…"); return; }

  const item = { name: name.slice(0,26), rate, text: text.slice(0,600), ts: new Date().toISOString() };
  const list=loadReviews();
  list.push(item);
  saveReviews(list);

  document.getElementById("rv_text").value="";
  toast("Publicado âœ…");
  reviewsRender();
}

function reviewsRender(){
  const list=loadReviews().filter(x=>x.text && x.text.trim().length>0);
  const count=list.length;
  const avg = count ? (list.reduce((a,b)=>a+(Number(b.rate)||0),0)/count) : 0;

  const rvAvg=el("rv_avg"), rvCount=el("rv_count"), rvBadge=el("rv_badge"), rvStars=el("rv_stars"), rvLast=el("rv_last");
  if(rvAvg) rvAvg.textContent = count ? avg.toFixed(1) : "â€”";
  if(rvCount) rvCount.textContent = count ? `${count} avaliaÃ§Ãµes` : "Sem avaliaÃ§Ãµes ainda";
  if(rvBadge) rvBadge.textContent = count ? "Avaliado por clientes" : "Novo";
  if(rvLast) rvLast.textContent = count ? "Atualizado" : "â€”";
  renderStars(rvStars, Math.round(avg));

  const box=el("rv_list");
  if(!box) return;
  if(count===0){
    box.innerHTML="<div class='tiny muted'>Sem avaliaÃ§Ãµes por enquanto. Seja o primeiro ğŸ˜‰</div>";
    return;
  }
  box.innerHTML="";
  list.slice().reverse().slice(0, 18).forEach(it=>{
    const d=document.createElement("div");
    d.className="rvItem";
    d.innerHTML=`
      <div class="ad_top">
        <div>
          <b>${escapeHTML(it.name||"Cliente")}</b>
          <div class="tiny muted">${escapeHTML(new Date(it.ts).toLocaleString("pt-BR"))}</div>
        </div>
        <div class="stars" aria-label="rating"></div>
      </div>
      <div class="divider"></div>
      <div class="tiny muted">${escapeHTML(it.text||"")}</div>
    `;
    box.appendChild(d);
    renderStars(d.querySelector(".stars"), it.rate);
  });

  // Add top badge in header if element exists
  const headerBadge = document.getElementById("topReviewBadge");
  if(headerBadge){
    headerBadge.textContent = count ? `â­ ${avg.toFixed(1)} â€¢ ${count} avaliaÃ§Ãµes` : "â­ Novo";
  }
}

// Add a small badge on home header if possible
(function(){
  if(!document.getElementById("topReviewBadge")){
    const h = document.querySelector(".hero .heroSub") || document.querySelector(".hero p") || null;
    if(h){
      const b=document.createElement("div");
      b.className="chip ok";
      b.id="topReviewBadge";
      b.style.display="inline-flex";
      b.style.marginTop="10px";
      b.textContent="â­ Novo";
      h.parentElement.appendChild(b);
    }
  }
})();

setTimeout(()=>{ try{ reviewsRender(); }catch(e){} }, 260);
/* ===== end Upgrade 13 ===== */


/* ===== Upgrade 15: CatÃ¡logo (coleÃ§Ãµes + filtro + busca) ===== */
const CATS = [
  { id:"all", label:"Tudo" },
  { id:"trend", label:"ğŸ”¥ Trends" },
  { id:"anime", label:"ğŸ—¡ï¸ Anime" },
  { id:"premium", label:"ğŸ’ Premium" },
];

function productTags(p){
  const name = (p?.name||"").toLowerCase();
  const tags = new Set();
  // HeurÃ­stica simples (edite depois se quiser)
  if(/anime|manga|otaku|waifu|shonen|jjk|jujutsu|genshin|one piece|naruto|bleach/.test(name)) tags.add("anime");
  if(/premium|vip|pro|ultimate|gold|diamond/.test(name)) tags.add("premium");
  if(/trend|viral|tiktok|hype|top/.test(name)) tags.add("trend");
  // fallback: se nada, assume trend (pra nÃ£o ficar vazio)
  if(tags.size===0) tags.add("trend");
  return Array.from(tags);
}

function catalogState(){
  const s = loadJSON("vv_catalog_state") || { cat:"all" };
  return s;
}
function saveCatalogState(s){
  saveJSON("vv_catalog_state", s);
}

function catalogChips(){
  const box = document.getElementById("cat_chips");
  if(!box) return;
  const st = catalogState();
  box.innerHTML = "";
  CATS.forEach(c=>{
    const b=document.createElement("button");
    b.className = "chipBtn" + (st.cat===c.id ? " active" : "");
    b.textContent = c.label;
    b.onclick = ()=>{ const ns=catalogState(); ns.cat=c.id; saveCatalogState(ns); catalogRender(); };
    box.appendChild(b);
  });
}

function catalogGetProducts(){
  try{ return (typeof PRODUCTS!=="undefined" && Array.isArray(PRODUCTS)) ? PRODUCTS : []; }catch(e){ return []; }
}

function catalogScore(p, q){
  if(!q) return 0;
  const n=(p.name||"").toLowerCase();
  const d=(p.desc||p.description||"").toLowerCase();
  let score=0;
  if(n.includes(q)) score += 10;
  if(d.includes(q)) score += 3;
  q.split(" ").filter(Boolean).forEach(w=>{
    if(n.includes(w)) score += 3;
    if(d.includes(w)) score += 1;
  });
  return score;
}

function catalogRender(){
  const grid = document.getElementById("cat_grid");
  if(!grid) return;
  catalogChips();

  const st = catalogState();
  const q = (document.getElementById("cat_search")?.value||"").toLowerCase().trim();
  const sort = (document.getElementById("cat_sort")?.value||"relevance");

  let list = catalogGetProducts().map(p=>({p, tags:productTags(p), score:catalogScore(p,q)}));

  if(st.cat && st.cat!=="all"){
    list = list.filter(x=>x.tags.includes(st.cat));
  }
  if(q){
    list = list.filter(x=> x.score>0 || (x.p.name||"").toLowerCase().includes(q) || (x.p.desc||"").toLowerCase().includes(q));
  }

  if(sort==="priceAsc") list.sort((a,b)=>(Number(a.p.price||0)-Number(b.p.price||0)));
  else if(sort==="priceDesc") list.sort((a,b)=>(Number(b.p.price||0)-Number(a.p.price||0)));
  else if(sort==="nameAsc") list.sort((a,b)=> String(a.p.name||"").localeCompare(String(b.p.name||""), "pt-BR"));
  else { // relevance
    list.sort((a,b)=> (b.score-a.score) || (Number(a.p.price||0)-Number(b.p.price||0)));
  }

  const cnt = document.getElementById("cat_count");
  if(cnt) cnt.textContent = String(list.length);

  grid.innerHTML = "";
  if(list.length===0){
    grid.innerHTML = "<div class='tiny muted'>Nenhum resultado. Tente outra palavra ou categoria.</div>";
    return;
  }

  list.slice(0, 60).forEach(x=>{
    const p=x.p;
    const card=document.createElement("div");
    card.className="card";
    const tagLine = x.tags.map(t=> t==="anime"?"ğŸ—¡ï¸ Anime":t==="premium"?"ğŸ’ Premium":"ğŸ”¥ Trends").join(" â€¢ ");
    card.innerHTML = `
      <div class="cardTop">
        <div class="cardImg">${escapeHTML((p.name||"").slice(0,2).toUpperCase())}</div>
        <div style="flex:1">
          <div class="cardName">${escapeHTML(p.name||"Produto")}</div>
          <div class="cardDesc">${escapeHTML(p.desc||p.description||"")}</div>
          <div class="tiny muted" style="margin-top:6px">${escapeHTML(tagLine)}</div>
        </div>
        <div style="text-align:right">
          <div class="mono" style="font-weight:900">${money(Number(p.price||0))}</div>
          <div class="tiny muted">PIX</div>
        </div>
      </div>
      <div class="prodActions">
        <button class="btn accent" onclick="addToCart('${p.id}')">Adicionar</button>
        <button class="btn" onclick="quickBuy('${p.id}')">Comprar</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

// Go to checkout quickly
function quickBuy(id){
  addToCart(id);
  try{ setPage("track"); }catch(e){}
  try{ setPage("home"); }catch(e){}
  try{ setPage("cart"); }catch(e){}
  toast("Adicionado ao carrinho âœ…");
}

setTimeout(()=>{ try{ catalogRender(); }catch(e){} }, 280);
/* ===== end Upgrade 15 ===== */


/* ===== Upgrade 16: Meus pedidos (cliente) ===== */
function moKeyAll(){ return "vv_orders_by_customer"; }
function moNormWhats(s){ return (s||"").replace(/\D/g,""); }

function moGetCustomer(){
  const w = moNormWhats(document.getElementById("mo_whats")?.value||"");
  return w || "";
}
function moLoadAll(){ return loadJSON(moKeyAll()) || {}; }
function moSaveAll(obj){ saveJSON(moKeyAll(), obj || {}); }

function myOrdersSaveWhats(){
  const w = moNormWhats(document.getElementById("mo_whats")?.value||"");
  if(!w){ toast("Coloque seu WhatsApp âœ…"); return; }
  localStorage.setItem("vv_my_whats", w);
  toast("Salvo âœ…");
  myOrdersRender();
}
function myOrdersClear(){
  document.getElementById("mo_whats").value="";
  localStorage.removeItem("vv_my_whats");
  toast("Limpo.");
  myOrdersRender();
}

function moAddOrderForCustomer(order){
  // order: {orderId,total,user,itemsHash,sig,ts}
  const w = moNormWhats(order?.customerWhats || order?.whats || "");
  if(!w) return;
  const all = moLoadAll();
  const list = all[w] || [];
  if(!list.some(x=>x.orderId===order.orderId)){
    list.push({
      orderId: order.orderId,
      total: order.total,
      user: order.user,
      itemsHash: order.itemsHash,
      sig: order.sig,
      ts: order.ts || new Date().toISOString()
    });
    all[w]=list.slice(-200);
    moSaveAll(all);
  }
}

function myOrdersRender(){
  const box = document.getElementById("mo_list");
  const badge = document.getElementById("mo_count");
  if(!box) return;

  const w = moGetCustomer();
  const all = moLoadAll();
  const list = (w && all[w]) ? all[w].slice().reverse() : [];

  if(badge) badge.textContent = String(list.length);
  box.innerHTML = "";
  if(!w){
    box.innerHTML = "<div class='tiny muted'>Digite seu WhatsApp para ver seus pedidos neste aparelho.</div>";
    return;
  }
  if(list.length===0){
    box.innerHTML = "<div class='tiny muted'>Nenhum pedido encontrado para este WhatsApp neste aparelho.</div>";
    return;
  }

  list.slice(0, 30).forEach(o=>{
    const wrap=document.createElement("div");
    wrap.className="ad_item";
    wrap.innerHTML = `
      <div class="ad_top">
        <div>
          <b class="mono2">${escapeHTML(o.orderId)}</b>
          <div class="tiny muted">Total: <b>${escapeHTML(String(o.total||"-"))}</b> â€¢ Nome: <b>${escapeHTML(o.user||"-")}</b></div>
          <div class="tiny muted mono2">${escapeHTML(new Date(o.ts).toLocaleString("pt-BR"))}</div>
        </div>
        <div><span class="chip">ğŸ“¦ RastreÃ¡vel</span></div>
      </div>
      <div class="ad_actions">
        <button class="btn accent" onclick="myOrdersOpenTrack('${o.orderId}')">Rastrear</button>
        <button class="btn" onclick="myOrdersReopenTicket('${o.orderId}')">Abrir ticket</button>
        <button class="btn" onclick="myOrdersCopy('${o.orderId}','${w}')">Copiar</button>
      </div>
    `;
    box.appendChild(wrap);
  });
}

function myOrdersOpenTrack(orderId){
  setPage("track");
  const input=document.getElementById("tr_orderId");
  if(input) input.value=orderId;
  loadTracking();
}

function myOrdersCopy(orderId, w){
  const all = moLoadAll();
  const o = (all[w]||[]).find(x=>x.orderId===orderId);
  if(!o) return;
  const text = `Order ID: ${o.orderId}\nTotal: ${o.total}\nNome: ${o.user}`;
  navigator.clipboard?.writeText(text);
  toast("Copiado âœ…");
}

function myOrdersReopenTicket(orderId){
  // Prefill ticket form and open support (if exists)
  try{ openSupport && openSupport(); }catch(e){}
  const moW = moNormWhats(document.getElementById("mo_whats")?.value||"");
  const tkMsg = document.getElementById("tk_msg");
  const tkWhats = document.getElementById("tk_whats");
  if(tkWhats && moW) tkWhats.value = "+"+moW;
  if(tkMsg) tkMsg.value = `OlÃ¡! Preciso de ajuda com meu pedido ${orderId}.`;
  // scroll to ticket form
  const tf = document.getElementById("ticketForm");
  if(tf) tf.scrollIntoView({behavior:"smooth", block:"start"});
  toast("Ticket pronto âœ…");
}

// Init input with saved whatsapp
setTimeout(()=>{
  try{
    const w = localStorage.getItem("vv_my_whats") || "";
    if(w && document.getElementById("mo_whats")) document.getElementById("mo_whats").value = "+"+w;
    myOrdersRender();
  }catch(e){}
}, 260);

// Hook: after signed order created, attempt to store by customer WhatsApp from checkout inputs
(function(){
  const _oldCreate=window.createSignedOrder;
  if(typeof _oldCreate==="function"){
    window.createSignedOrder=async function(){
      const r = await _oldCreate.apply(this, arguments);
      try{
        if(state && state.signed && state.signed.orderId){
          const w = (document.getElementById("custWhats")?.value || document.getElementById("tk_whats")?.value || "").trim();
          const ord = { ...state.signed, customerWhats: w };
          moAddOrderForCustomer(ord);
          // also store last whatsapp for customer convenience
          const wn = moNormWhats(w);
          if(wn) localStorage.setItem("vv_my_whats", wn);
        }
      }catch(e){}
      return r;
    }
  }
})();
/* ===== end Upgrade 16 ===== */


/* ===== Upgrade 17: NotificaÃ§Ã£o de tickets (badge + alerta) ===== */
function notifyKey(){ return "vv_ticket_notify_on"; }
function notifyOn(){ return (localStorage.getItem(notifyKey()) ?? "1") === "1"; }
function setNotify(v){ localStorage.setItem(notifyKey(), v ? "1" : "0"); }

function lastSeenKey(){ return "vv_ticket_last_seen_ts"; }
function getLastSeen(){ return localStorage.getItem(lastSeenKey()) || ""; }
function setLastSeen(ts){ localStorage.setItem(lastSeenKey(), ts || ""); }

function badgeShow(show){
  const b = document.getElementById("ad_badge");
  if(!b) return;
  b.style.display = show ? "inline-flex" : "none";
  b.classList.toggle("pulse", show);
}

function updateNotifyBtn(){
  const btn = document.getElementById("ad_notify_btn");
  if(!btn) return;
  btn.textContent = notifyOn() ? "ğŸ”” NotificaÃ§Ãµes: ON" : "ğŸ”• NotificaÃ§Ãµes: OFF";
}

function toggleTicketNotify(){
  setNotify(!notifyOn());
  updateNotifyBtn();
  toast(notifyOn() ? "NotificaÃ§Ãµes ativadas âœ…" : "NotificaÃ§Ãµes desativadas");
}

function playBeep(){
  try{
    const ctx = new (window.AudioContext||window.webkitAudioContext)();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type="sine"; o.frequency.value=880;
    g.gain.value=0.05;
    o.start();
    setTimeout(()=>{ o.stop(); ctx.close(); }, 180);
  }catch(e){}
}

function showWebNotify(title, body){
  try{
    if(!("Notification" in window)) return;
    if(Notification.permission==="granted"){
      new Notification(title, { body });
    }else if(Notification.permission!=="denied"){
      Notification.requestPermission().then(p=>{
        if(p==="granted") new Notification(title, { body });
      });
    }
  }catch(e){}
}

function newestTicketTs(list){
  let max = "";
  (list||[]).forEach(t=>{
    const ts = t.lastUpdate || t.createdAt || "";
    if(ts && (!max || ts>max)) max = ts;
  });
  return max;
}

function checkNewTickets(){
  try{
    const list = (typeof loadTickets==="function") ? loadTickets() : [];
    const newest = newestTicketTs(list);
    const seen = getLastSeen();
    const hasNew = newest && (!seen || newest > seen);
    // show badge if new
    badgeShow(hasNew);

    // If admin page open and panel visible, mark as seen automatically
    const adminVisible = document.getElementById("pageAdmin") && document.getElementById("pageAdmin").style.display !== "none";
    if(adminVisible && typeof adminOK==="function" && adminOK()){
      setLastSeen(newest || seen);
      badgeShow(false);
      return;
    }

    if(hasNew && notifyOn()){
      // Alert once per new timestamp
      if(localStorage.getItem("vv_ticket_alerted_ts") !== newest){
        localStorage.setItem("vv_ticket_alerted_ts", newest);
        playBeep();
        showWebNotify("ViralVault: Ticket novo", "Um cliente abriu um ticket. Abra o Painel Admin.");
        toast("Ticket novo ğŸ«");
      }
    }
  }catch(e){}
}

function markTicketsSeen(){
  try{
    const list = loadTickets();
    const newest = newestTicketTs(list);
    if(newest) setLastSeen(newest);
    badgeShow(false);
  }catch(e){}
}

function testTicketNotify(){
  playBeep();
  showWebNotify("ViralVault: Teste", "NotificaÃ§Ã£o de ticket funcionando.");
  toast("Teste enviado âœ…");
}

// Patch ticketsRefresh to update badge/seen states
(function(){
  const _old = window.ticketsRefresh;
  if(typeof _old==="function"){
    window.ticketsRefresh = function(){
      const r = _old.apply(this, arguments);
      try{ checkNewTickets(); }catch(e){}
      return r;
    }
  }
})();

// When user opens admin page, mark as seen
(function(){
  const _oldSetPage = window.setPage;
  if(typeof _oldSetPage==="function"){
    window.setPage = function(page){
      const r = _oldSetPage.apply(this, arguments);
      if(page==="admin"){
        setTimeout(()=>{ try{ markTicketsSeen(); updateNotifyBtn(); }catch(e){} }, 120);
      }
      return r;
    }
  }
})();

setTimeout(()=>{ try{ updateNotifyBtn(); checkNewTickets(); }catch(e){} }, 400);
setInterval(()=>{ try{ checkNewTickets(); }catch(e){} }, 9000);
/* ===== end Upgrade 17 ===== */


/* ===== Upgrade 18: Logs de seguranÃ§a + contador anti-golpe ===== */
function secKey(){ return "vv_security_logs"; }
function secCountKey(){ return "vv_security_blocked_count"; }
function secLoad(){ return loadJSON(secKey()) || []; }
function secSave(list){ saveJSON(secKey(), (list||[]).slice(-500)); }
function secIncBlocked(){ localStorage.setItem(secCountKey(), String((parseInt(localStorage.getItem(secCountKey())||"0",10)||0)+1)); }
function secBlocked(){ return parseInt(localStorage.getItem(secCountKey())||"0",10)||0; }

function secLog(type, detail){
  try{
    const list = secLoad();
    list.push({ ts:new Date().toISOString(), type, detail: (detail||"").slice(0,500) });
    secSave(list);
  }catch(e){}
}

function secRefresh(){
  const box=document.getElementById("ad_sec");
  const cnt=document.getElementById("sec_counter");
  if(cnt) cnt.textContent = String(secBlocked());
  if(!box) return;
  const list=secLoad().slice().reverse();
  if(list.length===0){
    box.innerHTML="<div class='tiny muted'>Sem eventos ainda.</div>";
    return;
  }
  box.innerHTML="";
  list.slice(0, 40).forEach(e=>{
    const wrap=document.createElement("div");
    wrap.className="ad_item";
    const icon = e.type.includes("fail") ? "âš ï¸" : e.type.includes("blocked") ? "ğŸ›‘" : "ğŸ›¡ï¸";
    wrap.innerHTML = `
      <div class="ad_top">
        <div>
          <b>${escapeHTML(icon+" "+e.type)}</b>
          <div class="tiny muted mono2">${escapeHTML(new Date(e.ts).toLocaleString("pt-BR"))}</div>
        </div>
        <div><span class="chip">${escapeHTML(e.type)}</span></div>
      </div>
      <div class="divider"></div>
      <div class="tiny muted">${escapeHTML(e.detail||"")}</div>
    `;
    box.appendChild(wrap);
  });
}

function secExport(){
  const list=secLoad();
  const blob=new Blob([JSON.stringify({blocked:secBlocked(), events:list}, null, 2)], {type:"application/json"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url; a.download="viralvault_security_logs.json";
  document.body.appendChild(a); a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
}
function secClear(){
  saveJSON(secKey(), []);
  toast("Logs limpos.");
  secRefresh();
}

// Hook: verification flow logs (best-effort)
(function(){
  const _oldVerify = window.verifyFromForm;
  if(typeof _oldVerify==="function"){
    window.verifyFromForm = async function(){
      try{
        const r = await _oldVerify.apply(this, arguments);
        const res = document.getElementById("vf_result")?.textContent || "";
        if(res.toLowerCase().includes("falso") || res.toLowerCase().includes("erro")){
          secLog("verify_fail", res.slice(0,200));
          secIncBlocked();
        }else{
          secLog("verify_ok", "VerificaÃ§Ã£o ok.");
        }
        return r;
      }catch(err){
        secLog("verify_error", (err?.message||String(err)).slice(0,200));
        throw err;
      }
    }
  }
})();

// Hook: tracking errors (best-effort)
(function(){
  const _oldTrack = window.loadTracking;
  if(typeof _oldTrack==="function"){
    window.loadTracking = async function(){
      try{
        const r = await _oldTrack.apply(this, arguments);
        const box = document.getElementById("tr_status")?.textContent || "";
        if(box.toLowerCase().includes("erro") || box.toLowerCase().includes("nÃ£o encontrado")){
          secLog("track_fail", box.slice(0,200));
        }
        return r;
      }catch(err){
        secLog("track_error", (err?.message||String(err)).slice(0,200));
        throw err;
      }
    }
  }
})();

// Hook: ticket creation rate-limit (8s)
(function(){
  let last=0;
  const _oldOpen = window.openTicket;
  if(typeof _oldOpen==="function"){
    window.openTicket = function(){
      const now=Date.now();
      if(now-last < 8000){
        secLog("ticket_blocked", "Spam de ticket bloqueado (8s).");
        secIncBlocked();
        toast("Aguarde alguns segundos antes de abrir outro ticket âœ…");
        return;
      }
      last=now;
      secLog("ticket_open", "Ticket criado.");
      return _oldOpen.apply(this, arguments);
    }
  }
})();

// Auto refresh when admin opens
(function(){
  const _oldSetPage = window.setPage;
  if(typeof _oldSetPage==="function"){
    window.setPage = function(page){
      const r = _oldSetPage.apply(this, arguments);
      if(page==="admin"){
        setTimeout(()=>{ try{ secRefresh(); }catch(e){} }, 180);
      }
      return r;
    }
  }
})();

setTimeout(()=>{ try{ secRefresh(); }catch(e){} }, 600);
/* ===== end Upgrade 18 ===== */


/* ===== Upgrade 19: Modo ManutenÃ§Ã£o (pausar checkout) ===== */
function maintKey(){ return "vv_maintenance_on"; }
function maintOn(){ return (localStorage.getItem(maintKey()) ?? "0") === "1"; }
function setMaint(v){ localStorage.setItem(maintKey(), v ? "1" : "0"); }

function renderMaint(){
  const on = maintOn();
  const banner = document.getElementById("maintBanner");
  const badge = document.getElementById("maintBadge");
  const btn = document.getElementById("ad_maint_btn");
  if(banner) banner.style.display = on ? "block" : "none";
  if(badge){ badge.textContent = on ? "ON" : "OFF"; badge.className = "chip " + (on ? "bad" : "ok"); }
  if(btn) btn.textContent = on ? "ğŸ› ï¸ ManutenÃ§Ã£o: ON" : "ğŸ› ï¸ ManutenÃ§Ã£o: OFF";
}

function toggleMaintenance(){
  setMaint(!maintOn());
  renderMaint();
  toast(maintOn() ? "ManutenÃ§Ã£o ativada âœ…" : "ManutenÃ§Ã£o desativada âœ…");
}

function maintTest(){
  toast("Teste: banner/pausa de checkout âœ…");
  const was = maintOn();
  setMaint(true); renderMaint();
  setTimeout(()=>{ setMaint(was); renderMaint(); }, 1400);
}

function maintenanceBlock(reason){
  toast(reason || "Checkout pausado (manutenÃ§Ã£o).");
  // optionally open support
  try{ openSupport && openSupport(); }catch(e){}
  return false;
}

// Block key actions: createSignedOrder and WhatsApp finalize
(function(){
  const _oldCreate = window.createSignedOrder;
  if(typeof _oldCreate==="function"){
    window.createSignedOrder = async function(){
      if(maintOn()) return maintenanceBlock("ğŸ› ï¸ Estamos em manutenÃ§Ã£o. Volte em alguns minutos âœ…");
      return _oldCreate.apply(this, arguments);
    }
  }
})();

(function(){
  const _oldSend = window.sendToWhatsApp;
  if(typeof _oldSend==="function"){
    window.sendToWhatsApp = function(){
      if(maintOn()) return maintenanceBlock("ğŸ› ï¸ Compras pausadas. Fale com o suporte pelo chat âœ…");
      return _oldSend.apply(this, arguments);
    }
  }
})();

// Also disable checkout buttons visually if possible
function maintDisableButtons(){
  const on = maintOn();
  document.querySelectorAll("button").forEach(b=>{
    const t=(b.textContent||"").toLowerCase();
    if(t.includes("finalizar") || t.includes("gerar pedido") || t.includes("whatsapp") || t.includes("comprar")){
      b.disabled = on;
      b.style.opacity = on ? "0.6" : "";
      b.style.cursor = on ? "not-allowed" : "";
    }
  });
}
setInterval(()=>{ try{ maintDisableButtons(); }catch(e){} }, 3000);
setTimeout(()=>{ try{ renderMaint(); maintDisableButtons(); }catch(e){} }, 400);
/* ===== end Upgrade 19 ===== */


/* ===== Upgrade 20: Backup/Restore 1 clique ===== */
const BACKUP_KEYS = [
  "vv_orders",               // old
  "vv_orders_by_customer",   // my orders
  "vv_tickets",
  "vv_reviews",
  "vv_coupon_applied",
  "vv_security_logs",
  "vv_security_blocked_count",
  "vv_ticket_last_seen_ts",
  "vv_ticket_alerted_ts",
  "vv_my_whats",
  "vv_admin_pass_hash",
  "vv_admin_lock",
  "vv_catalog_state",
  "vv_maintenance_on",
  "vv_ticket_notify_on"
];

function backupAll(){
  const data = {
    brand:"ViralVault",
    version:"vv_backup_v1",
    ts: new Date().toISOString(),
    items: {}
  };
  BACKUP_KEYS.forEach(k=>{
    const v = localStorage.getItem(k);
    if(v !== null) data.items[k] = v;
  });
  // also include any vv_* keys not listed (future-proof) but keep it small
  Object.keys(localStorage).forEach(k=>{
    if(k.startsWith("vv_") && !(k in data.items) && k.length < 80){
      const v = localStorage.getItem(k);
      if(v !== null) data.items[k] = v;
    }
  });

  const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href=url;
  a.download = `viralvault_backup_${Date.now()}.json`;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{URL.revokeObjectURL(url); a.remove();},0);
  toast("Backup baixado âœ…");
}

function restoreAll(){
  // open file picker
  const inp = document.createElement("input");
  inp.type="file";
  inp.accept="application/json";
  inp.onchange = async ()=>{
    try{
      const file = inp.files?.[0];
      if(!file){ return; }
      const text = await file.text();
      const obj = JSON.parse(text);
      if(!obj || !obj.items){ toast("Arquivo invÃ¡lido."); return; }

      // Restore only vv_* keys from backup
      const items = obj.items;
      Object.keys(items).forEach(k=>{
        if(k.startsWith("vv_")){
          localStorage.setItem(k, String(items[k]));
        }
      });

      toast("Restaurado âœ… Recarregandoâ€¦");
      setTimeout(()=>location.reload(), 650);
    }catch(e){
      toast("Erro ao restaurar. Verifique o arquivo.");
      console.error(e);
    }
  };
  inp.click();
}
/* ===== end Upgrade 20 ===== */


/* ===== Upgrade 21: Dashboard (mÃ©tricas + grÃ¡fico simples) ===== */
function dashGetOrders(){
  // Prefer admin orders store if present
  try{
    if(typeof loadOrders==="function") return loadOrders() || [];
  }catch(e){}
  // fallback: try localStorage
  return loadJSON("vv_orders") || [];
}
function dashGetTickets(){
  try{ if(typeof loadTickets==="function") return loadTickets() || []; }catch(e){}
  return loadJSON("vv_tickets") || [];
}
function dashCouponsUsed(){
  // best-effort count from coupon usage store(s)
  let n=0;
  try{
    const applied = loadJSON("vv_coupon_applied") || {};
    n = Object.keys(applied).length;
  }catch(e){}
  return n;
}

function dayKeyISO(d){
  // yyyy-mm-dd
  const z = new Date(d.getTime() - d.getTimezoneOffset()*60000);
  return z.toISOString().slice(0,10);
}

function dashOrdersLastDays(days=7){
  const now = new Date();
  const keys=[];
  for(let i=days-1;i>=0;i--){
    const d=new Date(now); d.setDate(now.getDate()-i);
    keys.push(dayKeyISO(d));
  }
  const counts = Object.fromEntries(keys.map(k=>[k,0]));
  const orders = dashGetOrders();
  orders.forEach(o=>{
    const ts = o.ts || o.createdAt || o.date || "";
    if(!ts) return;
    const k = String(ts).slice(0,10);
    if(k in counts) counts[k]++;
  });
  return {keys, counts};
}

function dashMoneyFromOrders(){
  const orders = dashGetOrders();
  let sum = 0;
  orders.forEach(o=>{
    const t = o.total || o.amount || o.price || 0;
    const num = Number(String(t).replace(/[^0-9.,]/g,"").replace(".","").replace(",","."));
    if(!isNaN(num)) sum += num;
  });
  return sum;
}

function dashRefresh(){
  const orders = dashGetOrders();
  const tickets = dashGetTickets();
  const openTickets = tickets.filter(t=> !t.resolved && (t.status||"").toLowerCase()!=="resolvido").length;
  const rev = dashMoneyFromOrders();
  const coupons = dashCouponsUsed();

  const dOrders=el("d_orders"), dRev=el("d_rev"), dCoupons=el("d_coupons"), dTickets=el("d_tickets");
  if(dOrders) dOrders.textContent = String(orders.length);
  if(dRev) dRev.textContent = money(rev);
  if(dCoupons) dCoupons.textContent = String(coupons);
  if(dTickets) dTickets.textContent = String(openTickets);

  if(el("d_orders_sub")) el("d_orders_sub").textContent = orders.length ? "Pedidos registrados" : "Ainda sem pedidos";
  if(el("d_rev_sub")) el("d_rev_sub").textContent = orders.length ? "SomatÃ³rio do total" : "â€”";
  if(el("d_coupons_sub")) el("d_coupons_sub").textContent = coupons ? "Clientes economizaram" : "â€”";
  if(el("d_tickets_sub")) el("d_tickets_sub").textContent = openTickets ? "Precisa atenÃ§Ã£o" : "Tudo ok";

  // bars
  const {keys, counts} = dashOrdersLastDays(7);
  const max = Math.max(1, ...Object.values(counts));
  const wrap = el("d_bars");
  if(wrap){
    wrap.innerHTML = "";
    keys.forEach(k=>{
      const v = counts[k];
      const row=document.createElement("div");
      row.className="barRow";
      row.innerHTML = `
        <div class="tiny muted mono2">${escapeHTML(k.slice(5).replace("-","/"))}</div>
        <div class="bar"><i style="width:${Math.round((v/max)*100)}%"></i></div>
        <div class="tiny muted" style="text-align:right"><b>${v}</b></div>
      `;
      wrap.appendChild(row);
    });
  }

  // insights
  const ins = [];
  if(openTickets>0) ins.push(`VocÃª tem <b>${openTickets}</b> ticket(s) aberto(s). Responder rÃ¡pido aumenta confianÃ§a.`);
  if(orders.length===0) ins.push("Dica: poste o link do verificador VV-OFICIAL na bio/Stories para aumentar credibilidade.");
  if(coupons===0) ins.push("Cupom do dia pode aumentar conversÃ£o. Mostre no checkout e em posts.");
  if(orders.length>0 && rev/orders.length < 20) ins.push("Ticket mÃ©dio baixo: teste combos / bundles Premium.");
  const insEl = el("d_insights");
  if(insEl) insEl.innerHTML = ins.length ? ins.join("<br>") : "Tudo certo âœ…";

  toast("Dashboard atualizado âœ…");
}

// Auto refresh when opening dash
(function(){
  const _oldSetPage = window.setPage;
  if(typeof _oldSetPage==="function"){
    window.setPage = function(page){
      const r = _oldSetPage.apply(this, arguments);
      if(page==="dash"){
        setTimeout(()=>{ try{ dashRefresh(); }catch(e){} }, 120);
      }
      return r;
    }
  }
})();

setTimeout(()=>{ try{ dashRefresh(); }catch(e){} }, 800);
/* ===== end Upgrade 21 ===== */


/* ===== Upgrade 22: Vitrine (link direto + landing) ===== */
function siteBaseURL(){
  // Remove hash and query
  return location.origin + location.pathname;
}

function vitProducts(){
  try{ return (typeof PRODUCTS!=="undefined" && Array.isArray(PRODUCTS)) ? PRODUCTS : []; }catch(e){ return []; }
}

function vitInit(){
  const sel = el("vit_product");
  if(!sel) return;
  sel.innerHTML = "";
  vitProducts().forEach(p=>{
    const o=document.createElement("option");
    o.value=p.id;
    o.textContent = `${p.name} â€¢ ${money(Number(p.price||0))}`;
    sel.appendChild(o);
  });
  vitrineUpdate();
}

function vitrineUpdate(){
  const sel = el("vit_product");
  const cpn = (el("vit_coupon")?.value||"").trim();
  if(!sel) return;
  const pid = sel.value || (vitProducts()[0]?.id||"");
  const url = new URL(siteBaseURL(), location.origin);
  url.searchParams.set("p", pid);
  if(cpn) url.searchParams.set("cupom", cpn);
  url.searchParams.set("view", "vitrine");
  el("vit_link").value = url.toString();

  // Preview card
  const p = vitProducts().find(x=>x.id===pid) || {};
  const pv = el("vit_preview");
  if(pv){
    pv.innerHTML = `
      <div class="card">
        <div class="cardTop">
          <div class="cardImg">${escapeHTML((p.name||"").slice(0,2).toUpperCase())}</div>
          <div style="flex:1">
            <div class="cardName">${escapeHTML(p.name||"Produto")}</div>
            <div class="cardDesc">${escapeHTML(p.desc||p.description||"")}</div>
            <div class="tiny muted" style="margin-top:6px">${cpn ? "ğŸ Cupom: "+escapeHTML(cpn) : "Sem cupom"}</div>
          </div>
          <div style="text-align:right">
            <div class="mono" style="font-weight:900">${money(Number(p.price||0))}</div>
            <div class="tiny muted">PIX</div>
          </div>
        </div>
        <div class="prodActions">
          <button class="btn accent" onclick="vitrineBuy('${pid}','${escapeHTML(cpn).replace(/'/g,"&#39;")}')">Comprar agora</button>
          <button class="btn" onclick="addToCart('${pid}')">Adicionar</button>
        </div>
      </div>
    `;
  }

  const caption = `ğŸ”¥ ${p.name||"Produto"}\nâœ… Verificado VV-OFICIAL\nğŸ“¦ Rastreio\n${cpn ? "ğŸ Cupom: "+cpn+"\n" : ""}ğŸ‘‰ Link: ${url.toString()}`;
  const capEl = el("vit_caption");
  if(capEl) capEl.textContent = caption;
}

function vitrineCopy(){
  const v = el("vit_link")?.value||"";
  navigator.clipboard?.writeText(v);
  toast("Link copiado âœ…");
}
function vitrineOpen(){
  const v = el("vit_link")?.value||"";
  if(v) window.open(v, "_blank");
}
function vitrineBuy(pid, coupon){
  addToCart(pid);
  // try apply coupon if field exists
  try{
    if(coupon){
      const inp = document.getElementById("couponCode");
      if(inp){ inp.value = coupon; applyCoupon && applyCoupon(); }
    }
  }catch(e){}
  toast("No carrinho âœ…");
  try{ setPage("home"); }catch(e){}
}

// Landing via URL params: ?view=vitrine&p=<id>&cupom=...
function vitHandleURL(){
  try{
    const sp = new URLSearchParams(location.search);
    if(sp.get("view")!=="vitrine") return;
    const pid = sp.get("p") || "";
    const cpn = (sp.get("cupom")||"").trim();

    const p = vitProducts().find(x=>x.id===pid) || vitProducts()[0];
    if(!p) return;

    // Show home and highlight product
    setPage("home");
    // open a small modal-like toast + auto add
    toast("Abrindo vitrineâ€¦");
    // Apply coupon (best-effort)
    if(cpn){
      const inp = document.getElementById("couponCode");
      if(inp){ inp.value = cpn; if(typeof applyCoupon==="function") applyCoupon(); }
    }

    // scroll to products grid if present
    setTimeout(()=>{
      const grid = document.querySelector("#productsGrid") || document.querySelector(".products") || null;
      if(grid) grid.scrollIntoView({behavior:"smooth", block:"start"});
    }, 200);

    // Create floating vitrine card
    const existing = document.getElementById("vitrineFloating");
    if(existing) existing.remove();
    const f=document.createElement("div");
    f.id="vitrineFloating";
    f.style.position="fixed";
    f.style.left="16px";
    f.style.right="16px";
    f.style.bottom="16px";
    f.style.zIndex="9999";
    f.innerHTML = `
      <div class="card" style="border-radius:22px">
        <div class="cardTop">
          <div class="cardImg">${escapeHTML((p.name||"").slice(0,2).toUpperCase())}</div>
          <div style="flex:1">
            <div class="cardName">${escapeHTML(p.name||"Produto")}</div>
            <div class="cardDesc">${escapeHTML(p.desc||p.description||"")}</div>
            <div class="tiny muted" style="margin-top:6px">âœ… VV-OFICIAL â€¢ ğŸ“¦ Rastreio ${cpn ? " â€¢ ğŸ "+escapeHTML(cpn) : ""}</div>
          </div>
          <button class="btn" onclick="document.getElementById('vitrineFloating').remove()">âœ•</button>
        </div>
        <div class="prodActions">
          <button class="btn accent" onclick="addToCart('${p.id}'); toast('Adicionado âœ…')">Comprar</button>
          <button class="btn" onclick="setPage('verify')">Verificar</button>
        </div>
      </div>
    `;
    document.body.appendChild(f);
  }catch(e){}
}

// Init
setTimeout(()=>{ try{ vitInit(); vitHandleURL(); }catch(e){} }, 900);
/* ===== end Upgrade 22 ===== */


/* ===== Upgrade 23: Bundles/Combos (desconto automÃ¡tico) ===== */
const BUNDLES = [
  // Edite como quiser. Exemplo genÃ©rico:
  { id:"WELCOME_BUNDLE", name:"Combo Boas-vindas", items:["p1","p2"], discountPct: 8, label:"Leve 2 e ganhe 8%" },
  { id:"PREMIUM_PACK", name:"Pack Premium", items:["p3","p4","p5"], discountPct: 12, label:"Pack 3 itens -12%" },
];

function getCartItems(){
  // best-effort: state.cart assumed [{id,qty}]
  try{
    if(state && Array.isArray(state.cart)) return state.cart;
  }catch(e){}
  return [];
}

function cartCountById(){
  const m = {};
  getCartItems().forEach(it=>{
    const id = it.id || it.productId;
    const q = Number(it.qty||it.quantity||1);
    if(!id) return;
    m[id] = (m[id]||0) + (isNaN(q)?1:q);
  });
  return m;
}

function productById(id){
  try{ return (typeof PRODUCTS!=="undefined" && Array.isArray(PRODUCTS)) ? PRODUCTS.find(p=>p.id===id) : null; }catch(e){}
  return null;
}

function bundleEligible(b, counts){
  return b.items.every(id => (counts[id]||0) >= 1);
}

function bundleDiscountValue(b, counts){
  // simple: sum price of bundle items once each, apply pct
  let sum = 0;
  b.items.forEach(id=>{
    const p = productById(id);
    sum += Number(p?.price||0);
  });
  return sum * (Number(b.discountPct||0)/100);
}

function calcBundles(){
  const counts = cartCountById();
  const applied = [];
  let totalDisc = 0;
  BUNDLES.forEach(b=>{
    if(bundleEligible(b, counts)){
      const d = bundleDiscountValue(b, counts);
      if(d>0){
        applied.push({ ...b, discount: d });
        totalDisc += d;
      }
    }
  });
  return { applied, totalDisc };
}

function renderBundles(){
  const list = document.getElementById("bundleList");
  const disc = document.getElementById("bundleDiscount");
  if(disc) disc.textContent = money(0);
  if(!list) return;
  list.innerHTML = "";

  // show all bundles with status
  const counts = cartCountById();
  BUNDLES.forEach(b=>{
    const ok = bundleEligible(b, counts);
    const items = b.items.map(id=> productById(id)?.name || id).join(" + ");
    const wrap=document.createElement("div");
    wrap.className = "bundleItem";
    wrap.innerHTML = `
      <div class="ad_top">
        <div>
          <b>${escapeHTML(b.name)}</b>
          <div class="tiny muted">${escapeHTML(b.label||"")}</div>
        </div>
        <div><span class="chip ${ok?"ok":"bad"}">${ok?"ATIVO":"FALTA ITENS"}</span></div>
      </div>
      <div class="divider"></div>
      <div class="tiny muted">${escapeHTML(items)}</div>
    `;
    list.appendChild(wrap);
  });

  const { totalDisc } = calcBundles();
  if(disc) disc.textContent = money(totalDisc);

  // also update totals if function exists
  try{ if(typeof updateTotals==="function") updateTotals(); }catch(e){}
}

// Patch totals: subtract bundle discount from grand total display (best-effort)
(function(){
  const _old = window.computeTotal;
  if(typeof _old==="function"){
    window.computeTotal = function(){
      const base = _old.apply(this, arguments);
      try{
        const { totalDisc } = calcBundles();
        return Math.max(0, Number(base||0) - totalDisc);
      }catch(e){ return base; }
    }
  }
})();

// If there is a renderCart/totals function, hook it to also render bundles
(function(){
  const hooks = ["renderCart","updateCartUI","updateTotals","refreshCart"];
  hooks.forEach(fn=>{
    const old = window[fn];
    if(typeof old==="function"){
      window[fn] = function(){
        const r = old.apply(this, arguments);
        try{ renderBundles(); }catch(e){}
        return r;
      }
    }
  });
})();

// Add "Oferta" badge in catÃ¡logo cards if product belongs to a bundle
(function(){
  const oldCatalogRender = window.catalogRender;
  if(typeof oldCatalogRender==="function"){
    window.catalogRender = function(){
      const r = oldCatalogRender.apply(this, arguments);
      try{
        const grid = document.getElementById("cat_grid");
        if(!grid) return r;
        // quick scan: if cardName matches a bundle item, append tiny badge
        const bundleItems = new Set(BUNDLES.flatMap(b=>b.items));
        grid.querySelectorAll(".card").forEach(card=>{
          const name = card.querySelector(".cardName")?.textContent||"";
          // find product by name (best-effort) then by id from button onclick
          const btn = card.querySelector("button.btn.accent");
          const on = btn?.getAttribute("onclick")||"";
          const m = on.match(/addToCart\('([^']+)'\)/);
          const pid = m ? m[1] : null;
          if(pid && bundleItems.has(pid) && !card.querySelector(".offerBadge")){
            const badge=document.createElement("div");
            badge.className="chip ok offerBadge";
            badge.textContent="Oferta";
            badge.style.marginTop="8px";
            card.querySelector(".cardDesc")?.parentElement?.appendChild(badge);
          }
        });
      }catch(e){}
      return r;
    }
  }
})();

setTimeout(()=>{ try{ renderBundles(); }catch(e){} }, 1200);
/* ===== end Upgrade 23 ===== */


/* ===== Upgrade 24: Programa de Fidelidade (pontos + nÃ­veis + cupom) ===== */
function loyKey(){ return "vv_loyalty"; } // {whats:{points, level, history[]}}
function loyLoad(){ return loadJSON(loyKey()) || {}; }
function loySaveAll(o){ saveJSON(loyKey(), o||{}); }
function loyNorm(s){ return (s||"").replace(/\D/g,""); }

const LOY_LEVELS = [
  {name:"Bronze", min:0, perk:"Acesso ao cupom de boas-vindas"},
  {name:"Prata", min:150, perk:"Cupons exclusivos (5%)"},
  {name:"Ouro", min:350, perk:"Prioridade no suporte + 10% em datas especiais"},
];

const LOY_REWARDS = [
  {id:"VV5", need:120, pct:5, label:"Cupom 5% (120 pts)"},
  {id:"VV10", need:220, pct:10, label:"Cupom 10% (220 pts)"},
];

function loyGetWhats(){
  return loyNorm(el("loy_whats")?.value||"");
}

function loyGetProfile(w){
  const all = loyLoad();
  if(!all[w]) all[w] = { points:0, history:[] };
  return all[w];
}

function loyLevel(points){
  let lvl = LOY_LEVELS[0];
  LOY_LEVELS.forEach(x=>{ if(points>=x.min) lvl=x; });
  return lvl;
}

function loyRender(){
  const w = loyGetWhats();
  const benefits = el("loy_benefits");
  const hist = el("loy_hist");
  const histc = el("loy_hist_count");
  const pointsEl = el("loy_points");
  const lvlEl = el("loy_level");
  const nextEl = el("loy_next");

  if(!w){
    if(pointsEl) pointsEl.textContent="0";
    if(lvlEl) lvlEl.textContent="â€”";
    if(nextEl) nextEl.textContent="Digite seu WhatsApp para ver seus pontos.";
    if(benefits) benefits.innerHTML = "<div class='tiny muted'>Digite seu WhatsApp acima.</div>";
    if(hist) hist.innerHTML = "<div class='tiny muted'>â€”</div>";
    if(histc) histc.textContent="0";
    return;
  }

  const all = loyLoad();
  const p = loyGetProfile(w);
  const pts = Number(p.points||0);
  const lvl = loyLevel(pts);

  if(pointsEl) pointsEl.textContent = String(pts);
  if(lvlEl) lvlEl.textContent = "â­ " + lvl.name;
  if(nextEl){
    const next = LOY_LEVELS.find(x=>x.min>lvl.min);
    nextEl.textContent = next ? `Faltam ${next.min-pts} pts para ${next.name}.` : "VocÃª estÃ¡ no nÃ­vel mÃ¡ximo âœ…";
  }

  // benefits list
  if(benefits){
    const items = [
      {t:"NÃ­veis", d:LOY_LEVELS.map(x=>`${x.name} (${x.min}+): ${x.perk}`).join(" â€¢ ")},
      {t:"Recompensas", d:LOY_REWARDS.map(r=>`${r.label}`).join(" â€¢ ")},
      {t:"Como ganha pontos", d:"1 real gasto = 1 ponto (pontos entram quando o pedido Ã© gerado no site)."},
    ];
    benefits.innerHTML = "";
    items.forEach(it=>{
      const div=document.createElement("div");
      div.className="bundleItem";
      div.innerHTML = `<b>${escapeHTML(it.t)}</b><div class="tiny muted" style="margin-top:6px">${escapeHTML(it.d)}</div>`;
      benefits.appendChild(div);
    });
  }

  // history
  const h = (p.history||[]).slice().reverse();
  if(histc) histc.textContent = String(h.length);
  if(hist){
    if(h.length===0){ hist.innerHTML="<div class='tiny muted'>Sem histÃ³rico ainda.</div>"; }
    else{
      hist.innerHTML="";
      h.slice(0,30).forEach(e=>{
        const wrap=document.createElement("div");
        wrap.className="ad_item";
        wrap.innerHTML = `
          <div class="ad_top">
            <div>
              <b>${escapeHTML(e.type||"Evento")}</b>
              <div class="tiny muted mono2">${escapeHTML(new Date(e.ts).toLocaleString("pt-BR"))}</div>
            </div>
            <div><span class="chip ok">${escapeHTML(String(e.delta||0))} pts</span></div>
          </div>
          <div class="divider"></div>
          <div class="tiny muted">${escapeHTML(e.note||"")}</div>
        `;
        hist.appendChild(wrap);
      });
    }
  }

  // persist
  loySaveAll(all);
}

function loySave(){
  const w = loyGetWhats();
  if(!w){ toast("Coloque seu WhatsApp âœ…"); return; }
  localStorage.setItem("vv_loy_whats", w);
  toast("Salvo âœ…");
  loyRender();
}

function loyAddPoints(whats, points, note){
  const w = loyNorm(whats);
  if(!w) return;
  const all = loyLoad();
  const p = loyGetProfile(w);
  const delta = Math.max(0, Math.round(Number(points||0)));
  p.points = Number(p.points||0) + delta;
  p.history = p.history || [];
  p.history.push({ ts:new Date().toISOString(), type:"Compra", delta, note: note||"Pontos por pedido" });
  all[w]=p;
  loySaveAll(all);
}

function loyClaim(){
  const w = loyGetWhats();
  if(!w){ toast("Coloque seu WhatsApp âœ…"); return; }
  const all = loyLoad();
  const p = loyGetProfile(w);
  const pts = Number(p.points||0);

  // pick best reward affordable
  const reward = LOY_REWARDS.slice().reverse().find(r=>pts >= r.need);
  if(!reward){ toast("Ainda nÃ£o tem pontos suficientes pra gerar cupom."); return; }

  // Deduct points
  p.points = pts - reward.need;
  p.history.push({ ts:new Date().toISOString(), type:"Cupom", delta: -reward.need, note:`Gerou cupom ${reward.id} (${reward.pct}%)` });
  all[w]=p; loySaveAll(all);

  // Generate unique coupon per customer
  const code = `LOY-${reward.id}-${w.slice(-4)}-${Math.random().toString(36).slice(2,6).toUpperCase()}`;

  // Store in advanced coupons store if exists, else fallback to local coupon list
  try{
    const cs = loadJSON("vv_advanced_coupons") || {};
    cs[code] = { pct: reward.pct, maxUsesPerCustomer: 1, createdAt: new Date().toISOString(), note:"Fidelidade" };
    saveJSON("vv_advanced_coupons", cs);
  }catch(e){
    // ignore
  }

  // Show & copy
  navigator.clipboard?.writeText(code);
  toast("Cupom gerado e copiado âœ…");
  // Put in checkout field if exists
  const inp = document.getElementById("couponCode");
  if(inp){ inp.value = code; if(typeof applyCoupon==="function") applyCoupon(); }
  loyRender();
}

// Hook: add points when signed order is created (uses customer WhatsApp input if exists)
(function(){
  const _old = window.createSignedOrder;
  if(typeof _old==="function"){
    window.createSignedOrder = async function(){
      const r = await _old.apply(this, arguments);
      try{
        const w = (document.getElementById("custWhats")?.value || localStorage.getItem("vv_my_whats") || "").toString();
        // estimate points from cart total (use computeTotal if exists)
        let total = 0;
        try{ total = (typeof computeTotal==="function") ? Number(computeTotal()||0) : 0; }catch(e){}
        loyAddPoints(w, total, `Pedido ${state?.signed?.orderId||""}`);
      }catch(e){}
      return r;
    }
  }
})();

// Init saved whatsapp
setTimeout(()=>{
  try{
    const w = localStorage.getItem("vv_loy_whats") || "";
    if(w && el("loy_whats")) el("loy_whats").value = "+"+w;
    loyRender();
  }catch(e){}
}, 750);
/* ===== end Upgrade 24 ===== */


/* ===== Upgrade 25: Favoritos (wishlist) + salvar para depois ===== */
function favKey(){ return "vv_favorites"; } // array of product ids
function favLoad(){ return loadJSON(favKey()) || []; }
function favSave(list){ saveJSON(favKey(), (list||[]).slice(-300)); }

function favHas(id){ return favLoad().includes(id); }
function favToggle(id){
  if(!id) return;
  const list = favLoad();
  const i = list.indexOf(id);
  if(i>=0){ list.splice(i,1); toast("Removido dos favoritos"); }
  else { list.push(id); toast("Adicionado aos favoritos â¤ï¸"); }
  favSave(list);
  favRender();
  // refresh catalog badges
  try{ if(typeof catalogRender==="function") catalogRender(); }catch(e){}
}

function favClear(){
  favSave([]);
  toast("Favoritos limpos.");
  favRender();
  try{ if(typeof catalogRender==="function") catalogRender(); }catch(e){}
}

function favRender(){
  const grid = el("fav_grid");
  const cnt = el("fav_count");
  if(!grid) return;
  const ids = favLoad();
  if(cnt) cnt.textContent = String(ids.length);
  grid.innerHTML = "";
  if(ids.length===0){
    grid.innerHTML = "<div class='tiny muted'>Sem favoritos ainda. No CatÃ¡logo, clique em â¤ï¸ para salvar.</div>";
    return;
  }
  const prods = (typeof PRODUCTS!=="undefined" && Array.isArray(PRODUCTS)) ? PRODUCTS : [];
  ids.slice().reverse().forEach(id=>{
    const p = prods.find(x=>x.id===id);
    if(!p) return;
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML = `
      <div class="cardTop">
        <div class="cardImg">${escapeHTML((p.name||"").slice(0,2).toUpperCase())}</div>
        <div style="flex:1">
          <div class="cardName">${escapeHTML(p.name||"Produto")}</div>
          <div class="cardDesc">${escapeHTML(p.desc||p.description||"")}</div>
        </div>
        <div style="text-align:right">
          <div class="mono" style="font-weight:900">${money(Number(p.price||0))}</div>
          <button class="btn" onclick="favToggle('${p.id}')">â¤ï¸</button>
        </div>
      </div>
      <div class="prodActions">
        <button class="btn accent" onclick="addToCart('${p.id}')">Adicionar</button>
        <button class="btn" onclick="setPage('home'); toast('Veja o carrinho âœ…')">Ir ao carrinho</button>
      </div>
    `;
    grid.appendChild(card);
  });
}

// Add a heart button inside catalog cards
(function(){
  const oldCatalog = window.catalogRender;
  if(typeof oldCatalog==="function"){
    window.catalogRender = function(){
      const r = oldCatalog.apply(this, arguments);
      try{
        const grid = document.getElementById("cat_grid");
        if(!grid) return r;
        grid.querySelectorAll(".card").forEach(card=>{
          const btn = card.querySelector("button.btn.accent");
          const on = btn?.getAttribute("onclick")||"";
          const m = on.match(/addToCart\('([^']+)'\)/);
          const pid = m ? m[1] : null;
          if(!pid) return;
          if(card.querySelector(".favBtn")) return;
          const fav=document.createElement("button");
          fav.className="btn favBtn";
          fav.textContent = favHas(pid) ? "ğŸ’–" : "ğŸ¤";
          fav.onclick = ()=>{ favToggle(pid); fav.textContent = favHas(pid) ? "ğŸ’–" : "ğŸ¤"; };
          // Put near actions row
          const actions = card.querySelector(".prodActions");
          if(actions) actions.appendChild(fav);
        });
      }catch(e){}
      return r;
    }
  }
})();

// Save-for-later: move cart items to favorites
function saveForLater(id){
  if(!id) return;
  if(!favHas(id)) { const list=favLoad(); list.push(id); favSave(list); }
  // remove from cart (best-effort)
  try{
    if(state && Array.isArray(state.cart)){
      state.cart = state.cart.filter(x=> (x.id||x.productId)!==id);
      saveCart && saveCart();
      renderCart && renderCart();
    }
  }catch(e){}
  toast("Salvo para depois â¤ï¸");
  favRender();
}

// Try to add "Salvar" button in cart UI if cart rows exist with data-id
setTimeout(()=>{
  try{
    document.querySelectorAll("[data-cart-id]").forEach(row=>{
      const id=row.getAttribute("data-cart-id");
      if(!id) return;
      if(row.querySelector(".saveLaterBtn")) return;
      const b=document.createElement("button");
      b.className="btn saveLaterBtn";
      b.textContent="Salvar";
      b.onclick=()=>saveForLater(id);
      row.appendChild(b);
    });
  }catch(e){}
}, 1400);

setTimeout(()=>{ try{ favRender(); }catch(e){} }, 900);
/* ===== end Upgrade 25 ===== */


/* ===== Upgrade 27: PÃ¡gina TransparÃªncia & Antiâ€‘Golpe ===== */
function trustExplainText(){
  return [
    "âœ… Como confirmar que Ã© real (VVâ€‘OFICIAL):",
    "1) Copie o Order ID do seu pedido.",
    "2) Abra a aba 'Verificar' neste site.",
    "3) Cole o Order ID e confirme.",
    "Se aparecer âœ… 'Verificado no servidor', o pedido Ã© legÃ­timo.",
    "Se aparecer âŒ 'Pedido falso', NÃƒO pague."
  ].join("\n");
}

function trustWhats(){
  // Try common places where the WhatsApp is stored/configured
  const candidates = [
    window.WHATSAPP_NUMBER,
    localStorage.getItem("vv_support_whats"),
    localStorage.getItem("vv_my_whats"),
  ].filter(Boolean);
  // fallback: use the number embedded earlier in builds (if any)
  return String(candidates[0]||"5511941598713");
}

function openWhatsSupport(){
  const n = trustWhats().replace(/\D/g,"");
  const msg = encodeURIComponent("OlÃ¡! Preciso de suporte (ViralVault).");
  window.open(`https://wa.me/${n}?text=${msg}`, "_blank");
}

setTimeout(()=>{
  try{
    const n = trustWhats().replace(/\D/g,"");
    const pretty = "+" + n.replace(/^(\d{2})(\d{2})(\d{5})(\d{4}).*$/,"$1 $2 $3-$4");
    const elx = document.getElementById("trust_whats_text");
    if(elx) elx.textContent = pretty;
  }catch(e){}
}, 700);
/* ===== end Upgrade 27 ===== */


/* ===== Upgrade 28: Status do Sistema (Worker online + latÃªncia) ===== */
function stAutoKey(){ return "vv_status_auto"; }
function stAutoOn(){ return (localStorage.getItem(stAutoKey()) ?? "1")==="1"; }
function stSetAuto(v){ localStorage.setItem(stAutoKey(), v ? "1":"0"); }

function getWorkerURL(){
  // try common config names
  const cand = [
    window.WORKER_URL,
    localStorage.getItem("vv_worker_url"),
    localStorage.getItem("vv_sign_worker_url"),
  ].filter(Boolean)[0];
  // fallback: if verify page has an endpoint variable in code, user will edit there.
  return String(cand || "https://viralvault-sign.darlanana06.workers.dev/");
}

function statusAutoToggle(){
  stSetAuto(!stAutoOn());
  const b = el("st_auto_btn");
  if(b) b.textContent = stAutoOn() ? "Auto: ON" : "Auto: OFF";
  toast("Auto teste: " + (stAutoOn() ? "ON" : "OFF"));
}

async function statusRun(){
  const url = getWorkerURL().replace(/\/+$/,"") + "/sign";
  if(el("st_worker_url")) el("st_worker_url").textContent = url;
  const t0 = performance.now();
  let rep = { ok:false, url, ts:new Date().toISOString() };
  try{
    // Minimal valid payload to force signature
    const payload = { total: 1, user: "status", itemsHash: "status" };
    const r = await fetch(url, { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify(payload) });
    const t1 = performance.now();
    rep.http = r.status;
    rep.latencyMs = Math.round(t1 - t0);
    rep.body = await r.json().catch(()=>({raw:"(nÃ£o-JSON)"}));
    rep.ok = !!rep.body?.ok;
  }catch(e){
    rep.error = String(e?.message||e);
  }

  // UI
  if(el("st_latency")) el("st_latency").textContent = rep.latencyMs ? (rep.latencyMs+" ms") : "â€”";
  if(el("st_last")) el("st_last").textContent = new Date().toLocaleString("pt-BR");
  const badge = el("st_worker_badge");
  if(badge){
    if(rep.ok){
      badge.className="chip ok";
      badge.textContent="ONLINE";
    }else{
      badge.className="chip bad";
      badge.textContent="OFFLINE";
    }
  }
  const rb = el("st_report_badge");
  if(rb){ rb.className = "chip " + (rep.ok ? "ok":"bad"); rb.textContent = rep.ok ? "OK" : "FALHA"; }

  const text = [
    "ViralVault â€¢ Status do Sistema",
    "URL: " + rep.url,
    "HTTP: " + (rep.http ?? "â€”"),
    "LatÃªncia: " + (rep.latencyMs ? rep.latencyMs+"ms" : "â€”"),
    "Resultado: " + (rep.ok ? "ONLINE âœ…" : "OFFLINE âŒ"),
    rep.error ? ("Erro: " + rep.error) : "",
    "Resposta: " + JSON.stringify(rep.body || {}, null, 2)
  ].filter(Boolean).join("\n");

  if(el("st_report")) el("st_report").textContent = text;
  toast(rep.ok ? "Worker ONLINE âœ…" : "Falha no teste âŒ");
  return rep.ok;
}

// auto-run on open
(function(){
  const old = window.setPage;
  if(typeof old==="function"){
    window.setPage = function(page){
      const r = old.apply(this, arguments);
      if(page==="status"){
        setTimeout(()=>{
          try{
            const b = el("st_auto_btn");
            if(b) b.textContent = stAutoOn() ? "Auto: ON" : "Auto: OFF";
            if(stAutoOn()) statusRun();
          }catch(e){}
        }, 160);
      }
      return r;
    }
  }
})();

// periodic auto test (light)
setInterval(()=>{
  try{
    const statusVisible = document.getElementById("pageStatus") && document.getElementById("pageStatus").style.display !== "none";
    if(statusVisible && stAutoOn()) statusRun();
  }catch(e){}
}, 60000);
/* ===== end Upgrade 28 ===== */


/* ===== Upgrade 29: Pagamento (PIX seguro + gerador) ===== */
function payGenerate(){
  const order = (el("pay_order")?.value||"").trim();
  const total = (el("pay_total")?.value||"").trim();
  const pix = (el("pay_pix")?.value||"").trim();
  if(!order || !total){
    toast("Preencha Order ID e Total âœ…");
    return;
  }
  const site = location.origin + location.pathname;
  const msg = [
    "ğŸ§¾ *Pagamento ViralVault*",
    "",
    "âœ… *Pedido verificado*: use o verificador antes de pagar.",
    `ğŸ” Order ID: *${order}*`,
    `ğŸ’° Total: *R$ ${total}*`,
    pix ? `ğŸ”‘ Chave PIX: *${pix}*` : "",
    "",
    "âš ï¸ SeguranÃ§a: confirme o *nome do recebedor* no app do banco.",
    `ğŸŒ Site oficial: ${site}`
  ].filter(Boolean).join("\n");

  el("pay_msg").value = msg;

  // payload for copy/paste
  const payload = `PIX|ORDER:${order}|TOTAL:${total}|KEY:${pix||"-"}|SITE:${site}`;
  el("pay_payload").value = payload;

  // QR (simple): Use Google Chart API (just for QR image)
  const qr = el("pay_qr");
  if(qr){
    const q = encodeURIComponent(payload);
    qr.innerHTML = `<img alt="QR PIX" style="max-width:180px;border-radius:16px" src="https://chart.googleapis.com/chart?chs=220x220&cht=qr&chl=${q}" />`;
  }
  toast("Mensagem gerada âœ…");
}

function openWhatsFromPay(){
  const n = (typeof trustWhats==="function" ? trustWhats() : "5511941598713").replace(/\D/g,"");
  const msg = encodeURIComponent(el("pay_msg")?.value||"");
  if(!msg){ toast("Gere a mensagem primeiro âœ…"); return; }
  window.open(`https://wa.me/${n}?text=${msg}`, "_blank");
}

// Auto-fill from last signed order if exists
setTimeout(()=>{
  try{
    if(state?.signed?.orderId && el("pay_order")) el("pay_order").value = state.signed.orderId;
    if(state?.signed?.total && el("pay_total")) el("pay_total").value = String(state.signed.total).replace(".",",");
  }catch(e){}
}, 900);
/* ===== end Upgrade 29 ===== */


/* ===== Upgrade 30: Loja 100% Digital (entrega instantÃ¢nea) ===== */
function delivKeyEmail(){ return "vv_deliv_email"; }
function delivKeyWhats(){ return "vv_deliv_whats"; }

function delivLoad(){
  try{
    if(el("delivEmail")) el("delivEmail").value = localStorage.getItem(delivKeyEmail()) || "";
    if(el("delivWhats")) el("delivWhats").value = localStorage.getItem(delivKeyWhats()) || (localStorage.getItem("vv_my_whats")||"");
  }catch(e){}
}

function delivSave(){
  try{
    if(el("delivEmail")) localStorage.setItem(delivKeyEmail(), (el("delivEmail").value||"").trim());
    if(el("delivWhats")) localStorage.setItem(delivKeyWhats(), (el("delivWhats").value||"").trim());
    // also mirror to vv_my_whats for other parts
    const w=(el("delivWhats")?.value||"").trim();
    if(w) localStorage.setItem("vv_my_whats", w);
  }catch(e){}
}

// Patch WhatsApp message to include delivery info
(function(){
  const old = window.sendToWhatsApp;
  if(typeof old==="function"){
    window.sendToWhatsApp = function(){
      try{ delivSave(); }catch(e){}
      // attempt to append info if message builder exists
      try{
        if(state && state.signed){
          state.signed.delivery = {
            email: (localStorage.getItem(delivKeyEmail())||"").trim(),
            whatsapp: (localStorage.getItem(delivKeyWhats())||"").trim()
          };
        }
      }catch(e){}
      return old.apply(this, arguments);
    }
  }
})();

// When building message for WhatsApp, also add delivery fields (best-effort if a builder exists)
(function(){
  const oldBuild = window.buildWhatsMessage;
  if(typeof oldBuild==="function"){
    window.buildWhatsMessage = function(){
      const msg = oldBuild.apply(this, arguments) || "";
      const email = (localStorage.getItem(delivKeyEmail())||"").trim();
      const w = (localStorage.getItem(delivKeyWhats())||"").trim();
      const extra = [
        "",
        "ğŸ“¦ *Entrega digital*",
        w ? ("WhatsApp: *"+w+"*") : "",
        email ? ("E-mail: *"+email+"*") : "",
      ].filter(Boolean).join("\n");
      return msg + extra;
    }
  }
})();

// Add "Digital" badge in catalog cards (non-invasive)
(function(){
  const oldCatalog = window.catalogRender;
  if(typeof oldCatalog==="function"){
    window.catalogRender = function(){
      const r = oldCatalog.apply(this, arguments);
      try{
        const grid = document.getElementById("cat_grid");
        if(grid){
          grid.querySelectorAll(".card").forEach(card=>{
            if(card.querySelector(".digitalBadge")) return;
            const b=document.createElement("span");
            b.className="chip ok digitalBadge";
            b.textContent="Digital";
            b.style.marginTop="8px";
            card.querySelector(".cardDesc")?.parentElement?.appendChild(b);
          });
        }
      }catch(e){}
      return r;
    }
  }
})();

setTimeout(()=>{ try{ delivLoad(); }catch(e){} }, 700);
setInterval(()=>{ try{ delivSave(); }catch(e){} }, 8000);
/* ===== end Upgrade 30 ===== */


/* ===== Upgrade 31: Entrega Roblox 1 clique (itens/brainrots) ===== */
function delivTplKey(){ return "vv_deliv_tpl"; }

function delivTplDefault(){
  return [
"âœ… *ViralVault â€” Entrega Roblox (VVâ€‘OFICIAL)*",
"",
"ğŸ” Pedido: *{orderId}*",
"ğŸ’° Total: *{total}*",
"ğŸ§¾ Itens: {items}",
"",
"ğŸ® Roblox: *{robloxUser}*",
"ğŸ“ Jogo/Servidor: {server}",
"ğŸ•’ HorÃ¡rio: {time}",
"",
"ğŸ“· *Prova de entrega:* envio print/vÃ­deo apÃ³s entregar.",
"",
"Se precisar alterar horÃ¡rio/servidor, responda aqui âœ…"
  ].join("\n");
}

function delivTplLoad(){
  return localStorage.getItem(delivTplKey()) || delivTplDefault();
}
function delivTplSave(){
  localStorage.setItem(delivTplKey(), el("deliv_tpl").value || delivTplDefault());
  toast("Template salvo âœ…");
}
function delivTplReset(){
  el("deliv_tpl").value = delivTplDefault();
  delivTplSave();
}

function delivLoadCheckout(){
  try{
    if(el("rbxUser")) el("rbxUser").value = localStorage.getItem("vv_rbx_user") || "";
    if(el("rbxServer")) el("rbxServer").value = localStorage.getItem("vv_rbx_server") || "";
    if(el("rbxTime")) el("rbxTime").value = localStorage.getItem("vv_rbx_time") || "";
  }catch(e){}
}
function delivSaveCheckout(){
  try{
    if(el("rbxUser")) localStorage.setItem("vv_rbx_user", (el("rbxUser").value||"").trim());
    if(el("rbxServer")) localStorage.setItem("vv_rbx_server", (el("rbxServer").value||"").trim());
    if(el("rbxTime")) localStorage.setItem("vv_rbx_time", (el("rbxTime").value||"").trim());
  }catch(e){}
}

function delivItemsText(order){
  try{
    const items = order.items || order.cart || [];
    if(Array.isArray(items) && items.length){
      return items.map(it=>{
        const n = it.name || productById(it.id||it.productId)?.name || it.id || "item";
        const q = it.qty || it.quantity || 1;
        return `${q}x ${n}`;
      }).join(", ");
    }
  }catch(e){}
  return "â€”";
}

function delivFill(tpl, order){
  const robloxUser = (order.robloxUser || order.delivery?.robloxUser || localStorage.getItem("vv_rbx_user") || "â€”").toString();
  const server = (order.robloxServer || order.delivery?.server || localStorage.getItem("vv_rbx_server") || "â€”").toString();
  const time = (order.robloxTime || order.delivery?.time || localStorage.getItem("vv_rbx_time") || "â€”").toString();

  return (tpl||"").replaceAll("{orderId}", order.orderId||"â€”")
                   .replaceAll("{total}", money(Number(order.total||0)))
                   .replaceAll("{items}", delivItemsText(order))
                   .replaceAll("{robloxUser}", robloxUser.startsWith("@")?robloxUser:("@"+robloxUser))
                   .replaceAll("{server}", server||"â€”")
                   .replaceAll("{time}", time||"â€”");
}

function delivSend(order){
  const n = (typeof trustWhats==="function" ? trustWhats() : "5511941598713").replace(/\D/g,"");
  const tpl = delivTplLoad();
  const msg = encodeURIComponent(delivFill(tpl, order||{}));
  window.open(`https://wa.me/${n}?text=${msg}`, "_blank");
}

function delivRequireFields(){
  const u = (el("rbxUser")?.value||"").trim();
  if(!u){ toast("Preencha o Username do Roblox âœ…"); return false; }
  return true;
}

// Hook order creation: store roblox fields into signed order metadata
(function(){
  const old = window.createSignedOrder;
  if(typeof old==="function"){
    window.createSignedOrder = async function(){
      delivSaveCheckout();
      if(!delivRequireFields()) return;
      const r = await old.apply(this, arguments);
      try{
        if(state && state.signed){
          state.signed.robloxUser = (localStorage.getItem("vv_rbx_user")||"").trim();
          state.signed.robloxServer = (localStorage.getItem("vv_rbx_server")||"").trim();
          state.signed.robloxTime = (localStorage.getItem("vv_rbx_time")||"").trim();
          // persist in orders store if exists
          try{
            const orders = (typeof loadOrders==="function") ? (loadOrders()||[]) : (loadJSON("vv_orders")||[]);
            const idx = orders.findIndex(o=>o.orderId===state.signed.orderId);
            if(idx>=0){
              orders[idx].robloxUser = state.signed.robloxUser;
              orders[idx].robloxServer = state.signed.robloxServer;
              orders[idx].robloxTime = state.signed.robloxTime;
              if(typeof saveOrders==="function") saveOrders(orders); else saveJSON("vv_orders", orders);
            }
          }catch(e){}
        }
      }catch(e){}
      return r;
    }
  }
})();

// Patch Admin orders render: add "Enviar entrega" button
(function(){
  const old = window.renderAdminOrders || window.renderOrdersAdmin;
  if(typeof old==="function"){
    const fnName = window.renderAdminOrders ? "renderAdminOrders" : "renderOrdersAdmin";
    window[fnName] = function(){
      const r = old.apply(this, arguments);
      try{
        // add buttons inside admin order cards
        document.querySelectorAll(".ad_item").forEach(card=>{
          if(card.querySelector(".btnDeliv")) return;
          // attempt to get orderId text
          const oid = card.querySelector("b.mono2")?.textContent || card.querySelector(".mono2")?.textContent || "";
          if(!oid.includes("vv_")) return;
          const btn=document.createElement("button");
          btn.className="btn accent btnDeliv";
          btn.textContent="Enviar entrega";
          btn.onclick=()=>{
            try{
              const orders = (typeof loadOrders==="function") ? (loadOrders()||[]) : (loadJSON("vv_orders")||[]);
              const order = orders.find(o=>o.orderId===oid) || {orderId:oid};
              delivSend(order);
            }catch(e){ toast("NÃ£o achei o pedido no histÃ³rico."); }
          };
          // place in top right
          const top = card.querySelector(".ad_top");
          if(top) top.appendChild(btn);
        });
      }catch(e){}
      return r;
    }
  }
})();

setTimeout(()=>{
  try{
    if(el("deliv_tpl")) el("deliv_tpl").value = delivTplLoad();
    delivLoadCheckout();
  }catch(e){}
}, 800);
/* ===== end Upgrade 31 ===== */


/* ===== Upgrade 32: Prova de entrega (1 clique) + marcar como Entregue + log ===== */
function deliveryLogKey(){ return "vv_delivery_log"; } // array
function loadDeliveryLog(){ return loadJSON(deliveryLogKey()) || []; }
function saveDeliveryLog(x){ saveJSON(deliveryLogKey(), (x||[]).slice(-800)); }

function markDelivered(orderId, note){
  if(!orderId) return;
  // Update order status in storage
  try{
    const orders = (typeof loadOrders==="function") ? (loadOrders()||[]) : (loadJSON("vv_orders")||[]);
    const idx = orders.findIndex(o=>o.orderId===orderId);
    if(idx>=0){
      orders[idx].status = "DELIVERED";
      orders[idx].deliveredAt = new Date().toISOString();
      orders[idx].deliveredNote = note || "";
      if(typeof saveOrders==="function") saveOrders(orders); else saveJSON("vv_orders", orders);
    }
  }catch(e){}

  // Push log
  try{
    const log = loadDeliveryLog();
    log.push({ ts:new Date().toISOString(), orderId, note: note||"", type:"delivered" });
    saveDeliveryLog(log);
  }catch(e){}

  // Update tracking store if exists (global track feature)
  try{
    const tracks = loadJSON("vv_tracks") || {};
    if(!tracks[orderId]) tracks[orderId] = [];
    tracks[orderId].push({ ts:new Date().toISOString(), step:"Entregue âœ…", note: note||"Entrega confirmada com prova" });
    saveJSON("vv_tracks", tracks);
  }catch(e){}

  toast("Marcado como ENTREGUE âœ…");
  try{
    if(typeof renderAdminOrders==="function") renderAdminOrders();
    if(typeof renderTrackUI==="function") renderTrackUI();
  }catch(e){}
}

function openProofMessage(order){
  const n = (typeof trustWhats==="function" ? trustWhats() : "5511941598713").replace(/\D/g,"");
  const oid = order?.orderId || "â€”";
  const roblox = (order?.robloxUser || localStorage.getItem("vv_rbx_user") || "â€”").toString();
  const msg = encodeURIComponent([
    "âœ… *Entrega confirmada â€” ViralVault*",
    "",
    `ğŸ” Pedido: *${oid}*`,
    `ğŸ® Roblox: *${roblox.startsWith("@")?roblox:"@"+roblox}*`,
    "",
    "ğŸ“· Prova de entrega: (anexe print/vÃ­deo aqui)",
    "Se precisar de suporte, responda esta mensagem âœ…"
  ].join("\n"));
  window.open(`https://wa.me/${n}?text=${msg}`, "_blank");
}

// Patch Admin cards: add buttons "Prova" and "Entregue âœ…"
(function(){
  const wrap = (fn)=>{
    const old = window[fn];
    if(typeof old!=="function") return;
    window[fn] = function(){
      const r = old.apply(this, arguments);
      try{
        document.querySelectorAll(".ad_item").forEach(card=>{
          const oid = card.querySelector("b.mono2")?.textContent || card.querySelector(".mono2")?.textContent || "";
          if(!oid.includes("vv_")) return;
          if(card.querySelector(".btnDelivered")) return;

          // find order
          let order = null;
          try{
            const orders = (typeof loadOrders==="function") ? (loadOrders()||[]) : (loadJSON("vv_orders")||[]);
            order = orders.find(o=>o.orderId===oid) || {orderId:oid};
          }catch(e){ order = {orderId:oid}; }

          const group = document.createElement("div");
          group.style.display="flex";
          group.style.gap="8px";
          group.style.flexWrap="wrap";

          const bProof=document.createElement("button");
          bProof.className="btn btnProof";
          bProof.textContent="Prova";
          bProof.onclick=()=>openProofMessage(order);

          const bDone=document.createElement("button");
          bDone.className="btn accent btnDelivered";
          bDone.textContent="Entregue âœ…";
          bDone.onclick=()=>{
            const note = prompt("Nota (opcional): ex: entregue no servidor X, 20:30") || "";
            markDelivered(oid, note);
          };

          // show status chip
          const chip = document.createElement("span");
          chip.className = "chip " + ((order.status==="DELIVERED")?"ok":"");
          chip.textContent = (order.status==="DELIVERED") ? "DELIVERED" : "PENDENTE";

          group.appendChild(bProof);
          group.appendChild(bDone);
          group.appendChild(chip);

          const top = card.querySelector(".ad_top");
          if(top) top.appendChild(group);
        });
      }catch(e){}
      return r;
    }
  };
  wrap("renderAdminOrders");
  wrap("renderOrdersAdmin");
})();

// Add Delivery Log section in Admin (simple)
(function(){
  const page = document.getElementById("pageAdmin");
  if(!page) return;
  if(document.getElementById("deliveryLogPanel")) return;

  const panel = document.createElement("div");
  panel.className="panel fade";
  panel.id="deliveryLogPanel";
  panel.innerHTML = `
    <div class="pHead"><b>ğŸ“· Log de entregas</b><span class="chip" id="dl_count">0</span></div>
    <div class="pBody">
      <div class="ad_list" id="dl_list"></div>
      <div class="prodActions" style="margin-top:10px">
        <button class="btn" onclick="dlRefresh()">Atualizar</button>
        <button class="btn" onclick="copyText(JSON.stringify(loadDeliveryLog(), null, 2))">Copiar JSON</button>
        <button class="btn" onclick="saveDeliveryLog([]); dlRefresh(); toast('Log limpo')">Limpar</button>
      </div>
    </div>
  `;
  page.querySelector(".box")?.appendChild(panel);

  window.dlRefresh = function(){
    const log = loadDeliveryLog().slice().reverse();
    const list = el("dl_list");
    const cnt = el("dl_count");
    if(cnt) cnt.textContent = String(log.length);
    if(!list) return;
    list.innerHTML = "";
    if(log.length===0){
      list.innerHTML = "<div class='tiny muted'>Sem entregas marcadas ainda.</div>";
      return;
    }
    log.slice(0,25).forEach(e=>{
      const it=document.createElement("div");
      it.className="ad_item";
      it.innerHTML = `
        <div class="ad_top">
          <div>
            <b class="mono2">${escapeHTML(e.orderId||"â€”")}</b>
            <div class="tiny muted mono2">${escapeHTML(new Date(e.ts).toLocaleString("pt-BR"))}</div>
          </div>
          <div><span class="chip ok">Entregue</span></div>
        </div>
        <div class="divider"></div>
        <div class="tiny muted">${escapeHTML(e.note||"")}</div>
      `;
      list.appendChild(it);
    });
  };

  setTimeout(()=>{ try{ dlRefresh(); }catch(e){} }, 900);
})();
/* ===== end Upgrade 32 ===== */


/* ===== Upgrade 33: SLA 24h + Reembolso (status + logs + mensagens prontas) ===== */
function slaMs(){ return 24*60*60*1000; }
function nowISO(){ return new Date().toISOString(); }

function orderStoreLoad(){
  try{ return (typeof loadOrders==="function") ? (loadOrders()||[]) : (loadJSON("vv_orders")||[]); }catch(e){ return []; }
}
function orderStoreSave(orders){
  try{ if(typeof saveOrders==="function") saveOrders(orders); else saveJSON("vv_orders", orders); }catch(e){}
}
function setOrderStatus(orderId, patch){
  const orders = orderStoreLoad();
  const i = orders.findIndex(o=>o.orderId===orderId);
  if(i<0){ toast("Pedido nÃ£o encontrado."); return null; }
  orders[i] = { ...orders[i], ...(patch||{}) };
  orderStoreSave(orders);
  return orders[i];
}

function markPaid(orderId){
  const o = setOrderStatus(orderId, { paidAt: nowISO(), status: "PAID" });
  if(!o) return;
  try{
    const tracks = loadJSON("vv_tracks") || {};
    if(!tracks[orderId]) tracks[orderId] = [];
    tracks[orderId].push({ ts: nowISO(), step:"Pagamento confirmado âœ…", note:"Pagamento confirmado manualmente" });
    saveJSON("vv_tracks", tracks);
  }catch(e){}
  toast("Marcado como PAGO âœ…");
  try{ if(typeof renderAdminOrders==="function") renderAdminOrders(); }catch(e){}
}

function markRefund(orderId, note){
  const o = setOrderStatus(orderId, { refundedAt: nowISO(), status: "REFUNDED", refundNote: note||"" });
  if(!o) return;
  try{
    const tracks = loadJSON("vv_tracks") || {};
    if(!tracks[orderId]) tracks[orderId] = [];
    tracks[orderId].push({ ts: nowISO(), step:"Reembolso â†©ï¸", note: note||"Reembolso total (SLA 24h)" });
    saveJSON("vv_tracks", tracks);
  }catch(e){}
  try{
    const log = loadJSON("vv_refund_log") || [];
    log.push({ ts: nowISO(), orderId, note: note||"", type:"refund" });
    saveJSON("vv_refund_log", log.slice(-600));
  }catch(e){}
  toast("Marcado como REEMBOLSADO â†©ï¸");
  try{ if(typeof renderAdminOrders==="function") renderAdminOrders(); }catch(e){}
}

function slaRemaining(order){
  const base = order.paidAt || order.ts || order.createdAt;
  if(!base) return null;
  const t = new Date(base).getTime();
  return (t + slaMs()) - Date.now();
}
function fmtRem(ms){
  if(ms==null) return "â€”";
  if(ms<=0) return "SLA estourado";
  const h = Math.floor(ms/3600000);
  const m = Math.floor((ms%3600000)/60000);
  return `${h}h ${m}m`;
}

function refundMsg(order){
  const n = (typeof trustWhats==="function" ? trustWhats() : "5511941598713").replace(/\D/g,"");
  const oid = order.orderId || "â€”";
  const msg = encodeURIComponent([
    "â†©ï¸ *Reembolso â€” ViralVault*",
    "",
    `ğŸ” Pedido: *${oid}*`,
    "Confirmamos o reembolso total conforme nossa garantia de entrega em atÃ© 24h.",
    "",
    "Se precisar de algo, responda esta mensagem âœ…"
  ].join("\n"));
  window.open(`https://wa.me/${n}?text=${msg}`, "_blank");
}

// Patch Admin cards
(function(){
  const wrap = (fn)=>{
    const old = window[fn];
    if(typeof old!=="function") return;
    window[fn] = function(){
      const r = old.apply(this, arguments);
      try{
        const orders = orderStoreLoad();
        document.querySelectorAll(".ad_item").forEach(card=>{
          const oid = card.querySelector("b.mono2")?.textContent || card.querySelector(".mono2")?.textContent || "";
          if(!oid.includes("vv_")) return;
          if(card.querySelector(".btnPaid")) return;

          const order = orders.find(o=>o.orderId===oid) || {orderId:oid};
          const rem = slaRemaining(order);

          const bPaid=document.createElement("button");
          bPaid.className="btn btnPaid";
          bPaid.textContent="Marcar PAGO";
          bPaid.onclick=()=>markPaid(oid);

          const bRef=document.createElement("button");
          bRef.className="btn btnRefund";
          bRef.textContent="Reembolsar â†©ï¸";
          bRef.onclick=()=>{
            const note = prompt("Motivo/nota (opcional):") || "";
            markRefund(oid, note);
            try{ refundMsg({ ...order, refundNote: note }); }catch(e){}
          };

          const slaChip=document.createElement("span");
          slaChip.className = "chip " + (rem!=null && rem<=0 ? "bad":"ok");
          slaChip.textContent = "SLA: " + fmtRem(rem);

          const statusChip=document.createElement("span");
          statusChip.className="chip " + (order.status==="REFUNDED" ? "bad" : (order.status==="PAID" || order.status==="DELIVERED" ? "ok" : ""));
          statusChip.textContent = order.status || "PENDING";

          const group=document.createElement("div");
          group.style.display="flex";
          group.style.gap="8px";
          group.style.flexWrap="wrap";
          group.appendChild(bPaid);
          group.appendChild(bRef);
          group.appendChild(slaChip);
          group.appendChild(statusChip);

          const top = card.querySelector(".ad_top");
          if(top) top.appendChild(group);
        });
      }catch(e){}
      return r;
    }
  };
  wrap("renderAdminOrders");
  wrap("renderOrdersAdmin");
})();

/* ===== end Upgrade 33 ===== */


/* ===== Upgrade 34: PÃ¡gina Garantia 24h (pÃºblica) ===== */
function g24Text(){
  return [
    "ğŸ›¡ï¸ *Garantia ViralVault (24h)*",
    "âœ… Entrega em atÃ© 24h apÃ³s confirmaÃ§Ã£o do pagamento.",
    "â†©ï¸ Se passar de 24h sem entrega: reembolso total.",
    "ğŸ” Sempre verifique o pedido no servidor (VVâ€‘OFICIAL) antes de pagar."
  ].join("\n");
}

(function(){
  const old = window.setPage;
  if(typeof old==="function"){
    window.setPage = function(page){
      const r = old.apply(this, arguments);
      if(page==="g24"){
        setTimeout(()=>{
          try{ if(el("g24_copy")) el("g24_copy").value = g24Text(); }catch(e){}
        }, 120);
      }
      return r;
    }
  }
})();
/* ===== end Upgrade 34 ===== */


/* ===== Upgrade 36: Admin 2FA (PIN + Authenticator) validado no Worker ===== */
function adminTokenKey(){ return "vv_admin_token"; }
function adminToken(){ return localStorage.getItem(adminTokenKey()) || ""; }
function adminSetToken(t){ localStorage.setItem(adminTokenKey(), t||""); }
function adminClearToken(){ localStorage.removeItem(adminTokenKey()); }

function workerBase(){
  const u = (typeof getWorkerURL==="function") ? getWorkerURL() : (window.WORKER_URL || localStorage.getItem("vv_worker_url") || "");
  return (u||"").replace(/\/+$/,"");
}

function adminLockOpen(msg){
  const m = el("adminLock"); if(!m) return;
  m.style.display="flex";
  if(el("adminLockMsg")) el("adminLockMsg").textContent = msg || "â€”";
  setTimeout(()=>{ try{ el("adminPin")?.focus(); }catch(e){} }, 50);
}
function adminLockClose(){
  const m = el("adminLock"); if(!m) return;
  m.style.display="none";
}

async function adminCheck(){
  const base = workerBase();
  if(!base){ return false; }
  const tok = adminToken();
  if(!tok) return false;
  try{
    const r = await fetch(base + "/admin/check", {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ token: tok })
    });
    const j = await r.json().catch(()=>({ok:false}));
    return !!j.ok;
  }catch(e){
    return false;
  }
}

async function adminLogin(){
  const base = workerBase();
  if(!base){
    if(el("adminLockMsg")) el("adminLockMsg").textContent = "Configure a URL do Worker primeiro (aba Status).";
    return;
  }
  const pin = (el("adminPin")?.value||"").trim();
  const code = (el("adminTotp")?.value||"").trim();
  if(pin.length < 8){
    if(el("adminLockMsg")) el("adminLockMsg").textContent = "PIN muito curto. Use 16+ caracteres.";
    return;
  }
  if(!/^\d{6}$/.test(code)){
    if(el("adminLockMsg")) el("adminLockMsg").textContent = "CÃ³digo 2FA deve ter 6 dÃ­gitos.";
    return;
  }
  if(el("adminLockMsg")) el("adminLockMsg").textContent = "Verificandoâ€¦";
  try{
    const r = await fetch(base + "/admin/auth", {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ pin, code })
    });
    const j = await r.json().catch(()=>({ok:false}));
    if(j.ok && j.token){
      adminSetToken(j.token);
      adminLockClose();
      toast("Admin liberado âœ…");
      // rerender admin if needed
      try{ if(typeof renderAdminOrders==="function") renderAdminOrders(); }catch(e){}
    }else{
      if(el("adminLockMsg")) el("adminLockMsg").textContent = j.error || "Falha no login. Confira PIN e 2FA.";
    }
  }catch(e){
    if(el("adminLockMsg")) el("adminLockMsg").textContent = "Erro ao conectar no Worker.";
  }
}

async function adminGate(){
  // called when opening admin page
  const ok = await adminCheck();
  if(ok) return true;
  adminLockOpen("Digite seu PIN + cÃ³digo 2FA para abrir o Admin.");
  return false;
}

// Hook setPage: protect admin pages
(function(){
  const old = window.setPage;
  if(typeof old==="function"){
    window.setPage = function(page){
      if(page==="admin"){
        // show page then gate (so modal works)
        const r = old.apply(this, arguments);
        setTimeout(async ()=>{ 
          const ok = await adminGate();
          // optional: blur admin if locked
          try{
            const box = document.querySelector("#pageAdmin .box");
            if(box) box.style.filter = ok ? "none" : "blur(6px)";
            if(box) box.style.pointerEvents = ok ? "auto" : "none";
          }catch(e){}
        }, 120);
        return r;
      }
      return old.apply(this, arguments);
    }
  }
})();

// Admin search helpers
function adminFind(){
  const id = (el("adminFindId")?.value||"").trim();
  if(!id){ toast("Digite um Order ID"); return; }
  const orders = (typeof loadOrders==="function") ? (loadOrders()||[]) : (loadJSON("vv_orders")||[]);
  const o = orders.find(x=>x.orderId===id);
  if(el("adminFindResult")){
    el("adminFindResult").textContent = o ? ("Encontrado âœ… Total: " + money(Number(o.total||0)) + " â€¢ Status: " + (o.status||"PENDING")) : "NÃ£o encontrado.";
  }
}
function adminClearFind(){
  if(el("adminFindId")) el("adminFindId").value="";
  if(el("adminFindResult")) el("adminFindResult").textContent="â€”";
}
/* ===== end Upgrade 36 ===== */

</script>

  <!-- Modal Produto -->
  <div class="modalBack" id="prodModalBack" onclick="closeProdModal(event)">
    <div class="modal" role="dialog" aria-modal="true" aria-label="Detalhes do produto" onclick="event.stopPropagation()">
      <div class="modalHead">
        <div>
          <b>Detalhes do produto</b>
          <div class="tiny muted" id="pmSub">Detalhes e compra</div>
        </div>
        <button class="noticeBtn" onclick="closeProdModal()">âœ• Fechar</button>
      </div>
      <div class="modalGrid">
        <div class="mediaBox" id="pmMedia">
          <div class="ph">Sem mÃ­dia â€” adicione imagem/vÃ­deo no admin</div>
        </div>
        <div>
          <h3 class="prodTitle" id="pmTitle">â€”</h3>
          <div class="prodMeta" id="pmMeta"></div>
          <div class="prodDesc" id="pmDesc"></div>
          <div class="prodActions">
            <button class="btn accent" onclick="pmAddToCart()">ğŸ›’ Adicionar ao carrinho</button>
            <button class="btn" onclick="pmCopy()">Copiar detalhes</button>
            <button class="btn" onclick="openCartAtStep(1)">Abrir carrinho</button>
          </div>
          <div class="divider"></div>
          <div class="reviewBox">
            <b>â­ AvaliaÃ§Ãµes do produto</b>
            <div class="tiny muted">Clientes que compraram e avaliaram.</div>
            <div id="pmReviews" style="margin-top:8px"></div>
            <div class="divider"></div>
            <div class="tiny muted">Deixe sua avaliaÃ§Ã£o (apÃ³s gerar pedido VV-OFICIAL):</div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:10px">
              <input id="pmReviewText" class="input" placeholder="Escreva uma avaliaÃ§Ã£o curtaâ€¦" />
              <button class="btn" onclick="pmLeaveReview(5)">Enviar â­â­â­â­â­</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>


  <div class="modal" id="adminLock" style="display:none">
    <div class="modalCard fade">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <b>ğŸ”’ Admin protegido (2 etapas)</b>
        <span class="chip ok">2FA</span>
      </div>
      <div class="tiny muted" style="margin-top:6px">Etapa 1: PIN â€¢ Etapa 2: cÃ³digo do Authenticator (6 dÃ­gitos)</div>
      <div class="divider"></div>
      <div class="tiny muted">PIN</div>
      <input class="input mono" id="adminPin" placeholder="PIN forte" type="password" />
      <div style="height:10px"></div>
      <div class="tiny muted">CÃ³digo 2FA (Authenticator)</div>
      <input class="input mono" id="adminTotp" placeholder="123456" inputmode="numeric" />
      <div class="prodActions" style="margin-top:12px">
        <button class="btn accent" onclick="adminLogin()">Entrar</button>
        <button class="btn" onclick="adminLockClose()">Cancelar</button>
      </div>
      <div class="tiny muted" style="margin-top:10px" id="adminLockMsg">â€”</div>
    </div>
  </div>

</body>
</html>
