<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f1a" />
  <meta name="color-scheme" content="dark" />

  <title>ViralVault Store ‚Äî Checkout PIX + Verifica√ß√£o por Order ID</title>
  <meta name="description" content="ViralVault: checkout PIX com etapas, cat√°logo din√¢mico e verifica√ß√£o anti-golpe por Order ID." />
  <meta name="robots" content="index,follow" />
  <link rel="canonical" href="https://viralvault-store.vercel.app/" />

  <!-- Open Graph / Discord preview -->
  <meta property="og:title" content="ViralVault Store" />
  <meta property="og:description" content="Checkout PIX + verifica√ß√£o por Order ID. Cat√°logo din√¢mico e fluxo simples." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://viralvault-store.vercel.app/" />
  <meta property="og:image" content="data:image/svg+xml;utf8,<?xml version='1.0' encoding='UTF-8'?><svg xmlns='http://www.w3.org/2000/svg' width='1200' height='630'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='%230b0f1a'/><stop offset='1' stop-color='%23112b66'/></linearGradient></defs><rect width='1200' height='630' fill='url(%23g)'/><circle cx='260' cy='315' r='120' fill='%236ea8ff' opacity='0.9'/><text x='420' y='310' fill='white' font-size='68' font-family='Arial,Helvetica,sans-serif' font-weight='700'>ViralVault Store</text><text x='420' y='380' fill='white' opacity='0.78' font-size='34' font-family='Arial,Helvetica,sans-serif'>Checkout PIX ‚Ä¢ Verifica√ß√£o por Order ID</text></svg>" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="ViralVault Store" />
  <meta name="twitter:description" content="Checkout PIX + verifica√ß√£o por Order ID." />

  <!-- JSON-LD (WebSite) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebSite",
    "name": "ViralVault Store",
    "url": "https://viralvault-store.vercel.app/",
    "potentialAction": {
      "@type": "SearchAction",
      "target": "https://viralvault-store.vercel.app/?q={search_term_string}",
      "query-input": "required name=search_term_string"
    }
  }
  </script>

  <!-- PWA (manifest via data URI) -->
  <link rel="manifest" href="data:application/manifest+json,{\
    %22name%22:%22ViralVault%20Store%22,\
    %22short_name%22:%22ViralVault%22,\
    %22start_url%22:%22.%2F%22,\
    %22display%22:%22standalone%22,\
    %22background_color%22:%22%230b0f1a%22,\
    %22theme_color%22:%22%230b0f1a%22,\
    %22icons%22:[\
      {\
        %22src%22:%22data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><rect width='512' height='512' rx='120' fill='%230b0f1a'/><circle cx='256' cy='256' r='160' fill='%236ea8ff'/><text x='256' y='292' text-anchor='middle' font-family='Arial,Helvetica,sans-serif' font-size='140' font-weight='800' fill='%230b0f1a'>VV</text></svg>%22,\
        %22sizes%22:%22512x512%22,\
        %22type%22:%22image/svg+xml%22,\
        %22purpose%22:%22any%20maskable%22\
      }\
    ]\
  }" />

  <style>
    :root{
      --bg:#0b0f1a;
      --bg2:#0b1838;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.085);
      --stroke: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --muted2: rgba(255,255,255,.55);
      --brand:#6ea8ff;
      --brand2:#9b7bff;
      --good:#35d07f;
      --warn:#ffcc66;
      --bad:#ff6b6b;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r: 20px;
      --r2: 28px;
      --max: 1120px;
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
      --safe-right: env(safe-area-inset-right);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(110,168,255,.18), transparent 60%),
                  radial-gradient(900px 650px at 80% 20%, rgba(155,123,255,.14), transparent 60%),
                  radial-gradient(1200px 900px at 50% 100%, rgba(17,43,102,.25), transparent 60%),
                  linear-gradient(180deg, var(--bg), #070a12);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      overflow-x:hidden;
    }

    a{color:inherit; text-decoration:none}
    button, input, select, textarea{font:inherit}
    .wrap{max-width:var(--max); margin:0 auto; padding: 18px calc(18px + var(--safe-left)) calc(110px + var(--safe-bottom)) calc(18px + var(--safe-right));}

    /* Topbar */
    .topbar{
      position:sticky; top:0; z-index:50;
      padding: calc(14px + var(--safe-top)) calc(18px + var(--safe-left)) 14px calc(18px + var(--safe-right));
      background: linear-gradient(180deg, rgba(11,15,26,.86), rgba(11,15,26,.55));
      backdrop-filter: blur(14px);
      border-bottom: 1px solid rgba(255,255,255,.07);
    }
    .topbar-inner{max-width:var(--max); margin:0 auto; display:flex; align-items:center; gap:12px;}
    .brand{display:flex; align-items:center; gap:10px; min-width: 0;}
    .logo{
      width:42px; height:42px; border-radius: 14px;
      background: radial-gradient(circle at 35% 30%, rgba(110,168,255,1), rgba(155,123,255,.9));
      box-shadow: 0 14px 40px rgba(110,168,255,.18);
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,.14);
    }
    .logo span{font-weight:900; color:#0b0f1a; letter-spacing:.5px}
    .brand-title{display:flex; flex-direction:column; min-width:0}
    .brand-title strong{font-size:14px; line-height:1.1; letter-spacing:.2px}
    .brand-title small{font-size:12px; color:var(--muted2); white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .spacer{flex:1}

    .pill{
      display:inline-flex; align-items:center; gap:10px;
      padding:10px 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      box-shadow: 0 12px 40px rgba(0,0,0,.25);
    }
    .pill select{
      background: transparent;
      border: none;
      color: var(--text);
      outline: none;
      padding: 2px 2px;
      cursor:pointer;
    }

    .btn{
      appearance:none;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 14px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      user-select:none;
    }
    .btn:hover{background: rgba(255,255,255,.09); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(1px) scale(.99)}
    .btn.primary{
      border: 1px solid rgba(110,168,255,.45);
      background: linear-gradient(135deg, rgba(110,168,255,.95), rgba(155,123,255,.95));
      color:#0b0f1a;
      font-weight:800;
    }
    .btn.primary:hover{filter: brightness(1.02)}

    /* Cinematic hero */
    .hero{
      position:relative;
      padding: 18px 0 0;
    }
    .scene{
      position:relative;
      border-radius: var(--r2);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(1100px 800px at 15% 30%, rgba(110,168,255,.22), transparent 60%),
        radial-gradient(900px 700px at 80% 10%, rgba(155,123,255,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      min-height: 360px;
    }
    .scene::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(800px 300px at 30% 20%, rgba(255,255,255,.09), transparent 55%),
        radial-gradient(900px 300px at 70% 0%, rgba(255,255,255,.06), transparent 60%);
      pointer-events:none;
    }
    .scene::after{
      content:"";
      position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(0,0,0,.12), transparent 30%, transparent 70%, rgba(0,0,0,.18));
      pointer-events:none;
      mix-blend-mode: overlay;
    }

    .hero-grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:18px; padding: 22px; position:relative}
    @media (max-width: 880px){ .hero-grid{grid-template-columns:1fr; padding:18px} }

    .kicker{
      display:inline-flex; align-items:center; gap:10px;
      padding: 10px 12px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      border-radius: 999px;
      width: fit-content;
    }
    .dot{width:10px; height:10px; border-radius: 99px; background: var(--good); box-shadow: 0 0 0 6px rgba(53,208,127,.12)}
    h1{margin: 14px 0 10px; font-size: clamp(34px, 4.4vw, 56px); line-height: 1.02; letter-spacing: -.6px}
    .lead{margin:0; color: var(--muted); font-size: 15px; line-height:1.55; max-width: 56ch}

    .cta-row{display:flex; gap:10px; flex-wrap:wrap; margin-top:16px}

    .glass{
      border-radius: var(--r2);
      background: rgba(0,0,0,.20);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 60px rgba(0,0,0,.25);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }

    .quick{
      padding: 14px 14px 12px;
      display:flex;
      flex-direction:column;
      gap:10px;
      min-height: 220px;
    }
    .quick strong{font-size: 14px}
    .metric{display:flex; align-items:center; justify-content:space-between; gap:10px;}
    .metric span{color:var(--muted2); font-size:12px}
    .bar{height:10px; border-radius: 999px; background: rgba(255,255,255,.08); overflow:hidden; border:1px solid rgba(255,255,255,.10)}
    .bar > i{display:block; height:100%; width:40%; background: linear-gradient(90deg, rgba(110,168,255,.95), rgba(155,123,255,.95)); border-radius:999px}

    .hint{font-size:12px; color:var(--muted2); line-height:1.4}

    /* Sections */
    .section{margin-top: 18px}
    .card{padding: 18px; border-radius: var(--r2); border: 1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); box-shadow: var(--shadow); backdrop-filter: blur(14px)}
    .card h2{margin:0 0 6px; font-size: 22px; letter-spacing: -.2px}
    .card p{margin:0; color:var(--muted); line-height:1.55}

    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    @media (max-width: 900px){ .grid2{grid-template-columns:1fr} }

    .tabs{
      position:sticky;
      bottom: calc(10px + var(--safe-bottom));
      left:0; right:0;
      z-index:60;
      padding: 0 calc(14px + var(--safe-left)) 0 calc(14px + var(--safe-right));
    }
    .tabbar{
      max-width: var(--max);
      margin: 0 auto;
      display:flex;
      gap:10px;
      background: rgba(11,15,26,.72);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 999px;
      padding: 10px;
      box-shadow: 0 18px 70px rgba(0,0,0,.55);
      backdrop-filter: blur(14px);
    }
    .tab{
      flex:1;
      display:flex; align-items:center; justify-content:center;
      gap:10px;
      padding: 12px 12px;
      border-radius: 999px;
      border: 1px solid transparent;
      background: transparent;
      color: var(--muted);
      cursor:pointer;
      user-select:none;
      transition: background .12s ease, border-color .12s ease, color .12s ease;
    }
    .tab.active{color: var(--text); background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.10)}

    .chip{display:inline-flex; align-items:center; gap:8px; padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05); color:var(--muted); font-size:12px}
    .chip b{color:var(--text)}

    /* Catalog */
    .catalog-controls{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px}
    .search{
      flex: 1;
      min-width: 220px;
      display:flex; align-items:center; gap:10px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .search input{width:100%; background:transparent; border:none; outline:none; color:var(--text)}

    .products{display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:14px}
    @media (max-width: 980px){ .products{grid-template-columns: repeat(2,1fr)} }
    @media (max-width: 560px){ .products{grid-template-columns: 1fr} }

    .product{
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      padding: 14px;
      box-shadow: 0 16px 50px rgba(0,0,0,.35);
      display:flex; flex-direction:column; gap:10px;
      min-height: 152px;
    }
    .product .top{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
    .product strong{font-size: 14px; line-height:1.2}
    .product small{color:var(--muted2)}
    .price{font-weight:900; letter-spacing:.2px}
    .product .actions{display:flex; gap:10px; margin-top:auto}
    .qty{display:flex; align-items:center; gap:8px; padding: 8px 10px; border-radius: 14px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18)}
    .qty button{width:28px; height:28px; border-radius: 10px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.06); color: var(--text); cursor:pointer}
    .qty input{width:34px; text-align:center; background:transparent; border:none; color:var(--text); outline:none}

    /* Checkout */
    .steps{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
    .step{flex:1; min-width: 160px; padding: 12px 12px; border-radius: 16px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18)}
    .step b{display:block; font-size:12px; color:var(--muted2); margin-bottom:4px}
    .step span{display:block; font-size:14px}

    .form{display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:12px}
    @media (max-width: 720px){ .form{grid-template-columns:1fr} }
    .field{display:flex; flex-direction:column; gap:6px}
    .field label{font-size:12px; color:var(--muted2)}
    .field input, .field textarea{
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    .field textarea{min-height: 86px; resize: vertical}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:12px}
    .note{font-size:12px; color:var(--muted2); line-height:1.45}

    .panel{
      border-radius: var(--r2);
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      padding: 14px;
    }

    /* Lab */
    .lab-grid{display:grid; grid-template-columns: 1.05fr .95fr; gap:14px; margin-top:12px}
    @media (max-width: 980px){ .lab-grid{grid-template-columns:1fr} }

    .lab-card{padding: 14px; border-radius: 22px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.05)}
    .lab-card h3{margin:0 0 8px; font-size:16px}
    .lab-card p{margin:0 0 10px; color:var(--muted); font-size:13px; line-height:1.5}

    .slider{display:flex; align-items:center; gap:10px; margin-top:10px}
    .slider input{flex:1}

    .sand{
      width:100%;
      height: 240px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.10);
      background: radial-gradient(600px 260px at 30% 20%, rgba(110,168,255,.12), transparent 60%), rgba(0,0,0,.22);
      display:block;
    }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(90px + var(--safe-bottom));
      background: rgba(0,0,0,.72);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 999px;
      padding: 10px 12px;
      box-shadow: 0 20px 70px rgba(0,0,0,.65);
      backdrop-filter: blur(14px);
      z-index: 80;
      display:none;
      max-width: min(92vw, 720px);
      color: var(--text);
      font-size: 13px;
    }

    /* Scroll micro-interactions */
    .reveal{opacity:0; transform: translateY(10px); transition: opacity .35s ease, transform .35s ease}
    .reveal.on{opacity:1; transform: translateY(0)}

    @media (prefers-reduced-motion: reduce){
      .reveal{transition:none}
      .btn{transition:none}
      .tab{transition:none}
    }

    /* Hide any sensitive technical labels */
    [data-private]{display:none !important}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <div class="brand" role="button" tabindex="0" id="goHome">
        <div class="logo" aria-hidden="true"><span>VV</span></div>
        <div class="brand-title">
          <strong>ViralVault Store</strong>
          <small id="sysStatus">Checando sistema‚Ä¶</small>
        </div>
      </div>

      <div class="spacer"></div>

      <div class="pill" title="Idioma">
        <span aria-hidden="true">üåê</span>
        <select id="langSel" aria-label="Idioma">
          <option value="pt-BR">PT-BR</option>
          <option value="en">EN</option>
          <option value="es">ES</option>
        </select>
      </div>

      <button class="btn" id="discordBtn" type="button" aria-label="Abrir Discord">Discord</button>
      <button class="btn" id="installBtn" type="button" style="display:none" aria-label="Instalar app">Instalar</button>
    </div>
  </header>

  <main class="wrap">
    <section class="hero reveal" id="sec-home">
      <div class="scene" id="scene">
        <div class="hero-grid">
          <div>
            <div class="kicker"><span class="dot" aria-hidden="true"></span><span id="kickerText">Checkout PIX ‚Ä¢ Verifica√ß√£o Order ID ‚Ä¢ Anti-golpe</span></div>
            <h1 id="heroTitle">Organize seus itens do Roblox com um checkout s√©rio.</h1>
            <p class="lead" id="heroLead">Cat√°logo din√¢mico + pedido com PIX + verifica√ß√£o por Order ID. Fluxo r√°pido, sem confus√£o. Suporte via Discord.</p>

            <div class="cta-row">
              <button class="btn primary" id="ctaCatalog" type="button">Ver cat√°logo</button>
              <button class="btn" id="ctaCheckout" type="button">Ir pro checkout</button>
              <button class="btn" id="ctaOrder" type="button">Ver pedido</button>
            </div>

            <div class="catalog-controls" style="margin-top:14px">
              <span class="chip" id="chipWorker"><b>Worker</b> <span id="chipWorkerState">‚Ä¶</span></span>
              <span class="chip"><b>Cache</b> <span id="chipCache">local</span></span>
              <span class="chip"><b>Modo</b> <span id="chipMode">PWA</span></span>
            </div>
          </div>

          <aside class="glass quick" aria-label="Painel r√°pido">
            <strong id="quickTitle">Painel</strong>
            <div class="metric"><span id="m1">Cat√°logo</span><span id="m1v">‚Äî</span></div>
            <div class="bar" aria-hidden="true"><i id="m1b"></i></div>
            <div class="metric"><span id="m2">Carrinho</span><span id="m2v">0 itens</span></div>
            <div class="bar" aria-hidden="true"><i id="m2b" style="width:0%"></i></div>
            <div class="metric"><span id="m3">√öltimo pedido</span><span id="m3v">‚Äî</span></div>
            <div class="hint" id="quickHint">Dica: finalize o pedido e guarde seu <b>Order ID</b> para acompanhar.</div>

            <div class="row" style="margin-top: 10px">
              <button class="btn" id="reloadCatalog" type="button">Recarregar cat√°logo</button>
              <button class="btn" id="resetLocal" type="button">Reset local</button>
            </div>
          </aside>
        </div>
      </div>
    </section>

    <section class="section reveal" id="sec-catalog">
      <div class="card">
        <h2 id="catTitle">Cat√°logo</h2>
        <p id="catLead">Busque, selecione quantidades e adicione ao carrinho. Tudo salva localmente.</p>

        <div class="catalog-controls">
          <div class="search" role="search">
            <span aria-hidden="true">üîé</span>
            <input id="searchInput" placeholder="Buscar produto‚Ä¶" autocomplete="off" />
          </div>
          <button class="btn" id="viewCart" type="button">Ver carrinho</button>
          <button class="btn" id="toCheckout" type="button">Ir pro checkout</button>
        </div>

        <div class="products" id="products"></div>
      </div>
    </section>

    <section class="section reveal" id="sec-checkout">
      <div class="card">
        <h2 id="coTitle">Checkout (PIX)</h2>
        <p id="coLead">Finalize em etapas. Voc√™ gera o pedido, paga via PIX e acompanha pelo Order ID.</p>

        <div class="steps" aria-label="Etapas">
          <div class="step"><b>1</b><span id="s1">Dados</span></div>
          <div class="step"><b>2</b><span id="s2">Revis√£o</span></div>
          <div class="step"><b>3</b><span id="s3">PIX</span></div>
        </div>

        <div class="grid2" style="margin-top:14px">
          <div class="panel">
            <div class="form">
              <div class="field">
                <label for="robloxUser" id="lblUser">Seu user do Roblox (obrigat√≥rio)</label>
                <input id="robloxUser" placeholder="Ex: MeuUser_123" inputmode="text" autocomplete="username" />
              </div>
              <div class="field">
                <label for="coupon" id="lblCoupon">Cupom (opcional)</label>
                <input id="coupon" placeholder="Ex: VV10" inputmode="text" autocomplete="off" />
              </div>
              <div class="field" style="grid-column: 1 / -1">
                <label for="notes" id="lblNotes">Observa√ß√µes (opcional)</label>
                <textarea id="notes" placeholder="Ex: Entregar no hor√°rio X‚Ä¶"></textarea>
              </div>
            </div>

            <div class="row">
              <button class="btn" id="reviewBtn" type="button">Revisar pedido</button>
              <button class="btn primary" id="createOrderBtn" type="button">Gerar Order ID + PIX</button>
            </div>
            <div class="note" id="coHint">Voc√™ precisa ter itens no carrinho para gerar pedido.</div>
          </div>

          <div class="panel">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px">
              <strong id="cartTitle">Carrinho</strong>
              <span class="chip"><b>Total</b> <span id="cartTotal">R$ 0,00</span></span>
            </div>

            <div id="cartList" style="margin-top:10px"></div>

            <div class="row">
              <button class="btn" id="clearCart" type="button">Limpar carrinho</button>
              <button class="btn" id="saveCart" type="button">Salvar</button>
            </div>
          </div>
        </div>

        <div class="panel" style="margin-top:14px" id="pixPanel">
          <strong id="pixTitle">PIX</strong>
          <p class="note" id="pixLead">Ap√≥s gerar o pedido, o PIX aparece aqui. Guarde seu Order ID.</p>
          <div class="row">
            <button class="btn" id="copyPix" type="button" disabled>Copiar PIX</button>
            <button class="btn" id="copyOrderId" type="button" disabled>Copiar Order ID</button>
          </div>
          <div class="note" id="pixOut" style="margin-top:10px"></div>
        </div>
      </div>
    </section>

    <section class="section reveal" id="sec-order">
      <div class="card">
        <h2 id="orderTitle">Pedido</h2>
        <p id="orderLead">Cole seu Order ID para validar se √© oficial e ver andamento.</p>

        <div class="grid2" style="margin-top:12px">
          <div class="panel">
            <div class="field">
              <label for="orderIdIn" id="lblOrderId">Cole o Order ID</label>
              <input id="orderIdIn" placeholder="Ex: VV-2026-‚Ä¶" autocomplete="off" inputmode="text" />
            </div>
            <div class="row">
              <button class="btn primary" id="checkOrderBtn" type="button">Verificar</button>
              <button class="btn" id="useLastOrder" type="button">Usar √∫ltimo</button>
            </div>
            <div class="note" id="orderOut" style="margin-top:10px"></div>
          </div>

          <div class="panel">
            <strong id="purchasesTitle">Minhas Compras</strong>
            <p class="note" id="purchasesLead" style="margin-top:6px">Lista local + (se dispon√≠vel) hist√≥rico real do Worker pelo seu user.</p>
            <div class="row" style="margin-top:10px">
              <button class="btn" id="loadPurchases" type="button">Carregar por user</button>
              <button class="btn" id="clearPurchases" type="button">Limpar hist√≥rico</button>
            </div>
            <div id="purchases" style="margin-top:10px"></div>
          </div>
        </div>
      </div>
    </section>

    <section class="section reveal" id="sec-lab">
      <div class="card">
        <h2 id="labTitle">ViralVault Lab</h2>
        <p id="labLead">Um toque ‚Äú√∫nico‚Äù: ferramentas leves e divertidas, sem atrapalhar o checkout.</p>

        <div class="lab-grid">
          <div class="lab-card">
            <h3 id="ambTitle">Ambient Mixer (anti-ru√≠do)</h3>
            <p id="ambLead">Misture som suave (gerado localmente) para foco. N√£o usa arquivos externos.</p>

            <div class="row" style="margin-top:8px">
              <button class="btn" id="ambToggle" type="button">Ativar</button>
              <span class="chip"><b>Status</b> <span id="ambState">off</span></span>
            </div>

            <div class="slider"><span style="width:80px;color:var(--muted2)">Ru√≠do</span><input id="ambNoise" type="range" min="0" max="100" value="18" /><span id="ambNoiseV" style="width:34px;text-align:right;color:var(--muted2)">18</span></div>
            <div class="slider"><span style="width:80px;color:var(--muted2)">Brisa</span><input id="ambWind" type="range" min="0" max="100" value="10" /><span id="ambWindV" style="width:34px;text-align:right;color:var(--muted2)">10</span></div>
            <div class="slider"><span style="width:80px;color:var(--muted2)">Ping</span><input id="ambPing" type="range" min="0" max="100" value="6" /><span id="ambPingV" style="width:34px;text-align:right;color:var(--muted2)">6</span></div>

            <div class="note" id="ambNote" style="margin-top:8px">Dica: se o navegador bloquear √°udio, toque em ‚ÄúAtivar‚Äù novamente ap√≥s interagir.</div>
          </div>

          <div class="lab-card">
            <h3 id="sandTitle">This is Sand (mini)</h3>
            <p id="sandLead">Toque/arraste para ‚Äúdespejar‚Äù areia digital. Funciona offline.</p>
            <canvas class="sand" id="sandCanvas" width="900" height="480" aria-label="Areia digital"></canvas>
            <div class="row">
              <button class="btn" id="sandClear" type="button">Limpar</button>
              <button class="btn" id="sandPause" type="button">Pausar</button>
              <span class="chip"><b>FPS</b> <span id="sandFps">‚Äî</span></span>
            </div>
          </div>

          <div class="lab-card">
            <h3 id="futureTitle">Future Note</h3>
            <p id="futureLead">Escreva uma mensagem para voc√™ mesmo e escolha uma data. Desbloqueia automaticamente.</p>
            <div class="field">
              <label for="futureDate">Desbloquear em</label>
              <input id="futureDate" type="date" />
            </div>
            <div class="field" style="margin-top:8px">
              <label for="futureMsg">Mensagem</label>
              <textarea id="futureMsg" placeholder="Escreva aqui‚Ä¶"></textarea>
            </div>
            <div class="row">
              <button class="btn primary" id="futureSave" type="button">Salvar</button>
              <button class="btn" id="futureOpen" type="button">Ver</button>
              <button class="btn" id="futureDel" type="button">Apagar</button>
            </div>
            <div class="note" id="futureOut" style="margin-top:10px"></div>
          </div>

          <div class="lab-card">
            <h3 id="randomTitle">Useless-ish Button</h3>
            <p id="randomLead">Um bot√£o ‚Äúaleat√≥rio‚Äù, mas sempre √∫til: alterna entre dicas r√°pidas do site.</p>
            <div class="row">
              <button class="btn" id="randomTip" type="button">Me d√° uma dica</button>
              <span class="chip"><b>Modo</b> <span id="tipMode">prod</span></span>
            </div>
            <div class="note" id="tipOut" style="margin-top:10px">‚Äî</div>
          </div>
        </div>
      </div>
    </section>

    <section class="section reveal" id="sec-faq">
      <div class="card">
        <h2 id="faqTitle">FAQ</h2>
        <p id="faqLead">R√°pido e direto.</p>

        <div class="panel" style="margin-top:12px">
          <details>
            <summary id="faq1" style="cursor:pointer; padding:10px;">Como sei que √© oficial?</summary>
            <div class="note" id="faq1a" style="padding: 0 10px 10px;">Use a aba <b>Pedido</b> e verifique o status. Se o Order ID aparecer como v√°lido, √© oficial.</div>
          </details>
          <details>
            <summary id="faq2" style="cursor:pointer; padding:10px;">Quanto tempo para entrega?</summary>
            <div class="note" id="faq2a" style="padding: 0 10px 10px;">Depende do produto. Prioridade (24h) √© entregue primeiro.</div>
          </details>
          <details>
            <summary id="faq3" style="cursor:pointer; padding:10px;">Suporte</summary>
            <div class="note" style="padding: 0 10px 10px;">Entre no Discord e abra um ticket/DM.</div>
            <div class="row" style="padding: 0 10px 10px;">
              <button class="btn primary" id="discordBtn2" type="button">Abrir Discord</button>
            </div>
          </details>
        </div>

      </div>
    </section>

    <!-- Technical hints kept private -->
    <div data-private id="apiBase"></div>
  </main>

  <div class="tabs" aria-label="Navega√ß√£o">
    <nav class="tabbar">
      <button class="tab active" data-go="home" type="button">üõçÔ∏è <span id="tCat">Cat√°logo</span></button>
      <button class="tab" data-go="checkout" type="button">üßæ <span id="tCheckout">Checkout</span></button>
      <button class="tab" data-go="order" type="button">üì¶ <span id="tOrder">Pedido</span></button>
      <button class="tab" data-go="faq" type="button">‚ùì <span id="tFAQ">FAQ</span></button>
    </nav>
  </div>

  <div class="toast" id="toast" role="status" aria-live="polite"></div>

  <script>
  (() => {
    'use strict';

    // ========= CONFIG =========
    // Keep API base hidden from UI (not rendered). Still accessible from code.
    const API_BASE = 'https://viralvault-sign.darlanana06.workers.dev';
    const DISCORD_INVITE = 'https://discord.gg/fWAWquBu';

    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => Array.from(el.querySelectorAll(s));

    const fmtBRL = (n) => {
      const v = Number(n || 0);
      return v.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
    };

    const store = {
      get(k, d=null){ try{ const v = localStorage.getItem(k); return v ? JSON.parse(v) : d; }catch{ return d; } },
      set(k, v){ try{ localStorage.setItem(k, JSON.stringify(v)); }catch{} },
      del(k){ try{ localStorage.removeItem(k); }catch{} }
    };

    // ========= UI HELPERS =========
    const toast = (msg) => {
      const t = $('#toast');
      t.textContent = msg;
      t.style.display = 'block';
      clearTimeout(toast._t);
      toast._t = setTimeout(() => { t.style.display = 'none'; }, 2600);
    };

    const safeOpen = (url) => {
      try{
        const w = window.open(url, '_blank', 'noopener,noreferrer');
        if (!w) window.location.href = url;
      }catch{ window.location.href = url; }
    };

    // ========= PWA / SW =========
    // Inline service worker (no extra files)
    const SW_CODE = `
      const CACHE = 'vv-cache-v15';
      const CORE = ['.'];
      self.addEventListener('install', (e)=>{
        e.waitUntil((async()=>{
          const c = await caches.open(CACHE);
          await c.addAll(CORE);
          self.skipWaiting();
        })());
      });
      self.addEventListener('activate', (e)=>{
        e.waitUntil((async()=>{
          const keys = await caches.keys();
          await Promise.all(keys.filter(k=>k!==CACHE).map(k=>caches.delete(k)));
          self.clients.claim();
        })());
      });
      self.addEventListener('fetch', (e)=>{
        const req = e.request;
        const url = new URL(req.url);
        if (req.method !== 'GET') return;
        // Only cache same-origin navigations/static. Let API pass-through.
        if (url.origin !== self.location.origin) return;
        e.respondWith((async()=>{
          const cache = await caches.open(CACHE);
          const cached = await cache.match(req);
          if (cached) return cached;
          const res = await fetch(req);
          // Cache successful HTML/CSS/JS and navigations.
          if (res && res.ok && (req.mode === 'navigate' || /text\/html|text\/css|javascript/.test(res.headers.get('content-type')||''))) {
            cache.put(req, res.clone());
          }
          return res;
        })().catch(()=> caches.match('.')));
      });
    `;

    const registerSW = async () => {
      if (!('serviceWorker' in navigator)) return;
      try{
        const blob = new Blob([SW_CODE], {type:'text/javascript'});
        const url = URL.createObjectURL(blob);
        const reg = await navigator.serviceWorker.register(url, { scope: './' });
        URL.revokeObjectURL(url);
        return reg;
      }catch{}
    };

    // Install prompt
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      $('#installBtn').style.display = '';
    });

    $('#installBtn').addEventListener('click', async () => {
      if (!deferredPrompt) return toast('Instala√ß√£o indispon√≠vel agora.');
      deferredPrompt.prompt();
      const choice = await deferredPrompt.userChoice;
      deferredPrompt = null;
      $('#installBtn').style.display = 'none';
      toast(choice && choice.outcome === 'accepted' ? 'Instalado ‚úÖ' : 'Ok.');
    });

    // ========= SCROLL / NAV =========
    const sections = {
      home: $('#sec-home'),
      catalog: $('#sec-catalog'),
      checkout: $('#sec-checkout'),
      order: $('#sec-order'),
      faq: $('#sec-faq')
    };

    const go = (key) => {
      const el = sections[key] || sections.home;
      el.scrollIntoView({behavior:'smooth', block:'start'});
      $$('.tab').forEach(t => t.classList.toggle('active', t.dataset.go === key || (key==='home' && t.dataset.go==='home')));
    };

    $$('.tab').forEach(t => t.addEventListener('click', () => {
      const k = t.dataset.go;
      if (k === 'home') return go('catalog'); // UX: first tab lands on catalog
      go(k);
    }));

    $('#ctaCatalog').addEventListener('click', () => go('catalog'));
    $('#ctaCheckout').addEventListener('click', () => go('checkout'));
    $('#ctaOrder').addEventListener('click', () => go('order'));
    $('#goHome').addEventListener('click', () => window.scrollTo({top:0, behavior:'smooth'}));

    // Reveal on scroll
    const io = new IntersectionObserver((entries) => {
      entries.forEach(e => { if (e.isIntersecting) e.target.classList.add('on'); });
    }, { threshold: 0.08 });
    $$('.reveal').forEach(el => io.observe(el));

    // Cinematic parallax (lightweight)
    const scene = $('#scene');
    let raf = 0;
    const parallax = (x, y) => {
      if (matchMedia('(prefers-reduced-motion: reduce)').matches) return;
      cancelAnimationFrame(raf);
      raf = requestAnimationFrame(() => {
        const dx = (x - window.innerWidth/2) / window.innerWidth;
        const dy = (y - 180) / 420;
        scene.style.transform = `translate3d(${dx * -10}px, ${dy * -6}px, 0)`;
      });
    };
    scene.addEventListener('pointermove', (e) => parallax(e.clientX, e.clientY));
    scene.addEventListener('pointerleave', () => { scene.style.transform = 'translate3d(0,0,0)'; });

    // ========= DISCORD =========
    const openDiscord = () => safeOpen(DISCORD_INVITE);
    $('#discordBtn').addEventListener('click', openDiscord);
    $('#discordBtn2').addEventListener('click', openDiscord);

    // ========= API =========
    const api = async (path, opts={}) => {
      const url = API_BASE + path;
      const headers = Object.assign({ 'content-type':'application/json' }, opts.headers || {});
      const res = await fetch(url, Object.assign({ headers, mode:'cors' }, opts));
      const txt = await res.text();
      let data = null;
      try{ data = txt ? JSON.parse(txt) : null; }catch{ data = { raw: txt }; }
      if (!res.ok) {
        const msg = (data && (data.error || data.message)) ? (data.error || data.message) : `HTTP ${res.status}`;
        throw new Error(msg);
      }
      return data;
    };

    const setStatus = (ok, extra='') => {
      const el = $('#sysStatus');
      if (ok) {
        el.textContent = 'Sistema online' + (extra ? ` ‚Ä¢ ${extra}` : '');
        $('#chipWorkerState').textContent = 'ok';
        $('#chipWorkerState').style.color = 'var(--good)';
        $('#chipWorkerState').style.fontWeight = '800';
        $('#chipWorkerState').style.letterSpacing = '.2px';
      } else {
        el.textContent = 'Sistema offline' + (extra ? ` ‚Ä¢ ${extra}` : '');
        $('#chipWorkerState').textContent = 'offline';
        $('#chipWorkerState').style.color = 'var(--warn)';
      }
    };

    const healthCheck = async () => {
      try{
        const h = await api('/health', { method:'GET' });
        setStatus(true, 'Worker OK');
        return h;
      }catch(err){
        setStatus(false, 'tentando cache');
        return null;
      }
    };

    // ========= CATALOG / CART =========
    const state = {
      products: [],
      cart: store.get('vv_cart', {}),
      lastOrderId: store.get('vv_last_order', ''),
      purchases: store.get('vv_purchases', [])
    };

    const cartCount = () => Object.values(state.cart).reduce((a, it) => a + (it.qty || 0), 0);
    const cartTotal = () => Object.values(state.cart).reduce((a, it) => a + (Number(it.price||0) * (it.qty||0)), 0);

    const renderCart = () => {
      const el = $('#cartList');
      const entries = Object.values(state.cart);
      $('#m2v').textContent = `${cartCount()} itens`;
      $('#m2b').style.width = Math.min(100, cartCount()*12) + '%';
      $('#cartTotal').textContent = fmtBRL(cartTotal());

      if (!entries.length) {
        el.innerHTML = `<div class="note">Carrinho vazio.</div>`;
        return;
      }

      el.innerHTML = entries.map(it => {
        return `
          <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.14); margin-bottom:10px;">
            <div style="min-width:0">
              <div style="font-weight:800; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${escapeHtml(it.name||'Item')}</div>
              <div style="color:var(--muted2); font-size:12px">${fmtBRL(it.price)} ‚Ä¢ qnt: ${it.qty}</div>
            </div>
            <div style="display:flex; gap:8px; align-items:center;">
              <button class="btn" style="padding:10px 12px" data-dec="${it.id}">-</button>
              <button class="btn" style="padding:10px 12px" data-inc="${it.id}">+</button>
              <button class="btn" style="padding:10px 12px" data-rem="${it.id}">Remover</button>
            </div>
          </div>
        `;
      }).join('');

      $$('[data-inc]', el).forEach(b => b.addEventListener('click', () => setQty(b.dataset.inc, (state.cart[b.dataset.inc]?.qty||0)+1)));
      $$('[data-dec]', el).forEach(b => b.addEventListener('click', () => setQty(b.dataset.dec, Math.max(0,(state.cart[b.dataset.dec]?.qty||0)-1))));
      $$('[data-rem]', el).forEach(b => b.addEventListener('click', () => setQty(b.dataset.rem, 0)));
    };

    const setQty = (id, qty) => {
      const p = state.products.find(x => x.id === id) || state.cart[id];
      if (!p) return;
      if (qty <= 0) delete state.cart[id];
      else state.cart[id] = { id, name: p.name, price: p.price, qty };
      store.set('vv_cart', state.cart);
      renderCart();
      renderProducts($('#searchInput').value || '');
    };

    const renderProducts = (q='') => {
      const el = $('#products');
      const query = (q||'').trim().toLowerCase();
      const list = state.products.filter(p => !query || (p.name||'').toLowerCase().includes(query) || (p.id||'').toLowerCase().includes(query));

      $('#m1v').textContent = `${list.length} itens`;
      $('#m1b').style.width = Math.min(100, (list.length / Math.max(1,state.products.length)) * 100) + '%';

      if (!list.length) {
        el.innerHTML = `<div class="note">Nenhum produto encontrado.</div>`;
        return;
      }

      el.innerHTML = list.map(p => {
        const curQty = state.cart[p.id]?.qty || 0;
        return `
          <article class="product">
            <div class="top">
              <div style="min-width:0">
                <strong title="${escapeHtml(p.name)}">${escapeHtml(p.name)}</strong>
                <div><small>${escapeHtml(p.description||'')}</small></div>
              </div>
              <div style="text-align:right">
                <div class="price">${fmtBRL(p.price)}</div>
                <div><small>${escapeHtml(p.badge||'')}</small></div>
              </div>
            </div>
            <div class="actions">
              <div class="qty" aria-label="Quantidade">
                <button type="button" data-qdec="${p.id}">-</button>
                <input value="${curQty}" readonly aria-label="Quantidade atual" />
                <button type="button" data-qinc="${p.id}">+</button>
              </div>
              <button class="btn primary" type="button" data-add="${p.id}">${curQty ? 'Atualizar' : 'Adicionar'}</button>
            </div>
          </article>
        `;
      }).join('');

      $$('[data-qinc]', el).forEach(b => b.addEventListener('click', () => {
        const id = b.dataset.qinc;
        setQty(id, (state.cart[id]?.qty||0) + 1);
      }));
      $$('[data-qdec]', el).forEach(b => b.addEventListener('click', () => {
        const id = b.dataset.qdec;
        setQty(id, Math.max(0, (state.cart[id]?.qty||0) - 1));
      }));
      $$('[data-add]', el).forEach(b => b.addEventListener('click', () => {
        const id = b.dataset.add;
        const cur = state.cart[id]?.qty || 0;
        if (!cur) setQty(id, 1);
        toast('Carrinho atualizado.');
      }));
    };

    const loadCatalog = async ({ force=false } = {}) => {
      const cached = store.get('vv_catalog_cache', null);
      const cachedAt = store.get('vv_catalog_cache_at', 0);
      const fresh = (Date.now() - cachedAt) < (10*60*1000);

      if (cached && fresh && !force) {
        state.products = normalizeProducts(cached);
        renderProducts($('#searchInput').value || '');
        toast('Cat√°logo (cache)');
        return;
      }

      try{
        const data = await api('/catalog', { method:'GET' });
        const products = (data && (data.products || data.items)) ? (data.products || data.items) : [];
        state.products = normalizeProducts(products);
        store.set('vv_catalog_cache', products);
        store.set('vv_catalog_cache_at', Date.now());
        renderProducts($('#searchInput').value || '');
        toast('Cat√°logo atualizado.');
      }catch(err){
        if (cached) {
          state.products = normalizeProducts(cached);
          renderProducts($('#searchInput').value || '');
          toast('Sem rede: usando cache.');
        } else {
          $('#products').innerHTML = `<div class="note">Falha ao carregar cat√°logo: ${escapeHtml(err.message||'erro')}</div>`;
        }
      }
    };

    const normalizeProducts = (arr) => {
      const out = Array.isArray(arr) ? arr : [];
      return out.map((p, idx) => {
        const id = String(p.id || p.sku || `p_${idx}`);
        const name = String(p.name || p.title || id);
        const price = Number(p.price || p.value || 0);
        const description = String(p.description || '');
        const badge = String(p.badge || '');
        return { id, name, price, description, badge };
      });
    };

    const escapeHtml = (s) => String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));

    // Search
    $('#searchInput').addEventListener('input', () => renderProducts($('#searchInput').value || ''));

    // Cart buttons
    $('#viewCart').addEventListener('click', () => { go('checkout'); toast('Carrinho no checkout.'); });
    $('#toCheckout').addEventListener('click', () => go('checkout'));
    $('#clearCart').addEventListener('click', () => {
      state.cart = {};
      store.set('vv_cart', state.cart);
      renderCart();
      renderProducts($('#searchInput').value || '');
      toast('Carrinho limpo.');
    });
    $('#saveCart').addEventListener('click', () => { store.set('vv_cart', state.cart); toast('Salvo.'); });

    // ========= CREATE ORDER =========
    const validateUser = (u) => /^[A-Za-z0-9_]{3,20}$/.test(u || '');

    const buildOrderPayload = () => {
      const user = ($('#robloxUser').value || '').trim();
      const coupon = ($('#coupon').value || '').trim();
      const notes = ($('#notes').value || '').trim();
      if (!validateUser(user)) throw new Error('User obrigat√≥rio (3-20, letras/n√∫meros/_)');
      const items = Object.values(state.cart).map(it => ({ id: it.id, qty: it.qty }));
      if (!items.length) throw new Error('Carrinho vazio');
      return { user, coupon, notes, items };
    };

    const showPix = (order) => {
      const orderId = order?.orderId || order?.id || '';
      const pix = order?.pix || order?.pixCopiaCola || order?.pix_copia_cola || '';
      const total = order?.total ?? null;

      $('#pixOut').innerHTML = `
        <div style="display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:8px">
          <span class="chip"><b>Order ID</b> <span id="orderIdView">${escapeHtml(orderId || '‚Äî')}</span></span>
          <span class="chip"><b>Total</b> <span>${total != null ? fmtBRL(total) : fmtBRL(cartTotal())}</span></span>
          <span class="chip"><b>Status</b> <span>${escapeHtml(order?.status || 'created')}</span></span>
        </div>
        <div class="note" style="margin-top:10px">PIX copia e cola:</div>
        <div style="margin-top:8px; padding:12px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.18); word-break: break-all;">${escapeHtml(pix || 'PIX indispon√≠vel')}</div>
      `;

      $('#copyPix').disabled = !pix;
      $('#copyOrderId').disabled = !orderId;

      const save = { orderId, when: Date.now(), user: ($('#robloxUser').value||'').trim(), items: Object.values(state.cart) };
      if (orderId) {
        state.lastOrderId = orderId;
        store.set('vv_last_order', orderId);
        $('#m3v').textContent = orderId;
        // local purchases log
        state.purchases.unshift(save);
        state.purchases = state.purchases.slice(0, 50);
        store.set('vv_purchases', state.purchases);
        renderPurchases(state.purchases);
      }

      toast('Pedido criado.');
    };

    $('#reviewBtn').addEventListener('click', () => {
      try{
        const payload = buildOrderPayload();
        toast(`Ok: ${payload.items.length} item(ns) para ${payload.user}`);
      }catch(err){ toast(err.message || 'Erro'); }
    });

    $('#createOrderBtn').addEventListener('click', async () => {
      try{
        const payload = buildOrderPayload();
        $('#createOrderBtn').disabled = true;
        toast('Gerando pedido‚Ä¶');
        const order = await api('/create-order', { method:'POST', body: JSON.stringify(payload) });
        showPix(order);
      }catch(err){
        toast(err.message || 'Falha');
        $('#pixOut').textContent = err.message || 'Falha.';
      }finally{
        $('#createOrderBtn').disabled = false;
      }
    });

    $('#copyPix').addEventListener('click', async () => {
      const text = $('#pixOut').innerText || '';
      const m = text.match(/PIX copia e cola:\s*([\s\S]*)/i);
      const pix = m ? m[1].trim() : '';
      if (!pix) return toast('PIX indispon√≠vel.');
      try{ await navigator.clipboard.writeText(pix); toast('PIX copiado.'); }catch{ toast('N√£o deu. Copie manualmente.'); }
    });

    $('#copyOrderId').addEventListener('click', async () => {
      const el = $('#orderIdView');
      const id = el ? el.textContent.trim() : state.lastOrderId;
      if (!id) return toast('Sem Order ID.');
      try{ await navigator.clipboard.writeText(id); toast('Order ID copiado.'); }catch{ toast('N√£o deu. Copie manualmente.'); }
    });

    // ========= ORDER STATUS / PURCHASES =========
    const renderOrderStatus = (data) => {
      const ok = data?.ok !== false;
      const status = data?.status || data?.order?.status || '‚Äî';
      const orderId = data?.orderId || data?.order?.orderId || '';
      const paid = data?.paid ?? data?.order?.paid ?? null;
      const delivered = data?.delivered ?? data?.order?.delivered ?? null;

      const lines = [
        ok ? `<span class="chip"><b>V√°lido</b> <span style="color:var(--good);font-weight:900">sim</span></span>` : `<span class="chip"><b>V√°lido</b> <span style="color:var(--bad);font-weight:900">n√£o</span></span>`,
        `<span class="chip"><b>Status</b> <span>${escapeHtml(status)}</span></span>`,
        orderId ? `<span class="chip"><b>Order</b> <span>${escapeHtml(orderId)}</span></span>` : '',
        paid != null ? `<span class="chip"><b>Pago</b> <span>${paid ? 'sim' : 'n√£o'}</span></span>` : '',
        delivered != null ? `<span class="chip"><b>Entregue</b> <span>${delivered ? 'sim' : 'n√£o'}</span></span>` : ''
      ].filter(Boolean);

      $('#orderOut').innerHTML = lines.join(' ');
    };

    $('#checkOrderBtn').addEventListener('click', async () => {
      const id = ($('#orderIdIn').value || '').trim() || state.lastOrderId;
      if (!id) return toast('Cole um Order ID.');
      try{
        toast('Consultando‚Ä¶');
        const data = await api(`/order-status?orderId=${encodeURIComponent(id)}`, { method:'GET' });
        renderOrderStatus(data);
      }catch(err){
        $('#orderOut').textContent = err.message || 'Falha.';
        toast(err.message || 'Falha');
      }
    });

    $('#useLastOrder').addEventListener('click', () => {
      if (!state.lastOrderId) return toast('Sem √∫ltimo pedido.');
      $('#orderIdIn').value = state.lastOrderId;
      toast('Ok.');
    });

    const renderPurchases = (list) => {
      const el = $('#purchases');
      if (!list || !list.length) {
        el.innerHTML = `<div class="note">Sem hist√≥rico.</div>`;
        return;
      }
      el.innerHTML = list.slice(0, 20).map(p => {
        const when = new Date(p.when || Date.now()).toLocaleString('pt-BR');
        const cnt = (p.items || []).reduce((a,it)=>a+(it.qty||0),0);
        return `
          <div style="padding:10px; border-radius:16px; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.14); margin-bottom:10px;">
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
              <div style="min-width:0">
                <div style="font-weight:900; font-size:13px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">${escapeHtml(p.orderId || '‚Äî')}</div>
                <div style="color:var(--muted2); font-size:12px">${escapeHtml(p.user || '‚Äî')} ‚Ä¢ ${when}</div>
              </div>
              <span class="chip"><b>Itens</b> <span>${cnt}</span></span>
            </div>
          </div>
        `;
      }).join('');
    };

    $('#loadPurchases').addEventListener('click', async () => {
      const user = ($('#robloxUser').value || '').trim();
      if (!validateUser(user)) return toast('Digite seu user (3-20).');
      toast('Carregando‚Ä¶');

      // Start with local
      const local = state.purchases.filter(p => (p.user||'').toLowerCase() === user.toLowerCase());
      renderPurchases(local.length ? local : state.purchases);

      // Try worker (if route exists)
      try{
        const data = await api(`/order-user?user=${encodeURIComponent(user)}`, { method:'GET' });
        const orders = data?.orders || data?.items || [];
        if (Array.isArray(orders) && orders.length) {
          const mapped = orders.map(o => ({ orderId: o.orderId || o.id || '‚Äî', when: o.createdAt || o.ts || Date.now(), user }));
          renderPurchases(mapped.concat(local));
          toast('Hist√≥rico atualizado.');
        } else {
          toast('Sem hist√≥rico no servidor.');
        }
      }catch{
        toast('Servidor n√£o retornou hist√≥rico.');
      }
    });

    $('#clearPurchases').addEventListener('click', () => {
      state.purchases = [];
      store.set('vv_purchases', state.purchases);
      renderPurchases(state.purchases);
      toast('Hist√≥rico limpo.');
    });

    // ========= LAB: AMBIENT MIXER (WebAudio) =========
    let audio = { ctx:null, master:null, noise:null, wind:null, ping:null, pingT:null, on:false };

    const createNoise = (ctx) => {
      const buf = ctx.createBuffer(1, ctx.sampleRate * 2, ctx.sampleRate);
      const data = buf.getChannelData(0);
      for (let i=0; i<data.length; i++) data[i] = (Math.random()*2 - 1) * 0.35;
      const src = ctx.createBufferSource();
      src.buffer = buf;
      src.loop = true;
      const gain = ctx.createGain();
      gain.gain.value = 0.18;
      src.connect(gain);
      src.start();
      return { src, gain };
    };

    const createWind = (ctx) => {
      const osc = ctx.createOscillator();
      osc.type = 'sine';
      osc.frequency.value = 110;
      const lfo = ctx.createOscillator();
      lfo.type = 'sine';
      lfo.frequency.value = 0.12;
      const lfoGain = ctx.createGain();
      lfoGain.gain.value = 38;
      lfo.connect(lfoGain);
      lfoGain.connect(osc.frequency);
      const gain = ctx.createGain();
      gain.gain.value = 0.10;
      osc.connect(gain);
      osc.start();
      lfo.start();
      return { osc, gain, lfo, lfoGain };
    };

    const schedulePing = () => {
      if (!audio.on || !audio.ctx) return;
      const ctx = audio.ctx;
      const t = ctx.currentTime + 0.05;
      const o = ctx.createOscillator();
      o.type = 'triangle';
      o.frequency.value = 660 + Math.random()*110;
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.0001, t);
      g.gain.exponentialRampToValueAtTime(0.06, t + 0.02);
      g.gain.exponentialRampToValueAtTime(0.0001, t + 0.18);
      o.connect(g);
      g.connect(audio.master);
      o.start(t);
      o.stop(t + 0.22);

      const base = 2800;
      const density = Number($('#ambPing').value || 6);
      const wait = Math.max(650, base - density*20) + Math.random()*700;
      audio.pingT = setTimeout(schedulePing, wait);
    };

    const setAudioVolumes = () => {
      if (!audio.ctx) return;
      const nv = Number($('#ambNoise').value||0) / 100;
      const wv = Number($('#ambWind').value||0) / 100;
      audio.noise.gain.gain.value = 0.40 * nv;
      audio.wind.gain.gain.value = 0.20 * wv;
      $('#ambNoiseV').textContent = String($('#ambNoise').value);
      $('#ambWindV').textContent = String($('#ambWind').value);
      $('#ambPingV').textContent = String($('#ambPing').value);
    };

    const toggleAmbient = async () => {
      try{
        if (!audio.ctx) {
          audio.ctx = new (window.AudioContext || window.webkitAudioContext)();
          audio.master = audio.ctx.createGain();
          audio.master.gain.value = 0.9;
          audio.master.connect(audio.ctx.destination);

          audio.noise = createNoise(audio.ctx);
          audio.wind = createWind(audio.ctx);
          audio.noise.gain.connect(audio.master);
          audio.wind.gain.connect(audio.master);
        }

        if (audio.ctx.state === 'suspended') await audio.ctx.resume();

        audio.on = !audio.on;
        $('#ambState').textContent = audio.on ? 'on' : 'off';
        $('#ambToggle').textContent = audio.on ? 'Desativar' : 'Ativar';

        if (audio.on) {
          setAudioVolumes();
          clearTimeout(audio.pingT);
          schedulePing();
          toast('Mixer ligado.');
        } else {
          clearTimeout(audio.pingT);
          toast('Mixer desligado.');
        }
      }catch{
        toast('√Åudio indispon√≠vel.');
      }
    };

    $('#ambToggle').addEventListener('click', toggleAmbient);
    ['ambNoise','ambWind','ambPing'].forEach(id => $('#'+id).addEventListener('input', () => setAudioVolumes()));

    // ========= LAB: SAND =========
    const sand = (() => {
      const canvas = $('#sandCanvas');
      const ctx = canvas.getContext('2d', { alpha: true });
      let w=canvas.width, h=canvas.height;
      const dpr = Math.min(2, window.devicePixelRatio || 1);

      const resize = () => {
        const rect = canvas.getBoundingClientRect();
        const cw = Math.max(320, Math.floor(rect.width));
        const ch = Math.max(180, Math.floor(rect.height));
        canvas.width = Math.floor(cw * dpr);
        canvas.height = Math.floor(ch * dpr);
        w = canvas.width;
        h = canvas.height;
        ctx.setTransform(dpr,0,0,dpr,0,0);
      };

      const parts = [];
      const maxParts = 5500;
      let pouring = false;
      let px = 0, py = 0;
      let paused = false;
      let last = performance.now();
      let frames = 0;

      const color = () => {
        const pal = [
          [110,168,255],
          [155,123,255],
          [53,208,127],
          [255,204,102],
          [255,107,107]
        ];
        const c = pal[Math.floor(Math.random()*pal.length)];
        return `rgba(${c[0]},${c[1]},${c[2]},0.85)`;
      };

      const add = (x,y) => {
        for (let i=0;i<12;i++){
          if (parts.length >= maxParts) parts.shift();
          parts.push({
            x: x + (Math.random()*10-5),
            y: y + (Math.random()*10-5),
            vx: (Math.random()*0.8-0.4),
            vy: Math.random()*0.5,
            r: 1 + Math.random()*1.3,
            c: color()
          });
        }
      };

      const step = (dt) => {
        for (let i=0;i<parts.length;i++){
          const p = parts[i];
          p.vy += 0.07;
          p.x += p.vx;
          p.y += p.vy;
          p.vx *= 0.995;

          // floor
          if (p.y > (h/dpr) - p.r - 2) {
            p.y = (h/dpr) - p.r - 2;
            p.vy *= -0.18;
            p.vx *= 0.86;
          }
          // walls
          if (p.x < p.r) { p.x = p.r; p.vx *= -0.4; }
          if (p.x > (w/dpr)-p.r) { p.x = (w/dpr)-p.r; p.vx *= -0.4; }

          // slight damping
          p.vy *= 0.998;
        }
      };

      const draw = () => {
        ctx.clearRect(0,0,w/dpr,h/dpr);
        // subtle glow
        ctx.fillStyle = 'rgba(110,168,255,0.04)';
        ctx.fillRect(0,0,w/dpr,h/dpr);

        for (let i=0;i<parts.length;i++){
          const p = parts[i];
          ctx.beginPath();
          ctx.fillStyle = p.c;
          ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
          ctx.fill();
        }
      };

      const loop = (t) => {
        if (paused) return;
        const dt = Math.min(34, t-last);
        last = t;
        if (pouring) add(px,py);
        step(dt);
        draw();

        frames++;
        if (frames % 24 === 0) {
          const fps = Math.round(1000 / (dt || 16));
          $('#sandFps').textContent = String(fps);
        }

        requestAnimationFrame(loop);
      };

      const pos = (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = (e.clientX - rect.left);
        const y = (e.clientY - rect.top);
        return { x, y };
      };

      const onDown = (e) => { pouring = true; const p = pos(e); px=p.x; py=p.y; canvas.setPointerCapture?.(e.pointerId); };
      const onMove = (e) => { if (!pouring) return; const p = pos(e); px=p.x; py=p.y; };
      const onUp = () => { pouring = false; };

      canvas.addEventListener('pointerdown', onDown);
      canvas.addEventListener('pointermove', onMove);
      window.addEventListener('pointerup', onUp);

      const clear = () => { parts.length = 0; draw(); toast('Limpo.'); };
      const toggle = () => {
        paused = !paused;
        $('#sandPause').textContent = paused ? 'Retomar' : 'Pausar';
        if (!paused) { last = performance.now(); requestAnimationFrame(loop); }
        toast(paused ? 'Pausado.' : 'Rodando.');
      };

      $('#sandClear').addEventListener('click', clear);
      $('#sandPause').addEventListener('click', toggle);

      // Pause when hidden to save battery
      document.addEventListener('visibilitychange', () => {
        if (document.hidden) { paused = true; $('#sandPause').textContent = 'Retomar'; }
      });

      // Start
      resize();
      new ResizeObserver(resize).observe(canvas);
      requestAnimationFrame(loop);

      return { clear, toggle };
    })();

    // ========= LAB: FUTURE NOTE =========
    const futureKey = 'vv_future_note';

    const loadFuture = () => store.get(futureKey, null);
    const saveFuture = (obj) => store.set(futureKey, obj);
    const delFuture = () => store.del(futureKey);

    const futureRender = () => {
      const f = loadFuture();
      if (!f) { $('#futureOut').textContent = 'Sem mensagem salva.'; return; }
      const now = new Date();
      const unlock = new Date(f.unlock || 0);
      const unlocked = now >= unlock;
      const when = unlock.toLocaleDateString('pt-BR');
      if (!unlocked) {
        $('#futureOut').textContent = `Guardada. Desbloqueia em ${when}.`;
      } else {
        $('#futureOut').textContent = `Desbloqueada (${when}): ${f.msg || ''}`;
      }
    };

    $('#futureSave').addEventListener('click', () => {
      const d = $('#futureDate').value;
      const msg = ($('#futureMsg').value || '').trim();
      if (!d) return toast('Escolha uma data.');
      if (!msg) return toast('Escreva a mensagem.');
      saveFuture({ unlock: d, msg });
      toast('Salvo.');
      futureRender();
    });
    $('#futureOpen').addEventListener('click', () => { futureRender(); toast('Ok.'); });
    $('#futureDel').addEventListener('click', () => { delFuture(); $('#futureMsg').value=''; $('#futureDate').value=''; futureRender(); toast('Apagado.'); });

    // ========= LAB: RANDOM TIP =========
    const tips = [
      'Guarde seu Order ID: ele √© a chave do acompanhamento.',
      'Se o cat√°logo estiver vazio, toque em ‚ÄúRecarregar cat√°logo‚Äù.',
      'Sem rede? O app continua com cache/offline para navegar.',
      'Use o campo cupom apenas se voc√™ recebeu um cupom v√°lido.',
      'No ‚ÄúMinhas Compras‚Äù, coloque seu user e tente carregar hist√≥rico.'
    ];
    $('#randomTip').addEventListener('click', () => {
      const t = tips[Math.floor(Math.random()*tips.length)];
      $('#tipOut').textContent = t;
      toast('Dica pronta.');
    });

    // ========= TOOLING =========
    $('#reloadCatalog').addEventListener('click', () => loadCatalog({force:true}));
    $('#resetLocal').addEventListener('click', () => {
      store.del('vv_cart');
      store.del('vv_catalog_cache');
      store.del('vv_catalog_cache_at');
      store.del('vv_last_order');
      store.del('vv_purchases');
      state.cart = {};
      state.lastOrderId = '';
      state.purchases = [];
      renderCart();
      renderPurchases(state.purchases);
      toast('Reset ok.');
    });

    // ========= INIT =========
    const init = async () => {
      registerSW();
      await healthCheck();

      // catalog
      await loadCatalog();
      renderCart();
      renderPurchases(state.purchases);

      if (state.lastOrderId) $('#m3v').textContent = state.lastOrderId;

      // UX: set default date for future note
      const dt = new Date();
      dt.setDate(dt.getDate()+7);
      $('#futureDate').value = dt.toISOString().slice(0,10);
      futureRender();

      // Quick metrics
      $('#m1b').style.width = '42%';
      $('#m2b').style.width = Math.min(100, cartCount()*12) + '%';

      // hide worker chip details if you want later: keep only "ok/offline".
      // chip is already minimal.
    };

    init();

  })();
  </script>

<!-- ========= IA SUPPORT (FREE / SEM OPENAI) ========= -->
<div id="aiFab" aria-label="Abrir IA de suporte" title="IA de Suporte">
  <span class="aiFabIcon">‚ú¶</span>
  <span class="aiFabText">IA</span>
</div>

<div id="aiPanel" role="dialog" aria-modal="true" aria-hidden="true">
  <div class="aiTop">
    <div class="aiBrand">
      <div class="aiDot"></div>
      <div>
        <div class="aiTitle">ViralVault Assist</div>
        <div class="aiSub">Suporte inteligente (sem custos)</div>
      </div>
    </div>
    <button id="aiClose" class="aiClose" aria-label="Fechar">√ó</button>
  </div>

  <div id="aiMsgs" class="aiMsgs" aria-live="polite"></div>

  <div class="aiQuick" id="aiQuick">
    <button class="aiChip" data-q="Como comprar?">Como comprar</button>
    <button class="aiChip" data-q="Quanto tempo para entrega?">Entrega</button>
    <button class="aiChip" data-q="Como acompanhar meu pedido?">Pedido</button>
    <button class="aiChip" data-q="Formas de pagamento">Pagamento</button>
    <button class="aiChip" data-q="Suporte Discord">Discord</button>
  </div>

  <form id="aiForm" class="aiForm" autocomplete="off">
    <input id="aiInput" class="aiInput" type="text" inputmode="text" placeholder="Pergunte algo‚Ä¶ (ex: rastrear pedido 123)" maxlength="400" />
    <button id="aiSend" class="aiSend" type="submit">Enviar</button>
  </form>

  <div class="aiFoot">
    <div class="aiFootNote">Dica: escreva <b>pedido 123</b>, <b>pix</b>, <b>prazo</b>, <b>reembolso</b>.</div>
    <a class="aiDiscord" href="https://discord.gg/fWAWquBu" target="_blank" rel="noopener">Abrir Discord</a>
  </div>
</div>

<style id="aiSupportStyles">
  :root{
    --ai-bg: rgba(10,12,18,.72);
    --ai-card: rgba(255,255,255,.06);
    --ai-stroke: rgba(255,255,255,.12);
    --ai-text: rgba(255,255,255,.92);
    --ai-muted: rgba(255,255,255,.68);
    --ai-accent: rgba(120,180,255,.95);
    --ai-accent2: rgba(178,120,255,.95);
  }

  #aiFab{
    position: fixed;
    right: 16px;
    bottom: 18px;
    z-index: 99999;
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 12px 14px;
    border-radius: 999px;
    color: var(--ai-text);
    background: linear-gradient(135deg, rgba(90,160,255,.35), rgba(190,90,255,.28));
    border: 1px solid rgba(255,255,255,.16);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    box-shadow: 0 16px 48px rgba(0,0,0,.35);
    cursor: pointer;
    user-select: none;
    transform: translateZ(0);
  }
  #aiFab:active{ transform: scale(.98); }
  .aiFabIcon{
    width: 34px;
    height: 34px;
    display: grid;
    place-items: center;
    border-radius: 14px;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.22), rgba(255,255,255,.06));
    border: 1px solid rgba(255,255,255,.14);
    box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
    font-weight: 800;
  }
  .aiFabText{ font-weight: 800; letter-spacing: .5px; }

  #aiPanel{
    position: fixed;
    right: 16px;
    bottom: 72px;
    width: min(420px, calc(100vw - 32px));
    height: min(560px, calc(100vh - 120px));
    z-index: 99999;
    display: none;
    flex-direction: column;
    border-radius: 22px;
    overflow: hidden;
    background: linear-gradient(180deg, rgba(16,20,30,.72), rgba(10,12,18,.78));
    border: 1px solid rgba(255,255,255,.14);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    box-shadow: 0 28px 80px rgba(0,0,0,.45);
  }
  #aiPanel[aria-hidden="false"]{ display: flex; }

  .aiTop{
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 14px 14px;
    background: linear-gradient(90deg, rgba(110,170,255,.16), rgba(190,110,255,.12));
    border-bottom: 1px solid rgba(255,255,255,.10);
  }
  .aiBrand{ display:flex; align-items:center; gap: 10px; }
  .aiDot{
    width: 12px; height: 12px; border-radius: 99px;
    background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.9), rgba(255,255,255,.0)),
                linear-gradient(135deg, var(--ai-accent), var(--ai-accent2));
    box-shadow: 0 0 0 6px rgba(120,180,255,.12);
  }
  .aiTitle{ font-weight: 900; color: var(--ai-text); line-height: 1.1; }
  .aiSub{ font-size: 12px; color: var(--ai-muted); margin-top: 2px; }
  .aiClose{
    width: 36px; height: 36px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: var(--ai-text);
    cursor: pointer;
  }

  .aiMsgs{
    flex: 1;
    padding: 14px;
    overflow: auto;
  }
  .aiRow{ display: flex; margin: 10px 0; }
  .aiRow.user{ justify-content: flex-end; }
  .aiRow.bot{ justify-content: flex-start; }
  .aiBubble{
    max-width: 86%;
    padding: 12px 12px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    color: var(--ai-text);
    line-height: 1.35;
    white-space: pre-wrap;
    word-break: break-word;
  }
  .aiRow.user .aiBubble{
    background: linear-gradient(135deg, rgba(120,180,255,.18), rgba(178,120,255,.14));
    border-color: rgba(255,255,255,.16);
  }
  .aiMeta{ font-size: 11px; color: var(--ai-muted); margin-top: 6px; }

  .aiQuick{
    display: flex;
    gap: 8px;
    padding: 10px 12px;
    overflow-x: auto;
    border-top: 1px solid rgba(255,255,255,.08);
    border-bottom: 1px solid rgba(255,255,255,.08);
    background: rgba(0,0,0,.12);
  }
  .aiChip{
    flex: 0 0 auto;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(255,255,255,.06);
    color: var(--ai-text);
    cursor: pointer;
    font-weight: 700;
    font-size: 12px;
  }
  .aiChip:active{ transform: scale(.99); }

  .aiForm{
    display: flex;
    gap: 10px;
    padding: 12px;
    background: rgba(0,0,0,.14);
  }
  .aiInput{
    flex: 1;
    padding: 12px 12px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: var(--ai-text);
    outline: none;
  }
  .aiSend{
    padding: 12px 14px;
    border-radius: 14px;
    border: 1px solid rgba(255,255,255,.14);
    background: linear-gradient(135deg, rgba(120,180,255,.22), rgba(178,120,255,.18));
    color: var(--ai-text);
    cursor: pointer;
    font-weight: 900;
  }

  .aiFoot{
    display:flex;
    justify-content: space-between;
    gap: 12px;
    align-items: center;
    padding: 10px 12px;
    border-top: 1px solid rgba(255,255,255,.10);
    background: rgba(255,255,255,.03);
  }
  .aiFootNote{ font-size: 12px; color: var(--ai-muted); }
  .aiDiscord{
    padding: 8px 10px;
    border-radius: 12px;
    border: 1px solid rgba(255,255,255,.14);
    background: rgba(255,255,255,.06);
    color: var(--ai-text);
    text-decoration: none;
    font-weight: 900;
  }

  @media (prefers-reduced-motion: reduce){
    #aiFab, .aiSend, .aiChip{ transition: none !important; }
  }
</style>

<script>
(() => {
  const DISCORD_INVITE = "https://discord.gg/fWAWquBu";

  const fab = document.getElementById("aiFab");
  const panel = document.getElementById("aiPanel");
  const closeBtn = document.getElementById("aiClose");
  const msgs = document.getElementById("aiMsgs");
  const form = document.getElementById("aiForm");
  const input = document.getElementById("aiInput");

  const chips = Array.from(document.querySelectorAll(".aiChip"));

  const now = () => Date.now();
  const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

  // ===== Anti-spam (client-side) =====
  const RL_KEY = "vv_ai_rl_v1";
  function readRL(){
    try{ return JSON.parse(localStorage.getItem(RL_KEY) || "{}") || {}; }catch{ return {}; }
  }
  function writeRL(obj){
    try{ localStorage.setItem(RL_KEY, JSON.stringify(obj)); }catch{}
  }
  function canSend(){
    const t = now();
    const rl = readRL();
    const last = rl.last || 0;
    const bucket = (rl.bucket || []).filter(x => (t - x) < 60_000);

    // hard throttle: 1 msg / 1200ms
    if (t - last < 1200) return { ok:false, reason:"R√°pido demais. Aguarde 1s." };

    // per minute: 20
    if (bucket.length >= 20) return { ok:false, reason:"Limite de mensagens por minuto atingido." };

    bucket.push(t);
    writeRL({ last: t, bucket });
    return { ok:true };
  }

  // ===== Basic safety filter =====
  const blocked = [
    "spam", "phishing", "cartao clonado", "cc", "bin", "fraude", "golpe",
    "hack", "roubar", "invadir", "cheat", "exploit", "dupe"
  ];
  const profanity = ["porra","caralho","foda","fdp","puta","buceta","pau","pinto","arromb"];

  function normalize(s){
    return (s||"")
      .toLowerCase()
      .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
      .replace(/[^a-z0-9\s\-_.]/g, " ")
      .replace(/\s+/g, " ")
      .trim();
  }

  function containsAny(s, arr){
    return arr.some(w => s.includes(w));
  }

  // ===== Knowledge base (edit√°vel) =====
  const KB = [
    {
      q: "como comprar",
      a: "1) Abra o Cat√°logo\n2) Escolha o produto\n3) Clique em Comprar\n4) Pague via PIX\n5) V√° em Pedido e cole o ID/Comprovante quando solicitado.\n\nSe quiser atendimento humano: Discord.",
      tags: ["comprar","checkout","pix"]
    },
    {
      q: "entrega prazo tempo",
      a: "O prazo depende do produto e da fila. Normalmente: prioridade (24h) entra primeiro.\n\nDica: em Pedido, use seu n√∫mero/ID para acompanhar.",
      tags: ["entrega","prazo","24h"]
    },
    {
      q: "acompanhar pedido status",
      a: "Abra a aba Pedido e informe o ID do pedido (ou o identificador que voc√™ recebeu).\nSe o status estiver offline/erro, tente novamente em alguns minutos ou chame no Discord.",
      tags: ["pedido","status","rastrear"]
    },
    {
      q: "pagamento pix",
      a: "Aceitamos PIX. Copie e cole o c√≥digo PIX e finalize no seu banco.\nDepois, guarde o comprovante.\n\nSe o PIX expirar: gere um novo checkout e pague novamente.",
      tags: ["pix","pagamento","banco"]
    },
    {
      q: "reembolso estorno",
      a: "Reembolso varia por tipo de produto e est√°gio do pedido.\nSe o produto n√£o foi entregue ou houve erro, abra ticket no Discord com: ID do pedido + comprovante + print do erro.",
      tags: ["reembolso","estorno"]
    },
    {
      q: "discord suporte",
      a: "Suporte oficial √© pelo Discord. Entre por aqui: " + DISCORD_INVITE,
      tags: ["discord","suporte"]
    },
    {
      q: "seguranca oficial",
      a: "Canal oficial: somente pelo site + Discord do link dentro do site.\nNunca pe√ßa ajuda por DM aleat√≥ria.\nSe algu√©m pedir senha/c√≥digo, √© golpe.",
      tags: ["oficial","seguranca","golpe"]
    }
  ];

  function score(query, item){
    const q = normalize(query);
    const hay = normalize(item.q + " " + (item.tags||[]).join(" ") + " " + item.a);
    if (!q) return 0;

    const words = q.split(" ").filter(w => w.length >= 3);
    let s = 0;
    for (const w of words){
      if (hay.includes(w)) s += 1;
    }

    // boost for exact intent keywords
    if (hay.includes(q)) s += 2;
    return s;
  }

  function bestAnswer(text){
    const qn = normalize(text);

    if (containsAny(qn, profanity)){
      return {
        a: "Consigo ajudar, mas sem palavr√µes. Reenvie sua d√∫vida de forma objetiva.",
        conf: 1
      };
    }

    if (containsAny(qn, blocked)){
      return {
        a: "N√£o posso ajudar com isso. Se sua d√∫vida for sobre compra/entrega/suporte, descreva sem termos de risco.",
        conf: 1
      };
    }

    // Try to detect order id
    const idMatch = qn.match(/\b(pedido|order)\s*#?\s*(\d{2,})\b/);
    if (idMatch){
      const id = idMatch[2];
      return {
        a: `Entendi. Para acompanhar o pedido ${id}:\n\n1) Abra a aba Pedido\n2) Cole o ID ${id}\n3) Veja o status\n\nSe der \"offline\" ou erro, tente de novo mais tarde e chame no Discord com o ID.` ,
        conf: 3
      };
    }

    let best = null;
    let bestS = 0;
    for (const item of KB){
      const s = score(text, item);
      if (s > bestS){ bestS = s; best = item; }
    }

    if (!best || bestS <= 0){
      return {
        a: "N√£o tenho certeza pelo que voc√™ escreveu.\n\nMe diga: voc√™ quer *comprar*, *pagar via PIX*, *acompanhar pedido* ou *suporte*?\n\nSe preferir atendimento humano, use o Discord: " + DISCORD_INVITE,
        conf: 0
      };
    }

    return { a: best.a, conf: bestS };
  }

  function addMsg(who, text){
    const row = document.createElement("div");
    row.className = "aiRow " + who;

    const bub = document.createElement("div");
    bub.className = "aiBubble";
    bub.textContent = text;

    row.appendChild(bub);
    msgs.appendChild(row);
    msgs.scrollTop = msgs.scrollHeight;
  }

  function greet(){
    addMsg("bot", "Oi! Eu sou o ViralVault Assist.\n\nPosso ajudar com: compra, PIX, prazo, pedido e seguran√ßa.\nSe quiser humano: Discord.");
  }

  function openPanel(){
    panel.setAttribute("aria-hidden", "false");
    if (!msgs.dataset.inited){
      msgs.dataset.inited = "1";
      greet();
    }
    setTimeout(() => input.focus(), 30);
  }

  function closePanel(){
    panel.setAttribute("aria-hidden", "true");
  }

  fab.addEventListener("click", openPanel);
  closeBtn.addEventListener("click", closePanel);

  // click outside to close (mobile friendly)
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closePanel();
  });

  chips.forEach(ch => {
    ch.addEventListener("click", () => {
      const q = ch.getAttribute("data-q") || "";
      input.value = q;
      form.dispatchEvent(new Event("submit", { cancelable: true }));
    });
  });

  form.addEventListener("submit", (e) => {
    e.preventDefault();
    const txt = (input.value || "").trim();
    if (!txt) return;

    const rl = canSend();
    if (!rl.ok){
      addMsg("bot", rl.reason);
      return;
    }

    addMsg("user", txt);
    input.value = "";

    // tiny "thinking" effect
    const typing = document.createElement("div");
    typing.className = "aiRow bot";
    typing.innerHTML = '<div class="aiBubble">‚Ä¶</div>';
    msgs.appendChild(typing);
    msgs.scrollTop = msgs.scrollHeight;

    setTimeout(() => {
      typing.remove();
      const { a } = bestAnswer(txt);
      addMsg("bot", a);
    }, clamp(350 + Math.random()*350, 250, 900));
  });

})();
</script>
</body>
</html>
