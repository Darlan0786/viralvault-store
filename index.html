<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>ViralVault Store</title>

  <!-- SEO -->
  <meta name="description" content="ViralVault Store — catálogo, checkout PIX, status oficial e suporte via Discord."/>
  <meta name="keywords" content="ViralVault, robux, roblox, loja, pix, checkout, itens, conta, suporte, discord"/>
  <meta name="robots" content="index,follow"/>
  <link rel="canonical" href="https://viralvault-store.vercel.app/"/>

  <!-- OpenGraph / Twitter (sem imagem data-uri enorme p/ não quebrar) -->
  <meta property="og:title" content="ViralVault Store"/>
  <meta property="og:description" content="Catálogo, checkout PIX e status oficial."/>
  <meta property="og:type" content="website"/>
  <meta property="og:url" content="https://viralvault-store.vercel.app/"/>
  <meta name="twitter:card" content="summary"/>
  <meta name="twitter:title" content="ViralVault Store"/>
  <meta name="twitter:description" content="Catálogo, checkout PIX e status oficial."/>

  <meta name="theme-color" content="#0b0b0f"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>

  <!-- JSON-LD -->
  <script type="application/ld+json">
  {
    "@context":"https://schema.org",
    "@type":"WebSite",
    "name":"ViralVault Store",
    "url":"https://viralvault-store.vercel.app/"
  }
  </script>

  <style>
    :root{
      --bg:#07080c; --panel:#0c0e16; --panel2:#0a0b10;
      --text:#f2f4ff; --muted:rgba(242,244,255,.7);
      --line:rgba(255,255,255,.10);
      --yellow:#ffd11a; --red:#ff3b30; --green:#22c55e;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% -10%, rgba(255,209,26,.16), transparent 55%),
        radial-gradient(900px 600px at 90% 10%, rgba(255,59,48,.12), transparent 55%),
        radial-gradient(1100px 700px at 60% 120%, rgba(34,197,94,.10), transparent 60%),
        var(--bg);
      overflow-x:hidden;
    }
    a{color:inherit; text-decoration:none}
    code{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
    .wrap{max-width:1120px; margin:0 auto; padding:24px 16px 80px}
    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(to bottom, rgba(7,8,12,.92), rgba(7,8,12,.64));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .topbar{max-width:1120px; margin:0 auto; padding:12px 16px; display:flex; align-items:center; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; min-width:240px}
    .logo{
      width:34px; height:34px; border-radius:12px;
      background: radial-gradient(circle at 30% 30%, rgba(255,209,26,.95), rgba(255,59,48,.65) 55%, rgba(0,0,0,.0) 70%),
                  linear-gradient(135deg, rgba(255,209,26,.35), rgba(255,59,48,.2));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: 0 10px 35px rgba(0,0,0,.35);
    }
    .brand h1{font-size:14px; margin:0; letter-spacing:.6px; text-transform:uppercase}
    .brand .sub{font-size:12px; color:var(--muted)}
    .spacer{flex:1}

    .pillbar{display:flex; gap:10px; align-items:center}
    .pill{
      display:inline-flex; align-items:center; gap:10px;
      height:42px; padding:0 14px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .pill:hover{transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18)}
    .pill:active{transform: translateY(0px) scale(.98)}
    .icon{width:18px; height:18px; opacity:.9}

    /* HERO (faltava — agora “completo”) */
    .hero{
      margin-top:18px;
      padding:20px;
      border-radius:22px;
      border:1px solid rgba(255,255,255,.12);
      background:
        radial-gradient(600px 260px at 18% 10%, rgba(255,209,26,.20), transparent 60%),
        radial-gradient(600px 260px at 88% 20%, rgba(255,59,48,.16), transparent 60%),
        rgba(255,255,255,.04);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero:after{
      content:"";
      position:absolute; inset:-2px;
      background: linear-gradient(115deg, rgba(255,209,26,.18), rgba(255,59,48,.12), rgba(34,197,94,.10));
      filter: blur(28px);
      opacity:.55;
      z-index:-1;
    }
    .heroGrid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; align-items:stretch}
    @media (max-width: 920px){ .heroGrid{grid-template-columns:1fr} .brand{min-width:auto} }
    .hero h2{margin:0 0 6px; font-size:22px; letter-spacing:.2px}
    .hero p{margin:0; color:var(--muted); line-height:1.45}
    .heroActions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px}
    .kpis{display:grid; grid-template-columns:1fr; gap:10px}
    .kpi{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      border-radius:18px;
      padding:12px;
    }
    .kpi .t{font-size:12px; color:var(--muted)}
    .kpi .v{font-size:16px; font-weight:800; margin-top:4px}

    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; align-items:start; margin-top:16px}
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border:1px solid rgba(255,255,255,.12);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:16px 16px 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .title{margin:0; font-size:16px; letter-spacing:.2px}
    .muted{color:var(--muted); font-size:13px; line-height:1.35}
    .tag{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    .body{padding:16px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      height:44px; padding:0 14px; border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color:var(--text);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(255,255,255,.18)}
    .btn:active{transform: translateY(0px) scale(.99)}
    .btn.primary{
      background: linear-gradient(90deg, rgba(255,209,26,.95), rgba(255,59,48,.75));
      border:1px solid rgba(255,255,255,.22);
      color:#101015;
      font-weight:800;
    }
    .btn.ghost{background:transparent}

    input,select{
      width:100%;
      height:44px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color:var(--text);
      padding:0 12px;
      outline:none;
    }
    input:focus,select:focus{border-color: rgba(255,209,26,.55)}

    .products{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px}
    @media (max-width:560px){ .products{grid-template-columns:1fr} }
    .prod{
      border-radius:16px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      padding:12px;
      display:flex; flex-direction:column; gap:8px;
    }
    .prod h3{margin:0; font-size:14px}
    .price{font-weight:900; letter-spacing:.2px}
    .badges{display:flex; gap:8px; flex-wrap:wrap}
    .badge{font-size:11px; padding:5px 9px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06)}
    .badge.y{border-color: rgba(255,209,26,.4); background: rgba(255,209,26,.10)}
    .badge.r{border-color: rgba(255,59,48,.45); background: rgba(255,59,48,.10)}
    .badge.g{border-color: rgba(34,197,94,.45); background: rgba(34,197,94,.10)}
    .mini{font-size:12px; color:var(--muted); line-height:1.3}
    .hr{height:1px; background:rgba(255,255,255,.08); margin:12px 0}

    /* Sections */
    .section{margin-top:16px}
    .section .shd{display:flex; align-items:flex-end; justify-content:space-between; gap:12px; margin-bottom:10px}
    .section h3{margin:0; font-size:15px}
    .featureGrid{display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px}
    @media (max-width:920px){ .featureGrid{grid-template-columns:1fr} }
    .feature{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:14px;
      box-shadow: 0 12px 40px rgba(0,0,0,.22);
    }
    .feature .h{font-weight:900; margin-bottom:6px}
    .feature .d{color:var(--muted); font-size:13px; line-height:1.35}

    /* Support modal */
    .backdrop{position:fixed; inset:0; background:rgba(0,0,0,.62); display:none; z-index:1000; padding:18px}
    .modal{max-width:560px; margin:6vh auto; background:rgba(10,11,16,.95); border:1px solid rgba(255,255,255,.14); border-radius:20px; box-shadow:var(--shadow); overflow:hidden}
    .modal .mhd{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:14px 14px; border-bottom:1px solid rgba(255,255,255,.10)}
    .close{width:40px; height:40px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.06); cursor:pointer}
    .chat{height:340px; overflow:auto; padding:14px; background: rgba(0,0,0,.20)}
    .msg{border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:10px 10px; margin:10px 0; background: rgba(255,255,255,.04)}
    .msg.you{background: rgba(255,209,26,.08); border-color: rgba(255,209,26,.22)}
    .msg .who{font-size:11px; opacity:.75; margin-bottom:6px}
    .composer{display:flex; gap:10px; padding:12px; border-top:1px solid rgba(255,255,255,.10)}
    .composer input{flex:1}
    .hint{font-size:12px; color:var(--muted); padding:0 14px 12px}

    footer{margin-top:18px; color:var(--muted); font-size:12px}
    .footgrid{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    @media (max-width:720px){ .footgrid{grid-template-columns:1fr} }
  </style>
</head>
<body>
<header>
  <div class="topbar">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <div>
        <h1>ViralVault</h1>
        <div class="sub">Loja digital — checkout PIX • status oficial</div>
      </div>
    </div>

    <div class="spacer"></div>

    <div class="pillbar">
      <a class="pill" href="https://discord.gg/fWAWquBu" target="_blank" rel="noopener">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M8.7 8.3c.2 0 .4.2.4.4s-.2.4-.4.4-.4-.2-.4-.4.2-.4.4-.4Zm6.6 0c.2 0 .4.2.4.4s-.2.4-.4.4-.4-.2-.4-.4.2-.4.4-.4Z" fill="currentColor"/>
          <path d="M16.6 6.2A14 14 0 0 0 14 5.6a9 9 0 0 0-.4.9c-1.2-.2-2.4-.2-3.6 0a9 9 0 0 0-.4-.9 14 14 0 0 0-2.6.6A12.8 12.8 0 0 0 5 16.2c1 .8 2.2 1.4 3.4 1.8.3-.4.6-.8.8-1.2-.4-.2-.9-.4-1.3-.6l.3-.2c2.5 1.2 5.2 1.2 7.7 0l.3.2c-.4.2-.8.5-1.3.6.2.4.5.8.8 1.2 1.2-.4 2.4-1 3.4-1.8a12.8 12.8 0 0 0-2.3-10Z" stroke="currentColor" stroke-width="1.4" opacity=".9"/>
        </svg>
        <strong>Discord</strong>
      </a>
      <button class="pill" id="supportBtn" type="button" title="Suporte (chat)">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M7 18.5c-1.1 0-2-.9-2-2V7.8c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2v8.7c0 1.1-.9 2-2 2H10l-3.2 2.2c-.5.3-1.1 0-1.1-.6V18.5Z" stroke="currentColor" stroke-width="1.4" opacity=".9"/>
          <path d="M8 10h8M8 13h6" stroke="currentColor" stroke-width="1.4" opacity=".9"/>
        </svg>
        <strong>Suporte</strong>
      </button>
      <button class="pill" id="installBtn" type="button" title="Instalar App (PWA)">
        <svg class="icon" viewBox="0 0 24 24" fill="none" aria-hidden="true">
          <path d="M12 3v10m0 0 4-4m-4 4-4-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M5 14.5v4A2.5 2.5 0 0 0 7.5 21h9A2.5 2.5 0 0 0 19 18.5v-4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
        <strong>Instalar</strong>
      </button>
    </div>
  </div>
</header>

<div class="wrap">
  <!-- HERO -->
  <section class="hero" aria-label="ViralVault destaque">
    <div class="heroGrid">
      <div>
        <h2>ViralVault Store</h2>
        <p>
          Loja digital com <b>checkout PIX</b>, <b>Order ID</b> e <b>status oficial</b>.
          Suporte humano: <b>Discord</b>. Suporte rápido no site: assistente automático (grátis).
        </p>

        <div class="heroActions">
          <button class="btn primary" id="goCatalog" type="button">Ver Catálogo</button>
          <button class="btn" id="goCheckout" type="button">Criar Pedido</button>
          <a class="btn ghost" href="https://discord.gg/fWAWquBu" target="_blank" rel="noopener">Suporte Discord</a>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi">
          <div class="t">Status</div>
          <div class="v" id="kpiStatus">Conectando…</div>
        </div>
        <div class="kpi">
          <div class="t">Catálogo</div>
          <div class="v" id="kpiCatalog">—</div>
        </div>
        <div class="kpi">
          <div class="t">Suporte</div>
          <div class="v">Discord-only</div>
        </div>
      </div>
    </div>
  </section>

  <!-- FEATURES -->
  <section class="section" aria-label="Diferenciais">
    <div class="shd">
      <h3>Diferenciais</h3>
      <div class="muted">Interface completa • rápida • direta</div>
    </div>
    <div class="featureGrid">
      <div class="feature">
        <div class="h">Pedido + PIX em 1 clique</div>
        <div class="d">Gera Order ID e PIX copia-e-cola. Depois acompanha no painel oficial do pedido.</div>
      </div>
      <div class="feature">
        <div class="h">Status oficial (anti-fake)</div>
        <div class="d">Validação sempre por Order ID. Nada de depender de print ou conversa.</div>
      </div>
      <div class="feature">
        <div class="h">Suporte rápido e humano</div>
        <div class="d">Assistente automático no site para dúvidas comuns + Discord para atendimento humano.</div>
      </div>
    </div>
  </section>

  <div class="grid" id="mainGrid">
    <!-- LEFT -->
    <section class="card" id="catalogCard">
      <div class="hd">
        <div>
          <h2 class="title">Catálogo</h2>
          <div class="muted">Carregado do seu Worker. (Frontend não mostra URL do backend.)</div>
        </div>
        <span class="tag" id="catalogTag">Carregando…</span>
      </div>
      <div class="body">
        <div class="products" id="products"></div>

        <div class="hr"></div>

        <h2 class="title" style="margin:0 0 8px">Criar pedido (PIX)</h2>
        <div class="muted" style="margin-bottom:10px">Selecione um produto, informe seu usuário e gere o PIX + Order ID.</div>

        <div class="row" style="margin-bottom:10px" id="checkoutRow">
          <div style="flex:1; min-width:220px">
            <label class="mini">Produto</label>
            <select id="productSelect"></select>
          </div>
          <div style="flex:1; min-width:220px">
            <label class="mini">Usuário (Roblox)</label>
            <input id="userInput" placeholder="ex: James" autocomplete="username"/>
          </div>
        </div>

        <div class="row">
          <button class="btn primary" id="createOrderBtn" type="button">Gerar Pedido + PIX</button>
          <button class="btn" id="copyPixBtn" type="button" disabled>Copiar PIX</button>
          <button class="btn ghost" id="openDiscordBtn" type="button">Abrir Discord</button>
        </div>

        <div class="hr"></div>

        <h2 class="title" style="margin:0 0 8px">Pedido (Status Oficial)</h2>
        <div class="row" style="margin-bottom:10px">
          <div style="flex:1; min-width:240px">
            <label class="mini">Order ID</label>
            <input id="orderIdInput" placeholder="vv_..." autocomplete="off"/>
          </div>
          <div style="display:flex; gap:10px; align-items:end">
            <button class="btn" id="checkStatusBtn" type="button">Ver Status</button>
          </div>
        </div>

        <pre id="statusBox" style="margin:0; padding:12px; border-radius:16px; background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.12); color:rgba(242,244,255,.88); overflow:auto; max-height:280px"></pre>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="card">
      <div class="hd">
        <div>
          <h2 class="title">Suporte</h2>
          <div class="muted">Canal oficial: Discord. O chat do site é um assistente automático (grátis).</div>
        </div>
        <span class="tag">Discord-only</span>
      </div>
      <div class="body">
        <div class="row">
          <a class="btn primary" href="https://discord.gg/fWAWquBu" target="_blank" rel="noopener">Entrar no Discord</a>
          <button class="btn" id="supportBtn2" type="button">Abrir Chat</button>
        </div>

        <div class="hr"></div>

        <h2 class="title" style="margin:0 0 8px">Minhas Compras</h2>
        <div class="muted" style="margin-bottom:10px">Busca pelo usuário (rota <code>/my-orders?user=</code>).</div>
        <div class="row" style="margin-bottom:10px">
          <div style="flex:1; min-width:220px">
            <label class="mini">Usuário (Roblox)</label>
            <input id="historyUser" placeholder="ex: James" autocomplete="username"/>
          </div>
          <div style="display:flex; align-items:end">
            <button class="btn" id="loadHistoryBtn" type="button">Buscar</button>
          </div>
        </div>
        <pre id="historyBox" style="margin:0; padding:12px; border-radius:16px; background:rgba(0,0,0,.22); border:1px solid rgba(255,255,255,.12); color:rgba(242,244,255,.88); overflow:auto; max-height:320px"></pre>

        <div class="hr"></div>

        <h2 class="title" style="margin:0 0 8px">FAQ rápido</h2>
        <div class="mini">
          • “Paguei PIX e não atualizou” → aguarde alguns minutos e valide pelo Order ID.<br/>
          • “Como vejo status?” → use a caixa de Order ID.<br/>
          • “Quero humano” → Discord oficial.
        </div>

        <footer>
          <div class="footgrid">
            <div>© <span id="yy"></span> ViralVault.</div>
            <div style="text-align:right">PWA + SEO • versão v2</div>
          </div>
        </footer>
      </div>
    </aside>
  </div>
</div>

<!-- Support Modal -->
<div class="backdrop" id="supportBackdrop" role="dialog" aria-modal="true" aria-label="Suporte ViralVault">
  <div class="modal">
    <div class="mhd">
      <div>
        <div class="title" style="margin:0">Suporte (Assistente)</div>
        <div class="muted" style="font-size:12px">Para humano: Discord oficial.</div>
      </div>
      <button class="close" id="supportClose" type="button" aria-label="Fechar">✕</button>
    </div>
    <div class="chat" id="chatLog"></div>
    <div class="composer">
      <input id="chatInput" placeholder="Ex: paguei pix e não atualizou" autocomplete="off"/>
      <button class="btn primary" id="chatSend" type="button">Enviar</button>
    </div>
    <div class="hint" id="chatHint"></div>
  </div>
</div>

<script>
(() => {
  const API_BASE = "https://viralvault-sign.darlanana06.workers.dev";
  const DISCORD = "https://discord.gg/fWAWquBu";

  const $ = (id) => document.getElementById(id);
  $("yy").textContent = new Date().getFullYear();

  // ---------- PWA manifest (injetado seguro) ----------
  const manifest = {
    name: "ViralVault Store",
    short_name: "ViralVault",
    start_url: "/",
    display: "standalone",
    background_color: "#07080c",
    theme_color: "#0b0b0f",
    icons: [
      { src: "data:image/svg+xml;utf8," + encodeURIComponent(
        "<svg xmlns='http://www.w3.org/2000/svg' width='512' height='512'><defs><radialGradient id='rg' cx='30%25' cy='30%25' r='70%25'><stop offset='0%25' stop-color='%23ffd11a'/><stop offset='55%25' stop-color='%23ff3b30'/><stop offset='100%25' stop-color='%2307080c'/></radialGradient></defs><rect width='512' height='512' rx='128' fill='%2307080c'/><rect x='56' y='56' width='400' height='400' rx='120' fill='url(%23rg)' opacity='.95'/><text x='256' y='308' font-size='148' font-family='Arial' text-anchor='middle' fill='%23f2f4ff'>V</text></svg>"
      ), sizes: "512x512", type: "image/svg+xml" }
    ]
  };
  const manifestUrl = URL.createObjectURL(new Blob([JSON.stringify(manifest)], {type:"application/manifest+json"}));
  const link = document.createElement("link");
  link.rel = "manifest";
  link.href = manifestUrl;
  document.head.appendChild(link);

  // Install prompt button
  let deferredPrompt = null;
  const installBtn = $("installBtn");
  installBtn.style.display = "none";
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    deferredPrompt = e;
    installBtn.style.display = "inline-flex";
  });
  installBtn.addEventListener("click", async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    try { await deferredPrompt.userChoice; } catch {}
    deferredPrompt = null;
    installBtn.style.display = "none";
  });

  // Service Worker (blob) p/ offline cache simples
  async function registerSW(){
    try{
      const swCode = `
        const CACHE='vv-pwa-v2';
        const ASSETS=['/'];
        self.addEventListener('install', e=>{
          e.waitUntil(caches.open(CACHE).then(c=>c.addAll(ASSETS)).then(()=>self.skipWaiting()));
        });
        self.addEventListener('activate', e=>{
          e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k!==CACHE?caches.delete(k):null))).then(()=>self.clients.claim()));
        });
        self.addEventListener('fetch', e=>{
          const req=e.request;
          if(req.method!=='GET') return;
          e.respondWith(
            caches.match(req).then(cached=>cached || fetch(req).then(res=>{
              const copy=res.clone();
              caches.open(CACHE).then(c=>c.put(req,copy)).catch(()=>{});
              return res;
            }).catch(()=>cached || new Response('Offline',{status:200,headers:{'content-type':'text/plain'}})))
          );
        });
      `;
      const blob = new Blob([swCode], { type:'text/javascript' });
      const swUrl = URL.createObjectURL(blob);
      if('serviceWorker' in navigator){
        await navigator.serviceWorker.register(swUrl, { scope:'/' });
      }
    }catch(e){}
  }

  // ---------- Helpers ----------
  const esc = (s) => String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  const pretty = (obj) => JSON.stringify(obj, null, 2);

  async function api(path, opts = {}) {
    const r = await fetch(API_BASE + path, {
      ...opts,
      headers: { "Content-Type": "application/json", ...(opts.headers || {}) }
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) throw new Error(data?.error || ("HTTP " + r.status));
    return data;
  }

  // hero nav
  $("goCatalog").addEventListener("click", () => $("catalogCard").scrollIntoView({behavior:"smooth"}));
  $("goCheckout").addEventListener("click", () => $("checkoutRow").scrollIntoView({behavior:"smooth"}));

  // ---------- Catalog ----------
  let products = [];
  async function loadCatalog() {
    try {
      $("catalogTag").textContent = "Carregando…";
      const data = await api("/catalog", { method: "GET", headers: {} });
      products = Array.isArray(data?.products) ? data.products : [];
      $("catalogTag").textContent = products.length ? (products.length + " itens") : "Vazio";
      $("kpiCatalog").textContent = products.length ? (products.length + " produtos") : "Sem produtos";

      const select = $("productSelect");
      select.innerHTML = "";
      for (const p of products) {
        const opt = document.createElement("option");
        opt.value = p.id;
        opt.textContent = `${p.name} — R$ ${Number(p.price).toFixed(2)}`;
        select.appendChild(opt);
      }

      const list = $("products");
      list.innerHTML = products.map(p => `
        <div class="prod">
          <div class="badges">
            <span class="badge y">Categoria</span>
            ${p.badge ? `<span class="badge r">${esc(p.badge)}</span>` : `<span class="badge g">Oficial</span>`}
          </div>
          <h3>${esc(p.name)}</h3>
          <div class="mini">${esc(p.description || "Produto digital • entrega conforme pedido")}</div>
          <div class="row" style="justify-content:space-between; align-items:center; margin-top:6px">
            <div class="price">R$ ${Number(p.price).toFixed(2)}</div>
            <button class="btn" type="button" data-pid="${esc(p.id)}">Selecionar</button>
          </div>
        </div>
      `).join("");

      list.addEventListener("click", (e) => {
        const b = e.target.closest("button[data-pid]");
        if (!b) return;
        $("productSelect").value = b.getAttribute("data-pid");
        $("checkoutRow").scrollIntoView({behavior:"smooth"});
      }, { passive: true });

      $("kpiStatus").textContent = "Online ✅";
    } catch (e) {
      $("catalogTag").textContent = "Erro";
      $("kpiStatus").textContent = "Erro ⚠️";
      $("products").innerHTML = `<div class="muted">Falha ao carregar catálogo. Verifique o Worker.</div>`;
    }
  }

  // ---------- Create order ----------
  let lastPix = "";
  function toast(msg){ $("statusBox").textContent = msg; }

  $("createOrderBtn").addEventListener("click", async () => {
    $("copyPixBtn").disabled = true;
    lastPix = "";
    toast("Gerando pedido…");
    try {
      const productId = $("productSelect").value;
      const user = $("userInput").value.trim();
      if (!productId) throw new Error("Selecione um produto.");
      if (!user) throw new Error("Informe seu usuário (Roblox).");

      const data = await api("/create-order", {
        method: "POST",
        body: JSON.stringify({ productId, user })
      });

      const orderId = data?.orderId || data?.order?.orderId;
      const pix = String(data?.pixCopiaECola || "").trim();
      lastPix = pix;

      if (orderId) $("orderIdInput").value = orderId;

      toast(pretty({
        ok: true,
        orderId,
        order: data?.order || null,
        pixCopiaECola: pix ? "(disponível — use Copiar PIX)" : "(não configurado no Worker)"
      }));

      $("copyPixBtn").disabled = !pix;

    } catch (e) {
      toast("Erro: " + e.message);
    }
  });

  $("copyPixBtn").addEventListener("click", async () => {
    if (!lastPix) return;
    try {
      await navigator.clipboard.writeText(lastPix);
      toast("PIX copiado ✅ Cole no seu app do banco.");
    } catch {
      const ta = document.createElement("textarea");
      ta.value = lastPix;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      toast("PIX copiado ✅ (modo compatibilidade)");
    }
  });

  // ---------- Order status ----------
  $("checkStatusBtn").addEventListener("click", async () => {
    toast("Consultando status…");
    try {
      const orderId = $("orderIdInput").value.trim();
      if (!orderId) throw new Error("Informe o Order ID.");
      const data = await api("/order-status?orderId=" + encodeURIComponent(orderId), { method: "GET", headers: {} });
      toast(pretty(data));
    } catch (e) {
      toast("Erro: " + e.message);
    }
  });

  // ---------- History (my-orders) ----------
  $("loadHistoryBtn").addEventListener("click", async () => {
    $("historyBox").textContent = "Buscando…";
    try {
      const user = $("historyUser").value.trim();
      if (!user) throw new Error("Informe o usuário (Roblox).");
      const data = await api("/my-orders?user=" + encodeURIComponent(user), { method: "GET", headers: {} });
      $("historyBox").textContent = pretty(data);
    } catch (e) {
      $("historyBox").textContent = "Erro: " + e.message;
    }
  });

  // ---------- Discord ----------
  $("openDiscordBtn").addEventListener("click", () => window.open(DISCORD, "_blank", "noopener,noreferrer"));

  // ---------- Support (free AI) ----------
  const backdrop = $("supportBackdrop");
  const chatLog = $("chatLog");
  const chatInput = $("chatInput");
  const chatHint = $("chatHint");

  function addMsg(who, text){
    const div = document.createElement("div");
    div.className = "msg " + (who === "you" ? "you" : "bot");
    div.innerHTML = `<div class="who">${who === "you" ? "Você" : "Suporte"}</div><div style="white-space:pre-wrap;line-height:1.35">${esc(text)}</div>`;
    chatLog.appendChild(div);
    chatLog.scrollTop = chatLog.scrollHeight;
  }

  function openSupport(){
    backdrop.style.display = "block";
    if (chatLog.childElementCount === 0){
      addMsg("bot", "Olá! Me diga sua dúvida em 1 frase. Ex: “paguei pix e não atualizou”.");
      addMsg("bot", "Para humano: Discord oficial.");
    }
    setTimeout(() => chatInput.focus(), 50);
  }
  function closeSupport(){ backdrop.style.display = "none"; chatHint.textContent = ""; }

  $("supportBtn").addEventListener("click", openSupport);
  $("supportBtn2").addEventListener("click", openSupport);
  $("supportClose").addEventListener("click", closeSupport);
  backdrop.addEventListener("click", (e) => { if (e.target === backdrop) closeSupport(); });
  document.addEventListener("keydown", (e) => { if (e.key === "Escape") closeSupport(); });

  async function sendSupport(){
    const msg = chatInput.value.trim();
    if (!msg) return;
    chatInput.value = "";
    addMsg("you", msg);
    chatHint.textContent = "Digitando…";
    try {
      const r = await fetch(API_BASE + "/support", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ message: msg })
      });
      const data = await r.json().catch(() => ({}));
      if (!r.ok || !data?.ok) {
        chatHint.textContent = "";
        addMsg("bot", (data && data.error) ? data.error : "Falha. Tente novamente ou use o Discord.");
        return;
      }
      chatHint.textContent = "";
      addMsg("bot", data.answer || "Ok.");
    } catch {
      chatHint.textContent = "";
      addMsg("bot", "Sem conexão. Use o Discord: " + DISCORD);
    }
  }

  $("chatSend").addEventListener("click", sendSupport);
  chatInput.addEventListener("keydown", (e) => { if (e.key === "Enter") sendSupport(); });

  // init
  registerSW();
  loadCatalog();
})();
</script>
</body>
</html>
