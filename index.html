<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ViralVault Store</title>
  <meta name="description" content="ViralVault Store ‚Äî compra r√°pida e segura. Pagamento via PIX e entrega digital." />
  <style>
    :root{
      --bg:#0b0b12;
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.72);
      --accent:#ff4d7d;
      --accent2:#ff87a6;
      --ok:#22c55e;
      --bad:#ef4444;
      --shadow:0 18px 50px rgba(0,0,0,.35);
      --max:1120px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;width:100%;max-width:100%;overflow-x:hidden;
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(255,77,125,.22), transparent 55%),
        radial-gradient(900px 600px at 85% 20%, rgba(255,135,166,.15), transparent 55%),
        radial-gradient(900px 700px at 50% 120%, rgba(255,77,125,.12), transparent 60%),
        var(--bg);
      color:var(--text);
    }
    a{color:inherit}
    button,input,textarea{font:inherit}

    header{
      position:sticky;top:0;z-index:10;
      display:flex;align-items:center;gap:12px;
      padding:12px 14px;
      background:rgba(10,10,18,.70);
      backdrop-filter:blur(14px);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    .brand{display:flex;align-items:center;gap:10px;font-weight:1000;letter-spacing:.3px}
    .logo{width:14px;height:14px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent2));
      box-shadow:0 0 0 6px rgba(255,77,125,.18);
    }
    .spacer{margin-left:auto}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:10px 12px;border-radius:999px;border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:var(--muted);
      font-weight:900;font-size:13px;white-space:nowrap;
    }
    main{max-width:var(--max);margin:0 auto;padding:18px}
    .hero{
      border:1px solid rgba(255,255,255,.10);
      border-radius:26px;
      background:rgba(255,255,255,.05);
      box-shadow:var(--shadow);
      padding:20px;
      overflow:hidden;
      position:relative;
    }
    .hero::before{
      content:"";
      position:absolute;inset:-2px;
      background:
        radial-gradient(900px 300px at 10% 0%, rgba(255,77,125,.22), transparent 60%),
        radial-gradient(700px 260px at 100% 20%, rgba(255,135,166,.14), transparent 55%);
      pointer-events:none;
    }
    .hero > *{position:relative}
    h1{margin:10px 0 8px 0;font-size:34px;line-height:1.05;letter-spacing:-.6px}
    .sub{margin:0;color:var(--muted);font-weight:800;line-height:1.55}
    .grid{margin-top:16px;display:grid;grid-template-columns:repeat(3,1fr);gap:14px}
    .card{
      border-radius:22px;
      background:rgba(255,255,255,.05);
      border:1px solid rgba(255,255,255,.10);
      box-shadow:0 16px 45px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .cardInner{padding:16px}
    .tag{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:999px;
      font-size:12px;font-weight:1000;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);
      width:fit-content;margin-bottom:10px}
    .title{font-weight:1000;font-size:18px;margin:2px 0 8px 0}
    .desc{margin:0 0 12px 0;color:var(--muted);font-weight:800;font-size:14px;line-height:1.45}
    .row{display:flex;align-items:flex-end;justify-content:space-between;gap:10px}
    .price{font-size:22px;font-weight:1000}
    .btn{
      padding:12px 14px;border-radius:14px;border:none;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      color:white;font-weight:1000;font-size:14px;cursor:pointer;
      box-shadow:0 14px 30px rgba(255,77,125,.18);
    }
    .btn:active{transform:translateY(1px) scale(.99)}
    .btnGhost{
      background:rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      box-shadow:none;
    }

    /* Modal checkout */
    .modalWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;padding:16px;z-index:50;
      background:rgba(0,0,0,.60)}
    .modal{width:min(560px,100%);border-radius:26px;border:1px solid rgba(255,255,255,.12);
      background:rgba(14,14,24,.96);box-shadow:0 20px 60px rgba(0,0,0,.55);overflow:hidden}
    .modalTop{display:flex;align-items:center;justify-content:space-between;padding:14px;border-bottom:1px solid rgba(255,255,255,.10)}
    .modalTop b{font-size:18px}
    .xBtn{width:46px;height:46px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);
      color:var(--text);cursor:pointer;font-size:18px;font-weight:1000}
    .modalBody{padding:14px}
    .box{border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);padding:12px;margin:12px 0}
    label{display:block;font-weight:1000;color:rgba(255,255,255,.82);margin-bottom:6px}
    input,textarea{
      width:100%;padding:14px;border-radius:16px;border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.20);color:var(--text);outline:none;font-weight:900
    }
    textarea{min-height:92px;resize:vertical}
    .help{color:var(--muted);font-weight:900;font-size:13px;margin-top:6px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .status{margin-top:12px;padding:12px;border-radius:16px;border:1px dashed rgba(255,255,255,.16);
      background:rgba(0,0,0,.20);color:var(--muted);font-weight:1000;min-height:46px;display:flex;align-items:center}
    .status.ok{border-color:rgba(34,197,94,.25);background:rgba(34,197,94,.10);color:rgba(255,255,255,.92)}
    .status.bad{border-color:rgba(239,68,68,.28);background:rgba(239,68,68,.10);color:rgba(255,255,255,.92)}
    .qrWrap{display:grid;grid-template-columns: 1fr;gap: 10px;margin-top: 12px;}
    .qrCard{border-radius:18px;border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);
      padding:12px;display:flex;align-items:center;justify-content:center;}
    .qrCard img{width:230px;height:230px;border-radius:16px;background:white;padding:10px;}

    @media (max-width:900px){
      .grid{grid-template-columns:1fr}
      h1{font-size:30px}
    }
  </style>
</head>
<body>
  <header>
    <div class="brand"><div class="logo"></div><span>ViralVault Store</span></div>
    <div class="spacer"></div>
    <div class="pill">PIX ‚Ä¢ simples ‚Ä¢ entrega digital</div>
  </header>

  <main>
    <section class="hero">
      <div class="pill">üõ°Ô∏è Loja digital ‚Ä¢ pagamentos via PIX</div>
      <h1>Compre r√°pido e receba com seguran√ßa ‚ú®</h1>
      <p class="sub">Escolha um produto, informe seu user do Roblox e gere o PIX. Depois √© s√≥ pagar e aguardar.</p>
    </section>

    <section style="margin-top:16px">
      <div class="grid" id="productsGrid"></div>
    </section>
  </main>

  <!-- Modal -->
  <div class="modalWrap" id="modalWrap" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalTop">
        <b>Checkout (PIX) ‚Äî simples</b>
        <button class="xBtn" id="closeModal">‚úï</button>
      </div>
      <div class="modalBody">
        <div class="box">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div>
              <div style="color:var(--muted);font-weight:1000;font-size:13px">Produto</div>
              <div id="ckProdName" style="font-weight:1000;font-size:18px;margin-top:4px"></div>
            </div>
            <div style="text-align:right">
              <div style="color:var(--muted);font-weight:1000;font-size:13px">Pre√ßo</div>
              <div id="ckProdPrice" style="font-weight:1000;font-size:20px;margin-top:4px"></div>
            </div>
          </div>
        </div>

        <div class="box">
          <label for="robloxUser">Seu usu√°rio do Roblox</label>
          <input id="robloxUser" placeholder="@user_1234" autocomplete="off" />
          <div class="help">Sem usu√°rio, n√£o d√° pra entregar. üòâ</div>
        </div>

        <button class="btn" style="width:100%;padding:16px;border-radius:18px;font-size:16px" id="btnCreateOrder">
          Gerar pedido + PIX
        </button>

        <div class="box" id="orderBox" style="display:none">
          <div style="display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap">
            <div>
              <div style="color:var(--muted);font-weight:1000;font-size:13px">ID do pedido</div>
              <div id="orderId" style="font-weight:1000;font-size:18px;margin-top:4px"></div>
            </div>
          </div>

          <div style="margin-top:12px">
            <label for="pixPayload">PIX copia e cola</label>
            <textarea id="pixPayload" readonly></textarea>
          </div>

          <div class="qrWrap">
            <div class="qrCard" id="qrCard" style="display:none">
              <img id="pixQr" alt="QR Code PIX" />
            </div>
          </div>

          <div class="actions">
            <button class="btn btnGhost" id="btnCopyPix">Copiar PIX</button>
            <button class="btn btnGhost" id="btnCopyId">Copiar ID</button>
            <a class="btn btnGhost" id="btnSupport" href="#" target="_blank" rel="noopener">Falar com suporte</a>
          </div>

          <div class="status ok">Pedido criado ‚úÖ Pague via PIX e aguarde a entrega.</div>
        </div>

        <div class="status" id="statusBox">Pronto pra gerar seu pedido.</div>
      </div>
    </div>
  </div>

  <script>
    // ===== CONFIG =====
    const WORKER_BASE = "https://viralvault-sign.darlanana06.workers.dev";
    const ENDPOINTS = { catalog: "/catalog", createOrder: "/create-order" };
    const WHATSAPP_LINK = "https://wa.me/55XXXXXXXXXXX?text=Oi!%20Preciso%20de%20suporte%20no%20pedido%20";

    const fmtBRL = (v) => {
      try { return new Intl.NumberFormat("pt-BR", { style:"currency", currency:"BRL"}).format(v); }
      catch(e){ return "R$ " + (Number(v||0).toFixed(2)).replace(".", ","); }
    };
    const qs = (id) => document.getElementById(id);
    const setStatus = (msg, kind="") => {
      const el = qs("statusBox");
      el.textContent = msg;
      el.className = "status" + (kind ? " " + kind : "");
    };

    function setPixQrFromPayload(payload){
      // QR generator without key
      const url = "https://api.qrserver.com/v1/create-qr-code/?size=320x320&data=" + encodeURIComponent(payload);
      const img = qs("pixQr");
      img.src = url;
      qs("qrCard").style.display = "flex";
    }

    async function loadCatalog(){
      const grid = qs("productsGrid");
      grid.innerHTML = "";
      try{
        const res = await fetch(WORKER_BASE + ENDPOINTS.catalog, { method:"GET" });
        const data = await res.json();
        if(!data || data.ok !== true || !Array.isArray(data.products)) throw new Error(data?.error || "Cat√°logo inv√°lido");
        data.products.forEach(p => {
          const card = document.createElement("div");
          card.className = "card";
          card.innerHTML = `
            <div class="cardInner">
              <div class="tag">üíé Digital</div>
              <div class="title">${escapeHtml(p.name || p.id)}</div>
              <p class="desc">${escapeHtml(p.description || "Entrega digital ap√≥s confirma√ß√£o.")}</p>
              <div class="row">
                <div>
                  <div class="price">${fmtBRL(p.price || 0)}</div>
                  <div style="color:var(--muted);font-weight:1000;font-size:12px">Pagamento via PIX</div>
                </div>
                <button class="btn" data-buy="1">Comprar</button>
              </div>
            </div>`;
          card.querySelector("[data-buy]").addEventListener("click", () => openCheckout(p));
          grid.appendChild(card);
        });
      }catch(err){
        grid.innerHTML = `
          <div class="card"><div class="cardInner">
            <div class="title">Erro ao carregar cat√°logo</div>
            <p class="desc">${escapeHtml(String(err.message || err))}</p>
            <div class="help">Confira se <b>/catalog</b> est√° no Worker e se WORKER_BASE est√° correto.</div>
          </div></div>`;
      }
    }

    function escapeHtml(str){
      return String(str ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
      }[m]));
    }

    let selectedProduct = null;

    function openCheckout(prod){
      selectedProduct = prod;
      qs("ckProdName").textContent = prod.name || prod.id || "Produto";
      qs("ckProdPrice").textContent = fmtBRL(prod.price || 0);
      qs("robloxUser").value = "";
      qs("orderBox").style.display = "none";
      qs("pixPayload").value = "";
      qs("orderId").textContent = "";
      qs("qrCard").style.display = "none";
      setStatus("Preencha seu user e gere o pedido.", "");
      qs("modalWrap").style.display = "flex";
      qs("modalWrap").setAttribute("aria-hidden", "false");
    }

    function closeCheckout(){
      qs("modalWrap").style.display = "none";
      qs("modalWrap").setAttribute("aria-hidden", "true");
    }

    qs("closeModal").addEventListener("click", closeCheckout);
    qs("modalWrap").addEventListener("click", (e) => { if(e.target === qs("modalWrap")) closeCheckout(); });

    async function createOrder(){
      if(!selectedProduct) return;
      const robloxUser = (qs("robloxUser").value || "").trim();
      if(!robloxUser){
        setStatus("Preencha seu usu√°rio do Roblox antes de comprar.", "bad");
        return;
      }

      const payload = {
        productId: selectedProduct.id || selectedProduct.productId || selectedProduct.slug || selectedProduct.name,
        robloxUser
      };

      setStatus("Gerando pedido + PIX...", "");

      try{
        const res = await fetch(WORKER_BASE + ENDPOINTS.createOrder, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const data = await res.json().catch(() => ({}));

        if(!res.ok || data?.ok !== true){
          throw new Error(data?.error || "Falha ao criar pedido");
        }

        const pix =
          data.pix_copia_cola ||
          data.pixCopiaECola ||
          data.pix ||
          data.pix_copy_paste ||
          data.pixPayload ||
          data.qrcode ||
          data.brcode ||
          data.payload ||
          "";

        const orderId = data.orderId || data.order_id || data.id || "";

        if(!pix) throw new Error("Resposta sem PIX copia e cola.");

        qs("orderId").textContent = orderId || "‚Äî";
        qs("pixPayload").value = pix;
        qs("orderBox").style.display = "block";

        setPixQrFromPayload(pix);

        qs("btnSupport").href = WHATSAPP_LINK + encodeURIComponent(orderId || "");

        setStatus("Pedido criado ‚úÖ Agora pague via PIX.", "ok");
      }catch(err){
        setStatus("N√£o consegui gerar pedido + PIX. Motivo: " + (err.message || err), "bad");
      }
    }

    qs("btnCreateOrder").addEventListener("click", createOrder);

    qs("btnCopyPix").addEventListener("click", async () => {
      const v = qs("pixPayload").value || "";
      if(!v) return setStatus("PIX vazio.", "bad");
      try{ await navigator.clipboard.writeText(v); setStatus("PIX copiado ‚úÖ", "ok"); }
      catch(e){ setStatus("N√£o consegui copiar (seu navegador bloqueou).", "bad"); }
    });

    qs("btnCopyId").addEventListener("click", async () => {
      const v = qs("orderId").textContent || "";
      if(!v || v === "‚Äî") return setStatus("ID vazio.", "bad");
      try{ await navigator.clipboard.writeText(v); setStatus("ID copiado ‚úÖ", "ok"); }
      catch(e){ setStatus("N√£o consegui copiar (seu navegador bloqueou).", "bad"); }
    });

    loadCatalog();
  </script>
</body>
</html>
