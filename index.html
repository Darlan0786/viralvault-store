<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ViralVault Store</title>
  <meta name="description" content="ViralVault Store ‚Äî compra simples via PIX. Pague e aguarde a entrega." />
  <style>
    :root{ --bg:#0b0b12; --card:#ffffff; --muted:#667085; --text:#101828; --pink:#ff3d87; --pink2:#ff6aa2; --line:#eaeaea; }
    *{ box-sizing:border-box; }
    body{ margin:0; font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial; background: radial-gradient(1200px 600px at 50% 0%, rgba(255,61,135,.16), transparent 55%), #f6f6fb; color:var(--text); }
    header{ position:sticky; top:0; z-index:10; background:rgba(246,246,251,.85); backdrop-filter: blur(10px); border-bottom:1px solid rgba(0,0,0,.06); }
    .wrap{ max-width:980px; margin:0 auto; padding:14px 14px; }
    .top{ display:flex; align-items:center; gap:10px; }
    .logo{ width:34px; height:34px; border-radius:12px; background: linear-gradient(135deg,var(--pink),var(--pink2)); box-shadow: 0 12px 30px rgba(255,61,135,.22); }
    h1{ font-size:18px; margin:0; font-weight:900; }
    .pill{ margin-left:auto; font-weight:800; font-size:12px; padding:8px 10px; border-radius:999px; background:#fff; border:1px solid rgba(0,0,0,.06); color:#344054; }
    main{ max-width:980px; margin:0 auto; padding:16px 14px 60px; }
    .hero{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:18px; padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.06); }
    .hero b{ display:block; font-size:16px; }
    .hero p{ margin:6px 0 0; color:var(--muted); font-weight:700; line-height:1.4; }
    .grid{ display:grid; grid-template-columns: repeat(3,1fr); gap:12px; margin-top:14px; }
    @media (max-width:900px){ .grid{ grid-template-columns:1fr; } }
    .card{ background:#fff; border:1px solid rgba(0,0,0,.06); border-radius:18px; padding:14px; box-shadow: 0 10px 30px rgba(0,0,0,.05); }
    .tag{ display:inline-block; font-weight:900; font-size:12px; padding:6px 10px; border-radius:999px; background: rgba(255,61,135,.10); color:#b0124d; border:1px solid rgba(255,61,135,.16); }
    .name{ margin:10px 0 6px; font-weight:1000; font-size:16px; }
    .desc{ margin:0 0 12px; color:var(--muted); font-weight:700; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .price{ font-size:18px; font-weight:1000; }
    .btn{ border:none; cursor:pointer; font-weight:1000; padding:12px 14px; border-radius:14px; background: linear-gradient(90deg,var(--pink),var(--pink2)); color:#fff; box-shadow: 0 12px 25px rgba(255,61,135,.18); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    /* Modal */
    .overlay{ position:fixed; inset:0; display:none; background:rgba(0,0,0,.45); z-index:50; padding:14px; }
    .modal{ max-width:520px; margin:10vh auto 0; background:#fff; border-radius:18px; overflow:hidden; box-shadow: 0 20px 60px rgba(0,0,0,.25); border:1px solid rgba(0,0,0,.06); }
    .mTop{ display:flex; justify-content:space-between; align-items:center; padding:12px 12px; border-bottom:1px solid rgba(0,0,0,.06); }
    .mTop b{ font-size:16px; }
    .x{ width:44px; height:44px; border-radius:14px; border:1px solid rgba(0,0,0,.08); background:#fff; cursor:pointer; font-size:18px; }
    .mBody{ padding:12px; }
    .box{ border:1px solid rgba(0,0,0,.08); border-radius:16px; padding:12px; background:#fafafa; }
    .lbl{ font-weight:900; color:#344054; font-size:12px; }
    .val{ font-weight:1000; font-size:16px; margin-top:2px; }
    .field{ margin-top:10px; }
    input{ width:100%; padding:14px 14px; border-radius:16px; border:1px solid rgba(0,0,0,.10); font-weight:900; font-size:16px; outline:none; }
    input:focus{ border-color: rgba(255,61,135,.45); box-shadow: 0 0 0 4px rgba(255,61,135,.10); }
    .hint{ margin-top:6px; color:var(--muted); font-weight:800; font-size:12px; }
    .bigbtn{ width:100%; margin-top:12px; padding:16px; border-radius:16px; }
    .idBox{ margin-top:12px; display:none; }
    textarea{ width:100%; min-height:88px; resize:none; padding:12px; border-radius:16px; border:1px solid rgba(0,0,0,.10); font-weight:800; }
    .copyRow{ display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .ghost{ background:#fff; color:#101828; border:1px solid rgba(0,0,0,.10); box-shadow:none; }
    .ok{ margin-top:10px; font-weight:900; color:#067647; display:none; }
    .err{ margin-top:10px; font-weight:900; color:#b42318; display:none; white-space:pre-wrap; }
    footer{ margin-top:18px; color:#667085; font-weight:800; font-size:12px; text-align:center; }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="top">
        <div class="logo"></div>
        <h1>ViralVault Store</h1>
        <div class="pill">PIX ‚Ä¢ simples</div>
      </div>
    </div>
  </header>

  <main>
    <div class="hero">
      <b>Escolha um produto ‚Üí pague no PIX ‚Üí pronto.</b>
      <p>Voc√™ s√≥ precisa informar seu usu√°rio do Roblox pra entrega n√£o dar ruim. Depois do pagamento, √© s√≥ aguardar.</p>
    </div>

    <div class="grid" id="grid"></div>

    <footer>
      Suporte: WhatsApp ‚Ä¢ Transpar√™ncia: sem ‚Äúao vivo‚Äù fake.
    </footer>
  </main>

  <!-- Modal Checkout -->
  <div class="overlay" id="overlay">
    <div class="modal">
      <div class="mTop">
        <b>Checkout (PIX) ‚Äî simples</b>
        <button class="x" id="close">‚úï</button>
      </div>
      <div class="mBody">
        <div class="box">
          <div class="lbl">Produto</div>
          <div class="val" id="mProd">‚Äî</div>
          <div style="height:8px"></div>
          <div class="lbl">Pre√ßo</div>
          <div class="val" id="mPrice">‚Äî</div>
        </div>

        <div class="field">
          <div class="lbl">Seu usu√°rio do Roblox</div>
          <input id="user" placeholder="@user_1234" autocomplete="off" />
          <div class="hint">Sem usu√°rio, n√£o d√° pra entregar. üòâ</div>
        </div>

        <button class="btn bigbtn" id="btnCreate" disabled>Gerar pedido + PIX</button>

        <div class="ok" id="okMsg">Pedido criado! Copie o PIX e pague.</div>
        <div class="err" id="errMsg"></div>

        <div class="idBox" id="idBox">
          <div class="box">
            <div class="lbl">ID do pedido</div>
            <div class="val" id="orderId">‚Äî</div>
          </div>

          <div class="field">
            <div class="lbl">PIX copia e cola</div>
            <textarea id="pix" readonly></textarea>

            <div class="copyRow">
              <button class="btn ghost" id="btnCopy">Copiar PIX</button>
              <button class="btn ghost" id="btnStatus">Ver status</button>
            </div>

            <div class="hint" id="statusLine"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

<script>
  const WORKER_BASE = "https://viralvault-sign.darlanana06.workers.dev".replace(/\/+$/,'');
  const grid = document.getElementById('grid');

  const overlay = document.getElementById('overlay');
  const closeBtn = document.getElementById('close');
  const mProd = document.getElementById('mProd');
  const mPrice = document.getElementById('mPrice');
  const userInput = document.getElementById('user');
  const btnCreate = document.getElementById('btnCreate');
  const idBox = document.getElementById('idBox');
  const orderIdEl = document.getElementById('orderId');
  const pixEl = document.getElementById('pix');
  const btnCopy = document.getElementById('btnCopy');
  const btnStatus = document.getElementById('btnStatus');
  const statusLine = document.getElementById('statusLine');
  const okMsg = document.getElementById('okMsg');
  const errMsg = document.getElementById('errMsg');

  let selected = null;

  function brl(v){
    const n = Number(v||0);
    return n.toLocaleString('pt-BR', { style:'currency', currency:'BRL' });
  }

  function showModal(prod){
    selected = prod;
    mProd.textContent = prod.name || prod.id;
    mPrice.textContent = brl(prod.price);
    idBox.style.display = 'none';
    okMsg.style.display = 'none';
    errMsg.style.display = 'none';
    errMsg.textContent = '';
    statusLine.textContent = '';
    pixEl.value = '';
    orderIdEl.textContent = '‚Äî';
    overlay.style.display = 'block';
    validate();
  }

  function hideModal(){ overlay.style.display = 'none'; }

  closeBtn.addEventListener('click', hideModal);
  overlay.addEventListener('click', (e)=>{ if(e.target === overlay) hideModal(); });

  function validate(){
    const u = (userInput.value||'').trim();
    btnCreate.disabled = !selected || u.length < 2;
  }
  userInput.addEventListener('input', validate);

  async function loadCatalog(){
    grid.innerHTML = '<div class="card">Carregando cat√°logo...</div>';
    try {
      const r = await fetch(WORKER_BASE + '/catalog', { method:'GET' });
      const j = await r.json();
      if(!j || !j.ok) throw new Error((j && (j.error||j.message)) || 'Falha no cat√°logo');
      const items = j.products || [];
      if(!items.length){
        grid.innerHTML = '<div class="card">Sem produtos no momento.</div>';
        return;
      }
      grid.innerHTML = '';
      for(const p of items){
        const el = document.createElement('div');
        el.className = 'card';
        const badge = (p.badge||'').trim();
        el.innerHTML = `
          <span class="tag">${badge ? badge : 'Digital'}</span>
          <div class="name">${p.name || p.id}</div>
          <div class="desc">${p.description || 'Entrega digital ap√≥s confirma√ß√£o.'}</div>
          <div class="row">
            <div class="price">${brl(p.price)}</div>
            <button class="btn">Comprar</button>
          </div>
        `;
        el.querySelector('button').addEventListener('click', ()=> showModal(p));
        grid.appendChild(el);
      }
    } catch(err){
      grid.innerHTML = `<div class="card"><div class="name">Erro ao carregar cat√°logo</div><div class="desc">${String(err.message||err)}</div><div class="desc">Confere se existe rota <b>/catalog</b> no Worker e se WORKER_BASE est√° certo.</div></div>`;
    }
  }

  async function createOrder(){
    const u = (userInput.value||'').trim();
    if(!selected) return;
    if(u.length < 2) return;

    btnCreate.disabled = true;
    btnCreate.textContent = 'Gerando...';
    okMsg.style.display = 'none';
    errMsg.style.display = 'none';
    errMsg.textContent = '';

    try {
      const payload = { productId: selected.id, user: u };
      const r = await fetch(WORKER_BASE + '/create-order', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(payload)
      });

      let j = null;
      try { j = await r.json(); } catch(e){}

      if(!r.ok || !j || !j.ok){
        const msg = (j && (j.error || j.message)) || ('HTTP ' + r.status);
        throw new Error(msg);
      }

      const oid = j.orderId || j.id || '';
      const pix = j.pixCopyPaste || (j.pix && (j.pix.copyPaste || j.pix.copiaECola)) || (typeof j.pix === 'string' ? j.pix : '');

      if(!oid) throw new Error('Resposta sem orderId.');
      if(!pix) throw new Error('Resposta sem PIX copia e cola.');

      orderIdEl.textContent = oid;
      pixEl.value = pix;
      idBox.style.display = 'block';
      okMsg.style.display = 'block';
    } catch(err){
      errMsg.style.display = 'block';
      errMsg.textContent =
        'N√£o consegui gerar pedido + PIX.\n' +
        'Motivo: ' + String(err.message||err) + '\n\n' +
        'Se aparecer "Rota n√£o encontrada", seu Worker ainda n√£o tem /create-order.';
    } finally {
      btnCreate.textContent = 'Gerar pedido + PIX';
      validate();
    }
  }

  btnCreate.addEventListener('click', createOrder);

  btnCopy.addEventListener('click', async ()=>{
    try {
      await navigator.clipboard.writeText(pixEl.value || '');
      statusLine.textContent = '‚úÖ PIX copiado!';
      setTimeout(()=> statusLine.textContent = '', 1500);
    } catch(e){
      statusLine.textContent = '‚ö†Ô∏è N√£o deu pra copiar automaticamente. Selecione e copie manualmente.';
    }
  });

  btnStatus.addEventListener('click', async ()=>{
    const oid = (orderIdEl.textContent||'').trim();
    if(!oid || oid === '‚Äî') return;
    statusLine.textContent = 'Consultando status...';
    try {
      const r = await fetch(WORKER_BASE + '/order-status?orderId=' + encodeURIComponent(oid), { method:'GET' });
      const j = await r.json();
      if(!j || !j.ok) throw new Error((j && (j.error||j.message)) || 'Falha no status');
      statusLine.textContent = 'Status: ' + (j.status || 'desconhecido');
    } catch(err){
      statusLine.textContent = 'Erro no status: ' + String(err.message||err);
    }
  });

  loadCatalog();
</script>
</body>
</html>
