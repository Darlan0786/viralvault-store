<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ViralVault Store</title>
  <meta name="description" content="Loja digital ‚Äî checkout simples via PIX, status do pedido e suporte." />
  <style>
    :root{
      --bg:#0b0d10;
      --card:#11151b;
      --card2:#0f1319;
      --line:rgba(255,255,255,.08);
      --text:rgba(255,255,255,.92);
      --muted:rgba(255,255,255,.68);
      --yellow:#f6c945;
      --yellow2:#ffd86a;
      --good:#22c55e;
      --bad:#ef4444;
      --shadow: 0 18px 60px rgba(0,0,0,.55);
      --r:18px;
      --max:1100px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:radial-gradient(900px 600px at 20% 0%, rgba(246,201,69,.10), transparent 60%),
                                 radial-gradient(900px 600px at 80% 10%, rgba(255,216,106,.07), transparent 60%),
                                 var(--bg); color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;
      overflow-x:hidden;
    }
    a{color:inherit}
    .wrap{max-width:var(--max); margin:0 auto; padding:18px;}
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: rgba(11,13,16,.72);
      border-bottom:1px solid var(--line);
    }
    .top{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px;
      max-width:var(--max); margin:0 auto;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:950; letter-spacing:.2px;}
    .mark{width:14px;height:14px;border-radius:999px;background:linear-gradient(135deg,var(--yellow),var(--yellow2));
      box-shadow:0 0 0 6px rgba(246,201,69,.14);
    }
    .actions{display:flex; gap:10px; align-items:center;}
    .btn{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      color:var(--text);
      padding:12px 14px;
      border-radius:14px;
      cursor:pointer;
      font-weight:900;
      transition: transform .12s ease, filter .12s ease, background .12s ease;
      user-select:none;
    }
    .btn:hover{filter:brightness(1.08)}
    .btn:active{transform: translateY(1px) scale(.99)}
    .btnPrimary{
      border:none;
      background: linear-gradient(90deg,var(--yellow),var(--yellow2));
      color:#1a1a1a;
      box-shadow:0 14px 34px rgba(246,201,69,.22);
    }
    .pill{display:none; padding:10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04); color:var(--muted); font-weight:900; font-size:13px;
    }
    @media (max-width: 860px){ .pill{display:flex} }

    .hero{
      margin-top:18px;
      border-radius: 26px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .hero::before{
      content:"";
      position:absolute; inset:-1px;
      background: radial-gradient(800px 260px at 10% 0%, rgba(246,201,69,.18), transparent 60%),
                  radial-gradient(800px 260px at 90% 40%, rgba(255,216,106,.12), transparent 60%);
      pointer-events:none;
    }
    .heroIn{position:relative; padding:22px; display:grid; grid-template-columns:1.2fr .8fr; gap:16px; align-items:center;}
    @media (max-width: 900px){ .heroIn{grid-template-columns:1fr;} }
    h1{margin:10px 0 8px; font-size:40px; letter-spacing:-.7px; line-height:1.05;}
    .sub{margin:0; color:var(--muted); font-weight:800; line-height:1.55}
    .chips{margin-top:14px; display:flex; flex-wrap:wrap; gap:10px;}
    .chip{
      display:flex; gap:10px; align-items:center;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      padding:12px 12px;
      border-radius: 16px;
      color:var(--muted);
      font-weight:900;
      font-size:13px;
    }
    .dot{width:10px;height:10px;border-radius:999px;background:var(--yellow); box-shadow:0 0 0 5px rgba(246,201,69,.12)}
    .card{
      border:1px solid var(--line);
      background: rgba(15,19,25,.65);
      border-radius: 22px;
      box-shadow: 0 14px 50px rgba(0,0,0,.35);
      overflow:hidden;
    }
    .cardIn{padding:16px;}
    .miniTitle{font-weight:950; margin:0 0 6px; letter-spacing:-.2px}
    .miniSub{margin:0; color:var(--muted); font-weight:850; font-size:13px; line-height:1.5}
    .searchRow{margin-top:12px; display:flex; gap:10px; flex-wrap:wrap}
    .input{
      flex:1 1 240px;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color:var(--text);
      outline:none;
      font-weight:900;
    }
    .grid{margin-top:16px; display:grid; grid-template-columns: repeat(3, 1fr); gap:14px;}
    @media (max-width: 980px){ .grid{grid-template-columns:1fr;} }

    .prod{
      position:relative;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 22px;
      overflow:hidden;
    }
    .prod::before{
      content:"";
      position:absolute; inset:0;
      background: radial-gradient(420px 220px at 20% 0%, rgba(246,201,69,.13), transparent 60%);
      pointer-events:none;
    }
    .prodIn{position:relative; padding:16px;}
    .tag{display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03);
      font-weight:950; font-size:12px; color:rgba(255,255,255,.82);
      margin-bottom:10px;
    }
    .pName{margin:2px 0 6px; font-size:18px; font-weight:1000; letter-spacing:-.2px}
    .pDesc{margin:0 0 12px; color:var(--muted); font-weight:850; font-size:14px; line-height:1.45}
    .row{display:flex; align-items:flex-end; justify-content:space-between; gap:10px;}
    .price{font-weight:1100; font-size:20px}
    .small{color:var(--muted); font-weight:900; font-size:12px}
    .btnSmall{padding:12px 14px; border-radius:14px; font-size:14px}

    /* Modal checkout */
    .overlay{position:fixed; inset:0; background: rgba(0,0,0,.62); display:none; align-items:center; justify-content:center; padding:16px; z-index:100;}
    .modal{width:min(560px,100%); border-radius:26px; border:1px solid rgba(255,255,255,.12); background: rgba(12,14,18,.96);
      box-shadow: 0 24px 80px rgba(0,0,0,.60); overflow:hidden;
    }
    .mTop{display:flex; align-items:center; justify-content:space-between; padding:14px 14px; border-bottom:1px solid var(--line)}
    .mTitle{font-weight:1000}
    .x{width:46px;height:46px;border-radius:14px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);cursor:pointer;font-weight:1000}
    .mBody{padding:14px}
    .warn{
      margin-top:10px;
      padding:12px 12px;
      border-radius:16px;
      border:1px dashed rgba(246,201,69,.35);
      background: rgba(246,201,69,.08);
      color: rgba(255,255,255,.86);
      font-weight:900;
      font-size:13px;
      line-height:1.45;
    }
    .pixBox{
      margin-top:10px;
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      display:none;
      gap:10px;
    }
    .pixArea{display:grid; gap:8px;}
    textarea{
      width:100%;
      min-height:96px;
      resize:none;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color:var(--text);
      padding:12px;
      font-weight:900;
      outline:none;
    }
    .copyRow{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .hint{margin-top:10px; color:var(--muted); font-weight:850; font-size:13px; line-height:1.55}
    .ok{color:rgba(255,255,255,.92); border-left:4px solid rgba(34,197,94,.55); padding-left:10px;}
    .bad{color:rgba(255,255,255,.92); border-left:4px solid rgba(239,68,68,.55); padding-left:10px;}
    .kvs{display:grid; gap:6px; margin-top:10px; font-weight:900; color:var(--muted); font-size:13px}
    .kvs b{color:rgba(255,255,255,.92)}
    .qrWrap{display:none; margin-top:10px; border-radius:18px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.02); padding:12px}
    .qrRow{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .qrRow b{font-weight:1000}
    .qrImg{margin-top:10px; width:100%; border-radius:16px; border:1px solid rgba(255,255,255,.10); background:#fff; overflow:hidden}
    .qrImg img{width:100%; display:block}

    /* Timeline */
    .timeline{
      margin-top:12px;
      display:grid; gap:10px;
    }
    .step{
      display:flex; gap:10px; align-items:flex-start;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.02);
      padding:12px 12px;
      border-radius:18px;
    }
    .sIcon{
      width:36px;height:36px;border-radius:14px;
      display:flex;align-items:center;justify-content:center;
      background: rgba(246,201,69,.12);
      border:1px solid rgba(246,201,69,.22);
      color: rgba(255,255,255,.92);
      font-weight:1100;
      flex:0 0 auto;
    }
    .sText b{display:block; font-weight:1000}
    .sText small{display:block; color:var(--muted); font-weight:850; line-height:1.45}
    .done .sIcon{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.25)}
    .done .sIcon::after{content:"‚úì";}
    .wait .sIcon::after{content:"‚Ä¶";}
    .paid .sIcon{background: rgba(246,201,69,.14); border-color: rgba(246,201,69,.28)}
    .paid .sIcon::after{content:"$";}
    .deliv .sIcon{background: rgba(34,197,94,.12); border-color: rgba(34,197,94,.25)}
    .deliv .sIcon::after{content:"üì©";}

    footer{margin:26px 0 34px; text-align:center; color:rgba(255,255,255,.52); font-weight:900}
    .footLinks{margin-top:10px; display:flex; justify-content:center; gap:10px; flex-wrap:wrap}
    .footLinks a{padding:10px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.03); text-decoration:none; color:rgba(255,255,255,.76)}
  </style>
</head>
<body>
<header>
  <div class="top">
    <div class="brand"><span class="mark"></span><span>ViralVault Store</span></div>
    <div class="actions">
      <div class="pill">‚ö° Compra r√°pida</div>
      <button class="btn" id="btnOpenOrder">Ver pedido</button>
      <button class="btn btnPrimary" id="btnSupport">Suporte</button>
    </div>
  </div>
</header>

<div class="wrap">
  <section class="hero">
    <div class="heroIn">
      <div>
        <div class="chip"><span class="dot"></span> Loja digital ‚Ä¢ PIX ‚Ä¢ Entrega em at√© 24h</div>
        <h1>Compra simples. <br/>Acompanhe seu pedido sozinho.</h1>
        <p class="sub">Escolha o item, informe seu <b>@user</b> e pague via PIX. Voc√™ recebe um <b>link do pedido</b> para acompanhar o status (Pago / Entregue).</p>
        <div class="chips">
          <div class="chip">üîê Verifica√ß√£o no servidor</div>
          <div class="chip">üßæ ID do pedido para suporte</div>
          <div class="chip">üü° Visual clean</div>
        </div>
      </div>

      <div class="card">
        <div class="cardIn">
          <p class="miniTitle">Buscar produto</p>
          <p class="miniSub">Filtre r√°pido pelo nome do item.</p>
          <div class="searchRow">
            <input class="input" id="search" placeholder="Ex: brainrot, item, bundle..." />
            <button class="btn btnPrimary" id="reload">Atualizar</button>
          </div>
          <p class="hint">Dica: se o cat√°logo n√£o carregar, confirme seu Worker (rota <b>/catalog</b>).</p>
        </div>
      </div>
    </div>
  </section>

  <div class="grid" id="grid"></div>

  <footer>
    <div>‚ö†Ô∏è Anti-golpe: confira o dom√≠nio e o ID do pedido.</div>
    <div class="footLinks">
      <a href="#" id="openOrderFooter">Acompanhar pedido</a>
      <a href="#" id="openSupportFooter">Falar no WhatsApp</a>
    </div>
  </footer>
</div>

<!-- Checkout Modal -->
<div class="overlay" id="ov">
  <div class="modal" role="dialog" aria-modal="true">
    <div class="mTop">
      <div class="mTitle" id="mTitle">Checkout</div>
      <button class="x" id="xBtn">‚úï</button>
    </div>
    <div class="mBody">
      <div class="kvs" id="kvs"></div>

      <label class="small">Seu user (Roblox)</label>
      <input class="input" id="user" placeholder="@user_1234" />

      <div class="warn">
        ‚úÖ Pague e aguarde. Ap√≥s confirma√ß√£o, sua entrega entra na fila e √© feita em at√© <b>24h</b>.
      </div>

      <div class="timeline" id="timeline" style="display:none;">
        <div class="step done" id="t1"><div class="sIcon"></div><div class="sText"><b>Pedido criado</b><small>Geramos seu ID no servidor.</small></div></div>
        <div class="step wait" id="t2"><div class="sIcon"></div><div class="sText"><b>Aguardando pagamento</b><small>Ap√≥s pagar, a confirma√ß√£o pode levar alguns minutos.</small></div></div>
        <div class="step wait" id="t3"><div class="sIcon"></div><div class="sText"><b>Entrega</b><small>Ap√≥s ‚ÄúPago‚Äù, entregamos em at√© 24h.</small></div></div>
      </div>

      <div class="pixBox" id="pixBox">
        <div class="pixArea" style="width:100%">
          <label class="small">PIX copia e cola</label>
          <textarea id="pix" readonly></textarea>

          <div class="copyRow">
            <button class="btn btnPrimary" id="copyPix">Copiar PIX e pagar</button>
            <button class="btn" id="copyId">Copiar ID</button>
            <button class="btn" id="copyLink">Copiar link</button>
          </div>
        </div>
      </div>

      <div class="qrWrap" id="qrWrap">
        <div class="qrRow">
          <b>QR Code</b>
          <span class="small">Abra seu app do banco ‚Üí Ler QR</span>
        </div>
        <div class="qrImg"><img id="qr" alt="QR Code PIX" /></div>
      </div>

      <p class="hint" id="statusText"></p>

      <div class="copyRow" style="margin-top:12px; justify-content:space-between;">
        <button class="btn" id="backBtn" style="display:none;">‚Üê Voltar</button>
        <button class="btn btnPrimary" id="goBtn">Gerar pedido + PIX</button>
      </div>
    </div>
  </div>
</div>

<script>
  // ====== CONFIG ======
  const WORKER_BASE = "https://viralvault-sign.darlanana06.workers.dev";
  const SUPPORT_WA = "5511941598713"; // troque se quiser
  const FALLBACK_PIX = ""; // opcional: coloque seu PIX aqui pra nunca ficar vazio

  // ====== HELPERS ======
  const $ = (id)=>document.getElementById(id);
  const fmt = (n)=> (typeof n==="number" ? n.toFixed(2).replace(".",",") : String(n||""));
  const money = (cents)=> "R$ " + fmt((cents||0)/100);
  const cleanUser = (s)=> (s||"").trim().replace(/\s+/g,"");
  const ensureAt = (s)=> s.startsWith("@") ? s : ("@"+s);

  function toast(el, msg, cls=""){
    el.className = "hint " + cls;
    el.textContent = msg;
  }

  function qrFromPix(pix){
    // Use API p√∫blica de QR apenas para visual (n√£o envia dinheiro)
    // Encode compact
    const encoded = encodeURIComponent(pix);
    return "https://api.qrserver.com/v1/create-qr-code/?size=600x600&data=" + encoded;
  }

  function normalizePixFromResponse(data){
    // tenta v√°rios nomes comuns
    return data?.pixCopyPaste
      || data?.pix_copia_cola
      || data?.pix
      || data?.brcode
      || data?.pixPayload
      || data?.pix_copia_e_cola
      || data?.pixCopiaECola
      || data?.copyPaste
      || data?.payload
      || "";
  }

  function getOrderIdFromUrl(){
    const u = new URL(location.href);
    return u.searchParams.get("orderId") || "";
  }

  function setOrderIdToUrl(orderId){
    const u = new URL(location.href);
    u.searchParams.set("orderId", orderId);
    history.replaceState({}, "", u.toString());
  }

  async function safeFetchJson(url, opts){
    const res = await fetch(url, opts);
    const text = await res.text();
    let json;
    try{ json = JSON.parse(text); }catch(e){ json = { ok:false, error:"Resposta inv√°lida do servidor", raw:text?.slice(0,200) }; }
    if(!res.ok) json = { ...(json||{}), ok:false, http: res.status, statusText: res.statusText };
    return json;
  }

  // ====== CATALOG ======
  let catalog = [];
  let currentProduct = null;
  let polling = null;
  let lastOrderId = "";

  function render(list){
    const grid = $("grid");
    grid.innerHTML = "";
    if(!list.length){
      const d = document.createElement("div");
      d.className = "card";
      d.innerHTML = '<div class="cardIn"><p class="miniTitle">Sem itens</p><p class="miniSub">Seu cat√°logo est√° vazio ou falhou ao carregar.</p></div>';
      grid.appendChild(d);
      return;
    }
    list.forEach(p=>{
      const el = document.createElement("div");
      el.className = "prod";
      el.innerHTML = `
        <div class="prodIn">
          <div class="tag">‚≠ê Premium</div>
          <div class="pName">${escapeHtml(p.name||"Item")}</div>
          <div class="pDesc">${escapeHtml(p.desc||"Produto digital. Entrega em at√© 24h ap√≥s pagamento.")}</div>
          <div class="row">
            <div>
              <div class="price">${money(p.priceCents||p.price||0)}</div>
              <div class="small">PIX ‚Ä¢ Entrega 24h</div>
            </div>
            <button class="btn btnPrimary btnSmall">Comprar</button>
          </div>
        </div>`;
      el.querySelector("button").onclick = ()=> openCheckout(p);
      grid.appendChild(el);
    });
  }

  function escapeHtml(s){
    return String(s||"").replace(/[&<>"']/g, (m)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
  }

  async function loadCatalog(){
    const data = await safeFetchJson(WORKER_BASE + "/catalog", { method:"GET" });
    if(data?.ok && Array.isArray(data.items)){
      catalog = data.items;
    } else if(Array.isArray(data)){
      catalog = data;
    } else if(Array.isArray(data?.catalog)){
      catalog = data.catalog;
    } else {
      catalog = [];
      console.warn("catalog fail:", data);
    }
    applyFilter();
  }

  function applyFilter(){
    const q = ($("search").value||"").toLowerCase().trim();
    const list = !q ? catalog : catalog.filter(p=> (p.name||"").toLowerCase().includes(q) || (p.desc||"").toLowerCase().includes(q));
    render(list);
  }

  // ====== CHECKOUT ======
  function openModal(){
    $("ov").style.display = "flex";
    document.body.style.overflow = "hidden";
  }
  function closeModal(){
    $("ov").style.display = "none";
    document.body.style.overflow = "";
    stopPolling();
  }

  function stopPolling(){
    if(polling){ clearInterval(polling); polling = null; }
  }

  function setTimeline(status){
    $("timeline").style.display = "grid";
    const t2 = $("t2"), t3 = $("t3");
    // reset
    t2.className = "step wait";
    t3.className = "step wait";
    if(status === "pending" || status === "created"){
      t2.className = "step wait";
      t3.className = "step wait";
    } else if(status === "paid"){
      t2.className = "step paid";
      t3.className = "step wait";
    } else if(status === "delivered"){
      t2.className = "step paid";
      t3.className = "step deliv";
    }
  }

  function openCheckout(product){
    currentProduct = product;
    $("mTitle").textContent = "Checkout ‚Ä¢ " + (product?.name || "Item");
    $("kvs").innerHTML = `
      <div><b>Produto:</b> ${escapeHtml(product?.name||"")}</div>
      <div><b>Pre√ßo:</b> ${money(product?.priceCents||product?.price||0)}</div>
      <div><b>Entrega:</b> at√© 24h ap√≥s ‚ÄúPago‚Äù</div>
    `;
    $("pixBox").style.display = "none";
    $("qrWrap").style.display = "none";
    $("pix").value = "";
    $("user").value = "";
    $("goBtn").disabled = false;
    $("goBtn").textContent = "Gerar pedido + PIX";
    $("backBtn").style.display = "none";
    toast($("statusText"), "Preencha seu @user e gere o pedido.", "");
    $("timeline").style.display = "none";
    lastOrderId = "";

    openModal();
  }

  async function createOrder(){
    if(!currentProduct) return;
    const raw = cleanUser($("user").value);
    if(raw.length < 3){
      toast($("statusText"), "Digite seu user do Roblox (ex: @user_1234).", "bad");
      return;
    }
    const u = ensureAt(raw);

    $("goBtn").disabled = true;
    $("goBtn").textContent = "Gerando‚Ä¶";
    toast($("statusText"), "Criando pedido no servidor‚Ä¶", "");

    const body = {
      productId: currentProduct.id || currentProduct.productId || currentProduct.sku || currentProduct.name,
      user: u,
      username: u,
      robloxUser: u
    };

    const data = await safeFetchJson(WORKER_BASE + "/create-order", {
      method:"POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(body)
    });

    if(!data?.ok){
      $("goBtn").disabled = false;
      $("goBtn").textContent = "Gerar pedido + PIX";
      toast($("statusText"), "Erro: " + (data?.error || "n√£o foi poss√≠vel criar o pedido."), "bad");
      return;
    }

    lastOrderId = data.orderId || data.id || data.order_id || "";
    if(!lastOrderId){
      toast($("statusText"), "Pedido criado, mas sem orderId. Verifique o Worker.", "bad");
      $("goBtn").disabled = false;
      $("goBtn").textContent = "Tentar de novo";
      return;
    }

    setOrderIdToUrl(lastOrderId);

    // PIX
    const pix = normalizePixFromResponse(data) || FALLBACK_PIX;
    if(!pix){
      toast($("statusText"), "Pedido criado ‚úÖ Mas sem PIX no retorno. Configure PIX_COPYPASTE no Worker.", "bad");
    } else {
      $("pix").value = pix;
      $("pixBox").style.display = "grid";
      $("qr").src = qrFromPix(pix);
      $("qrWrap").style.display = "block";
      toast($("statusText"), "Pedido criado ‚úÖ Copie o PIX e pague. Depois, aguarde a confirma√ß√£o.", "ok");
    }

    // Timeline + polling
    setTimeline("pending");
    startPolling(lastOrderId);

    $("goBtn").disabled = true;
    $("goBtn").textContent = "Aguardando pagamento‚Ä¶";
    $("backBtn").style.display = "inline-flex";
  }

  async function checkStatus(orderId){
    const url = WORKER_BASE + "/order-status?orderId=" + encodeURIComponent(orderId);
    const data = await safeFetchJson(url, { method:"GET" });
    if(!data?.ok) return null;
    const stRaw = (data.status || data.state || "").toLowerCase();
    if(stRaw.includes("deliver")) return "delivered";
    if(stRaw.includes("entreg")) return "delivered";
    if(stRaw.includes("paid") || stRaw.includes("pago")) return "paid";
    if(stRaw.includes("pend") || stRaw.includes("wait") || stRaw.includes("criad")) return "pending";
    return stRaw || "pending";
  }

  function startPolling(orderId){
    stopPolling();
    polling = setInterval(async ()=>{
      const st = await checkStatus(orderId);
      if(!st) return;
      setTimeline(st);
      if(st === "paid"){
        toast($("statusText"), "Pagamento confirmado ‚úÖ Entrega em at√© 24h.", "ok");
        $("goBtn").textContent = "Pagamento confirmado ‚úÖ";
      }
      if(st === "delivered"){
        toast($("statusText"), "Entregue ‚úÖ Se precisar, chame o suporte com o ID.", "ok");
        $("goBtn").textContent = "Entregue ‚úÖ";
        stopPolling();
      }
    }, 4000);
  }

  // ====== ORDER LOOKUP ======
  async function openOrderLookup(){
    const existing = getOrderIdFromUrl();
    const orderId = prompt("Cole o ID do pedido (vv_...):", existing || "");
    if(!orderId) return;
    lastOrderId = orderId.trim();
    openModal();
    $("mTitle").textContent = "Pedido ‚Ä¢ " + lastOrderId;
    $("kvs").innerHTML = `<div><b>ID:</b> ${escapeHtml(lastOrderId)}</div><div><b>Status:</b> verificando‚Ä¶</div>`;
    $("pixBox").style.display = "none";
    $("qrWrap").style.display = "none";
    $("timeline").style.display = "grid";
    $("goBtn").disabled = true;
    $("goBtn").textContent = "Acompanhando‚Ä¶";
    $("backBtn").style.display = "inline-flex";
    toast($("statusText"), "Acompanhando status no servidor‚Ä¶", "");
    setOrderIdToUrl(lastOrderId);
    setTimeline("pending");
    startPolling(lastOrderId);
  }

  // ====== EVENTS ======
  $("reload").onclick = loadCatalog;
  $("search").addEventListener("input", applyFilter);

  $("btnSupport").onclick = ()=> window.open("https://wa.me/" + SUPPORT_WA + "?text=" + encodeURIComponent("Oi! Preciso de ajuda na ViralVault Store."), "_blank");
  $("openSupportFooter").onclick = (e)=>{ e.preventDefault(); $("btnSupport").click(); };

  $("btnOpenOrder").onclick = openOrderLookup;
  $("openOrderFooter").onclick = (e)=>{ e.preventDefault(); openOrderLookup(); };

  $("xBtn").onclick = closeModal;
  $("ov").addEventListener("click", (e)=>{ if(e.target === $("ov")) closeModal(); });

  $("goBtn").onclick = createOrder;
  $("backBtn").onclick = ()=>{ stopPolling(); $("goBtn").disabled=false; $("goBtn").textContent="Gerar pedido + PIX"; $("backBtn").style.display="none"; $("timeline").style.display="none"; toast($("statusText"), "Voc√™ pode gerar de novo se precisar.", ""); };

  $("copyPix").onclick = async ()=>{
    const v = $("pix").value.trim();
    if(!v){ toast($("statusText"), "PIX vazio. Configure PIX_COPYPASTE no Worker.", "bad"); return; }
    await navigator.clipboard.writeText(v);
    $("copyPix").textContent = "PIX copiado ‚úÖ";
    setTimeout(()=> $("copyPix").textContent = "Copiar PIX e pagar", 1600);
    window.open("https://wa.me/" + SUPPORT_WA + "?text=" + encodeURIComponent("Acabei de pagar meu pedido " + (lastOrderId||"") + ". Aguardo entrega."), "_blank");
  };

  $("copyId").onclick = async ()=>{
    if(!lastOrderId){ toast($("statusText"), "Sem ID ainda.", "bad"); return; }
    await navigator.clipboard.writeText(lastOrderId);
    $("copyId").textContent = "ID copiado ‚úÖ";
    setTimeout(()=> $("copyId").textContent = "Copiar ID", 1400);
  };

  $("copyLink").onclick = async ()=>{
    if(!lastOrderId){ toast($("statusText"), "Sem ID ainda.", "bad"); return; }
    const u = new URL(location.href);
    u.searchParams.set("orderId", lastOrderId);
    await navigator.clipboard.writeText(u.toString());
    $("copyLink").textContent = "Link copiado ‚úÖ";
    setTimeout(()=> $("copyLink").textContent = "Copiar link", 1400);
  };

  // ====== INIT ======
  (async ()=>{
    await loadCatalog();

    // If page opened with orderId in URL, auto open tracking
    const id = getOrderIdFromUrl();
    if(id){
      setTimeout(()=>{ lastOrderId = id; openOrderLookup(); }, 250);
    }
  })();
</script>
</body>
</html>
