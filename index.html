<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ViralVault Store</title>
  <meta name="description" content="Loja digital de Roblox com checkout via PIX e verifica√ß√£o por Order ID." />
  <meta name="theme-color" content="#0b1020" />
  <meta property="og:title" content="ViralVault Store" />
  <meta property="og:description" content="Checkout PIX + verifica√ß√£o por Order ID + suporte no WhatsApp." />
  <meta property="og:type" content="website" />
  <style>
    :root {
      --bg0:#070a12;
      --bg1:#0b1020;
      --card:rgba(255,255,255,.06);
      --card2:rgba(255,255,255,.085);
      --stroke:rgba(255,255,255,.12);
      --text:#eaf0ff;
      --muted:rgba(234,240,255,.72);
      --muted2:rgba(234,240,255,.52);
      --brand:#7b61ff;          /* roxo principal estilo Virtualities */
      --brand2:#36d1dc;         /* ciano */
      --ok:#22c55e;
      --warn:#f59e0b;
      --danger:#ef4444;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --r:18px;
      --r2:26px;
      --safeB: env(safe-area-inset-bottom, 0px);
      --safeT: env(safe-area-inset-top, 0px);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font: 500 15px/1.45 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue";
      background:
        radial-gradient(1200px 500px at 10% -10%, rgba(123,97,255,.35), transparent 60%),
        radial-gradient(1000px 520px at 100% 0%, rgba(54,209,220,.20), transparent 60%),
        radial-gradient(900px 600px at 40% 110%, rgba(239,68,68,.12), transparent 60%),
        linear-gradient(180deg, var(--bg1), var(--bg0));
      overflow-x:hidden;
      padding-bottom: calc(92px + var(--safeB));
    }

    a{color:inherit; text-decoration:none}
    .wrap{max-width:1100px; margin:0 auto; padding:18px 14px 120px}
    .topbar{
      position:sticky; top:0; z-index:50;
      padding-top: var(--safeT);
      backdrop-filter: blur(14px);
      background: linear-gradient(180deg, rgba(7,10,18,.86), rgba(7,10,18,.55));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .topbarInner{max-width:1100px; margin:0 auto; padding:12px 14px; display:flex; align-items:center; gap:12px}
    .brand{display:flex; align-items:center; gap:10px; min-width:170px}
    .logo{
      width:42px; height:42px; border-radius:14px;
      background: linear-gradient(135deg, rgba(123,97,255,1), rgba(54,209,220,1));
      display:grid; place-items:center; font-weight:900;
      box-shadow: 0 10px 30px rgba(123,97,255,.25);
    }
    .brandTitle{display:flex; flex-direction:column; line-height:1.05}
    .brandTitle b{font-size:15px}
    .brandTitle span{font-size:12px; color:var(--muted2)}

    .search{
      flex:1;
      display:flex; align-items:center; gap:10px;
      padding:10px 12px;
      border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
    }
    .search input{
      width:100%;
      border:0; outline:0;
      background:transparent;
      color:var(--text);
      font-size:14px;
    }
    .iconBtn{
      width:44px; height:44px;
      border-radius:14px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      cursor:pointer;
    }
    .badge{
      position:absolute; transform: translate(15px,-12px);
      min-width:18px; height:18px; padding:0 6px;
      border-radius:999px;
      display:grid; place-items:center;
      background: var(--danger);
      font-size:11px; font-weight:800;
      border:2px solid rgba(7,10,18,.9);
    }

    /* Hero estilo Virtualities */
    .hero{
      margin-top:14px;
      border-radius: var(--r2);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:
        radial-gradient(800px 340px at 25% 20%, rgba(123,97,255,.38), transparent 60%),
        radial-gradient(900px 420px at 90% 10%, rgba(54,209,220,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
      position:relative;
    }
    .hero::before{
      content:"";
      position:absolute; inset:0;
      background:
        linear-gradient(180deg, rgba(7,10,18,.08), rgba(7,10,18,.65));
      pointer-events:none;
    }
    .heroInner{position:relative; padding:26px 18px}
    .pill{
      display:inline-flex; gap:10px; align-items:center;
      padding:10px 14px;
      border-radius:999px;
      background: rgba(123,97,255,.14);
      border: 1px solid rgba(123,97,255,.35);
      color: rgba(234,240,255,.92);
      font-weight:800;
    }
    .pill .dot{width:9px; height:9px; border-radius:999px; background: var(--ok); box-shadow:0 0 0 5px rgba(34,197,94,.16)}
    h1{margin:14px 0 8px; font-size:44px; line-height:1.03; letter-spacing:-.02em}
    .sub{color:var(--muted); font-size:16px; max-width:64ch}
    .ctaRow{display:flex; gap:12px; flex-wrap:wrap; margin-top:16px}
    .btn{
      border:0;
      border-radius: 16px;
      padding:12px 16px;
      display:inline-flex; align-items:center; gap:10px;
      cursor:pointer;
      font-weight:900;
      letter-spacing:.01em;
      transition:.15s transform, .15s opacity;
    }
    .btn:active{transform:translateY(1px)}
    .btnPrimary{
      background: linear-gradient(135deg, var(--brand), #a78bfa);
      color:#0b1020;
      box-shadow: 0 12px 30px rgba(123,97,255,.25);
    }
    .btnGhost{
      background: rgba(255,255,255,.06);
      color:var(--text);
      border:1px solid rgba(255,255,255,.12);
    }

    .grid{display:grid; grid-template-columns: 1.2fr .8fr; gap:14px; margin-top:14px}
    .card{
      border-radius: var(--r);
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      box-shadow: 0 18px 50px rgba(0,0,0,.25);
      overflow:hidden;
    }
    .cardHd{padding:14px 14px 0}
    .cardHd h2{margin:0; font-size:18px}
    .cardHd p{margin:6px 0 0; color:var(--muted2)}
    .cardBd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{display:block; font-size:12px; color:var(--muted2); margin:0 0 6px}
    .inp{
      width:100%;
      padding:12px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      outline:none;
    }
    .mini{font-size:12px; color:var(--muted2)}

    /* Cat√°logo */
    .sectionTitle{display:flex; align-items:flex-end; justify-content:space-between; margin:18px 0 10px}
    .sectionTitle h3{margin:0; font-size:16px}
    .sectionTitle span{color:var(--muted2); font-size:12px}
    .cats{display:flex; gap:10px; overflow:auto; padding-bottom:6px}
    .chip{
      flex:0 0 auto;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      font-weight:800;
    }
    .chip.active{background: rgba(123,97,255,.16); border-color: rgba(123,97,255,.35); color:rgba(234,240,255,.95)}

    .products{display:grid; grid-template-columns: repeat(2, minmax(0,1fr)); gap:12px}
    .p{
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      cursor:pointer;
      transition:.15s transform, .15s opacity;
    }
    .p:active{transform:translateY(1px)}
    .pImg{
      height:120px;
      background: radial-gradient(400px 140px at 20% 20%, rgba(123,97,255,.25), transparent 60%),
                  radial-gradient(450px 160px at 90% 0%, rgba(54,209,220,.18), transparent 60%),
                  linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.12));
      display:flex; align-items:flex-end; padding:10px;
    }
    .tag{
      font-size:11px; font-weight:900;
      padding:6px 10px; border-radius:999px;
      background: rgba(0,0,0,.38);
      border:1px solid rgba(255,255,255,.10);
      color: rgba(234,240,255,.9);
      backdrop-filter: blur(10px);
    }
    .pBody{padding:10px}
    .pName{font-weight:900; margin:0 0 6px}
    .pMeta{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .price{font-weight:1000}
    .muted{color:var(--muted2); font-size:12px}

    /* Drawer carrinho */
    .overlay{position:fixed; inset:0; background: rgba(0,0,0,.55); display:none; z-index:2000}
    .drawer{
      position:fixed; right:0; top:0; height:100%; width:min(420px, 92vw);
      background: rgba(7,10,18,.92);
      backdrop-filter: blur(18px);
      border-left:1px solid rgba(255,255,255,.10);
      transform: translateX(110%);
      transition:.2s transform;
      z-index:2100;
      padding: 16px 14px calc(18px + var(--safeB));
      display:flex; flex-direction:column; gap:12px;
    }
    .drawer.open{transform:translateX(0)}
    .overlay.show{display:block}
    .drawerTop{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .x{width:44px; height:44px; border-radius:14px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.06); color:var(--text); cursor:pointer}
    .cartList{display:flex; flex-direction:column; gap:10px; overflow:auto; padding-right:2px}
    .cartItem{display:flex; gap:10px; padding:10px; border-radius:16px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10)}
    .ciBox{width:52px; height:52px; border-radius:14px; background: rgba(123,97,255,.18); border:1px solid rgba(123,97,255,.25)}
    .ciInfo{flex:1}
    .ciInfo b{display:block}
    .qty{display:flex; align-items:center; gap:8px}
    .qbtn{width:34px; height:34px; border-radius:12px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.06); color:var(--text); cursor:pointer}
    .sum{margin-top:auto; border-top:1px solid rgba(255,255,255,.10); padding-top:12px}
    .sumRow{display:flex; justify-content:space-between; align-items:center}

    /* Checkout wizard */
    .steps{display:flex; gap:8px}
    .step{flex:1; padding:9px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.10); background: rgba(255,255,255,.06); color:var(--muted2); font-weight:900; font-size:12px; text-align:center}
    .step.on{background: rgba(123,97,255,.16); border-color: rgba(123,97,255,.35); color: rgba(234,240,255,.95)}
    .hide{display:none !important}

    /* Bottom nav estilo app */
    #bottomNav{
      position:fixed; left:0; right:0; bottom:0;
      padding: 10px 12px calc(10px + var(--safeB));
      z-index:1200;
      pointer-events:none;
    }
    #bottomNav .bar{
      pointer-events:auto;
      max-width: 560px;
      margin:0 auto;
      display:flex; gap:8px;
      padding:10px;
      border-radius: 22px;
      background: rgba(7,10,18,.72);
      border:1px solid rgba(255,255,255,.10);
      backdrop-filter: blur(16px);
      box-shadow: 0 16px 50px rgba(0,0,0,.45);
    }
    .navBtn{
      flex:1;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: rgba(234,240,255,.82);
      border-radius: 18px;
      padding:10px 10px;
      cursor:pointer;
      font-weight:900;
      font-size:12px;
      display:flex; flex-direction:column; gap:4px; align-items:center; justify-content:center;
    }
    .navBtn.on{background: rgba(123,97,255,.16); border-color: rgba(123,97,255,.35); color: rgba(234,240,255,.95)}

    /* WhatsApp float (apenas 1, sem duplicar) */
    #wppFloat{
      position:fixed; right:16px;
      bottom: calc(92px + 16px + var(--safeB));
      z-index:1300;
    }
    #wppFloat button{
      border:0; cursor:pointer;
      padding:12px 14px;
      border-radius: 18px;
      display:flex; align-items:center; gap:10px;
      font-weight:1000;
      color:#06220f;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      box-shadow: 0 18px 45px rgba(34,197,94,.25);
    }

    /* Responsive */
    @media(max-width:860px){
      .grid{grid-template-columns:1fr}
      h1{font-size:38px}
      .products{grid-template-columns: repeat(2, minmax(0,1fr));}
      .brand{min-width:auto}
      .brandTitle span{display:none}
      .search{display:none} /* estilo Virtualities mobile: foco no conte√∫do */
    }
    @media(max-width:390px){
      h1{font-size:34px}
      .products{grid-template-columns:1fr}
    }

    /* Toast */
    #toast{position:fixed; left:50%; transform:translateX(-50%); bottom: calc(92px + 22px + var(--safeB));
      background: rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.12); color: rgba(234,240,255,.92);
      padding:10px 12px; border-radius:999px; z-index:1400; display:none; backdrop-filter: blur(10px);
      max-width:min(92vw,520px); text-align:center;
    }
  </style>
</head>

<body>
  <div class="topbar">
    <div class="topbarInner">
      <div class="brand" role="button" tabindex="0" onclick="go('home')">
        <div class="logo">VV</div>
        <div class="brandTitle">
          <b>ViralVault Store</b>
          <span>loja digital ‚Ä¢ PIX ‚Ä¢ verifica√ß√£o Order ID</span>
        </div>
      </div>

      <div class="search" title="Buscar no cat√°logo">
        üîé <input id="q" placeholder="Buscar produto, jogo ou categoria..." />
      </div>

      <div style="position:relative">
        <button class="iconBtn" id="cartBtn" aria-label="Carrinho" onclick="openCart()">üõí</button>
        <div class="badge" id="cartBadge" style="display:none">0</div>
      </div>
      <button class="iconBtn" id="statusBtn" aria-label="Pedido" onclick="go('pedido')">üì¶</button>
    </div>
  </div>

  <div class="wrap">
    <section class="hero" id="home">
      <div class="heroInner">
        <div class="pill"><span class="dot"></span> Checkout PIX ‚Ä¢ Verifica√ß√£o Order ID ‚Ä¢ Anti-golpe</div>
        <h1>Turbine seus itens do <span style="color:#a78bfa">Roblox</span>.</h1>
        <div class="sub">
          Compra r√°pida, entrega organizada e suporte no WhatsApp. Gere seu pedido, pague via PIX e acompanhe tudo pelo <b>Order ID</b>.
        </div>
        <div class="ctaRow">
          <button class="btn btnPrimary" onclick="go('catalogo')">üõçÔ∏è Ver cat√°logo</button>
          <button class="btn btnGhost" onclick="go('checkout')">üßæ Ir pro checkout</button>
          <button class="btn btnGhost" onclick="go('pedido')">üîé Ver pedido</button>
        </div>
      </div>
    </section>

    <div class="grid">
      <section class="card" id="catalogo">
        <div class="cardHd">
          <h2>Cat√°logo</h2>
          <p>Toque em uma categoria e escolha o que voc√™ quer comprar.</p>
        </div>
        <div class="cardBd">
          <div class="sectionTitle">
            <h3>Categorias</h3>
            <span id="catHint">Carregando‚Ä¶</span>
          </div>
          <div class="cats" id="cats"></div>

          <div class="sectionTitle">
            <h3>Produtos</h3>
            <span id="pCount">0</span>
          </div>
          <div class="products" id="products"></div>

          <div class="mini" id="catSource" style="margin-top:10px"></div>
        </div>
      </section>

      <section class="card" id="checkout">
        <div class="cardHd">
          <h2>Checkout (1/2/3)</h2>
          <p>Finaliza em etapas ‚Äî simples e sem confus√£o.</p>
        </div>

        <div class="cardBd">
          <div class="steps" style="margin-bottom:12px">
            <div class="step on" id="s1">1 ‚Ä¢ Dados</div>
            <div class="step" id="s2">2 ‚Ä¢ Revis√£o</div>
            <div class="step" id="s3">3 ‚Ä¢ PIX</div>
          </div>

          <div id="step1">
            <label>Seu user do Roblox (obrigat√≥rio)</label>
            <input class="inp" id="robloxUser" placeholder="Ex: Darlan0786" autocomplete="off" />
            <div class="mini" style="margin-top:8px">Dica: s√≥ letras, n√∫meros e _ (3‚Äì20 caracteres).</div>
            <div class="row" style="margin-top:12px">
              <button class="btn btnPrimary" onclick="nextStep()">Pr√≥ximo ‚ûú</button>
              <button class="btn btnGhost" onclick="openCart()">Ver carrinho</button>
            </div>
          </div>

          <div id="step2" class="hide">
            <div class="card" style="background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.08)">
              <div class="cardBd">
                <b>Revis√£o</b>
                <div class="mini" id="reviewTxt" style="margin-top:6px"></div>
              </div>
            </div>
            <div class="row" style="margin-top:12px">
              <button class="btn btnGhost" onclick="prevStep()">‚óÄ Voltar</button>
              <button class="btn btnPrimary" onclick="createOrder()">Gerar pedido + PIX</button>
            </div>
          </div>

          <div id="step3" class="hide">
            <div class="card" style="background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.08)">
              <div class="cardBd">
                <div class="row" style="justify-content:space-between">
                  <b>PIX</b>
                  <span class="mini" id="pixTotal"></span>
                </div>
                <div class="mini" style="margin-top:8px">Copie o c√≥digo PIX e pague no seu banco. Depois, envie o comprovante no WhatsApp.</div>
                <textarea class="inp" id="pixCode" rows="4" style="margin-top:10px; resize:none"></textarea>
                <div class="row" style="margin-top:10px">
                  <button class="btn btnPrimary" onclick="copyPix()">üìã Copiar PIX</button>
                  <button class="btn btnGhost" onclick="sendWppProof()">üí¨ Enviar comprovante</button>
                </div>
                <div class="mini" id="orderIdBox" style="margin-top:10px"></div>
              </div>
            </div>
            <div class="row" style="margin-top:12px">
              <button class="btn btnGhost" onclick="resetCheckout()">Novo pedido</button>
              <button class="btn btnGhost" onclick="go('pedido')">Acompanhar pedido</button>
            </div>
          </div>
        </div>
      </section>
    </div>

    <section class="card" id="pedido" style="margin-top:14px">
      <div class="cardHd">
        <h2>Status do pedido (Order ID)</h2>
        <p>Verifique se √© oficial e veja o andamento.</p>
      </div>
      <div class="cardBd">
        <div class="row">
          <div style="flex:1; min-width:220px">
            <label>Cole o Order ID</label>
            <input class="inp" id="orderIdInput" placeholder="Ex: VV-2026-..." />
          </div>
          <div style="display:flex; gap:10px; align-items:flex-end">
            <button class="btn btnPrimary" onclick="checkOrder()">üîé Verificar</button>
          </div>
        </div>

        <div class="card" style="margin-top:12px; background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.08)">
          <div class="cardBd" id="orderOut">
            <span class="mini">Cole um Order ID e toque em Verificar.</span>
          </div>
        </div>
      </div>
    </section>

    <section class="card" id="faq" style="margin-top:14px">
      <div class="cardHd">
        <h2>FAQ</h2>
        <p>R√°pido e direto.</p>
      </div>
      <div class="cardBd">
        <details>
          <summary><b>Como sei que √© oficial?</b></summary>
          <div class="mini">Sempre gere seu pedido aqui. Depois, use o Order ID para verificar status. Se o site n√£o confirmar, n√£o pague.</div>
        </details>
        <details style="margin-top:10px">
          <summary><b>Quanto tempo para entrega?</b></summary>
          <div class="mini">Depende do item, mas a meta √© entregar o mais r√°pido poss√≠vel. O status mostra: Criado ‚Üí Pago ‚Üí Entregue.</div>
        </details>
        <details style="margin-top:10px">
          <summary><b>Suporte</b></summary>
          <div class="mini">Use o bot√£o do WhatsApp. Envie seu Order ID e o comprovante.</div>
        </details>
      </div>
    </section>
  </div>

  <!-- WhatsApp Float -->
  <div id="wppFloat">
    <button onclick="openWpp()">üí¨ WhatsApp</button>
  </div>

  <!-- Bottom Nav -->
  <div id="bottomNav">
    <div class="bar">
      <button class="navBtn on" id="nCat" onclick="go('catalogo')">üõçÔ∏è<div>Cat√°logo</div></button>
      <button class="navBtn" id="nChk" onclick="go('checkout')">üßæ<div>Checkout</div></button>
      <button class="navBtn" id="nPed" onclick="go('pedido')">üì¶<div>Pedido</div></button>
      <button class="navBtn" id="nFaq" onclick="go('faq')">‚ùì<div>FAQ</div></button>
    </div>
  </div>

  <!-- Cart overlay/drawer -->
  <div class="overlay" id="ov" onclick="closeCart()"></div>
  <aside class="drawer" id="drawer" aria-label="Carrinho">
    <div class="drawerTop">
      <div>
        <b style="font-size:16px">Carrinho</b>
        <div class="mini" id="cartMini"></div>
      </div>
      <button class="x" onclick="closeCart()">‚úï</button>
    </div>

    <div class="cartList" id="cartList"></div>

    <div class="sum">
      <div class="sumRow">
        <b>Total</b>
        <b id="cartTotal">R$ 0,00</b>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn btnPrimary" style="flex:1; justify-content:center" onclick="go('checkout'); closeCart(); toast('Checkout aberto ‚úÖ')">Finalizar</button>
        <button class="btn btnGhost" onclick="clearCart()">Limpar</button>
      </div>
    </div>
  </aside>

  <div id="toast"></div>

  <script>
    const WORKER = 'https://viralvault-sign.darlanana06.workers.dev';
    // Configs
    const WPP_NUMBER = "5511941598713";
    const CATALOG_ENDPOINTS = [
      WORKER + "/catalog",
      WORKER + "/catalog.json",
      WORKER + "/products",
      WORKER + "/produtos"
    ];

    // State
    let catalog = [];
    let categories = [];
    let activeCat = "Todos";
    let cart = load("vv_cart", []);
    let currentOrder = null;
    let step = 1;

    // Helpers
    const money = (n)=> "R$ " + (Number(n||0)).toFixed(2).replace(".", ",");
    function save(k,v){ localStorage.setItem(k, JSON.stringify(v)); }
    function load(k, d){ try{ return JSON.parse(localStorage.getItem(k) || "null") ?? d; }catch(e){ return d; } }
    function toast(msg){ const t=document.getElementById("toast"); t.textContent=msg; t.style.display="block"; clearTimeout(window.__tt); window.__tt=setTimeout(()=>t.style.display="none", 2200); }

    function setNav(id){
      ["nCat","nChk","nPed","nFaq"].forEach(x=>document.getElementById(x).classList.remove("on"));
      const map={catalogo:"nCat", checkout:"nChk", pedido:"nPed", faq:"nFaq", home:"nCat"};
      const key = map[id] || "nCat";
      document.getElementById(key).classList.add("on");
    }

    function go(id){
      const el = document.getElementById(id);
      if(!el) return;
      setNav(id);
      el.scrollIntoView({behavior:"smooth", block:"start"});
    }

    // Search
    const q = document.getElementById("q");
    if(q){
      q.addEventListener("input", ()=> renderProducts());
    }

    // Catalog fetch (worker) with fallback
    const fallbackCatalog = [
      {id:"robux_100", name:"Robux 100", category:"Robux", price:4.80, tag:"Robux"},
      {id:"robux_500", name:"Robux 500", category:"Robux", price:19.90, tag:"Robux"},
      {id:"conta_dragon", name:"Conta Dragon", category:"Conta", price:49.90, tag:"Conta"},
      {id:"item_raro", name:"Item Raro", category:"Itens", price:9.60, tag:"Itens"}
    ];

    async function loadCatalog(){
      document.getElementById("catHint").textContent = "Carregando‚Ä¶";
      let data = null;
      let used = "";
      for(const url of CATALOG_ENDPOINTS){
        try{
          const r = await fetch(url, {cache:"no-store"});
          if(!r.ok) continue;
          data = await r.json();
          used = url;
          break;
        }catch(e){}
      }

      // Normalize
      if(!data){
        catalog = fallbackCatalog;
        document.getElementById("catSource").textContent = "Cat√°logo: modo fallback (offline).";
      } else {
        // Accept formats: array; {items:[]}; {products:[]}
        const arr = Array.isArray(data) ? data : (data.items || data.products || data.catalog || []);
        catalog = arr.map((p, idx)=> ({
          id: String(p.id || p.sku || p.code || idx),
          name: String(p.name || p.title || p.produto || "Produto"),
          category: String(p.category || p.categoria || p.type || "Outros"),
          price: Number(p.price || p.valor || p.amount || 0),
          tag: String(p.tag || p.badge || p.category || "ViralVault")
        })).filter(x=>x.name);
        document.getElementById("catSource").textContent = "Cat√°logo: online (" + used.replace(WORKER,"") + ")";
      }

      categories = ["Todos", ...Array.from(new Set(catalog.map(p=>p.category)))];
      renderCats();
      renderProducts();
      updateCartUI();
      document.getElementById("catHint").textContent = categories.length + " categorias";
    }

    function renderCats(){
      const c = document.getElementById("cats");
      c.innerHTML = "";
      categories.forEach(cat=>{
        const b = document.createElement("div");
        b.className = "chip" + (cat===activeCat ? " active":"");
        b.textContent = cat;
        b.onclick = ()=>{ activeCat = cat; renderCats(); renderProducts(); };
        c.appendChild(b);
      });
    }

    function renderProducts(){
      const list = document.getElementById("products");
      const query = (document.getElementById("q")?.value || "").toLowerCase().trim();
      let items = catalog.slice();
      if(activeCat !== "Todos") items = items.filter(p=>p.category===activeCat);
      if(query) items = items.filter(p=> (p.name + " " + p.category + " " + (p.tag||"")).toLowerCase().includes(query));

      document.getElementById("pCount").textContent = items.length + " itens";
      list.innerHTML = "";
      items.forEach(p=>{
        const card = document.createElement("div");
        card.className = "p";
        card.innerHTML = `
          <div class="pImg"><span class="tag">${escapeHtml(p.tag || p.category)}</span></div>
          <div class="pBody">
            <div class="pName">${escapeHtml(p.name)}</div>
            <div class="pMeta">
              <div class="price">${money(p.price)}</div>
              <div class="muted">Toque para adicionar</div>
            </div>
          </div>`;
        card.onclick = ()=> addToCart(p.id);
        list.appendChild(card);
      });
    }

    function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[m])); }

    // Cart
    function openCart(){ document.getElementById("ov").classList.add("show"); document.getElementById("drawer").classList.add("open"); }
    function closeCart(){ document.getElementById("ov").classList.remove("show"); document.getElementById("drawer").classList.remove("open"); }
    function clearCart(){ cart = []; save("vv_cart", cart); updateCartUI(); toast("Carrinho limpo"); }

    function addToCart(id){
      const p = catalog.find(x=>x.id===id);
      if(!p) return;
      const it = cart.find(x=>x.id===id);
      if(it) it.qty += 1;
      else cart.push({id, qty:1});
      save("vv_cart", cart);
      updateCartUI();
      toast("Adicionado ‚úÖ");
    }
    function dec(id){ const it=cart.find(x=>x.id===id); if(!it) return; it.qty-=1; if(it.qty<=0) cart=cart.filter(x=>x.id!==id); save("vv_cart",cart); updateCartUI(); }
    function inc(id){ const it=cart.find(x=>x.id===id); if(!it) return; it.qty+=1; save("vv_cart",cart); updateCartUI(); }

    function cartTotal(){
      return cart.reduce((sum, it)=>{
        const p=catalog.find(x=>x.id===it.id);
        return sum + (p? p.price*it.qty : 0);
      },0);
    }

    function updateCartUI(){
      const badge = document.getElementById("cartBadge");
      const count = cart.reduce((a,x)=>a+x.qty,0);
      badge.style.display = count? "grid":"none";
      badge.textContent = String(count);

      document.getElementById("cartMini").textContent = count ? (count + " item(ns)") : "Vazio";
      document.getElementById("cartTotal").textContent = money(cartTotal());

      const list = document.getElementById("cartList");
      list.innerHTML = "";
      if(!cart.length){
        list.innerHTML = `<div class="mini">Seu carrinho est√° vazio. Toque em um produto no cat√°logo para adicionar.</div>`;
        return;
      }
      cart.forEach(it=>{
        const p = catalog.find(x=>x.id===it.id) || {name:"Produto", price:0};
        const row = document.createElement("div");
        row.className = "cartItem";
        row.innerHTML = `
          <div class="ciBox"></div>
          <div class="ciInfo">
            <b>${escapeHtml(p.name)}</b>
            <div class="mini">${money(p.price)} ‚Ä¢ ${escapeHtml(p.category||"")}</div>
            <div class="qty" style="margin-top:8px">
              <button class="qbtn" onclick="dec('${it.id}')">‚àí</button>
              <b>${it.qty}</b>
              <button class="qbtn" onclick="inc('${it.id}')">+</button>
            </div>
          </div>`;
        list.appendChild(row);
      });
    }

    // Checkout steps
    function setStep(n){
      step = n;
      document.getElementById("step1").classList.toggle("hide", n!==1);
      document.getElementById("step2").classList.toggle("hide", n!==2);
      document.getElementById("step3").classList.toggle("hide", n!==3);
      document.getElementById("s1").classList.toggle("on", n===1);
      document.getElementById("s2").classList.toggle("on", n===2);
      document.getElementById("s3").classList.toggle("on", n===3);
    }

    function validUser(u){
      return /^[A-Za-z0-9_](3, 20)$/.test(u);
    }

    function nextStep(){
      if(!cart.length){ toast("Adicione itens no carrinho primeiro"); go("catalogo"); return; }
      const u = document.getElementById("robloxUser").value.trim();
      if(!validUser(u)){ toast("User inv√°lido. Ex: Darlan0786"); return; }
      const lines = cart.map(it=>{
        const p=catalog.find(x=>x.id===it.id);
        return `‚Ä¢ ${it.qty}x ${p? p.name : it.id}`;
      }).join("\n");
      document.getElementById("reviewTxt").textContent = `User: ${u}\n\nItens:\n${lines}\n\nTotal: ${money(cartTotal())}`;
      setStep(2);
      go("checkout");
    }
    function prevStep(){ setStep(1); }
    function resetCheckout(){ currentOrder=null; document.getElementById("pixCode").value=""; document.getElementById("orderIdBox").textContent=""; setStep(1); }

    // Create order via Worker
    async function createOrder(){
      const u = document.getElementById("robloxUser").value.trim();
      if(!validUser(u)){ toast("User inv√°lido"); setStep(1); return; }
      const items = cart.map(it=>{
        const p=catalog.find(x=>x.id===it.id) || {};
        return {
          id: it.id,
          name: p.name || it.id,
          category: p.category || "Outros",
          qty: it.qty,
          price: Number(p.price||0)
        };
      });
      const payload = { user: u, items, total: cartTotal(), source: "site-index" };

      toast("Gerando pedido‚Ä¶");
      try{
        const r = await fetch(WORKER + "/create-order", {
          method:"POST",
          headers:{"content-type":"application/json"},
          body: JSON.stringify(payload)
        });
        const data = await r.json().catch(()=>null);
        if(!r.ok || !data) throw new Error(data?.error || "Falha");
        currentOrder = data;
        const orderId = data.orderId || data.id || data.order_id;
        const pix = data.pix || data.pixCode || data.pix_code || data.qr || data.payload;
        document.getElementById("pixCode").value = pix || "";
        document.getElementById("pixTotal").textContent = money(cartTotal());
        document.getElementById("orderIdBox").innerHTML = "<b>Order ID:</b> " + escapeHtml(orderId || "(n√£o retornado)") + " ‚Ä¢ <span class='mini'>Use no Status do pedido</span>";
        setStep(3);
        toast("Pedido criado ‚úÖ");
        if(orderId){ document.getElementById("orderIdInput").value = orderId; }
      }catch(e){
        console.error(e);
        toast("Erro ao gerar pedido. Tente novamente.");
      }
    }

    async function copyPix(){
      const v = document.getElementById("pixCode").value.trim();
      if(!v){ toast("PIX vazio"); return; }
      try{ await navigator.clipboard.writeText(v); toast("PIX copiado ‚úÖ"); }
      catch(e){ document.getElementById("pixCode").select(); document.execCommand("copy"); toast("PIX copiado ‚úÖ"); }
    }

    function openWpp(){
      const msg = encodeURIComponent("Ol√°! Vim pelo site ViralVault. Preciso de ajuda üôÇ");
      window.open(`https://wa.me/${WPP_NUMBER}?text=${msg}`, "_blank");
    }

    function sendWppProof(){
      const u = document.getElementById("robloxUser").value.trim();
      const orderId = (currentOrder?.orderId || currentOrder?.id || currentOrder?.order_id || document.getElementById("orderIdInput").value.trim() || "").trim();
      const total = money(cartTotal());
      const items = cart.map(it=>{
        const p=catalog.find(x=>x.id===it.id);
        return `${it.qty}x ${p? p.name : it.id}`;
      }).join(", ");
      const msg = encodeURIComponent(
        `‚úÖ Comprovante/Status\n`+
        `User: ${u}\n`+
        `Order ID: ${orderId}\n`+
        `Itens: ${items}\n`+
        `Total: ${total}\n\n`+
        `Vou enviar o comprovante agora.`
      );
      window.open(`https://wa.me/${WPP_NUMBER}?text=${msg}`, "_blank");
    }

    // Order status
    async function checkOrder(){
      const id = document.getElementById("orderIdInput").value.trim();
      if(!id){ toast("Cole um Order ID"); return; }
      const out = document.getElementById("orderOut");
      out.innerHTML = "<span class='mini'>Consultando‚Ä¶</span>";
      try{
        const r = await fetch(WORKER + "/order-status?orderId=" + encodeURIComponent(id), {cache:"no-store"});
        const data = await r.json().catch(()=>null);
        if(!r.ok || !data) throw new Error(data?.error || "Falha");
        const status = String(data.status || data.state || "desconhecido").toLowerCase();
        const map = {
          created: ["Criado", "üßæ"],
          pending: ["Pendente", "‚è≥"],
          paid: ["Pago", "‚úÖ"],
          delivered: ["Entregue", "üì¶"],
          canceled: ["Cancelado", "üõë"],
        };
        const key = (map[status] ? status : (status.includes("paid")?"paid": status.includes("deliver")?"delivered": status.includes("cancel")?"canceled": status.includes("pend")?"pending":"created"));
        const label = map[key][0];
        const emoji = map[key][1];
        const user = data.user || data.username || "-";
        const total = money(data.total || data.amount || cartTotal());
        out.innerHTML = `
          <div class="row" style="justify-content:space-between; align-items:flex-start">
            <div>
              <b style="font-size:16px">${emoji} ${label}</b>
              <div class="mini">Order ID: ${escapeHtml(id)} ‚Ä¢ User: ${escapeHtml(user)}</div>
            </div>
            <div style="text-align:right">
              <b>${total}</b>
              <div class="mini">Total</div>
            </div>
          </div>
          <div class="card" style="margin-top:12px; background:rgba(255,255,255,.05); border-color:rgba(255,255,255,.08)">
            <div class="cardBd">
              <b>Timeline</b>
              <div class="mini" style="margin-top:6px">üßæ Criado ‚Üí ‚úÖ Pago ‚Üí üì¶ Entregue</div>
              <div class="mini" style="margin-top:10px">${escapeHtml(data.note || data.message || "")}</div>
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <button class="btn btnPrimary" onclick="sendWppFromOrder('${escapeHtml(id)}')">üí¨ Falar no WhatsApp</button>
            <button class="btn btnGhost" onclick="toast('Dica: envie o comprovante no WhatsApp com o Order ID')">‚ÑπÔ∏è Dica</button>
          </div>
        `;
      }catch(e){
        console.error(e);
        out.innerHTML = "<span class='mini'>N√£o consegui consultar. Verifique o Order ID ou tente de novo.</span>";
      }
    }

    function sendWppFromOrder(orderId){
      const msg = encodeURIComponent(`Ol√°! Quero suporte. Meu Order ID √©: ${orderId}`);
      window.open(`https://wa.me/${WPP_NUMBER}?text=${msg}`, "_blank");
    }

    // Init
    (function(){
      loadCatalog();
      updateCartUI();
      setStep(1);
      // keyboard shortcuts basic
      document.addEventListener("keydown", (e)=>{
        if(e.key==="k" && (e.ctrlKey||e.metaKey)){ e.preventDefault(); go("catalogo"); }
        if(e.key==="c" && (e.ctrlKey||e.metaKey)){ e.preventDefault(); go("checkout"); }
        if(e.key==="p" && (e.ctrlKey||e.metaKey)){ e.preventDefault(); go("pedido"); }
      });
    })();
  </script>
</body>
</html>
