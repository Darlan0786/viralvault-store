<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ViralVault Store ‚Ä¢ Loja Digital</title>
  <meta name="description" content="Loja digital com entrega em at√© 24h e suporte r√°pido. Verifica√ß√£o de pedido no servidor." />
  <meta name="theme-color" content="#f7f6ff" />
  <style>
    :root{
      --bg:#f7f6ff;
      --card:#ffffff;
      --card2:#ffffff;
      --text:#14162a;
      --muted:#5a5f7a;
      --line:rgba(20,22,42,.10);
      --accent:#ff3b30; /* red */
      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --r:18px;
      --shadow:0 18px 50px rgba(20,22,42,.12);
      --btnH:44px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --card:#ffffff;
        --card2:#ffffff;
        --text:#0b1020;
        --muted:#576179;
        --line:rgba(0,0,0,.08);
        --shadow:0 18px 50px rgba(10,20,40,.10);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;
      background: radial-gradient(1000px 600px at 10% -10%, rgba(255,59,48,.12), transparent 55%),
                  radial-gradient(900px 520px at 110% 10%, rgba(99,102,241,.14), transparent 58%),
                  radial-gradient(900px 520px at 50% 110%, rgba(236,72,153,.10), transparent 58%),
                  var(--bg);
    color:var(--text);
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{
      position:sticky;top:0;z-index:50;
      background: rgba(247,246,255,.72);
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
    }
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 18px;
    }
    .brand{display:flex;align-items:center;gap:12px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: linear-gradient(135deg, rgba(255,59,48,.95), rgba(99,102,241,.95));
      box-shadow: var(--shadow);
      display:grid;place-items:center;
      font-weight:900; letter-spacing:.5px;
    }
    .brand b{font-size:15px}
    .brand .sub{font-size:12px;color:var(--muted)}
    nav{
      display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;
    }
    .tab{
      transition: transform .15s ease, box-shadow .15s ease, border-color .15s ease;

      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 82%, transparent);
      color:var(--text);
      padding:10px 12px;border-radius:999px;
      font-weight:900;font-size:13px; letter-spacing:.2px;
      cursor:pointer;
    }
    .tab:hover{ transform: translateY(-1px); box-shadow: 0 12px 30px rgba(20,22,42,.10); }
    .btn:hover{ transform: translateY(-1px); }
    .btn.primary:hover{ box-shadow: 0 16px 34px rgba(255,59,48,.18); }
    .tab.active{border-color: color-mix(in oklab, var(--accent) 55%, var(--line)); box-shadow: 0 10px 26px rgba(0,0,0,.18);}
    .grid{
      display:grid;grid-template-columns: 1.1fr .9fr; gap:14px; align-items:start;
    }
    @media (max-width: 920px){ .grid{grid-template-columns:1fr} }
    .card{
      background: color-mix(in oklab, var(--card) 92%, transparent);
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 16px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid var(--line);
      background: color-mix(in oklab, var(--card2) 88%, transparent);
    }
    .card .bd{padding:14px 16px}
    .muted{color:var(--muted)}
    .tiny{font-size:12px}
    .chip{
      display:inline-flex;align-items:center;gap:8px;
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--line);
      font-size:12px;font-weight:800;
      background: rgba(255,255,255,.78);
    }
    .chip.ok{border-color: color-mix(in oklab, var(--ok) 55%, var(--line));}
    .chip.bad{border-color: color-mix(in oklab, var(--bad) 55%, var(--line));}
    .chip.warn{border-color: color-mix(in oklab, var(--warn) 55%, var(--line));}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      transition: transform .12s ease, box-shadow .15s ease, border-color .15s ease;

      min-height:var(--btnH);
      padding:10px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      color:var(--text);
      font-weight:900;
      cursor:pointer;
      flex:0 0 auto;
    }
    .btn.primary{
      border-color: color-mix(in oklab, var(--accent) 60%, var(--line));
      background: linear-gradient(135deg, color-mix(in oklab, var(--accent) 92%, #fff 0%), #7a1b17);
      color:#fff;
      box-shadow: 0 14px 28px rgba(255,59,48,.16);
    }
    .btn.ghost{background: transparent}
    .btn:disabled{opacity:.55; cursor:not-allowed}
    .input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: color-mix(in oklab, var(--card) 92%, transparent);
      color:var(--text);
      outline:none;
    }
    textarea{min-height:96px; resize:vertical}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .prodGrid{
      display:grid; grid-template-columns: repeat(3, 1fr); gap:12px;
    }
    @media (max-width: 980px){ .prodGrid{grid-template-columns: repeat(2, 1fr);} }
    @media (max-width: 560px){ .prodGrid{grid-template-columns: 1fr;} }
    .prod{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      background: color-mix(in oklab, var(--card) 92%, transparent);
      display:flex; flex-direction:column; gap:10px;
    }
    .prod .title{font-weight:950}
    .prod .price{font-weight:950}
    .prod .tag{display:flex;gap:8px;flex-wrap:wrap}
    .prod .tag span{font-size:12px;font-weight:900;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
    .prodActions{display:flex;gap:10px;flex-wrap:wrap}
    .prodActions .btn{
      transition: transform .12s ease, box-shadow .15s ease, border-color .15s ease;
flex:1 1 160px}
    @media (max-width:520px){ .prodActions .btn{
      transition: transform .12s ease, box-shadow .15s ease, border-color .15s ease;
flex:1 1 100%} }
    .hidden{display:none !important}
    footer{padding:22px 0 34px;color:var(--muted);font-size:12px}
    /* Mobile quick bar */
    .quickbar{
      position:fixed;left:12px;right:12px;bottom:12px;z-index:60;
      display:none;gap:10px;padding:10px;border-radius:18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow);
    }
    .quickbar .btn{
      transition: transform .12s ease, box-shadow .15s ease, border-color .15s ease;
flex:1}
    @media (max-width: 820px){
      .quickbar{display:flex}
      body{padding-bottom:92px}
    }
  </style>
</head>

<body>
<header>
  <div class="top">
    <div class="brand">
      <div class="logo">VV</div>
      <div>
        <b>ViralVault Store</b>
        <div class="sub">Loja digital ‚Ä¢ entrega em at√© 24h ‚Ä¢ suporte r√°pido</div>
      </div>
    </div>
    <nav id="nav">
      <button class="tab active" data-page="home">Home</button>
      <button class="tab" data-page="catalogo">Cat√°logo</button>
      <button class="tab" data-page="verificar">Verificar</button>
      <button class="tab" data-page="status">Status</button>
      <button class="tab" data-page="admin">Admin</button>
    </nav>
  </div>
</header>

<main class="wrap">
  <!-- HOME -->
  <section id="page-home">
    <div class="grid">
      <div class="card">
        <div class="hd">
          <div>
            <b>Checkout (Roblox)</b>
            <div class="tiny muted">Itens/brainrots ‚Ä¢ entrega em at√© <b>24h</b> ap√≥s confirma√ß√£o</div>
          </div>
          <span class="chip ok">Garantia 24h</span>
        </div>
        <div class="bd">
          <div class="row">
            <span class="chip">‚úÖ Sem senha</span>
            <span class="chip">üîé Pedido verific√°vel</span>
            <span class="chip">üì∑ Prova de entrega</span>
          </div>

          <div class="hr"></div>

          <div class="prodActions">
            <button class="btn primary" id="btnIrCatalogo">Escolher produtos</button>
            <button class="btn" id="btnVerGarantia">Ver garantia</button>
            <button class="btn" id="btnSuporte">Suporte</button>
          </div>

          <div class="hr"></div>

          <div class="row" style="gap:12px">
            <div style="flex:1;min-width:220px">
              <div class="tiny muted">Seu @ do Roblox (obrigat√≥rio)</div>
              <input class="input" id="robloxUser" placeholder="Ex: Darlan123" autocomplete="off" />
            </div>
            <div style="flex:1;min-width:220px">
              <div class="tiny muted">Jogo/Servidor (opcional)</div>
              <input class="input" id="robloxServer" placeholder="Ex: Blox Fruits / Server 3" autocomplete="off" />
            </div>
          </div>
          <div style="height:10px"></div>
          <div class="row" style="gap:12px">
            <div style="flex:1;min-width:220px">
              <div class="tiny muted">Hor√°rio (opcional)</div>
              <input class="input" id="robloxTime" placeholder="Ex: hoje 21:00" autocomplete="off" />
            </div>
            <div style="flex:1;min-width:220px">
              <div class="tiny muted">WhatsApp para contato</div>
              <input class="input" id="whats" placeholder="Ex: 55119..." autocomplete="off" />
            </div>
          </div>

          <div class="hr"></div>

          <div class="card" style="box-shadow:none;border-radius:14px;border:1px dashed var(--line);background:transparent">
            <div class="bd" style="padding:12px 12px">
              <b>üßæ Seu carrinho</b>
              <div class="tiny muted">Cupom: <b>WELCOME10</b> (10% ‚Ä¢ 1 uso por cliente)</div>
              <div class="hr" style="margin:10px 0"></div>
              <div id="cartList" class="tiny muted">Seu carrinho est√° vazio.</div>
              <div class="hr" style="margin:10px 0"></div>

              <div class="row" style="align-items:flex-end">
                <div style="flex:1;min-width:240px">
                  <div class="tiny muted">Cupom</div>
                  <input class="input" id="coupon" placeholder="Digite o cupom" />
                  <div class="tiny muted" id="couponMsg" style="margin-top:6px">‚Äî</div>
                </div>
                <button class="btn" id="btnAplicarCupom">Aplicar</button>
              </div>

              <div style="height:10px"></div>
              <div class="row" style="justify-content:space-between">
                <div>
                  <div class="tiny muted">Total</div>
                  <div style="font-size:20px;font-weight:950" id="total">R$ 0,00</div>
                </div>
                <div class="row">
                  <button class="btn" id="btnLimpar">Limpar</button>
                  <button class="btn primary" id="btnGerarPedido">Gerar pedido</button>
                </div>
              </div>
              <div class="tiny muted" style="margin-top:10px">
                Ao gerar o pedido, voc√™ recebe um <b>Order ID</b> e pode <b>verificar no servidor</b> antes de pagar.
              </div>
            </div>
          </div>

          <div class="hr"></div>

          <div id="orderBox" class="hidden">
            <div class="row" style="justify-content:space-between;align-items:flex-start">
              <div>
                <b>‚úÖ Pedido gerado</b>
                <div class="tiny muted">Guarde seu ID e verifique no servidor.</div>
              </div>
              <span class="chip ok" id="sigChip">VV-OFICIAL</span>
            </div>
            <div style="height:10px"></div>
            <div class="row" style="gap:12px;align-items:flex-end">
              <div style="flex:1;min-width:240px">
                <div class="tiny muted">Order ID</div>
                <input class="input" id="orderId" readonly />
              </div>
              <button class="btn" id="btnCopiarId">Copiar</button>
            </div>
            <div style="height:10px"></div>
            <div class="prodActions">
              <button class="btn" id="btnIrVerificar">Verificar no servidor</button>
              <button class="btn primary" id="btnPagar">Pagar via WhatsApp (PIX)</button>
            </div>
            <div class="tiny muted" style="margin-top:10px" id="orderNote">‚Äî</div>
          </div>

        </div>
      </div>

      <div class="card">
        <div class="hd">
          <div>
            <b>Confian√ßa</b>
            <div class="tiny muted">Compra segura e transparente</div>
          </div>
          <span class="chip">Anti-golpe</span>
        </div>
        <div class="bd">
          <div class="row">
            <span class="chip ok">HTTPS</span>
            <span class="chip ok">Sem senha</span>
            <span class="chip ok">Verifica√ß√£o</span>
          </div>
          <div class="hr"></div>
          <div class="tiny muted">
            ‚úÖ Sempre confira o recebedor do PIX<br/>
            ‚úÖ Gere o pedido e <b>verifique</b> antes de pagar<br/>
            ‚úÖ Entrega em at√© <b>24h</b> ap√≥s confirma√ß√£o<br/>
            ‚Ü©Ô∏è Atrasou 24h sem entrega? <b>Reembolso total</b>
          </div>
          <div class="hr"></div>
          <div class="prodActions">
            <button class="btn" id="btnAbrirVerificar">Verificar pedido</button>
            <button class="btn" id="btnAbrirStatus">Status do sistema</button>
            <button class="btn primary" id="btnAbrirSuporte2">Falar com suporte</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CATALOGO -->
  <section id="page-catalogo" class="hidden">
    <div class="card">
      <div class="hd">
        <div>
          <b>Cat√°logo (Roblox)</b>
          <div class="tiny muted">Adicione seus itens/brainrots ao carrinho</div>
        </div>
        <span class="chip">‚úÖ Digital</span>
      </div>
      <div class="bd">

        <div class="row" style="gap:12px;align-items:flex-end">
          <div style="flex:1;min-width:220px">
            <div class="tiny muted">Buscar</div>
            <input class="input" id="search" placeholder="Ex: brainrot, item, pacote..." autocomplete="off" />
          </div>
          <div style="width:220px;min-width:180px">
            <div class="tiny muted">Filtro</div>
            <select id="filter" class="input">
              <option value="all">Todos</option>
              <option value="brainrot">Brainrots</option>
              <option value="item">Itens</option>
              <option value="servico">Servi√ßos</option>
              <option value="pacote">Pacotes</option>
            </select>
          </div>
          <div style="width:200px;min-width:160px">
            <div class="tiny muted">Ordenar</div>
            <select id="sort" class="input">
              <option value="reco">Recomendado</option>
              <option value="low">Menor pre√ßo</option>
              <option value="high">Maior pre√ßo</option>
              <option value="az">A ‚Üí Z</option>
            </select>
          </div>
        </div>
        <div class="hr"></div>
        <div class="prodGrid" id="prodGrid"></div>
        <div class="hr"></div>
        <div class="prodActions">
          <button class="btn primary" id="btnVoltarCheckout">Voltar pro checkout</button>
          <button class="btn" id="btnLimpar2">Limpar carrinho</button>
        </div>
      </div>
    </div>
  </section>

  <!-- VERIFICAR -->
  <section id="page-verificar" class="hidden">
    <div class="card">
      <div class="hd">
        <div>
          <b>Verificar pedido</b>
          <div class="tiny muted">Confirme no servidor antes de pagar</div>
        </div>
        <span class="chip ok">VV-OFICIAL</span>
      </div>
      <div class="bd">
        <div class="row" style="gap:12px;align-items:flex-end">
          <div style="flex:1;min-width:240px">
            <div class="tiny muted">URL do Worker</div>
            <input class="input" id="workerUrl" placeholder="https://seu-worker.workers.dev" />
            <div class="tiny muted" style="margin-top:6px">Ex: https://viralvault-sign.seuuser.workers.dev</div>
          </div>
          <button class="btn" id="btnSalvarWorker">Salvar</button>
        </div>
        <div class="hr"></div>
        <div class="row" style="gap:12px;align-items:flex-end">
          <div style="flex:1;min-width:240px">
            <div class="tiny muted">Order ID</div>
            <input class="input" id="verifyOrderId" placeholder="vv_..." />
          </div>
          <button class="btn primary" id="btnVerificar">Verificar</button>
        </div>
        <div style="height:10px"></div>
        <div class="card" style="box-shadow:none">
          <div class="bd">
            <pre id="verifyOut" class="tiny" style="white-space:pre-wrap;margin:0;color:var(--muted)">‚Äî</pre>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- STATUS -->
  <section id="page-status" class="hidden">
    <div class="card">
      <div class="hd">
        <div>
          <b>Status do sistema</b>
          <div class="tiny muted">Checa se o servidor est√° online</div>
        </div>
        <span class="chip" id="sysChip">‚Äî</span>
      </div>
      <div class="bd">
        <div class="prodActions">
          <button class="btn primary" id="btnPing">Testar servidor</button>
          <button class="btn" id="btnAbrirVerificar2">Ir para verificar</button>
          <button class="btn" id="btnVoltarHome">Voltar</button>
        </div>
        <div class="hr"></div>
        <pre id="pingOut" class="tiny" style="white-space:pre-wrap;margin:0;color:var(--muted)">‚Äî</pre>
      </div>
    </div>
  </section>

  <!-- ADMIN (simples) -->
  <section id="page-admin" class="hidden">
    <div class="card">
      <div class="hd">
        <div>
          <b>Admin (simples)</b>
          <div class="tiny muted">Painel f√°cil ‚Ä¢ (PIN + 2FA via Worker opcional)</div>
        </div>
        <span class="chip warn">Protegido</span>
      </div>
      <div class="bd">
        <div class="card" style="box-shadow:none">
          <div class="bd">
            <b>üß∞ Como usar</b>
            <div class="tiny muted" style="margin-top:6px">
              1) Cliente paga e envia comprovante<br/>
              2) Voc√™ marca o pedido como <b>PAGO</b><br/>
              3) Entrega no Roblox e marca <b>ENTREGUE</b> + prova<br/>
              ‚è±Ô∏è SLA: <b>24h</b> ‚Ä¢ atrasou: <b>reembolso total</b>
            </div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="row" style="gap:12px;align-items:flex-end">
          <div style="flex:1;min-width:240px">
            <div class="tiny muted">Buscar por Order ID</div>
            <input class="input" id="adminFind" placeholder="vv_..." />
          </div>
          <button class="btn primary" id="btnAdminBuscar">Buscar</button>
        </div>
        <div style="height:10px"></div>
        <div class="card" style="box-shadow:none">
          <div class="bd">
            <pre id="adminOut" class="tiny" style="white-space:pre-wrap;margin:0;color:var(--muted)">‚Äî</pre>
          </div>
        </div>
        <div class="hr"></div>
        <div class="prodActions">
          <button class="btn" id="btnAdminPago">Marcar PAGO</button>
          <button class="btn" id="btnAdminEntrega">Enviar entrega (WhatsApp)</button>
          <button class="btn primary" id="btnAdminEntregue">Entregue ‚úÖ (log)</button>
          <button class="btn" id="btnAdminReembolso">Reembolsar ‚Ü©Ô∏è</button>
        </div>
        <div class="tiny muted" style="margin-top:10px">
          Dica: para ‚Äúseguran√ßa imposs√≠vel de adivinhar‚Äù, use o Admin 2FA no Worker (PIN + Authenticator).
        </div>
      </div>
    </div>
  </section>

  <footer>
    <div class="hr"></div>
    <div><b>ViralVault Store</b> ‚Ä¢ Produtos digitais ‚Ä¢ SP</div>
    <div>Entrega em at√© 24h ap√≥s confirma√ß√£o ‚Ä¢ Se atrasar: reembolso total</div>
    <div class="tiny">¬© <span id="yy"></span> ‚Ä¢ Pol√≠tica e transpar√™ncia dispon√≠veis no checkout</div>
  </footer>
</main>

<div class="quickbar" id="quickbar">
  <button class="btn primary" data-page="catalogo">Cat√°logo</button>
  <button class="btn" data-page="verificar">Verificar</button>
  <button class="btn" id="qbSuporte">Suporte</button>
</div>

<script>
/* ============ ViralVault Rebuild (v1) ============
   - 100% est√°tico
   - sem overlays
   - bot√µes organizados
   - carrinho + cupom WELCOME10 (1 uso por cliente no device)
   - cria√ß√£o de pedido local + (opcional) assinatura no Worker
   - p√°ginas: Home/Cat√°logo/Verificar/Status/Admin
*/

const $ = (id)=>document.getElementById(id);
const money = (n)=> (Number(n)||0).toLocaleString("pt-BR",{style:"currency",currency:"BRL"});

const CFG_KEY="vv_cfg_rebuild";
const ORD_KEY="vv_orders_rebuild";
const USED_COUPON="vv_coupon_used_welcome10";

const DEFAULT_CFG={
  whatsapp:"5511941598713",
  workerUrl:"",
  storeName:"ViralVault Store"
};

const PRODUCTS=[
  {id:"br01", cat:"brainrot", name:"Brainrot Premium (1x)", price:9.90, tag:["Digital","Roblox"]},
  {id:"br02", cat:"brainrot", name:"Brainrot Deluxe (2x)", price:17.90, tag:["Digital","Roblox"]},
  {id:"it01", cat:"item", name:"Item/Drop (padr√£o)", price:12.90, tag:["Digital","Roblox"]},
  {id:"it02", cat:"item", name:"Item/Drop (r√°pido)", price:19.90, tag:["Digital","Roblox"]},
  {id:"sv01", cat:"servico", name:"Servi√ßo leve (sem senha)", price:24.90, tag:["Digital","Roblox"]},
  {id:"pk01", cat:"pacote", name:"Pacote Mix (3 itens)", price:29.90, tag:["Digital","Roblox"]},
];

let state={
  page:"home",
  cart: loadJSON("vv_cart_rebuild") || [],
  discount: 0,
  couponApplied: "",
  lastOrder: null,
  adminSel: null,
};

function loadJSON(k){ try{ return JSON.parse(localStorage.getItem(k)||"null"); }catch(e){ return null; } }
function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

function cfg(){
  return {...DEFAULT_CFG, ...(loadJSON(CFG_KEY)||{})};
}
function setCfg(patch){
  saveJSON(CFG_KEY, {...cfg(), ...(patch||{})});
}

function setPage(p){
  state.page = p;
  ["home","catalogo","verificar","status","admin"].forEach(x=>{
    const el = $("page-"+x);
    if(el) el.classList.toggle("hidden", x!==p);
  });
  // nav active
  document.querySelectorAll(".tab").forEach(t=>{
    t.classList.toggle("active", t.dataset.page===p);
  });
  // quickbar
  document.querySelectorAll("#quickbar [data-page]").forEach(b=>{
    b.classList.toggle("active", b.dataset.page===p);
  });
  // keep verify fields
  $("workerUrl").value = cfg().workerUrl || "";
  $("whats").value = (loadJSON("vv_contact_rebuild")||{}).whatsapp || cfg().whatsapp;
}

function toast(msg){
  // tiny toast without overlays that block clicks
  let t = $("vv_toast");
  if(!t){
    t = document.createElement("div");
    t.id="vv_toast";
    t.style.position="fixed";
    t.style.left="12px";
    t.style.right="12px";
    t.style.bottom="90px";
    t.style.zIndex="80";
    t.style.padding="12px";
    t.style.borderRadius="16px";
    t.style.border="1px solid var(--line)";
    t.style.background="color-mix(in oklab, var(--card) 92%, transparent)";
    t.style.boxShadow="var(--shadow)";
    t.style.pointerEvents="none"; // doesn't block clicks
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity="1";
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(()=>{ t.style.opacity="0"; }, 1800);
}

function cartTotals(){
  const sum = state.cart.reduce((a,it)=>a+(it.price*it.qty),0);
  const disc = Math.max(0, Math.min(state.discount, sum));
  return {sum, disc, total: Math.max(0, sum-disc)};
}

function renderProducts(){
  const g = $("prodGrid");
  const q = (($("search")?.value)||"").trim().toLowerCase();
  const f = ($("filter")?.value)||"all";
  const s = ($("sort")?.value)||"reco";

  let list = PRODUCTS.slice();

  if(f !== "all"){
    list = list.filter(p => p.cat === f);
  }
  if(q){
    list = list.filter(p => (p.name||"").toLowerCase().includes(q) || (p.tag||[]).some(t=>String(t).toLowerCase().includes(q)));
  }

  if(s === "low") list.sort((a,b)=>a.price-b.price);
  else if(s === "high") list.sort((a,b)=>b.price-a.price);
  else if(s === "az") list.sort((a,b)=>String(a.name).localeCompare(String(b.name),"pt-BR"));
  // reco = ordem padr√£o

  g.innerHTML="";
  for(const p of list){
    const d = document.createElement("div");
    d.className="prod";
    d.innerHTML = `
      <div class="title">${escapeHTML(p.name)}</div>
      <div class="tag">${p.tag.map(x=>`<span>${escapeHTML(x)}</span>`).join("")}</div>
      <div class="row" style="justify-content:space-between;align-items:end">
        <div>
          <div class="tiny muted">Pre√ßo</div>
          <div class="price">${money(p.price)}</div>
        </div>
        <button class="btn primary" data-add="${p.id}">Adicionar</button>
      </div>
    `;
    g.appendChild(d);
  }

  g.querySelectorAll("[data-add]").forEach(b=>{
    b.addEventListener("click", ()=> addToCart(b.dataset.add));
  });
}

function renderCart(){
  const list = $("cartList");
  if(!state.cart.length){
    list.textContent="Seu carrinho est√° vazio.";
    $("total").textContent=money(0);
    return;
  }
  const lines = state.cart.map(it=>{
    return `‚Ä¢ ${it.qty}x ${it.name} ‚Äî ${money(it.price*it.qty)}`;
  }).join("\n");
  const {sum, disc, total} = cartTotals();
  list.textContent = lines + (disc>0 ? `\n\nDesconto: -${money(disc)}` : "");
  $("total").textContent = money(total);
}

function addToCart(pid){
  const p = PRODUCTS.find(x=>x.id===pid);
  if(!p) return;
  const i = state.cart.findIndex(x=>x.id===pid);
  if(i>=0) state.cart[i].qty += 1;
  else state.cart.push({id:p.id, name:p.name, price:p.price, qty:1});
  saveJSON("vv_cart_rebuild", state.cart);
  renderCart();
  toast("Adicionado ao carrinho ‚úÖ");
}

function clearCart(){
  state.cart=[];
  state.discount=0;
  state.couponApplied="";
  saveJSON("vv_cart_rebuild", state.cart);
  renderCart();
  $("coupon").value="";
  $("couponMsg").textContent="‚Äî";
}

function applyCoupon(){
  const code = ($("coupon").value||"").trim().toUpperCase();
  if(!code){ $("couponMsg").textContent="Digite um cupom."; return; }
  if(code !== "WELCOME10"){
    $("couponMsg").textContent="Cupom inv√°lido.";
    toast("Cupom inv√°lido ‚ùå");
    return;
  }
  if(localStorage.getItem(USED_COUPON)==="1"){
    $("couponMsg").textContent="Esse cupom j√° foi usado neste dispositivo.";
    toast("Cupom j√° usado neste dispositivo.");
    return;
  }
  const {sum} = cartTotals();
  if(sum<=0){ $("couponMsg").textContent="Adicione itens primeiro."; return; }
  state.discount = +(sum*0.10).toFixed(2);
  state.couponApplied="WELCOME10";
  $("couponMsg").textContent="Cupom aplicado ‚úÖ (10%)";
  renderCart();
  toast("WELCOME10 aplicado ‚úÖ");
}

function saveContact(){
  const data = {
    whatsapp: ($("whats").value||"").replace(/\D/g,""),
    robloxUser: ($("robloxUser").value||"").trim(),
    robloxServer: ($("robloxServer").value||"").trim(),
    robloxTime: ($("robloxTime").value||"").trim(),
  };
  saveJSON("vv_contact_rebuild", data);
  return data;
}

function orders(){
  return loadJSON(ORD_KEY) || [];
}
function saveOrders(arr){
  saveJSON(ORD_KEY, arr);
}

function itemsHash(items){
  // Simple stable hash for client-side: NOT security, only consistency.
  const s = items.map(it=>`${it.id}:${it.qty}:${it.price}`).join("|");
  let h = 2166136261;
  for(let i=0;i<s.length;i++){
    h ^= s.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return "h"+(h>>>0).toString(16);
}

async function signOnWorker(payload){
  const base = (cfg().workerUrl||"").replace(/\/+$/,"");
  if(!base) return {ok:false, note:"Sem Worker configurado"};
  try{
    const r = await fetch(base + "/sign", {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify(payload)
    });
    const j = await r.json();
    return j;
  }catch(e){
    return {ok:false, error:"Falha ao conectar no Worker"};
  }
}

async function gerarPedido(){
  const contact = saveContact();
  if(!contact.robloxUser){
    toast("Coloque seu @ do Roblox.");
    $("robloxUser").focus();
    return;
  }
  if(!state.cart.length){
    toast("Seu carrinho est√° vazio.");
    return;
  }
  const {sum, disc, total} = cartTotals();
  const ord = {
    createdAt: new Date().toISOString(),
    orderId: "vv_" + Date.now() + "_" + Math.random().toString(36).slice(2,8),
    user: contact.robloxUser,
    server: contact.robloxServer,
    time: contact.robloxTime,
    whatsapp: contact.whatsapp || cfg().whatsapp,
    items: state.cart,
    itemsHash: itemsHash(state.cart),
    subtotal: +sum.toFixed(2),
    discount: +disc.toFixed(2),
    total: +total.toFixed(2),
    coupon: state.couponApplied || "",
    status: "PENDING"
  };

  const sigResp = await signOnWorker({ total: ord.total, user: ord.user, itemsHash: ord.itemsHash });
  ord.sig = sigResp.sig || "";
  ord.sigOk = !!sigResp.ok;
  ord.sigNote = sigResp.note || sigResp.error || "‚Äî";

  // save order
  const all = orders();
  all.unshift(ord);
  saveOrders(all.slice(0,500));

  // mark coupon used (once per device) when an order is generated with it
  if(ord.coupon==="WELCOME10") localStorage.setItem(USED_COUPON,"1");

  state.lastOrder = ord;
  $("orderBox").classList.remove("hidden");
  $("orderId").value = ord.orderId;
  $("verifyOrderId").value = ord.orderId;
  $("orderNote").textContent = ord.sigOk ? "‚úÖ Verificado no servidor (VV-OFICIAL)" : ("‚ö†Ô∏è Sem verifica√ß√£o no servidor: " + ord.sigNote);
  $("sigChip").className = "chip " + (ord.sigOk ? "ok" : "warn");
  $("sigChip").textContent = ord.sigOk ? "VV-OFICIAL" : "Sem verifica√ß√£o";
  toast("Pedido gerado ‚úÖ");

  renderCart();
}

async function verificarPedido(){
  const base = (cfg().workerUrl||"").replace(/\/+$/,"");
  const id = ($("verifyOrderId").value||"").trim();
  if(!base){ toast("Configure a URL do Worker."); return; }
  if(!id){ toast("Digite o Order ID."); return; }
  $("verifyOut").textContent="Verificando‚Ä¶";
  try{
    const r = await fetch(base + "/verify", {
      method:"POST",
      headers:{ "content-type":"application/json" },
      body: JSON.stringify({ orderId: id })
    });
    const j = await r.json();
    $("verifyOut").textContent = JSON.stringify(j, null, 2);
  }catch(e){
    $("verifyOut").textContent = JSON.stringify({ok:false,error:"Falha ao conectar no Worker"}, null, 2);
  }
}

async function pingWorker(){
  const base = (cfg().workerUrl||"").replace(/\/+$/,"");
  if(!base){ toast("Configure a URL do Worker."); return; }
  $("pingOut").textContent="Testando‚Ä¶";
  try{
    const r = await fetch(base + "/health", { method:"GET" });
    const txt = await r.text();
    $("pingOut").textContent = txt;
    $("sysChip").className="chip ok";
    $("sysChip").textContent="Online ‚úÖ";
  }catch(e){
    $("pingOut").textContent = JSON.stringify({ok:false,error:"Offline"}, null, 2);
    $("sysChip").className="chip bad";
    $("sysChip").textContent="Offline ‚ùå";
  }
}

function openWhatsSupport(prefill){
  const w = (saveContact().whatsapp || cfg().whatsapp || "").replace(/\D/g,"") || "5511941598713";
  const msg = encodeURIComponent(prefill || "Ol√°! Preciso de suporte com um pedido da ViralVault.");
  window.open("https://wa.me/" + w + "?text=" + msg, "_blank");
}

function pagarWhats(){
  const o = state.lastOrder;
  if(!o){ toast("Gere um pedido primeiro."); return; }
  const msg = [
    "üßæ *Pagamento (PIX) ‚Äî " + cfg().storeName + "*",
    "",
    "üîé Pedido: *" + o.orderId + "*",
    "üéÆ Roblox: @" + o.user,
    (o.server ? ("üïπÔ∏è Jogo/Servidor: " + o.server) : ""),
    (o.time ? ("‚è∞ Hor√°rio: " + o.time) : ""),
    "",
    "Itens:",
    ...o.items.map(it=>"‚Ä¢ " + it.qty + "x " + it.name),
    "",
    "Total: *" + money(o.total) + "*",
    "",
    "‚úÖ Entrega em at√© 24h ap√≥s confirma√ß√£o.",
    "üîí Antes de pagar, voc√™ pode verificar o pedido no servidor.",
  ].filter(Boolean).join("\n");
  openWhatsSupport(msg);
}

function escapeHTML(s){
  return String(s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m]));
}

/* Admin (local) */
function adminSelectById(id){
  const o = orders().find(x=>x.orderId===id);
  state.adminSel = o || null;
  $("adminOut").textContent = o ? JSON.stringify(o, null, 2) : "N√£o encontrado.";
  return o;
}
function adminPatch(patch){
  if(!state.adminSel){ toast("Busque um pedido."); return; }
  const all = orders();
  const i = all.findIndex(x=>x.orderId===state.adminSel.orderId);
  if(i<0){ toast("Pedido n√£o encontrado."); return; }
  all[i] = {...all[i], ...(patch||{})};
  saveOrders(all);
  state.adminSel = all[i];
  $("adminOut").textContent = JSON.stringify(all[i], null, 2);
}
function adminMarkPaid(){
  adminPatch({ status:"PAID", paidAt:new Date().toISOString() });
  toast("Marcado como PAGO ‚úÖ");
}
function adminSendDelivery(){
  if(!state.adminSel){ toast("Busque um pedido."); return; }
  const o = state.adminSel;
  const msg = [
    "üöÄ *Entrega Roblox ‚Äî " + cfg().storeName + "*",
    "",
    "üîé Pedido: *" + o.orderId + "*",
    "üéÆ Roblox: @" + o.user,
    (o.server ? ("üïπÔ∏è Jogo/Servidor: " + o.server) : ""),
    (o.time ? ("‚è∞ Hor√°rio: " + o.time) : ""),
    "",
    "Itens:",
    ...o.items.map(it=>"‚Ä¢ " + it.qty + "x " + it.name),
    "",
    "üì∑ Vou enviar a prova de entrega aqui quando finalizar ‚úÖ"
  ].filter(Boolean).join("\n");
  openWhatsSupport(msg);
}
function adminDelivered(){
  adminPatch({ status:"DELIVERED", deliveredAt:new Date().toISOString() });
  toast("Entregue ‚úÖ");
}
function adminRefund(){
  if(!state.adminSel){ toast("Busque um pedido."); return; }
  const note = prompt("Motivo/nota (opcional):") || "";
  adminPatch({ status:"REFUNDED", refundedAt:new Date().toISOString(), refundNote: note });
  const o = state.adminSel;
  const msg = [
    "‚Ü©Ô∏è *Reembolso ‚Äî " + cfg().storeName + "*",
    "",
    "üîé Pedido: *" + o.orderId + "*",
    "Confirmamos o reembolso total conforme nossa garantia de 24h.",
    note ? ("Nota: " + note) : "",
    "",
    "Se precisar de algo, estou √† disposi√ß√£o ‚úÖ"
  ].filter(Boolean).join("\n");
  openWhatsSupport(msg);
}

document.addEventListener("DOMContentLoaded", ()=>{
  $("yy").textContent = new Date().getFullYear();

  // nav
  document.querySelectorAll(".tab").forEach(b=>{
    b.addEventListener("click", ()=> setPage(b.dataset.page));
  });
  document.querySelectorAll("#quickbar [data-page]").forEach(b=>{
    b.addEventListener("click", ()=> setPage(b.dataset.page));
  });

  // home buttons
  $("btnIrCatalogo").addEventListener("click", ()=> setPage("catalogo"));
  $("btnVerGarantia").addEventListener("click", ()=> alert("üõ°Ô∏è Garantia 24h\n\nEntrega em at√© 24h ap√≥s confirma√ß√£o.\nSe passar de 24h sem entrega: reembolso total."));
  $("btnSuporte").addEventListener("click", ()=> openWhatsSupport());
  $("btnAbrirVerificar").addEventListener("click", ()=> setPage("verificar"));
  $("btnAbrirStatus").addEventListener("click", ()=> setPage("status"));
  $("btnAbrirSuporte2").addEventListener("click", ()=> openWhatsSupport());
  $("btnIrVerificar").addEventListener("click", ()=> setPage("verificar"));
  $("btnPagar").addEventListener("click", pagarWhats);
  $("btnCopiarId").addEventListener("click", ()=>{ navigator.clipboard.writeText($("orderId").value||""); toast("Copiado ‚úÖ"); });
  $("btnLimpar").addEventListener("click", clearCart);
  $("btnLimpar2").addEventListener("click", clearCart);
  $("btnGerarPedido").addEventListener("click", gerarPedido);
  $("btnAplicarCupom").addEventListener("click", applyCoupon);

  // catalog
  $("btnVoltarCheckout").addEventListener("click", ()=> setPage("home"));

  // verify
  $("btnSalvarWorker").addEventListener("click", ()=>{
    const u = ($("workerUrl").value||"").trim().replace(/\/+$/,"");
    setCfg({workerUrl:u});
    toast("Worker salvo ‚úÖ");
  });
  $("btnVerificar").addEventListener("click", verificarPedido);

  // status
  $("btnPing").addEventListener("click", pingWorker);
  $("btnAbrirVerificar2").addEventListener("click", ()=> setPage("verificar"));
  $("btnVoltarHome").addEventListener("click", ()=> setPage("home"));

  // quickbar support
  $("qbSuporte").addEventListener("click", ()=> openWhatsSupport());

  // admin
  $("btnAdminBuscar").addEventListener("click", ()=> adminSelectById(($("adminFind").value||"").trim()));
  $("btnAdminPago").addEventListener("click", adminMarkPaid);
  $("btnAdminEntrega").addEventListener("click", adminSendDelivery);
  $("btnAdminEntregue").addEventListener("click", adminDelivered);
  $("btnAdminReembolso").addEventListener("click", adminRefund);

  // preload contact
  const c = loadJSON("vv_contact_rebuild") || {};
  $("whats").value = c.whatsapp || cfg().whatsapp;
  $("robloxUser").value = c.robloxUser || "";
  $("robloxServer").value = c.robloxServer || "";
  $("robloxTime").value = c.robloxTime || "";

  // catalog controls
  const search = $("search");
  const filter = $("filter");
  const sort = $("sort");
  if(search) search.addEventListener("input", ()=> renderProducts());
  if(filter) filter.addEventListener("change", ()=> renderProducts());
  if(sort) sort.addEventListener("change", ()=> renderProducts());

  renderProducts();
  renderCart();
  setPage("home");
});
</script>
</body>
</html>
